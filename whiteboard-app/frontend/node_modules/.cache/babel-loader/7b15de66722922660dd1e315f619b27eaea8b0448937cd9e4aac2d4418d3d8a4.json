{"ast":null,"code":"var _jsxFileName = \"D:\\\\CapstoneProject\\\\whiteboard-app\\\\frontend\\\\src\\\\pages\\\\WhiteboardRoom.js\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useRef, useState, useCallback } from \"react\";\nimport { useParams, useNavigate } from \"react-router-dom\";\nimport { useAuth } from \"../context/AuthContext\";\nimport { useSocket } from \"../context/SocketContext\";\nimport { roomService } from \"../services/api\";\nimport Toolbar from \"../components/Toolbar\";\nimport Chat from \"../components/Chat\";\nimport StylingPanel from \"../components/StylingPanel\";\nimport toast from \"react-hot-toast\";\nimport { Plus, Minus, Save, FilePlus, ChevronRight, MessageCircle, Users, X } from \"lucide-react\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst WhiteboardRoom = () => {\n  _s();\n  var _room$host, _room$host2;\n  const {\n    roomId\n  } = useParams();\n  const navigate = useNavigate();\n  const {\n    user\n  } = useAuth();\n  const {\n    socket\n  } = useSocket();\n  const canvasRef = useRef(null);\n  const viewportRef = useRef(null);\n  const contextRef = useRef(null);\n\n  // Tools & Styling\n  const [tool, setTool] = useState(\"pencil\");\n  const [showStyling, setShowStyling] = useState(true);\n  const [color, setColor] = useState(\"#000000\");\n  const [size, setSize] = useState(4);\n  const [opacity, setOpacity] = useState(1);\n  const [strokeStyle, setStrokeStyle] = useState('solid');\n  const [fill, setFill] = useState(false);\n\n  // Camera / Infinite Canvas\n  const [cameraScale, setCameraScale] = useState(1);\n  const [cameraOffset, setCameraOffset] = useState({\n    x: -4000 + window.innerWidth / 2,\n    y: -4000 + window.innerHeight / 2\n  });\n  const cameraScaleRef = useRef(1);\n  const cameraOffsetRef = useRef({\n    x: -4000 + window.innerWidth / 2,\n    y: -4000 + window.innerHeight / 2\n  });\n  const isPanningRef = useRef(false);\n  const panStartRef = useRef({\n    x: 0,\n    y: 0\n  });\n\n  // â”€â”€â”€ STROKE-BASED ARCHITECTURE (Source of Truth) â”€â”€â”€\n  const strokesRef = useRef([]); // Performance ref â€” authoritative source\n  const [strokesVersion, setStrokesVersion] = useState(0); // Trigger re-render when needed\n\n  // Performance Refs for Drawing\n  const isDrawingRef = useRef(false);\n  const currentPointsRef = useRef([]);\n  const startPosRef = useRef({\n    x: 0,\n    y: 0\n  });\n  const lastPosRef = useRef({\n    x: 0,\n    y: 0\n  });\n  const snapshotCanvasRef = useRef(null);\n  const animationFrameRef = useRef(null);\n  const lastCursorEmitRef = useRef(0);\n  const imageFileRef = useRef(null);\n  const imagePlacePosRef = useRef({\n    x: 0,\n    y: 0\n  });\n  const imageCache = useRef(new Map());\n\n  // Undo/Redo history (stroke snapshots)\n  const historyRef = useRef([]);\n  const historyIndexRef = useRef(-1);\n\n  // Room State\n  const [room, setRoom] = useState(null);\n  const [participants, setParticipants] = useState([]);\n  const [messages, setMessages] = useState([]);\n  const [sharedFiles, setSharedFiles] = useState([]);\n  const [activeTab, setActiveTab] = useState(\"chat\");\n  const [loadingFileUpload, setLoadingFileUpload] = useState(false);\n  const [screenStream, setScreenStream] = useState(null);\n  const screenVideoRef = useRef(null);\n  const [isSidebarOpen, setIsSidebarOpen] = useState(false); // Hidden by default\n  const [remoteCursors, setRemoteCursors] = useState({});\n  const [typingUsers, setTypingUsers] = useState([]);\n\n  // Multi-page state\n  const [pages, setPages] = useState([]);\n  const [activePageId, setActivePageId] = useState(\"\");\n  const colors = [\"#000000\", \"#475569\", \"#dc2626\", \"#ea580c\", \"#d97706\", \"#65a30d\", \"#0891b2\", \"#2563eb\", \"#7c3aed\", \"#db2777\"];\n  const isDrawingTool = [\"pencil\", \"highlighter\", \"soft-brush\", \"marker\", \"smooth-pencil\", \"precision-eraser\", \"rect\", \"circle\", \"line\", \"arrow\", \"double-arrow\", \"rounded-rect\", \"ellipse\", \"triangle\", \"diamond\", \"sticky\", \"speech-bubble\", \"parallelogram\", \"cylinder\", \"document\", \"cloud\"].includes(tool);\n  const canvasCursor = {\n    select: 'default',\n    pan: 'grab',\n    eraser: 'cell',\n    'precision-eraser': 'cell',\n    text: 'text',\n    upload: 'copy'\n  }[tool] || 'crosshair';\n  const handleToolChange = newTool => {\n    if (tool === newTool) {\n      setShowStyling(!showStyling);\n    } else {\n      setTool(newTool);\n      setShowStyling(true);\n    }\n  };\n\n  // â”€â”€â”€ STROKE HELPERS â”€â”€â”€\n  const setStrokes = useCallback(newStrokes => {\n    if (typeof newStrokes === 'function') {\n      strokesRef.current = newStrokes(strokesRef.current);\n    } else {\n      strokesRef.current = newStrokes;\n    }\n    setStrokesVersion(v => v + 1);\n  }, []);\n  const pushToHistory = useCallback(() => {\n    const snapshot = JSON.parse(JSON.stringify(strokesRef.current));\n    historyRef.current = historyRef.current.slice(0, historyIndexRef.current + 1);\n    historyRef.current.push(snapshot);\n    historyIndexRef.current = historyRef.current.length - 1;\n  }, []);\n\n  // â”€â”€â”€ SOCKET SETUP â”€â”€â”€\n  useEffect(() => {\n    const fetchRoomDetails = async () => {\n      try {\n        const res = await roomService.getRoom(roomId);\n        setRoom(res.data.room);\n        setSharedFiles(res.data.room.sharedFiles || []);\n      } catch (err) {\n        toast.error(\"Failed to load workspace\");\n        navigate(\"/dashboard\");\n      }\n    };\n    fetchRoomDetails();\n    if (socket) {\n      socket.emit(\"join-room\", {\n        roomId,\n        userId: user._id,\n        userName: user.name\n      });\n      socket.on(\"user-joined\", data => toast.success(`${data.userName} joined`));\n      socket.on(\"online-users\", users => setParticipants(users));\n      socket.on(\"chat-message\", msg => setMessages(prev => [...prev, msg]));\n      socket.on(\"chat-history\", h => setMessages(h));\n      socket.on(\"drawing\", data => drawRemote(data));\n      socket.on(\"erase\", data => eraseRemote(data));\n      socket.on(\"board-cleared\", () => {\n        strokesRef.current = [];\n        historyRef.current = [[]];\n        historyIndexRef.current = 0;\n        setStrokesVersion(v => v + 1);\n        redrawCanvas();\n      });\n\n      // â”€â”€â”€ CANVAS STATE (strokes are the ONLY source of truth) â”€â”€â”€\n      socket.on(\"canvas-state\", data => {\n        if (data) {\n          const loadedStrokes = data.strokes && data.strokes.length > 0 ? data.strokes : [];\n          strokesRef.current = loadedStrokes;\n          setStrokesVersion(v => v + 1);\n          historyRef.current = [JSON.parse(JSON.stringify(loadedStrokes))];\n          historyIndexRef.current = 0;\n\n          // Pages\n          if (data.pages) setPages(data.pages);\n          if (data.pageId) setActivePageId(data.pageId);\n          requestAnimationFrame(() => redrawCanvas());\n        }\n      });\n      socket.on(\"new-stroke\", stroke => {\n        strokesRef.current = [...strokesRef.current, stroke];\n        setStrokesVersion(v => v + 1);\n        redrawCanvas();\n      });\n      socket.on(\"board-state-updated\", updatedStrokes => {\n        strokesRef.current = updatedStrokes;\n        setStrokesVersion(v => v + 1);\n        redrawCanvas();\n      });\n      socket.on(\"new-file\", file => setSharedFiles(prev => [...prev, file]));\n      socket.on(\"user-left\", data => toast(`ðŸ‘‹ ${data.userName} left`));\n      socket.on(\"cursor-move\", data => {\n        setRemoteCursors(prev => ({\n          ...prev,\n          [data.socketId]: data\n        }));\n        setTimeout(() => setRemoteCursors(prev => {\n          const n = {\n            ...prev\n          };\n          delete n[data.socketId];\n          return n;\n        }), 3000);\n      });\n\n      // Typing indicators\n      socket.on(\"typing-start\", ({\n        userName,\n        socketId\n      }) => {\n        setTypingUsers(prev => {\n          if (prev.find(u => u.socketId === socketId)) return prev;\n          return [...prev, {\n            userName,\n            socketId\n          }];\n        });\n      });\n      socket.on(\"typing-stop\", ({\n        socketId\n      }) => {\n        setTypingUsers(prev => prev.filter(u => u.socketId !== socketId));\n      });\n\n      // Page events\n      socket.on(\"page-added\", data => {\n        setPages(data.pages);\n        setActivePageId(data.pageId);\n        strokesRef.current = [];\n        setStrokesVersion(v => v + 1);\n        historyRef.current = [[]];\n        historyIndexRef.current = 0;\n        redrawCanvas();\n      });\n      socket.on(\"page-switched\", data => {\n        setActivePageId(data.pageId);\n        strokesRef.current = data.strokes || [];\n        setStrokesVersion(v => v + 1);\n        historyRef.current = [JSON.parse(JSON.stringify(data.strokes || []))];\n        historyIndexRef.current = 0;\n        redrawCanvas();\n      });\n      socket.on(\"page-deleted\", data => {\n        setPages(data.pages);\n        if (data.activePageId !== activePageId) {\n          setActivePageId(data.activePageId);\n          strokesRef.current = data.strokes || [];\n          setStrokesVersion(v => v + 1);\n          historyRef.current = [JSON.parse(JSON.stringify(data.strokes || []))];\n          historyIndexRef.current = 0;\n          redrawCanvas();\n        }\n        toast.success(\"Page deleted\");\n      });\n      socket.on(\"board-saved\", ({\n        pageId\n      }) => {\n        toast.success(\"Board saved!\");\n      });\n\n      // Undo/Redo from remote\n      socket.on(\"undo\", () => {/* Remote undo handled via board-state-updated */});\n      socket.on(\"redo\", () => {/* Remote redo handled via board-state-updated */});\n    }\n    return () => {\n      if (socket) {\n        socket.emit(\"leave-room\", {\n          roomId,\n          userId: user._id,\n          userName: user.name\n        });\n        [\"user-joined\", \"online-users\", \"chat-message\", \"chat-history\", \"drawing\", \"erase\", \"board-cleared\", \"canvas-state\", \"undo\", \"redo\", \"user-left\", \"new-stroke\", \"board-state-updated\", \"new-file\", \"cursor-move\", \"typing-start\", \"typing-stop\", \"page-added\", \"page-switched\", \"board-saved\"].forEach(ev => socket.off(ev));\n      }\n    };\n  }, [roomId, socket, user, navigate]);\n\n  // â”€â”€â”€ CANVAS SETUP â”€â”€â”€\n  useEffect(() => {\n    const viewport = viewportRef.current;\n    const canvas = canvasRef.current;\n    if (!viewport || !canvas) return;\n    const updateCanvasSize = () => {\n      const dpr = window.devicePixelRatio || 1;\n      canvas.width = viewport.clientWidth * dpr;\n      canvas.height = viewport.clientHeight * dpr;\n      const context = canvas.getContext(\"2d\", {\n        alpha: true\n      });\n      if (context) {\n        context.lineCap = \"round\";\n        context.lineJoin = \"round\";\n        contextRef.current = context;\n      }\n      if (!snapshotCanvasRef.current) {\n        snapshotCanvasRef.current = document.createElement('canvas');\n      }\n      snapshotCanvasRef.current.width = canvas.width;\n      snapshotCanvasRef.current.height = canvas.height;\n      redrawCanvas();\n    };\n    const ro = new ResizeObserver(() => updateCanvasSize());\n    ro.observe(viewport);\n    return () => ro.disconnect();\n  }, []);\n\n  // Redraw when strokes change\n  useEffect(() => {\n    redrawCanvas();\n  }, [strokesVersion]);\n\n  // â”€â”€â”€ ZOOM â”€â”€â”€\n  useEffect(() => {\n    const handleZoomIn = () => updateZoom(1.1);\n    const handleZoomOut = () => updateZoom(1 / 1.1);\n    const handleResetZoom = () => {\n      cameraScaleRef.current = 1;\n      cameraOffsetRef.current = {\n        x: -4000 + window.innerWidth / 2,\n        y: -4000 + window.innerHeight / 2\n      };\n      setCameraScale(1);\n      setCameraOffset(cameraOffsetRef.current);\n      syncViewDOM();\n    };\n    window.addEventListener('wb-zoom-in', handleZoomIn);\n    window.addEventListener('wb-zoom-out', handleZoomOut);\n    window.addEventListener('wb-reset-view', handleResetZoom);\n    return () => {\n      window.removeEventListener('wb-zoom-in', handleZoomIn);\n      window.removeEventListener('wb-zoom-out', handleZoomOut);\n      window.removeEventListener('wb-reset-view', handleResetZoom);\n    };\n  }, []);\n  useEffect(() => {\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n    const handleWheel = e => {\n      e.preventDefault();\n      if (e.ctrlKey) {\n        const zoomSpeed = 0.0012;\n        const delta = -e.deltaY * zoomSpeed * cameraScaleRef.current;\n        const newScale = Math.max(0.05, Math.min(10, cameraScaleRef.current + delta));\n        const rect = viewport.getBoundingClientRect();\n        const mouseX = e.clientX - rect.left;\n        const mouseY = e.clientY - rect.top;\n        const worldX = (mouseX - cameraOffsetRef.current.x) / cameraScaleRef.current;\n        const worldY = (mouseY - cameraOffsetRef.current.y) / cameraScaleRef.current;\n        cameraScaleRef.current = newScale;\n        cameraOffsetRef.current = {\n          x: mouseX - worldX * newScale,\n          y: mouseY - worldY * newScale\n        };\n        setCameraScale(newScale);\n        setCameraOffset(cameraOffsetRef.current);\n        syncViewDOM();\n      } else {\n        cameraOffsetRef.current = {\n          x: cameraOffsetRef.current.x - e.deltaX,\n          y: cameraOffsetRef.current.y - e.deltaY\n        };\n        syncViewDOM();\n        setCameraOffset(cameraOffsetRef.current);\n      }\n    };\n    viewport.addEventListener('wheel', handleWheel, {\n      passive: false\n    });\n    return () => viewport.removeEventListener('wheel', handleWheel);\n  }, []);\n  const updateZoom = factor => {\n    const newScale = Math.max(0.05, Math.min(10, cameraScaleRef.current * factor));\n    const centerX = window.innerWidth / 2;\n    const centerY = window.innerHeight / 2;\n    const worldX = (centerX - cameraOffsetRef.current.x) / cameraScaleRef.current;\n    const worldY = (centerY - cameraOffsetRef.current.y) / cameraScaleRef.current;\n    cameraScaleRef.current = newScale;\n    cameraOffsetRef.current = {\n      x: centerX - worldX * newScale,\n      y: centerY - worldY * newScale\n    };\n    setCameraScale(newScale);\n    setCameraOffset(cameraOffsetRef.current);\n    syncViewDOM();\n  };\n  const syncViewDOM = () => {\n    if (viewportRef.current) {\n      const scale = cameraScaleRef.current;\n      const ox = cameraOffsetRef.current.x;\n      const oy = cameraOffsetRef.current.y;\n      viewportRef.current.style.backgroundSize = `${24 * scale}px ${24 * scale}px`;\n      viewportRef.current.style.backgroundPosition = `${ox}px ${oy}px`;\n    }\n    redrawCanvas();\n  };\n\n  // â”€â”€â”€ CANVAS RENDERING (Pure stroke-based, no bitmap ghosts) â”€â”€â”€\n  const redrawCanvas = useCallback(() => {\n    const canvas = canvasRef.current;\n    const ctx = contextRef.current;\n    if (!canvas || !ctx) return;\n    const dpr = window.devicePixelRatio || 1;\n    ctx.setTransform(1, 0, 0, 1, 0, 0);\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n    // Apply Camera Transform\n    ctx.setTransform(cameraScaleRef.current * dpr, 0, 0, cameraScaleRef.current * dpr, cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr);\n\n    // Render all strokes â€” strokes are the ONLY source of truth\n    strokesRef.current.forEach(stroke => renderStroke(ctx, stroke));\n  }, []);\n  const renderStroke = (ctx, stroke) => {\n    const {\n      type,\n      points,\n      color,\n      size,\n      opacity,\n      strokeStyle,\n      fill\n    } = stroke;\n    if (type === 'text') {\n      ctx.save();\n      ctx.font = `bold ${size}px Inter, sans-serif`;\n      ctx.fillStyle = color;\n      ctx.globalAlpha = opacity;\n      ctx.globalCompositeOperation = \"source-over\";\n      ctx.shadowBlur = 0;\n      ctx.fillText(stroke.text || '', points[0].x, points[0].y);\n      ctx.restore();\n      return;\n    }\n    if (type === 'image') {\n      const cached = imageCache.current.get(stroke.src);\n      if (cached) {\n        ctx.save();\n        ctx.globalAlpha = stroke.opacity || 1;\n        ctx.drawImage(cached, points[0].x, points[0].y, stroke.imgW || 300, stroke.imgH || 200);\n        ctx.restore();\n      } else {\n        const img = new window.Image();\n        img.onload = () => {\n          imageCache.current.set(stroke.src, img);\n          redrawCanvas();\n        };\n        img.src = stroke.src;\n      }\n      return;\n    }\n    ctx.save();\n    if (type === 'eraser-precision' || type === 'mask') {\n      ctx.globalCompositeOperation = \"destination-out\";\n    } else {\n      ctx.globalCompositeOperation = \"source-over\";\n      ctx.globalAlpha = opacity;\n      ctx.strokeStyle = color;\n      ctx.fillStyle = color;\n      ctx.lineWidth = size;\n      ctx.setLineDash(strokeStyle === 'dashed' ? [10, 10] : []);\n      if (type === 'soft-brush') {\n        ctx.shadowBlur = size / 2;\n        ctx.shadowColor = color;\n      }\n      if (type === 'marker') {\n        ctx.globalAlpha = opacity * 0.6;\n      }\n    }\n    if (['pencil', 'highlighter', 'soft-brush', 'marker', 'smooth-pencil', 'eraser-precision'].includes(type)) {\n      if (points.length < 2) {\n        ctx.restore();\n        return;\n      }\n      ctx.beginPath();\n      ctx.moveTo(points[0].x, points[0].y);\n      for (let i = 1; i < points.length; i++) ctx.lineTo(points[i].x, points[i].y);\n      ctx.stroke();\n    } else {\n      drawShape(ctx, type, points, {\n        color,\n        size,\n        opacity,\n        strokeStyle,\n        fill\n      });\n    }\n    ctx.restore();\n  };\n  const drawShape = (ctx, type, points, style) => {\n    const start = points[0];\n    const end = points[points.length - 1];\n    const w = end.x - start.x;\n    const h = end.y - start.y;\n    if (type === 'rect') {\n      if (style.fill) ctx.fillRect(start.x, start.y, w, h);\n      ctx.strokeRect(start.x, start.y, w, h);\n    } else if (type === 'rounded-rect') {\n      ctx.beginPath();\n      ctx.roundRect(start.x, start.y, w, h, Math.min(Math.abs(w), Math.abs(h)) * 0.2);\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'circle' || type === 'ellipse') {\n      ctx.beginPath();\n      if (type === 'circle') {\n        const radius = Math.sqrt(w * w + h * h);\n        ctx.arc(start.x, start.y, radius, 0, 2 * Math.PI);\n      } else {\n        ctx.ellipse(start.x + w / 2, start.y + h / 2, Math.abs(w / 2), Math.abs(h / 2), 0, 0, 2 * Math.PI);\n      }\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'triangle') {\n      ctx.beginPath();\n      ctx.moveTo(start.x + w / 2, start.y);\n      ctx.lineTo(end.x, end.y);\n      ctx.lineTo(start.x, end.y);\n      ctx.closePath();\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'diamond') {\n      ctx.beginPath();\n      ctx.moveTo(start.x + w / 2, start.y);\n      ctx.lineTo(end.x, start.y + h / 2);\n      ctx.lineTo(start.x + w / 2, end.y);\n      ctx.lineTo(start.x, start.y + h / 2);\n      ctx.closePath();\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'line' || type === 'arrow' || type === 'double-arrow') {\n      ctx.beginPath();\n      ctx.moveTo(start.x, start.y);\n      ctx.lineTo(end.x, end.y);\n      ctx.stroke();\n      if (type === 'arrow' || type === 'double-arrow') drawArrowHead(ctx, start.x, start.y, end.x, end.y, style.size);\n      if (type === 'double-arrow') drawArrowHead(ctx, end.x, end.y, start.x, start.y, style.size);\n    } else if (type === 'sticky') {\n      ctx.save();\n      ctx.fillStyle = style.fill ? style.color : \"#fef08a\";\n      ctx.shadowBlur = 10;\n      ctx.shadowColor = \"rgba(0,0,0,0.1)\";\n      ctx.fillRect(start.x, start.y, w, h);\n      ctx.strokeStyle = \"rgba(0,0,0,0.05)\";\n      ctx.strokeRect(start.x, start.y, w, h);\n      ctx.restore();\n    } else if (type === 'speech-bubble') {\n      ctx.beginPath();\n      ctx.roundRect(start.x, start.y, w, h * 0.8, 10);\n      ctx.moveTo(start.x + w * 0.2, start.y + h * 0.8);\n      ctx.lineTo(start.x + w * 0.1, end.y);\n      ctx.lineTo(start.x + w * 0.4, start.y + h * 0.8);\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'parallelogram') {\n      const shift = w * 0.2;\n      ctx.beginPath();\n      ctx.moveTo(start.x + shift, start.y);\n      ctx.lineTo(end.x, start.y);\n      ctx.lineTo(end.x - shift, end.y);\n      ctx.lineTo(start.x, end.y);\n      ctx.closePath();\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'cylinder') {\n      const ry = Math.abs(h * 0.1);\n      ctx.beginPath();\n      ctx.ellipse(start.x + w / 2, end.y - ry, Math.abs(w / 2), ry, 0, 0, Math.PI, false);\n      ctx.stroke();\n      ctx.beginPath();\n      ctx.moveTo(start.x, start.y + ry);\n      ctx.lineTo(start.x, end.y - ry);\n      ctx.moveTo(end.x, start.y + ry);\n      ctx.lineTo(end.x, end.y - ry);\n      ctx.stroke();\n      ctx.beginPath();\n      ctx.ellipse(start.x + w / 2, start.y + ry, Math.abs(w / 2), ry, 0, 0, 2 * Math.PI);\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'document') {\n      const fold = Math.min(w, h) * 0.2;\n      ctx.beginPath();\n      ctx.moveTo(start.x, start.y);\n      ctx.lineTo(end.x - fold, start.y);\n      ctx.lineTo(end.x, start.y + fold);\n      ctx.lineTo(end.x, end.y);\n      ctx.lineTo(start.x, end.y);\n      ctx.closePath();\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n      ctx.beginPath();\n      ctx.moveTo(end.x - fold, start.y);\n      ctx.lineTo(end.x - fold, start.y + fold);\n      ctx.lineTo(end.x, start.y + fold);\n      ctx.stroke();\n    } else if (type === 'cloud') {\n      ctx.beginPath();\n      const mw = start.x + w / 2;\n      const mh = start.y + h / 2;\n      ctx.arc(mw - w * 0.2, mh, Math.abs(h * 0.3), 0, 2 * Math.PI);\n      ctx.arc(mw + w * 0.2, mh, Math.abs(h * 0.3), 0, 2 * Math.PI);\n      ctx.arc(mw, mh - h * 0.2, Math.abs(h * 0.3), 0, 2 * Math.PI);\n      ctx.arc(mw, mh + h * 0.2, Math.abs(h * 0.3), 0, 2 * Math.PI);\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    }\n  };\n  const drawArrowHead = (ctx, fromx, fromy, tox, toy, weight) => {\n    const headlen = weight * 4;\n    const angle = Math.atan2(toy - fromy, tox - fromx);\n    ctx.save();\n    ctx.translate(tox, toy);\n    ctx.rotate(angle);\n    ctx.beginPath();\n    ctx.moveTo(0, 0);\n    ctx.lineTo(-headlen, -headlen / 2);\n    ctx.lineTo(-headlen, headlen / 2);\n    ctx.closePath();\n    ctx.fill();\n    ctx.restore();\n  };\n  const getMousePos = e => {\n    const viewport = viewportRef.current;\n    if (!viewport) return {\n      x: 0,\n      y: 0\n    };\n    const rect = viewport.getBoundingClientRect();\n    return {\n      x: (e.clientX - rect.left - cameraOffsetRef.current.x) / cameraScaleRef.current,\n      y: (e.clientY - rect.top - cameraOffsetRef.current.y) / cameraScaleRef.current\n    };\n  };\n\n  // â”€â”€â”€ ERASER: Stroke removal (no ghost rendering) â”€â”€â”€\n  const eraseObjectAt = pos => {\n    const threshold = 15;\n    const newStrokes = strokesRef.current.filter(stroke => {\n      return !stroke.points.some(p => {\n        const dist = Math.sqrt(Math.pow(p.x - pos.x, 2) + Math.pow(p.y - pos.y, 2));\n        return dist < threshold;\n      });\n    });\n    if (newStrokes.length !== strokesRef.current.length) {\n      strokesRef.current = newStrokes;\n      setStrokesVersion(v => v + 1);\n      redrawCanvas();\n      // Sync erased state to all clients and DB\n      socket.emit(\"update-board-state\", {\n        roomId,\n        strokes: newStrokes,\n        pageId: activePageId\n      });\n    }\n  };\n\n  // â”€â”€â”€ DRAWING â”€â”€â”€\n  const startDrawing = e => {\n    if (e.button === 1 || tool === 'pan') {\n      isPanningRef.current = true;\n      panStartRef.current = {\n        x: e.clientX - cameraOffsetRef.current.x,\n        y: e.clientY - cameraOffsetRef.current.y\n      };\n      return;\n    }\n    const canvas = canvasRef.current;\n    if (!canvas || !contextRef.current) return;\n    const pos = getMousePos(e);\n    if (tool === 'select') return;\n    if (tool === 'upload') {\n      var _imageFileRef$current;\n      imagePlacePosRef.current = pos;\n      (_imageFileRef$current = imageFileRef.current) === null || _imageFileRef$current === void 0 ? void 0 : _imageFileRef$current.click();\n      return;\n    }\n    if (tool === 'eraser') {\n      eraseObjectAt(pos);\n      return;\n    }\n    if (tool === 'text') {\n      const textInput = prompt('Enter text:');\n      if (!textInput) return;\n      const textStroke = {\n        id: Date.now() + Math.random(),\n        type: 'text',\n        text: textInput,\n        points: [pos],\n        color,\n        size: size * 4,\n        opacity,\n        strokeStyle,\n        fill\n      };\n      strokesRef.current = [...strokesRef.current, textStroke];\n      setStrokesVersion(v => v + 1);\n      pushToHistory();\n      socket.emit('new-stroke', {\n        roomId,\n        stroke: textStroke,\n        pageId: activePageId\n      });\n      redrawCanvas();\n      return;\n    }\n    isDrawingRef.current = true;\n    currentPointsRef.current = [pos];\n    startPosRef.current = pos;\n    lastPosRef.current = pos;\n\n    // Take snapshot for shape preview\n    const snapCtx = snapshotCanvasRef.current.getContext('2d');\n    snapCtx.setTransform(1, 0, 0, 1, 0, 0);\n    snapCtx.clearRect(0, 0, canvas.width, canvas.height);\n    snapCtx.drawImage(canvas, 0, 0);\n    if (isDrawingTool) {\n      const ctx = contextRef.current;\n      const dpr = window.devicePixelRatio || 1;\n      ctx.setTransform(cameraScaleRef.current * dpr, 0, 0, cameraScaleRef.current * dpr, cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr);\n      ctx.beginPath();\n      ctx.moveTo(pos.x, pos.y);\n      ctx.lineWidth = size;\n      ctx.strokeStyle = color;\n      ctx.globalAlpha = tool === \"highlighter\" ? opacity * 0.4 : tool === \"marker\" ? opacity * 0.6 : opacity;\n      ctx.setLineDash(strokeStyle === 'dashed' ? [10, 10] : []);\n      ctx.lineCap = \"round\";\n      ctx.lineJoin = \"round\";\n      ctx.globalCompositeOperation = tool === \"precision-eraser\" ? \"destination-out\" : \"source-over\";\n      ctx.shadowBlur = 0;\n    }\n  };\n  const handleMouseMove = e => {\n    const now = Date.now();\n    if (socket && now - lastCursorEmitRef.current > 50) {\n      lastCursorEmitRef.current = now;\n      socket.emit('cursor-move', {\n        roomId,\n        cursorData: {\n          x: e.clientX,\n          y: e.clientY,\n          userName: user.name,\n          color\n        }\n      });\n    }\n    if (isPanningRef.current) {\n      cameraOffsetRef.current = {\n        x: e.clientX - panStartRef.current.x,\n        y: e.clientY - panStartRef.current.y\n      };\n      syncViewDOM();\n      return;\n    }\n    if (isDrawingRef.current) {\n      if (animationFrameRef.current) cancelAnimationFrame(animationFrameRef.current);\n      const clientX = e.clientX;\n      const clientY = e.clientY;\n      const shiftKey = e.shiftKey;\n      animationFrameRef.current = requestAnimationFrame(() => draw({\n        clientX,\n        clientY,\n        shiftKey\n      }));\n    } else if (tool === 'eraser' && e.buttons === 1) {\n      eraseObjectAt(getMousePos(e));\n    }\n  };\n  const draw = e => {\n    if (!isDrawingRef.current || !contextRef.current) return;\n    const pos = getMousePos(e);\n    let currentPos = pos;\n    if (tool === 'smooth-pencil' && currentPointsRef.current.length > 0) {\n      const lastPoint = currentPointsRef.current[currentPointsRef.current.length - 1];\n      currentPos = {\n        x: lastPoint.x * 0.8 + pos.x * 0.2,\n        y: lastPoint.y * 0.8 + pos.y * 0.2,\n        shiftKey: e.shiftKey\n      };\n    } else {\n      currentPos = {\n        ...pos,\n        shiftKey: e.shiftKey\n      };\n    }\n    currentPointsRef.current.push(currentPos);\n    const ctx = contextRef.current;\n    if ([\"pencil\", \"highlighter\", \"soft-brush\", \"marker\", \"smooth-pencil\", \"precision-eraser\"].includes(tool)) {\n      if (e.shiftKey) {\n        redrawCanvas();\n        ctx.beginPath();\n        ctx.moveTo(startPosRef.current.x, startPosRef.current.y);\n        ctx.lineTo(currentPos.x, currentPos.y);\n        ctx.stroke();\n        return;\n      }\n      ctx.lineTo(currentPos.x, currentPos.y);\n      ctx.stroke();\n\n      // Throttled emit for real-time collab\n      socket.emit(\"drawing\", {\n        roomId,\n        drawingData: {\n          x: currentPos.x,\n          y: currentPos.y,\n          prevX: lastPosRef.current.x,\n          prevY: lastPosRef.current.y,\n          color,\n          size,\n          opacity: ctx.globalAlpha,\n          tool\n        }\n      });\n      lastPosRef.current = currentPos;\n    } else if ([\"rect\", \"circle\", \"line\", \"arrow\", \"double-arrow\", \"rounded-rect\", \"ellipse\", \"triangle\", \"diamond\", \"sticky\", \"speech-bubble\", \"parallelogram\", \"cylinder\", \"document\", \"cloud\"].includes(tool)) {\n      const dpr = window.devicePixelRatio || 1;\n      ctx.setTransform(1, 0, 0, 1, 0, 0);\n      ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);\n      ctx.drawImage(snapshotCanvasRef.current, 0, 0);\n      ctx.setTransform(cameraScaleRef.current * dpr, 0, 0, cameraScaleRef.current * dpr, cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr);\n      drawShape(ctx, tool, [startPosRef.current, currentPos], {\n        color,\n        size,\n        opacity,\n        strokeStyle,\n        fill\n      });\n    }\n  };\n  const stopDrawing = () => {\n    if (isPanningRef.current) {\n      isPanningRef.current = false;\n      setCameraOffset(cameraOffsetRef.current);\n      return;\n    }\n    const canvas = canvasRef.current;\n    if (!isDrawingRef.current || !canvas) return;\n    if (animationFrameRef.current) cancelAnimationFrame(animationFrameRef.current);\n    isDrawingRef.current = false;\n    let points = [...currentPointsRef.current];\n    if ([\"pencil\", \"highlighter\", \"soft-brush\", \"marker\", \"smooth-pencil\"].includes(tool) && points.length > 1 && points[points.length - 1].shiftKey) {\n      points = [points[0], points[points.length - 1]];\n    }\n    const newStroke = {\n      id: Date.now() + Math.random(),\n      type: tool === 'precision-eraser' ? 'eraser-precision' : tool,\n      points,\n      color,\n      size: tool === 'precision-eraser' ? 10 : size,\n      opacity: tool === 'highlighter' ? 0.4 : tool === 'marker' ? 0.6 : opacity,\n      strokeStyle,\n      fill\n    };\n    if (tool !== 'eraser') {\n      strokesRef.current = [...strokesRef.current, newStroke];\n      setStrokesVersion(v => v + 1);\n      pushToHistory();\n      socket.emit(\"new-stroke\", {\n        roomId,\n        stroke: newStroke,\n        pageId: activePageId\n      });\n    }\n    currentPointsRef.current = [];\n    // NO bitmap save â€” strokes are the source of truth\n  };\n\n  // â”€â”€â”€ UNDO / REDO (stroke-based) â”€â”€â”€\n  const handleUndo = () => {\n    if (historyIndexRef.current > 0) {\n      historyIndexRef.current -= 1;\n      const snapshot = historyRef.current[historyIndexRef.current];\n      strokesRef.current = JSON.parse(JSON.stringify(snapshot));\n      setStrokesVersion(v => v + 1);\n      redrawCanvas();\n      socket.emit(\"update-board-state\", {\n        roomId,\n        strokes: strokesRef.current,\n        pageId: activePageId\n      });\n    }\n  };\n  const handleRedo = () => {\n    if (historyIndexRef.current < historyRef.current.length - 1) {\n      historyIndexRef.current += 1;\n      const snapshot = historyRef.current[historyIndexRef.current];\n      strokesRef.current = JSON.parse(JSON.stringify(snapshot));\n      setStrokesVersion(v => v + 1);\n      redrawCanvas();\n      socket.emit(\"update-board-state\", {\n        roomId,\n        strokes: strokesRef.current,\n        pageId: activePageId\n      });\n    }\n  };\n  const drawRemote = data => {\n    const {\n      x,\n      y,\n      prevX,\n      prevY,\n      color,\n      size,\n      opacity,\n      tool\n    } = data;\n    const ctx = contextRef.current;\n    if (!ctx) return;\n    const dpr = window.devicePixelRatio || 1;\n    ctx.save();\n    ctx.setTransform(cameraScaleRef.current * dpr, 0, 0, cameraScaleRef.current * dpr, cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr);\n    ctx.globalAlpha = opacity || 1;\n    ctx.strokeStyle = color;\n    ctx.lineWidth = size;\n    ctx.lineCap = \"round\";\n    ctx.lineJoin = \"round\";\n    ctx.globalCompositeOperation = tool === \"precision-eraser\" ? \"destination-out\" : \"source-over\";\n    ctx.beginPath();\n    if (prevX && prevY) ctx.moveTo(prevX, prevY);else ctx.moveTo(x, y);\n    ctx.lineTo(x, y);\n    ctx.stroke();\n    ctx.restore();\n  };\n  const eraseRemote = data => {\n    // Remote erase is now handled via board-state-updated\n  };\n  const handleClearBoard = () => {\n    if (window.confirm('Clear all drawings for everyone?')) socket.emit('clear-board', {\n      roomId,\n      userId: user._id,\n      pageId: activePageId\n    });\n  };\n  const downloadCanvas = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n    const link = document.createElement('a');\n    link.download = `${(room === null || room === void 0 ? void 0 : room.roomName) || 'whiteboard'}-${Date.now()}.png`;\n    link.href = canvas.toDataURL('image/png');\n    link.click();\n    toast.success('Board exported as PNG!');\n  };\n  const handleImageUpload = e => {\n    const file = e.target.files[0];\n    if (!file) return;\n    const reader = new FileReader();\n    reader.onload = ev => {\n      const src = ev.target.result;\n      const img = new window.Image();\n      img.onload = () => {\n        const maxW = 400;\n        const scale = Math.min(1, maxW / img.width);\n        const imgW = Math.round(img.width * scale);\n        const imgH = Math.round(img.height * scale);\n        const pos = imagePlacePosRef.current;\n        imageCache.current.set(src, img);\n        const imageStroke = {\n          id: Date.now() + Math.random(),\n          type: 'image',\n          src,\n          points: [pos],\n          imgW,\n          imgH,\n          color,\n          size,\n          opacity,\n          strokeStyle,\n          fill\n        };\n        strokesRef.current = [...strokesRef.current, imageStroke];\n        setStrokesVersion(v => v + 1);\n        pushToHistory();\n        if (socket) socket.emit('new-stroke', {\n          roomId,\n          stroke: imageStroke,\n          pageId: activePageId\n        });\n        redrawCanvas();\n      };\n      img.src = src;\n    };\n    reader.readAsDataURL(file);\n    e.target.value = '';\n  };\n\n  // â”€â”€â”€ PAGE MANAGEMENT â”€â”€â”€\n  const handleSaveBoard = () => {\n    socket.emit(\"save-board\", {\n      roomId,\n      pageId: activePageId\n    });\n  };\n  const handleNewPage = () => {\n    socket.emit(\"new-page\", {\n      roomId,\n      userId: user._id\n    });\n  };\n  const handleSwitchPage = pageId => {\n    if (pageId === activePageId) return;\n    socket.emit(\"switch-page\", {\n      roomId,\n      pageId\n    });\n  };\n\n  // â”€â”€â”€ SCREEN SHARING â”€â”€â”€\n  const startScreenShare = async () => {\n    try {\n      if (screenStream) {\n        screenStream.getTracks().forEach(t => t.stop());\n        setScreenStream(null);\n        socket.emit('screen-share-stopped', {\n          roomId\n        });\n        toast('Screen sharing stopped');\n        return;\n      }\n      const stream = await navigator.mediaDevices.getDisplayMedia({\n        video: true,\n        audio: false\n      });\n      setScreenStream(stream);\n      socket.emit('screen-share-started', {\n        roomId,\n        userId: user._id,\n        userName: user.name\n      });\n      stream.getVideoTracks()[0].onended = () => {\n        setScreenStream(null);\n        socket.emit('screen-share-stopped', {\n          roomId\n        });\n        toast('Screen sharing stopped');\n      };\n      toast.success('Screen sharing started!');\n    } catch (err) {\n      if (err.name !== 'NotAllowedError') toast.error('Screen sharing failed');\n    }\n  };\n\n  // â”€â”€â”€ KEYBOARD SHORTCUTS â”€â”€â”€\n  React.useEffect(() => {\n    const onKey = e => {\n      if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;\n      if (e.ctrlKey || e.metaKey) {\n        if (e.key === 'z') {\n          e.preventDefault();\n          handleUndo();\n        }\n        if (e.key === 'y') {\n          e.preventDefault();\n          handleRedo();\n        }\n        return;\n      }\n      const map = {\n        v: 'select',\n        h: 'pan',\n        p: 'pencil',\n        e: 'eraser',\n        t: 'text'\n      };\n      if (map[e.key.toLowerCase()]) setTool(map[e.key.toLowerCase()]);\n    };\n    window.addEventListener('keydown', onKey);\n    return () => window.removeEventListener('keydown', onKey);\n  }, []);\n\n  // Unread messages badge\n  const [unreadCount, setUnreadCount] = useState(0);\n  useEffect(() => {\n    if (!isSidebarOpen && messages.length > 0) {\n      setUnreadCount(prev => prev + 1);\n    }\n  }, [messages.length]);\n  useEffect(() => {\n    if (isSidebarOpen) setUnreadCount(0);\n  }, [isSidebarOpen]);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"wb-layout-container\",\n    \"data-sidebar\": isSidebarOpen ? \"open\" : \"closed\",\n    children: [/*#__PURE__*/_jsxDEV(\"header\", {\n      className: \"wb-header-modern\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"wb-header-left\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wb-logo\",\n          onClick: () => navigate('/dashboard'),\n          children: /*#__PURE__*/_jsxDEV(\"span\", {\n            children: \"S\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 969,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 968,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wb-header-info\",\n          children: [/*#__PURE__*/_jsxDEV(\"h1\", {\n            children: (room === null || room === void 0 ? void 0 : room.roomName) || 'Untitled Board'\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 972,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"wb-header-status\",\n            children: [/*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"wb-status-dot\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 974,\n              columnNumber: 29\n            }, this), participants.length, \" online\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 973,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 971,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wb-header-divider\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 979,\n          columnNumber: 21\n        }, this), isDrawingTool && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wb-toolbar-controls\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"wb-color-grid\",\n            children: colors.map(c => /*#__PURE__*/_jsxDEV(\"button\", {\n              onClick: () => setColor(c),\n              className: `wb-color-btn ${color === c ? 'active' : ''}`,\n              style: {\n                backgroundColor: c\n              }\n            }, c, false, {\n              fileName: _jsxFileName,\n              lineNumber: 986,\n              columnNumber: 37\n            }, this))\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 984,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"wb-header-divider\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 994,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"wb-slider-group\",\n            children: [/*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"wb-slider-label\",\n              children: \"Size\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 996,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n              type: \"range\",\n              min: \"1\",\n              max: \"40\",\n              value: size,\n              onChange: e => setSize(parseInt(e.target.value)),\n              className: \"wb-slider\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 997,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"wb-slider-value\",\n              children: size\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1000,\n              columnNumber: 33\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 995,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"wb-header-divider\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1002,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"wb-slider-group\",\n            children: [/*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"wb-slider-label\",\n              children: \"Opacity\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1004,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n              type: \"range\",\n              min: \"0.1\",\n              max: \"1\",\n              step: \"0.1\",\n              value: opacity,\n              onChange: e => setOpacity(parseFloat(e.target.value)),\n              className: \"wb-slider\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1005,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"wb-slider-value\",\n              children: [Math.round(opacity * 100), \"%\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1008,\n              columnNumber: 33\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1003,\n            columnNumber: 29\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 983,\n          columnNumber: 25\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 967,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"wb-header-right\",\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"wb-btn-icon\",\n          onClick: handleSaveBoard,\n          title: \"Save Board\",\n          children: /*#__PURE__*/_jsxDEV(Save, {\n            size: 16\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1017,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1016,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"wb-btn-icon\",\n          onClick: handleNewPage,\n          title: \"New Page\",\n          children: /*#__PURE__*/_jsxDEV(FilePlus, {\n            size: 16\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1020,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1019,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wb-header-divider\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1023,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"wb-btn-secondary\",\n          onClick: downloadCanvas,\n          children: \"Export\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1025,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"wb-btn-secondary\",\n          onClick: () => {\n            navigator.clipboard.writeText(window.location.href);\n            toast.success('Link copied!');\n          },\n          children: \"Invite\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1026,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: `wb-btn-primary ${screenStream ? 'wb-btn-danger' : ''}`,\n          onClick: startScreenShare,\n          children: screenStream ? 'Stop Share' : 'Share Screen'\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1030,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wb-header-divider\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1037,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: `wb-btn-chat ${isSidebarOpen ? 'active' : ''}`,\n          onClick: () => setIsSidebarOpen(!isSidebarOpen),\n          children: [/*#__PURE__*/_jsxDEV(MessageCircle, {\n            size: 18\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1044,\n            columnNumber: 25\n          }, this), unreadCount > 0 && !isSidebarOpen && /*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"wb-badge\",\n            children: unreadCount > 9 ? '9+' : unreadCount\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1046,\n            columnNumber: 29\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1040,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1014,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 966,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"aside\", {\n      className: \"wb-left-panel\",\n      children: /*#__PURE__*/_jsxDEV(Toolbar, {\n        activeTool: tool,\n        setTool: handleToolChange,\n        isHost: (room === null || room === void 0 ? void 0 : (_room$host = room.host) === null || _room$host === void 0 ? void 0 : _room$host.toString()) === user._id || (room === null || room === void 0 ? void 0 : (_room$host2 = room.host) === null || _room$host2 === void 0 ? void 0 : _room$host2._id) === user._id,\n        onClear: handleClearBoard,\n        onUndo: handleUndo,\n        onRedo: handleRedo,\n        onDelete: () => {}\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1054,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1053,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"main\", {\n      ref: viewportRef,\n      className: \"wb-viewport\",\n      style: {\n        backgroundImage: 'radial-gradient(#e2e8f0 1px, transparent 1px)',\n        backgroundSize: `${24 * cameraScale}px ${24 * cameraScale}px`,\n        backgroundPosition: `${cameraOffset.x}px ${cameraOffset.y}px`\n      },\n      children: [/*#__PURE__*/_jsxDEV(\"canvas\", {\n        ref: canvasRef,\n        className: \"wb-canvas\",\n        style: {\n          cursor: canvasCursor\n        },\n        onMouseDown: startDrawing,\n        onMouseMove: handleMouseMove,\n        onMouseUp: stopDrawing,\n        onMouseOut: stopDrawing\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1075,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n        type: \"file\",\n        accept: \"image/*\",\n        className: \"hidden\",\n        ref: imageFileRef,\n        onChange: handleImageUpload\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1085,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(StylingPanel, {\n        tool: tool,\n        visible: showStyling,\n        strokeStyle: strokeStyle,\n        setStrokeStyle: setStrokeStyle,\n        fill: fill,\n        setFill: setFill\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1086,\n        columnNumber: 17\n      }, this), pages.length > 0 && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"wb-page-tabs\",\n        children: pages.map(p => /*#__PURE__*/_jsxDEV(\"button\", {\n          className: `wb-page-tab ${p.pageId === activePageId ? 'active' : ''}`,\n          onClick: () => handleSwitchPage(p.pageId),\n          children: p.pageName\n        }, p.pageId, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1092,\n          columnNumber: 29\n        }, this))\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1090,\n        columnNumber: 21\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"wb-zoom-controls\",\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => {\n            cameraScaleRef.current = 1;\n            cameraOffsetRef.current = {\n              x: -4000 + window.innerWidth / 2,\n              y: -4000 + window.innerHeight / 2\n            };\n            setCameraScale(1);\n            setCameraOffset(cameraOffsetRef.current);\n            syncViewDOM();\n          },\n          className: \"wb-zoom-btn wb-zoom-label\",\n          children: [Math.round(cameraScale * 100), \"%\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1105,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wb-zoom-divider\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1115,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => updateZoom(1.1),\n          className: \"wb-zoom-btn\",\n          children: /*#__PURE__*/_jsxDEV(Plus, {\n            size: 14\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1116,\n            columnNumber: 85\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1116,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => updateZoom(1 / 1.1),\n          className: \"wb-zoom-btn\",\n          children: /*#__PURE__*/_jsxDEV(Minus, {\n            size: 14\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1117,\n            columnNumber: 89\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1117,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1104,\n        columnNumber: 17\n      }, this), Object.values(remoteCursors).map(cursor => /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"wb-remote-cursor\",\n        style: {\n          left: cursor.x,\n          top: cursor.y\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"svg\", {\n          width: \"12\",\n          height: \"16\",\n          viewBox: \"0 0 12 16\",\n          xmlns: \"http://www.w3.org/2000/svg\",\n          children: /*#__PURE__*/_jsxDEV(\"path\", {\n            d: \"M0 0 L0 14 L4 10 L6.5 14.5 L8 13.5 L5.5 9 L10 9 Z\",\n            fill: cursor.color || '#06b6d4',\n            stroke: \"white\",\n            strokeWidth: \"1\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1128,\n            columnNumber: 29\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1127,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n          className: \"wb-cursor-label\",\n          style: {\n            backgroundColor: cursor.color || '#06b6d4'\n          },\n          children: cursor.userName\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1131,\n          columnNumber: 25\n        }, this)]\n      }, cursor.socketId, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1122,\n        columnNumber: 21\n      }, this)), screenStream && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"wb-screen-preview\",\n        children: /*#__PURE__*/_jsxDEV(\"video\", {\n          ref: el => {\n            if (el) el.srcObject = screenStream;\n          },\n          autoPlay: true,\n          muted: true,\n          className: \"wb-screen-video\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1140,\n          columnNumber: 25\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1139,\n        columnNumber: 21\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 1066,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"aside\", {\n      className: `wb-right-panel ${isSidebarOpen ? 'open' : ''}`,\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"wb-sidebar-inner\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wb-sidebar-header\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"wb-sidebar-tabs\",\n            children: ['chat', 'files', 'users'].map(tab => /*#__PURE__*/_jsxDEV(\"button\", {\n              onClick: () => setActiveTab(tab),\n              className: `wb-sidebar-tab ${activeTab === tab ? \"active\" : \"\"}`,\n              children: [tab === 'chat' && /*#__PURE__*/_jsxDEV(MessageCircle, {\n                size: 13\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1160,\n                columnNumber: 56\n              }, this), tab === 'users' && /*#__PURE__*/_jsxDEV(Users, {\n                size: 13\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1161,\n                columnNumber: 57\n              }, this), tab]\n            }, tab, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1155,\n              columnNumber: 33\n            }, this))\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1153,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n            className: \"wb-sidebar-close\",\n            onClick: () => setIsSidebarOpen(false),\n            children: /*#__PURE__*/_jsxDEV(X, {\n              size: 16\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1167,\n              columnNumber: 29\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1166,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1152,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wb-sidebar-content\",\n          children: activeTab === \"chat\" ? /*#__PURE__*/_jsxDEV(Chat, {\n            messages: messages,\n            onSendMessage: txt => socket.emit(\"chat-message\", {\n              roomId,\n              message: txt,\n              userId: user._id,\n              userName: user.name\n            }),\n            currentUser: user,\n            socket: socket,\n            roomId: roomId,\n            typingUsers: typingUsers,\n            participants: participants\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1172,\n            columnNumber: 29\n          }, this) : activeTab === \"files\" ? /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"wb-files-panel\",\n            children: [/*#__PURE__*/_jsxDEV(\"label\", {\n              className: `wb-file-upload-btn ${loadingFileUpload ? 'disabled' : ''}`,\n              children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                children: loadingFileUpload ? 'Uploading...' : 'ðŸ“Ž Share Asset'\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1184,\n                columnNumber: 37\n              }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n                type: \"file\",\n                className: \"hidden\",\n                disabled: loadingFileUpload,\n                onChange: async e => {\n                  const file = e.target.files[0];\n                  if (!file) return;\n                  setLoadingFileUpload(true);\n                  try {\n                    const fd = new FormData();\n                    fd.append('file', file);\n                    const res = await roomService.uploadFile(roomId, fd);\n                    setSharedFiles(prev => [...prev, res.data.file]);\n                    socket.emit('file-shared', {\n                      roomId,\n                      file: res.data.file\n                    });\n                    toast.success(`${file.name} shared!`);\n                  } catch {\n                    toast.error('Upload failed');\n                  } finally {\n                    setLoadingFileUpload(false);\n                    e.target.value = '';\n                  }\n                }\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1185,\n                columnNumber: 37\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1183,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"wb-files-list\",\n              children: sharedFiles.map((f, i) => /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"wb-file-item\",\n                children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                  children: f.fileName\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1206,\n                  columnNumber: 45\n                }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                  children: \"\\u2B07\\uFE0F\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1207,\n                  columnNumber: 45\n                }, this)]\n              }, i, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1205,\n                columnNumber: 41\n              }, this))\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1203,\n              columnNumber: 33\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1182,\n            columnNumber: 29\n          }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"wb-users-panel\",\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"wb-users-count\",\n              children: [participants.length, \" Online\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1214,\n              columnNumber: 33\n            }, this), participants.map((p, i) => /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"wb-user-item\",\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"wb-user-avatar\",\n                children: p.userName[0]\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1217,\n                columnNumber: 41\n              }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                className: \"wb-user-name\",\n                children: p.userName\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1218,\n                columnNumber: 41\n              }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"wb-user-status\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1219,\n                columnNumber: 41\n              }, this)]\n            }, i, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1216,\n              columnNumber: 37\n            }, this))]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1213,\n            columnNumber: 29\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1170,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1151,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1150,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 964,\n    columnNumber: 9\n  }, this);\n};\n_s(WhiteboardRoom, \"BJSfgOTZ7FJd550QUFzuhHvigP0=\", false, function () {\n  return [useParams, useNavigate, useAuth, useSocket];\n});\n_c = WhiteboardRoom;\nexport default WhiteboardRoom;\nvar _c;\n$RefreshReg$(_c, \"WhiteboardRoom\");","map":{"version":3,"names":["React","useEffect","useRef","useState","useCallback","useParams","useNavigate","useAuth","useSocket","roomService","Toolbar","Chat","StylingPanel","toast","Plus","Minus","Save","FilePlus","ChevronRight","MessageCircle","Users","X","jsxDEV","_jsxDEV","WhiteboardRoom","_s","_room$host","_room$host2","roomId","navigate","user","socket","canvasRef","viewportRef","contextRef","tool","setTool","showStyling","setShowStyling","color","setColor","size","setSize","opacity","setOpacity","strokeStyle","setStrokeStyle","fill","setFill","cameraScale","setCameraScale","cameraOffset","setCameraOffset","x","window","innerWidth","y","innerHeight","cameraScaleRef","cameraOffsetRef","isPanningRef","panStartRef","strokesRef","strokesVersion","setStrokesVersion","isDrawingRef","currentPointsRef","startPosRef","lastPosRef","snapshotCanvasRef","animationFrameRef","lastCursorEmitRef","imageFileRef","imagePlacePosRef","imageCache","Map","historyRef","historyIndexRef","room","setRoom","participants","setParticipants","messages","setMessages","sharedFiles","setSharedFiles","activeTab","setActiveTab","loadingFileUpload","setLoadingFileUpload","screenStream","setScreenStream","screenVideoRef","isSidebarOpen","setIsSidebarOpen","remoteCursors","setRemoteCursors","typingUsers","setTypingUsers","pages","setPages","activePageId","setActivePageId","colors","isDrawingTool","includes","canvasCursor","select","pan","eraser","text","upload","handleToolChange","newTool","setStrokes","newStrokes","current","v","pushToHistory","snapshot","JSON","parse","stringify","slice","push","length","fetchRoomDetails","res","getRoom","data","err","error","emit","userId","_id","userName","name","on","success","users","msg","prev","h","drawRemote","eraseRemote","redrawCanvas","loadedStrokes","strokes","pageId","requestAnimationFrame","stroke","updatedStrokes","file","socketId","setTimeout","n","find","u","filter","forEach","ev","off","viewport","canvas","updateCanvasSize","dpr","devicePixelRatio","width","clientWidth","height","clientHeight","context","getContext","alpha","lineCap","lineJoin","document","createElement","ro","ResizeObserver","observe","disconnect","handleZoomIn","updateZoom","handleZoomOut","handleResetZoom","syncViewDOM","addEventListener","removeEventListener","handleWheel","e","preventDefault","ctrlKey","zoomSpeed","delta","deltaY","newScale","Math","max","min","rect","getBoundingClientRect","mouseX","clientX","left","mouseY","clientY","top","worldX","worldY","deltaX","passive","factor","centerX","centerY","scale","ox","oy","style","backgroundSize","backgroundPosition","ctx","setTransform","clearRect","renderStroke","type","points","save","font","fillStyle","globalAlpha","globalCompositeOperation","shadowBlur","fillText","restore","cached","get","src","drawImage","imgW","imgH","img","Image","onload","set","lineWidth","setLineDash","shadowColor","beginPath","moveTo","i","lineTo","drawShape","start","end","w","fillRect","strokeRect","roundRect","abs","radius","sqrt","arc","PI","ellipse","closePath","drawArrowHead","shift","ry","fold","mw","mh","fromx","fromy","tox","toy","weight","headlen","angle","atan2","translate","rotate","getMousePos","eraseObjectAt","pos","threshold","some","p","dist","pow","startDrawing","button","_imageFileRef$current","click","textInput","prompt","textStroke","id","Date","now","random","snapCtx","handleMouseMove","cursorData","cancelAnimationFrame","shiftKey","draw","buttons","currentPos","lastPoint","drawingData","prevX","prevY","stopDrawing","newStroke","handleUndo","handleRedo","handleClearBoard","confirm","downloadCanvas","link","download","roomName","href","toDataURL","handleImageUpload","target","files","reader","FileReader","result","maxW","round","imageStroke","readAsDataURL","value","handleSaveBoard","handleNewPage","handleSwitchPage","startScreenShare","getTracks","t","stop","stream","navigator","mediaDevices","getDisplayMedia","video","audio","getVideoTracks","onended","onKey","tagName","metaKey","key","map","toLowerCase","unreadCount","setUnreadCount","className","children","onClick","fileName","_jsxFileName","lineNumber","columnNumber","c","backgroundColor","onChange","parseInt","step","parseFloat","title","clipboard","writeText","location","activeTool","isHost","host","toString","onClear","onUndo","onRedo","onDelete","ref","backgroundImage","cursor","onMouseDown","onMouseMove","onMouseUp","onMouseOut","accept","visible","pageName","Object","values","viewBox","xmlns","d","strokeWidth","el","srcObject","autoPlay","muted","tab","onSendMessage","txt","message","currentUser","disabled","fd","FormData","append","uploadFile","f","_c","$RefreshReg$"],"sources":["D:/CapstoneProject/whiteboard-app/frontend/src/pages/WhiteboardRoom.js"],"sourcesContent":["import React, { useEffect, useRef, useState, useCallback } from \"react\";\r\nimport { useParams, useNavigate } from \"react-router-dom\";\r\nimport { useAuth } from \"../context/AuthContext\";\r\nimport { useSocket } from \"../context/SocketContext\";\r\nimport { roomService } from \"../services/api\";\r\nimport Toolbar from \"../components/Toolbar\";\r\nimport Chat from \"../components/Chat\";\r\nimport StylingPanel from \"../components/StylingPanel\";\r\nimport toast from \"react-hot-toast\";\r\nimport { Plus, Minus, Save, FilePlus, ChevronRight, MessageCircle, Users, X } from \"lucide-react\";\r\n\r\nconst WhiteboardRoom = () => {\r\n    const { roomId } = useParams();\r\n    const navigate = useNavigate();\r\n    const { user } = useAuth();\r\n    const { socket } = useSocket();\r\n\r\n    const canvasRef = useRef(null);\r\n    const viewportRef = useRef(null);\r\n    const contextRef = useRef(null);\r\n\r\n    // Tools & Styling\r\n    const [tool, setTool] = useState(\"pencil\");\r\n    const [showStyling, setShowStyling] = useState(true);\r\n    const [color, setColor] = useState(\"#000000\");\r\n    const [size, setSize] = useState(4);\r\n    const [opacity, setOpacity] = useState(1);\r\n    const [strokeStyle, setStrokeStyle] = useState('solid');\r\n    const [fill, setFill] = useState(false);\r\n\r\n    // Camera / Infinite Canvas\r\n    const [cameraScale, setCameraScale] = useState(1);\r\n    const [cameraOffset, setCameraOffset] = useState({ x: -4000 + window.innerWidth / 2, y: -4000 + window.innerHeight / 2 });\r\n\r\n    const cameraScaleRef = useRef(1);\r\n    const cameraOffsetRef = useRef({ x: -4000 + window.innerWidth / 2, y: -4000 + window.innerHeight / 2 });\r\n    const isPanningRef = useRef(false);\r\n    const panStartRef = useRef({ x: 0, y: 0 });\r\n\r\n    // â”€â”€â”€ STROKE-BASED ARCHITECTURE (Source of Truth) â”€â”€â”€\r\n    const strokesRef = useRef([]);  // Performance ref â€” authoritative source\r\n    const [strokesVersion, setStrokesVersion] = useState(0); // Trigger re-render when needed\r\n\r\n    // Performance Refs for Drawing\r\n    const isDrawingRef = useRef(false);\r\n    const currentPointsRef = useRef([]);\r\n    const startPosRef = useRef({ x: 0, y: 0 });\r\n    const lastPosRef = useRef({ x: 0, y: 0 });\r\n    const snapshotCanvasRef = useRef(null);\r\n    const animationFrameRef = useRef(null);\r\n    const lastCursorEmitRef = useRef(0);\r\n    const imageFileRef = useRef(null);\r\n    const imagePlacePosRef = useRef({ x: 0, y: 0 });\r\n    const imageCache = useRef(new Map());\r\n\r\n    // Undo/Redo history (stroke snapshots)\r\n    const historyRef = useRef([]);\r\n    const historyIndexRef = useRef(-1);\r\n\r\n    // Room State\r\n    const [room, setRoom] = useState(null);\r\n    const [participants, setParticipants] = useState([]);\r\n    const [messages, setMessages] = useState([]);\r\n    const [sharedFiles, setSharedFiles] = useState([]);\r\n    const [activeTab, setActiveTab] = useState(\"chat\");\r\n    const [loadingFileUpload, setLoadingFileUpload] = useState(false);\r\n    const [screenStream, setScreenStream] = useState(null);\r\n    const screenVideoRef = useRef(null);\r\n    const [isSidebarOpen, setIsSidebarOpen] = useState(false); // Hidden by default\r\n    const [remoteCursors, setRemoteCursors] = useState({});\r\n    const [typingUsers, setTypingUsers] = useState([]);\r\n\r\n    // Multi-page state\r\n    const [pages, setPages] = useState([]);\r\n    const [activePageId, setActivePageId] = useState(\"\");\r\n\r\n    const colors = [\r\n        \"#000000\", \"#475569\", \"#dc2626\", \"#ea580c\", \"#d97706\",\r\n        \"#65a30d\", \"#0891b2\", \"#2563eb\", \"#7c3aed\", \"#db2777\"\r\n    ];\r\n\r\n    const isDrawingTool = [\"pencil\", \"highlighter\", \"soft-brush\", \"marker\", \"smooth-pencil\", \"precision-eraser\",\r\n        \"rect\", \"circle\", \"line\", \"arrow\", \"double-arrow\", \"rounded-rect\", \"ellipse\",\r\n        \"triangle\", \"diamond\", \"sticky\", \"speech-bubble\", \"parallelogram\",\r\n        \"cylinder\", \"document\", \"cloud\"\r\n    ].includes(tool);\r\n\r\n    const canvasCursor = {\r\n        select: 'default', pan: 'grab', eraser: 'cell',\r\n        'precision-eraser': 'cell', text: 'text', upload: 'copy',\r\n    }[tool] || 'crosshair';\r\n\r\n    const handleToolChange = (newTool) => {\r\n        if (tool === newTool) { setShowStyling(!showStyling); }\r\n        else { setTool(newTool); setShowStyling(true); }\r\n    };\r\n\r\n    // â”€â”€â”€ STROKE HELPERS â”€â”€â”€\r\n    const setStrokes = useCallback((newStrokes) => {\r\n        if (typeof newStrokes === 'function') {\r\n            strokesRef.current = newStrokes(strokesRef.current);\r\n        } else {\r\n            strokesRef.current = newStrokes;\r\n        }\r\n        setStrokesVersion(v => v + 1);\r\n    }, []);\r\n\r\n    const pushToHistory = useCallback(() => {\r\n        const snapshot = JSON.parse(JSON.stringify(strokesRef.current));\r\n        historyRef.current = historyRef.current.slice(0, historyIndexRef.current + 1);\r\n        historyRef.current.push(snapshot);\r\n        historyIndexRef.current = historyRef.current.length - 1;\r\n    }, []);\r\n\r\n    // â”€â”€â”€ SOCKET SETUP â”€â”€â”€\r\n    useEffect(() => {\r\n        const fetchRoomDetails = async () => {\r\n            try {\r\n                const res = await roomService.getRoom(roomId);\r\n                setRoom(res.data.room);\r\n                setSharedFiles(res.data.room.sharedFiles || []);\r\n            } catch (err) {\r\n                toast.error(\"Failed to load workspace\");\r\n                navigate(\"/dashboard\");\r\n            }\r\n        };\r\n        fetchRoomDetails();\r\n\r\n        if (socket) {\r\n            socket.emit(\"join-room\", { roomId, userId: user._id, userName: user.name });\r\n\r\n            socket.on(\"user-joined\", (data) => toast.success(`${data.userName} joined`));\r\n            socket.on(\"online-users\", (users) => setParticipants(users));\r\n            socket.on(\"chat-message\", (msg) => setMessages((prev) => [...prev, msg]));\r\n            socket.on(\"chat-history\", (h) => setMessages(h));\r\n            socket.on(\"drawing\", (data) => drawRemote(data));\r\n            socket.on(\"erase\", (data) => eraseRemote(data));\r\n\r\n            socket.on(\"board-cleared\", () => {\r\n                strokesRef.current = [];\r\n                historyRef.current = [[]];\r\n                historyIndexRef.current = 0;\r\n                setStrokesVersion(v => v + 1);\r\n                redrawCanvas();\r\n            });\r\n\r\n            // â”€â”€â”€ CANVAS STATE (strokes are the ONLY source of truth) â”€â”€â”€\r\n            socket.on(\"canvas-state\", (data) => {\r\n                if (data) {\r\n                    const loadedStrokes = (data.strokes && data.strokes.length > 0) ? data.strokes : [];\r\n                    strokesRef.current = loadedStrokes;\r\n                    setStrokesVersion(v => v + 1);\r\n\r\n                    historyRef.current = [JSON.parse(JSON.stringify(loadedStrokes))];\r\n                    historyIndexRef.current = 0;\r\n\r\n                    // Pages\r\n                    if (data.pages) setPages(data.pages);\r\n                    if (data.pageId) setActivePageId(data.pageId);\r\n\r\n                    requestAnimationFrame(() => redrawCanvas());\r\n                }\r\n            });\r\n\r\n            socket.on(\"new-stroke\", (stroke) => {\r\n                strokesRef.current = [...strokesRef.current, stroke];\r\n                setStrokesVersion(v => v + 1);\r\n                redrawCanvas();\r\n            });\r\n\r\n            socket.on(\"board-state-updated\", (updatedStrokes) => {\r\n                strokesRef.current = updatedStrokes;\r\n                setStrokesVersion(v => v + 1);\r\n                redrawCanvas();\r\n            });\r\n\r\n            socket.on(\"new-file\", (file) => setSharedFiles(prev => [...prev, file]));\r\n            socket.on(\"user-left\", (data) => toast(`ðŸ‘‹ ${data.userName} left`));\r\n\r\n            socket.on(\"cursor-move\", (data) => {\r\n                setRemoteCursors(prev => ({ ...prev, [data.socketId]: data }));\r\n                setTimeout(() => setRemoteCursors(prev => { const n = { ...prev }; delete n[data.socketId]; return n; }), 3000);\r\n            });\r\n\r\n            // Typing indicators\r\n            socket.on(\"typing-start\", ({ userName, socketId }) => {\r\n                setTypingUsers(prev => {\r\n                    if (prev.find(u => u.socketId === socketId)) return prev;\r\n                    return [...prev, { userName, socketId }];\r\n                });\r\n            });\r\n            socket.on(\"typing-stop\", ({ socketId }) => {\r\n                setTypingUsers(prev => prev.filter(u => u.socketId !== socketId));\r\n            });\r\n\r\n            // Page events\r\n            socket.on(\"page-added\", (data) => {\r\n                setPages(data.pages);\r\n                setActivePageId(data.pageId);\r\n                strokesRef.current = [];\r\n                setStrokesVersion(v => v + 1);\r\n                historyRef.current = [[]];\r\n                historyIndexRef.current = 0;\r\n                redrawCanvas();\r\n            });\r\n\r\n            socket.on(\"page-switched\", (data) => {\r\n                setActivePageId(data.pageId);\r\n                strokesRef.current = data.strokes || [];\r\n                setStrokesVersion(v => v + 1);\r\n                historyRef.current = [JSON.parse(JSON.stringify(data.strokes || []))];\r\n                historyIndexRef.current = 0;\r\n                redrawCanvas();\r\n            });\r\n\r\n            socket.on(\"page-deleted\", (data) => {\r\n                setPages(data.pages);\r\n                if (data.activePageId !== activePageId) {\r\n                    setActivePageId(data.activePageId);\r\n                    strokesRef.current = data.strokes || [];\r\n                    setStrokesVersion(v => v + 1);\r\n                    historyRef.current = [JSON.parse(JSON.stringify(data.strokes || []))];\r\n                    historyIndexRef.current = 0;\r\n                    redrawCanvas();\r\n                }\r\n                toast.success(\"Page deleted\");\r\n            });\r\n\r\n            socket.on(\"board-saved\", ({ pageId }) => {\r\n                toast.success(\"Board saved!\");\r\n            });\r\n\r\n            // Undo/Redo from remote\r\n            socket.on(\"undo\", () => { /* Remote undo handled via board-state-updated */ });\r\n            socket.on(\"redo\", () => { /* Remote redo handled via board-state-updated */ });\r\n        }\r\n\r\n        return () => {\r\n            if (socket) {\r\n                socket.emit(\"leave-room\", { roomId, userId: user._id, userName: user.name });\r\n                [\"user-joined\", \"online-users\", \"chat-message\", \"chat-history\", \"drawing\", \"erase\",\r\n                    \"board-cleared\", \"canvas-state\", \"undo\", \"redo\", \"user-left\", \"new-stroke\",\r\n                    \"board-state-updated\", \"new-file\", \"cursor-move\", \"typing-start\", \"typing-stop\",\r\n                    \"page-added\", \"page-switched\", \"board-saved\"].forEach(ev => socket.off(ev));\r\n            }\r\n        };\r\n    }, [roomId, socket, user, navigate]);\r\n\r\n    // â”€â”€â”€ CANVAS SETUP â”€â”€â”€\r\n    useEffect(() => {\r\n        const viewport = viewportRef.current;\r\n        const canvas = canvasRef.current;\r\n        if (!viewport || !canvas) return;\r\n\r\n        const updateCanvasSize = () => {\r\n            const dpr = window.devicePixelRatio || 1;\r\n            canvas.width = viewport.clientWidth * dpr;\r\n            canvas.height = viewport.clientHeight * dpr;\r\n\r\n            const context = canvas.getContext(\"2d\", { alpha: true });\r\n            if (context) {\r\n                context.lineCap = \"round\";\r\n                context.lineJoin = \"round\";\r\n                contextRef.current = context;\r\n            }\r\n\r\n            if (!snapshotCanvasRef.current) {\r\n                snapshotCanvasRef.current = document.createElement('canvas');\r\n            }\r\n            snapshotCanvasRef.current.width = canvas.width;\r\n            snapshotCanvasRef.current.height = canvas.height;\r\n            redrawCanvas();\r\n        };\r\n\r\n        const ro = new ResizeObserver(() => updateCanvasSize());\r\n        ro.observe(viewport);\r\n        return () => ro.disconnect();\r\n    }, []);\r\n\r\n    // Redraw when strokes change\r\n    useEffect(() => { redrawCanvas(); }, [strokesVersion]);\r\n\r\n    // â”€â”€â”€ ZOOM â”€â”€â”€\r\n    useEffect(() => {\r\n        const handleZoomIn = () => updateZoom(1.1);\r\n        const handleZoomOut = () => updateZoom(1 / 1.1);\r\n        const handleResetZoom = () => {\r\n            cameraScaleRef.current = 1;\r\n            cameraOffsetRef.current = { x: -4000 + window.innerWidth / 2, y: -4000 + window.innerHeight / 2 };\r\n            setCameraScale(1);\r\n            setCameraOffset(cameraOffsetRef.current);\r\n            syncViewDOM();\r\n        };\r\n\r\n        window.addEventListener('wb-zoom-in', handleZoomIn);\r\n        window.addEventListener('wb-zoom-out', handleZoomOut);\r\n        window.addEventListener('wb-reset-view', handleResetZoom);\r\n        return () => {\r\n            window.removeEventListener('wb-zoom-in', handleZoomIn);\r\n            window.removeEventListener('wb-zoom-out', handleZoomOut);\r\n            window.removeEventListener('wb-reset-view', handleResetZoom);\r\n        };\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        const viewport = viewportRef.current;\r\n        if (!viewport) return;\r\n\r\n        const handleWheel = (e) => {\r\n            e.preventDefault();\r\n            if (e.ctrlKey) {\r\n                const zoomSpeed = 0.0012;\r\n                const delta = -e.deltaY * zoomSpeed * cameraScaleRef.current;\r\n                const newScale = Math.max(0.05, Math.min(10, cameraScaleRef.current + delta));\r\n                const rect = viewport.getBoundingClientRect();\r\n                const mouseX = e.clientX - rect.left;\r\n                const mouseY = e.clientY - rect.top;\r\n                const worldX = (mouseX - cameraOffsetRef.current.x) / cameraScaleRef.current;\r\n                const worldY = (mouseY - cameraOffsetRef.current.y) / cameraScaleRef.current;\r\n                cameraScaleRef.current = newScale;\r\n                cameraOffsetRef.current = { x: mouseX - worldX * newScale, y: mouseY - worldY * newScale };\r\n                setCameraScale(newScale);\r\n                setCameraOffset(cameraOffsetRef.current);\r\n                syncViewDOM();\r\n            } else {\r\n                cameraOffsetRef.current = {\r\n                    x: cameraOffsetRef.current.x - e.deltaX,\r\n                    y: cameraOffsetRef.current.y - e.deltaY\r\n                };\r\n                syncViewDOM();\r\n                setCameraOffset(cameraOffsetRef.current);\r\n            }\r\n        };\r\n\r\n        viewport.addEventListener('wheel', handleWheel, { passive: false });\r\n        return () => viewport.removeEventListener('wheel', handleWheel);\r\n    }, []);\r\n\r\n    const updateZoom = (factor) => {\r\n        const newScale = Math.max(0.05, Math.min(10, cameraScaleRef.current * factor));\r\n        const centerX = window.innerWidth / 2;\r\n        const centerY = window.innerHeight / 2;\r\n        const worldX = (centerX - cameraOffsetRef.current.x) / cameraScaleRef.current;\r\n        const worldY = (centerY - cameraOffsetRef.current.y) / cameraScaleRef.current;\r\n        cameraScaleRef.current = newScale;\r\n        cameraOffsetRef.current = { x: centerX - worldX * newScale, y: centerY - worldY * newScale };\r\n        setCameraScale(newScale);\r\n        setCameraOffset(cameraOffsetRef.current);\r\n        syncViewDOM();\r\n    };\r\n\r\n    const syncViewDOM = () => {\r\n        if (viewportRef.current) {\r\n            const scale = cameraScaleRef.current;\r\n            const ox = cameraOffsetRef.current.x;\r\n            const oy = cameraOffsetRef.current.y;\r\n            viewportRef.current.style.backgroundSize = `${24 * scale}px ${24 * scale}px`;\r\n            viewportRef.current.style.backgroundPosition = `${ox}px ${oy}px`;\r\n        }\r\n        redrawCanvas();\r\n    };\r\n\r\n    // â”€â”€â”€ CANVAS RENDERING (Pure stroke-based, no bitmap ghosts) â”€â”€â”€\r\n    const redrawCanvas = useCallback(() => {\r\n        const canvas = canvasRef.current;\r\n        const ctx = contextRef.current;\r\n        if (!canvas || !ctx) return;\r\n\r\n        const dpr = window.devicePixelRatio || 1;\r\n        ctx.setTransform(1, 0, 0, 1, 0, 0);\r\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n\r\n        // Apply Camera Transform\r\n        ctx.setTransform(\r\n            cameraScaleRef.current * dpr, 0,\r\n            0, cameraScaleRef.current * dpr,\r\n            cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr\r\n        );\r\n\r\n        // Render all strokes â€” strokes are the ONLY source of truth\r\n        strokesRef.current.forEach(stroke => renderStroke(ctx, stroke));\r\n    }, []);\r\n\r\n    const renderStroke = (ctx, stroke) => {\r\n        const { type, points, color, size, opacity, strokeStyle, fill } = stroke;\r\n\r\n        if (type === 'text') {\r\n            ctx.save();\r\n            ctx.font = `bold ${size}px Inter, sans-serif`;\r\n            ctx.fillStyle = color;\r\n            ctx.globalAlpha = opacity;\r\n            ctx.globalCompositeOperation = \"source-over\";\r\n            ctx.shadowBlur = 0;\r\n            ctx.fillText(stroke.text || '', points[0].x, points[0].y);\r\n            ctx.restore();\r\n            return;\r\n        }\r\n\r\n        if (type === 'image') {\r\n            const cached = imageCache.current.get(stroke.src);\r\n            if (cached) {\r\n                ctx.save();\r\n                ctx.globalAlpha = stroke.opacity || 1;\r\n                ctx.drawImage(cached, points[0].x, points[0].y, stroke.imgW || 300, stroke.imgH || 200);\r\n                ctx.restore();\r\n            } else {\r\n                const img = new window.Image();\r\n                img.onload = () => { imageCache.current.set(stroke.src, img); redrawCanvas(); };\r\n                img.src = stroke.src;\r\n            }\r\n            return;\r\n        }\r\n\r\n        ctx.save();\r\n\r\n        if (type === 'eraser-precision' || type === 'mask') {\r\n            ctx.globalCompositeOperation = \"destination-out\";\r\n        } else {\r\n            ctx.globalCompositeOperation = \"source-over\";\r\n            ctx.globalAlpha = opacity;\r\n            ctx.strokeStyle = color;\r\n            ctx.fillStyle = color;\r\n            ctx.lineWidth = size;\r\n            ctx.setLineDash(strokeStyle === 'dashed' ? [10, 10] : []);\r\n            if (type === 'soft-brush') { ctx.shadowBlur = size / 2; ctx.shadowColor = color; }\r\n            if (type === 'marker') { ctx.globalAlpha = opacity * 0.6; }\r\n        }\r\n\r\n        if (['pencil', 'highlighter', 'soft-brush', 'marker', 'smooth-pencil', 'eraser-precision'].includes(type)) {\r\n            if (points.length < 2) { ctx.restore(); return; }\r\n            ctx.beginPath();\r\n            ctx.moveTo(points[0].x, points[0].y);\r\n            for (let i = 1; i < points.length; i++) ctx.lineTo(points[i].x, points[i].y);\r\n            ctx.stroke();\r\n        } else {\r\n            drawShape(ctx, type, points, { color, size, opacity, strokeStyle, fill });\r\n        }\r\n        ctx.restore();\r\n    };\r\n\r\n    const drawShape = (ctx, type, points, style) => {\r\n        const start = points[0];\r\n        const end = points[points.length - 1];\r\n        const w = end.x - start.x;\r\n        const h = end.y - start.y;\r\n\r\n        if (type === 'rect') {\r\n            if (style.fill) ctx.fillRect(start.x, start.y, w, h);\r\n            ctx.strokeRect(start.x, start.y, w, h);\r\n        } else if (type === 'rounded-rect') {\r\n            ctx.beginPath();\r\n            ctx.roundRect(start.x, start.y, w, h, Math.min(Math.abs(w), Math.abs(h)) * 0.2);\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'circle' || type === 'ellipse') {\r\n            ctx.beginPath();\r\n            if (type === 'circle') {\r\n                const radius = Math.sqrt(w * w + h * h);\r\n                ctx.arc(start.x, start.y, radius, 0, 2 * Math.PI);\r\n            } else {\r\n                ctx.ellipse(start.x + w / 2, start.y + h / 2, Math.abs(w / 2), Math.abs(h / 2), 0, 0, 2 * Math.PI);\r\n            }\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'triangle') {\r\n            ctx.beginPath();\r\n            ctx.moveTo(start.x + w / 2, start.y);\r\n            ctx.lineTo(end.x, end.y);\r\n            ctx.lineTo(start.x, end.y);\r\n            ctx.closePath();\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'diamond') {\r\n            ctx.beginPath();\r\n            ctx.moveTo(start.x + w / 2, start.y);\r\n            ctx.lineTo(end.x, start.y + h / 2);\r\n            ctx.lineTo(start.x + w / 2, end.y);\r\n            ctx.lineTo(start.x, start.y + h / 2);\r\n            ctx.closePath();\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'line' || type === 'arrow' || type === 'double-arrow') {\r\n            ctx.beginPath();\r\n            ctx.moveTo(start.x, start.y);\r\n            ctx.lineTo(end.x, end.y);\r\n            ctx.stroke();\r\n            if (type === 'arrow' || type === 'double-arrow') drawArrowHead(ctx, start.x, start.y, end.x, end.y, style.size);\r\n            if (type === 'double-arrow') drawArrowHead(ctx, end.x, end.y, start.x, start.y, style.size);\r\n        } else if (type === 'sticky') {\r\n            ctx.save();\r\n            ctx.fillStyle = style.fill ? style.color : \"#fef08a\";\r\n            ctx.shadowBlur = 10;\r\n            ctx.shadowColor = \"rgba(0,0,0,0.1)\";\r\n            ctx.fillRect(start.x, start.y, w, h);\r\n            ctx.strokeStyle = \"rgba(0,0,0,0.05)\";\r\n            ctx.strokeRect(start.x, start.y, w, h);\r\n            ctx.restore();\r\n        } else if (type === 'speech-bubble') {\r\n            ctx.beginPath();\r\n            ctx.roundRect(start.x, start.y, w, h * 0.8, 10);\r\n            ctx.moveTo(start.x + w * 0.2, start.y + h * 0.8);\r\n            ctx.lineTo(start.x + w * 0.1, end.y);\r\n            ctx.lineTo(start.x + w * 0.4, start.y + h * 0.8);\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'parallelogram') {\r\n            const shift = w * 0.2;\r\n            ctx.beginPath();\r\n            ctx.moveTo(start.x + shift, start.y);\r\n            ctx.lineTo(end.x, start.y);\r\n            ctx.lineTo(end.x - shift, end.y);\r\n            ctx.lineTo(start.x, end.y);\r\n            ctx.closePath();\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'cylinder') {\r\n            const ry = Math.abs(h * 0.1);\r\n            ctx.beginPath();\r\n            ctx.ellipse(start.x + w / 2, end.y - ry, Math.abs(w / 2), ry, 0, 0, Math.PI, false);\r\n            ctx.stroke();\r\n            ctx.beginPath();\r\n            ctx.moveTo(start.x, start.y + ry);\r\n            ctx.lineTo(start.x, end.y - ry);\r\n            ctx.moveTo(end.x, start.y + ry);\r\n            ctx.lineTo(end.x, end.y - ry);\r\n            ctx.stroke();\r\n            ctx.beginPath();\r\n            ctx.ellipse(start.x + w / 2, start.y + ry, Math.abs(w / 2), ry, 0, 0, 2 * Math.PI);\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'document') {\r\n            const fold = Math.min(w, h) * 0.2;\r\n            ctx.beginPath();\r\n            ctx.moveTo(start.x, start.y);\r\n            ctx.lineTo(end.x - fold, start.y);\r\n            ctx.lineTo(end.x, start.y + fold);\r\n            ctx.lineTo(end.x, end.y);\r\n            ctx.lineTo(start.x, end.y);\r\n            ctx.closePath();\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n            ctx.beginPath();\r\n            ctx.moveTo(end.x - fold, start.y);\r\n            ctx.lineTo(end.x - fold, start.y + fold);\r\n            ctx.lineTo(end.x, start.y + fold);\r\n            ctx.stroke();\r\n        } else if (type === 'cloud') {\r\n            ctx.beginPath();\r\n            const mw = start.x + w / 2;\r\n            const mh = start.y + h / 2;\r\n            ctx.arc(mw - w * 0.2, mh, Math.abs(h * 0.3), 0, 2 * Math.PI);\r\n            ctx.arc(mw + w * 0.2, mh, Math.abs(h * 0.3), 0, 2 * Math.PI);\r\n            ctx.arc(mw, mh - h * 0.2, Math.abs(h * 0.3), 0, 2 * Math.PI);\r\n            ctx.arc(mw, mh + h * 0.2, Math.abs(h * 0.3), 0, 2 * Math.PI);\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        }\r\n    };\r\n\r\n    const drawArrowHead = (ctx, fromx, fromy, tox, toy, weight) => {\r\n        const headlen = weight * 4;\r\n        const angle = Math.atan2(toy - fromy, tox - fromx);\r\n        ctx.save();\r\n        ctx.translate(tox, toy);\r\n        ctx.rotate(angle);\r\n        ctx.beginPath();\r\n        ctx.moveTo(0, 0);\r\n        ctx.lineTo(-headlen, -headlen / 2);\r\n        ctx.lineTo(-headlen, headlen / 2);\r\n        ctx.closePath();\r\n        ctx.fill();\r\n        ctx.restore();\r\n    };\r\n\r\n    const getMousePos = (e) => {\r\n        const viewport = viewportRef.current;\r\n        if (!viewport) return { x: 0, y: 0 };\r\n        const rect = viewport.getBoundingClientRect();\r\n        return {\r\n            x: (e.clientX - rect.left - cameraOffsetRef.current.x) / cameraScaleRef.current,\r\n            y: (e.clientY - rect.top - cameraOffsetRef.current.y) / cameraScaleRef.current\r\n        };\r\n    };\r\n\r\n    // â”€â”€â”€ ERASER: Stroke removal (no ghost rendering) â”€â”€â”€\r\n    const eraseObjectAt = (pos) => {\r\n        const threshold = 15;\r\n        const newStrokes = strokesRef.current.filter(stroke => {\r\n            return !stroke.points.some(p => {\r\n                const dist = Math.sqrt(Math.pow(p.x - pos.x, 2) + Math.pow(p.y - pos.y, 2));\r\n                return dist < threshold;\r\n            });\r\n        });\r\n\r\n        if (newStrokes.length !== strokesRef.current.length) {\r\n            strokesRef.current = newStrokes;\r\n            setStrokesVersion(v => v + 1);\r\n            redrawCanvas();\r\n            // Sync erased state to all clients and DB\r\n            socket.emit(\"update-board-state\", { roomId, strokes: newStrokes, pageId: activePageId });\r\n        }\r\n    };\r\n\r\n    // â”€â”€â”€ DRAWING â”€â”€â”€\r\n    const startDrawing = (e) => {\r\n        if (e.button === 1 || tool === 'pan') {\r\n            isPanningRef.current = true;\r\n            panStartRef.current = { x: e.clientX - cameraOffsetRef.current.x, y: e.clientY - cameraOffsetRef.current.y };\r\n            return;\r\n        }\r\n\r\n        const canvas = canvasRef.current;\r\n        if (!canvas || !contextRef.current) return;\r\n        const pos = getMousePos(e);\r\n\r\n        if (tool === 'select') return;\r\n\r\n        if (tool === 'upload') {\r\n            imagePlacePosRef.current = pos;\r\n            imageFileRef.current?.click();\r\n            return;\r\n        }\r\n\r\n        if (tool === 'eraser') {\r\n            eraseObjectAt(pos);\r\n            return;\r\n        }\r\n\r\n        if (tool === 'text') {\r\n            const textInput = prompt('Enter text:');\r\n            if (!textInput) return;\r\n            const textStroke = {\r\n                id: Date.now() + Math.random(), type: 'text', text: textInput,\r\n                points: [pos], color, size: size * 4, opacity, strokeStyle, fill\r\n            };\r\n            strokesRef.current = [...strokesRef.current, textStroke];\r\n            setStrokesVersion(v => v + 1);\r\n            pushToHistory();\r\n            socket.emit('new-stroke', { roomId, stroke: textStroke, pageId: activePageId });\r\n            redrawCanvas();\r\n            return;\r\n        }\r\n\r\n        isDrawingRef.current = true;\r\n        currentPointsRef.current = [pos];\r\n        startPosRef.current = pos;\r\n        lastPosRef.current = pos;\r\n\r\n        // Take snapshot for shape preview\r\n        const snapCtx = snapshotCanvasRef.current.getContext('2d');\r\n        snapCtx.setTransform(1, 0, 0, 1, 0, 0);\r\n        snapCtx.clearRect(0, 0, canvas.width, canvas.height);\r\n        snapCtx.drawImage(canvas, 0, 0);\r\n\r\n        if (isDrawingTool) {\r\n            const ctx = contextRef.current;\r\n            const dpr = window.devicePixelRatio || 1;\r\n            ctx.setTransform(\r\n                cameraScaleRef.current * dpr, 0,\r\n                0, cameraScaleRef.current * dpr,\r\n                cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr\r\n            );\r\n            ctx.beginPath();\r\n            ctx.moveTo(pos.x, pos.y);\r\n            ctx.lineWidth = size;\r\n            ctx.strokeStyle = color;\r\n            ctx.globalAlpha = tool === \"highlighter\" ? (opacity * 0.4) :\r\n                tool === \"marker\" ? (opacity * 0.6) : opacity;\r\n            ctx.setLineDash(strokeStyle === 'dashed' ? [10, 10] : []);\r\n            ctx.lineCap = \"round\";\r\n            ctx.lineJoin = \"round\";\r\n            ctx.globalCompositeOperation = (tool === \"precision-eraser\") ? \"destination-out\" : \"source-over\";\r\n            ctx.shadowBlur = 0;\r\n        }\r\n    };\r\n\r\n    const handleMouseMove = (e) => {\r\n        const now = Date.now();\r\n        if (socket && now - lastCursorEmitRef.current > 50) {\r\n            lastCursorEmitRef.current = now;\r\n            socket.emit('cursor-move', { roomId, cursorData: { x: e.clientX, y: e.clientY, userName: user.name, color } });\r\n        }\r\n\r\n        if (isPanningRef.current) {\r\n            cameraOffsetRef.current = {\r\n                x: e.clientX - panStartRef.current.x,\r\n                y: e.clientY - panStartRef.current.y\r\n            };\r\n            syncViewDOM();\r\n            return;\r\n        }\r\n\r\n        if (isDrawingRef.current) {\r\n            if (animationFrameRef.current) cancelAnimationFrame(animationFrameRef.current);\r\n            const clientX = e.clientX;\r\n            const clientY = e.clientY;\r\n            const shiftKey = e.shiftKey;\r\n            animationFrameRef.current = requestAnimationFrame(() => draw({ clientX, clientY, shiftKey }));\r\n        } else if (tool === 'eraser' && e.buttons === 1) {\r\n            eraseObjectAt(getMousePos(e));\r\n        }\r\n    };\r\n\r\n    const draw = (e) => {\r\n        if (!isDrawingRef.current || !contextRef.current) return;\r\n        const pos = getMousePos(e);\r\n        let currentPos = pos;\r\n\r\n        if (tool === 'smooth-pencil' && currentPointsRef.current.length > 0) {\r\n            const lastPoint = currentPointsRef.current[currentPointsRef.current.length - 1];\r\n            currentPos = {\r\n                x: lastPoint.x * 0.8 + pos.x * 0.2,\r\n                y: lastPoint.y * 0.8 + pos.y * 0.2,\r\n                shiftKey: e.shiftKey\r\n            };\r\n        } else {\r\n            currentPos = { ...pos, shiftKey: e.shiftKey };\r\n        }\r\n\r\n        currentPointsRef.current.push(currentPos);\r\n        const ctx = contextRef.current;\r\n\r\n        if ([\"pencil\", \"highlighter\", \"soft-brush\", \"marker\", \"smooth-pencil\", \"precision-eraser\"].includes(tool)) {\r\n            if (e.shiftKey) {\r\n                redrawCanvas();\r\n                ctx.beginPath();\r\n                ctx.moveTo(startPosRef.current.x, startPosRef.current.y);\r\n                ctx.lineTo(currentPos.x, currentPos.y);\r\n                ctx.stroke();\r\n                return;\r\n            }\r\n            ctx.lineTo(currentPos.x, currentPos.y);\r\n            ctx.stroke();\r\n\r\n            // Throttled emit for real-time collab\r\n            socket.emit(\"drawing\", {\r\n                roomId,\r\n                drawingData: {\r\n                    x: currentPos.x, y: currentPos.y,\r\n                    prevX: lastPosRef.current.x, prevY: lastPosRef.current.y,\r\n                    color, size, opacity: ctx.globalAlpha, tool\r\n                }\r\n            });\r\n            lastPosRef.current = currentPos;\r\n        } else if ([\"rect\", \"circle\", \"line\", \"arrow\", \"double-arrow\", \"rounded-rect\", \"ellipse\", \"triangle\", \"diamond\", \"sticky\", \"speech-bubble\", \"parallelogram\", \"cylinder\", \"document\", \"cloud\"].includes(tool)) {\r\n            const dpr = window.devicePixelRatio || 1;\r\n            ctx.setTransform(1, 0, 0, 1, 0, 0);\r\n            ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);\r\n            ctx.drawImage(snapshotCanvasRef.current, 0, 0);\r\n            ctx.setTransform(\r\n                cameraScaleRef.current * dpr, 0,\r\n                0, cameraScaleRef.current * dpr,\r\n                cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr\r\n            );\r\n            drawShape(ctx, tool, [startPosRef.current, currentPos], { color, size, opacity, strokeStyle, fill });\r\n        }\r\n    };\r\n\r\n    const stopDrawing = () => {\r\n        if (isPanningRef.current) {\r\n            isPanningRef.current = false;\r\n            setCameraOffset(cameraOffsetRef.current);\r\n            return;\r\n        }\r\n\r\n        const canvas = canvasRef.current;\r\n        if (!isDrawingRef.current || !canvas) return;\r\n        if (animationFrameRef.current) cancelAnimationFrame(animationFrameRef.current);\r\n\r\n        isDrawingRef.current = false;\r\n        let points = [...currentPointsRef.current];\r\n\r\n        if ([\"pencil\", \"highlighter\", \"soft-brush\", \"marker\", \"smooth-pencil\"].includes(tool) && points.length > 1 && points[points.length - 1].shiftKey) {\r\n            points = [points[0], points[points.length - 1]];\r\n        }\r\n\r\n        const newStroke = {\r\n            id: Date.now() + Math.random(),\r\n            type: tool === 'precision-eraser' ? 'eraser-precision' : tool,\r\n            points,\r\n            color,\r\n            size: tool === 'precision-eraser' ? 10 : size,\r\n            opacity: tool === 'highlighter' ? 0.4 : tool === 'marker' ? 0.6 : opacity,\r\n            strokeStyle,\r\n            fill\r\n        };\r\n\r\n        if (tool !== 'eraser') {\r\n            strokesRef.current = [...strokesRef.current, newStroke];\r\n            setStrokesVersion(v => v + 1);\r\n            pushToHistory();\r\n            socket.emit(\"new-stroke\", { roomId, stroke: newStroke, pageId: activePageId });\r\n        }\r\n\r\n        currentPointsRef.current = [];\r\n        // NO bitmap save â€” strokes are the source of truth\r\n    };\r\n\r\n    // â”€â”€â”€ UNDO / REDO (stroke-based) â”€â”€â”€\r\n    const handleUndo = () => {\r\n        if (historyIndexRef.current > 0) {\r\n            historyIndexRef.current -= 1;\r\n            const snapshot = historyRef.current[historyIndexRef.current];\r\n            strokesRef.current = JSON.parse(JSON.stringify(snapshot));\r\n            setStrokesVersion(v => v + 1);\r\n            redrawCanvas();\r\n            socket.emit(\"update-board-state\", { roomId, strokes: strokesRef.current, pageId: activePageId });\r\n        }\r\n    };\r\n\r\n    const handleRedo = () => {\r\n        if (historyIndexRef.current < historyRef.current.length - 1) {\r\n            historyIndexRef.current += 1;\r\n            const snapshot = historyRef.current[historyIndexRef.current];\r\n            strokesRef.current = JSON.parse(JSON.stringify(snapshot));\r\n            setStrokesVersion(v => v + 1);\r\n            redrawCanvas();\r\n            socket.emit(\"update-board-state\", { roomId, strokes: strokesRef.current, pageId: activePageId });\r\n        }\r\n    };\r\n\r\n    const drawRemote = (data) => {\r\n        const { x, y, prevX, prevY, color, size, opacity, tool } = data;\r\n        const ctx = contextRef.current;\r\n        if (!ctx) return;\r\n        const dpr = window.devicePixelRatio || 1;\r\n        ctx.save();\r\n        ctx.setTransform(\r\n            cameraScaleRef.current * dpr, 0,\r\n            0, cameraScaleRef.current * dpr,\r\n            cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr\r\n        );\r\n        ctx.globalAlpha = opacity || 1;\r\n        ctx.strokeStyle = color;\r\n        ctx.lineWidth = size;\r\n        ctx.lineCap = \"round\";\r\n        ctx.lineJoin = \"round\";\r\n        ctx.globalCompositeOperation = (tool === \"precision-eraser\") ? \"destination-out\" : \"source-over\";\r\n        ctx.beginPath();\r\n        if (prevX && prevY) ctx.moveTo(prevX, prevY);\r\n        else ctx.moveTo(x, y);\r\n        ctx.lineTo(x, y);\r\n        ctx.stroke();\r\n        ctx.restore();\r\n    };\r\n\r\n    const eraseRemote = (data) => {\r\n        // Remote erase is now handled via board-state-updated\r\n    };\r\n\r\n    const handleClearBoard = () => {\r\n        if (window.confirm('Clear all drawings for everyone?'))\r\n            socket.emit('clear-board', { roomId, userId: user._id, pageId: activePageId });\r\n    };\r\n\r\n    const downloadCanvas = () => {\r\n        const canvas = canvasRef.current;\r\n        if (!canvas) return;\r\n        const link = document.createElement('a');\r\n        link.download = `${room?.roomName || 'whiteboard'}-${Date.now()}.png`;\r\n        link.href = canvas.toDataURL('image/png');\r\n        link.click();\r\n        toast.success('Board exported as PNG!');\r\n    };\r\n\r\n    const handleImageUpload = (e) => {\r\n        const file = e.target.files[0];\r\n        if (!file) return;\r\n        const reader = new FileReader();\r\n        reader.onload = (ev) => {\r\n            const src = ev.target.result;\r\n            const img = new window.Image();\r\n            img.onload = () => {\r\n                const maxW = 400;\r\n                const scale = Math.min(1, maxW / img.width);\r\n                const imgW = Math.round(img.width * scale);\r\n                const imgH = Math.round(img.height * scale);\r\n                const pos = imagePlacePosRef.current;\r\n                imageCache.current.set(src, img);\r\n                const imageStroke = {\r\n                    id: Date.now() + Math.random(),\r\n                    type: 'image', src,\r\n                    points: [pos], imgW, imgH,\r\n                    color, size, opacity, strokeStyle, fill\r\n                };\r\n                strokesRef.current = [...strokesRef.current, imageStroke];\r\n                setStrokesVersion(v => v + 1);\r\n                pushToHistory();\r\n                if (socket) socket.emit('new-stroke', { roomId, stroke: imageStroke, pageId: activePageId });\r\n                redrawCanvas();\r\n            };\r\n            img.src = src;\r\n        };\r\n        reader.readAsDataURL(file);\r\n        e.target.value = '';\r\n    };\r\n\r\n    // â”€â”€â”€ PAGE MANAGEMENT â”€â”€â”€\r\n    const handleSaveBoard = () => {\r\n        socket.emit(\"save-board\", { roomId, pageId: activePageId });\r\n    };\r\n\r\n    const handleNewPage = () => {\r\n        socket.emit(\"new-page\", { roomId, userId: user._id });\r\n    };\r\n\r\n    const handleSwitchPage = (pageId) => {\r\n        if (pageId === activePageId) return;\r\n        socket.emit(\"switch-page\", { roomId, pageId });\r\n    };\r\n\r\n    // â”€â”€â”€ SCREEN SHARING â”€â”€â”€\r\n    const startScreenShare = async () => {\r\n        try {\r\n            if (screenStream) {\r\n                screenStream.getTracks().forEach(t => t.stop());\r\n                setScreenStream(null);\r\n                socket.emit('screen-share-stopped', { roomId });\r\n                toast('Screen sharing stopped');\r\n                return;\r\n            }\r\n            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });\r\n            setScreenStream(stream);\r\n            socket.emit('screen-share-started', { roomId, userId: user._id, userName: user.name });\r\n            stream.getVideoTracks()[0].onended = () => {\r\n                setScreenStream(null);\r\n                socket.emit('screen-share-stopped', { roomId });\r\n                toast('Screen sharing stopped');\r\n            };\r\n            toast.success('Screen sharing started!');\r\n        } catch (err) {\r\n            if (err.name !== 'NotAllowedError') toast.error('Screen sharing failed');\r\n        }\r\n    };\r\n\r\n    // â”€â”€â”€ KEYBOARD SHORTCUTS â”€â”€â”€\r\n    React.useEffect(() => {\r\n        const onKey = (e) => {\r\n            if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;\r\n            if (e.ctrlKey || e.metaKey) {\r\n                if (e.key === 'z') { e.preventDefault(); handleUndo(); }\r\n                if (e.key === 'y') { e.preventDefault(); handleRedo(); }\r\n                return;\r\n            }\r\n            const map = { v: 'select', h: 'pan', p: 'pencil', e: 'eraser', t: 'text' };\r\n            if (map[e.key.toLowerCase()]) setTool(map[e.key.toLowerCase()]);\r\n        };\r\n        window.addEventListener('keydown', onKey);\r\n        return () => window.removeEventListener('keydown', onKey);\r\n    }, []);\r\n\r\n    // Unread messages badge\r\n    const [unreadCount, setUnreadCount] = useState(0);\r\n    useEffect(() => {\r\n        if (!isSidebarOpen && messages.length > 0) {\r\n            setUnreadCount(prev => prev + 1);\r\n        }\r\n    }, [messages.length]);\r\n    useEffect(() => {\r\n        if (isSidebarOpen) setUnreadCount(0);\r\n    }, [isSidebarOpen]);\r\n\r\n    return (\r\n        <div className=\"wb-layout-container\" data-sidebar={isSidebarOpen ? \"open\" : \"closed\"}>\r\n            {/* Header */}\r\n            <header className=\"wb-header-modern\">\r\n                <div className=\"wb-header-left\">\r\n                    <div className=\"wb-logo\" onClick={() => navigate('/dashboard')}>\r\n                        <span>S</span>\r\n                    </div>\r\n                    <div className=\"wb-header-info\">\r\n                        <h1>{room?.roomName || 'Untitled Board'}</h1>\r\n                        <span className=\"wb-header-status\">\r\n                            <span className=\"wb-status-dot\"></span>\r\n                            {participants.length} online\r\n                        </span>\r\n                    </div>\r\n\r\n                    <div className=\"wb-header-divider\"></div>\r\n\r\n                    {/* Navbar Styling Controls */}\r\n                    {isDrawingTool && (\r\n                        <div className=\"wb-toolbar-controls\">\r\n                            <div className=\"wb-color-grid\">\r\n                                {colors.map(c => (\r\n                                    <button\r\n                                        key={c}\r\n                                        onClick={() => setColor(c)}\r\n                                        className={`wb-color-btn ${color === c ? 'active' : ''}`}\r\n                                        style={{ backgroundColor: c }}\r\n                                    />\r\n                                ))}\r\n                            </div>\r\n                            <div className=\"wb-header-divider\"></div>\r\n                            <div className=\"wb-slider-group\">\r\n                                <span className=\"wb-slider-label\">Size</span>\r\n                                <input type=\"range\" min=\"1\" max=\"40\" value={size}\r\n                                    onChange={(e) => setSize(parseInt(e.target.value))}\r\n                                    className=\"wb-slider\" />\r\n                                <span className=\"wb-slider-value\">{size}</span>\r\n                            </div>\r\n                            <div className=\"wb-header-divider\"></div>\r\n                            <div className=\"wb-slider-group\">\r\n                                <span className=\"wb-slider-label\">Opacity</span>\r\n                                <input type=\"range\" min=\"0.1\" max=\"1\" step=\"0.1\" value={opacity}\r\n                                    onChange={(e) => setOpacity(parseFloat(e.target.value))}\r\n                                    className=\"wb-slider\" />\r\n                                <span className=\"wb-slider-value\">{Math.round(opacity * 100)}%</span>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"wb-header-right\">\r\n                    {/* Save & New Page */}\r\n                    <button className=\"wb-btn-icon\" onClick={handleSaveBoard} title=\"Save Board\">\r\n                        <Save size={16} />\r\n                    </button>\r\n                    <button className=\"wb-btn-icon\" onClick={handleNewPage} title=\"New Page\">\r\n                        <FilePlus size={16} />\r\n                    </button>\r\n\r\n                    <div className=\"wb-header-divider\"></div>\r\n\r\n                    <button className=\"wb-btn-secondary\" onClick={downloadCanvas}>Export</button>\r\n                    <button className=\"wb-btn-secondary\" onClick={() => {\r\n                        navigator.clipboard.writeText(window.location.href);\r\n                        toast.success('Link copied!');\r\n                    }}>Invite</button>\r\n                    <button\r\n                        className={`wb-btn-primary ${screenStream ? 'wb-btn-danger' : ''}`}\r\n                        onClick={startScreenShare}\r\n                    >\r\n                        {screenStream ? 'Stop Share' : 'Share Screen'}\r\n                    </button>\r\n\r\n                    <div className=\"wb-header-divider\"></div>\r\n\r\n                    {/* Chat Toggle */}\r\n                    <button\r\n                        className={`wb-btn-chat ${isSidebarOpen ? 'active' : ''}`}\r\n                        onClick={() => setIsSidebarOpen(!isSidebarOpen)}\r\n                    >\r\n                        <MessageCircle size={18} />\r\n                        {unreadCount > 0 && !isSidebarOpen && (\r\n                            <span className=\"wb-badge\">{unreadCount > 9 ? '9+' : unreadCount}</span>\r\n                        )}\r\n                    </button>\r\n                </div>\r\n            </header>\r\n\r\n            {/* Left Sidebar */}\r\n            <aside className=\"wb-left-panel\">\r\n                <Toolbar\r\n                    activeTool={tool}\r\n                    setTool={handleToolChange}\r\n                    isHost={room?.host?.toString() === user._id || room?.host?._id === user._id}\r\n                    onClear={handleClearBoard}\r\n                    onUndo={handleUndo}\r\n                    onRedo={handleRedo}\r\n                    onDelete={() => { }}\r\n                />\r\n            </aside>\r\n\r\n            {/* Canvas Viewport */}\r\n            <main\r\n                ref={viewportRef}\r\n                className=\"wb-viewport\"\r\n                style={{\r\n                    backgroundImage: 'radial-gradient(#e2e8f0 1px, transparent 1px)',\r\n                    backgroundSize: `${24 * cameraScale}px ${24 * cameraScale}px`,\r\n                    backgroundPosition: `${cameraOffset.x}px ${cameraOffset.y}px`\r\n                }}\r\n            >\r\n                <canvas\r\n                    ref={canvasRef}\r\n                    className=\"wb-canvas\"\r\n                    style={{ cursor: canvasCursor }}\r\n                    onMouseDown={startDrawing}\r\n                    onMouseMove={handleMouseMove}\r\n                    onMouseUp={stopDrawing}\r\n                    onMouseOut={stopDrawing}\r\n                />\r\n\r\n                <input type=\"file\" accept=\"image/*\" className=\"hidden\" ref={imageFileRef} onChange={handleImageUpload} />\r\n                <StylingPanel tool={tool} visible={showStyling} strokeStyle={strokeStyle} setStrokeStyle={setStrokeStyle} fill={fill} setFill={setFill} />\r\n\r\n                {/* Page Tabs */}\r\n                {pages.length > 0 && (\r\n                    <div className=\"wb-page-tabs\">\r\n                        {pages.map((p) => (\r\n                            <button\r\n                                key={p.pageId}\r\n                                className={`wb-page-tab ${p.pageId === activePageId ? 'active' : ''}`}\r\n                                onClick={() => handleSwitchPage(p.pageId)}\r\n                            >\r\n                                {p.pageName}\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n\r\n                {/* Zoom Controls */}\r\n                <div className=\"wb-zoom-controls\">\r\n                    <button\r\n                        onClick={() => {\r\n                            cameraScaleRef.current = 1;\r\n                            cameraOffsetRef.current = { x: -4000 + window.innerWidth / 2, y: -4000 + window.innerHeight / 2 };\r\n                            setCameraScale(1); setCameraOffset(cameraOffsetRef.current); syncViewDOM();\r\n                        }}\r\n                        className=\"wb-zoom-btn wb-zoom-label\"\r\n                    >\r\n                        {Math.round(cameraScale * 100)}%\r\n                    </button>\r\n                    <div className=\"wb-zoom-divider\"></div>\r\n                    <button onClick={() => updateZoom(1.1)} className=\"wb-zoom-btn\"><Plus size={14} /></button>\r\n                    <button onClick={() => updateZoom(1 / 1.1)} className=\"wb-zoom-btn\"><Minus size={14} /></button>\r\n                </div>\r\n\r\n                {/* Remote Cursors */}\r\n                {Object.values(remoteCursors).map(cursor => (\r\n                    <div\r\n                        key={cursor.socketId}\r\n                        className=\"wb-remote-cursor\"\r\n                        style={{ left: cursor.x, top: cursor.y }}\r\n                    >\r\n                        <svg width=\"12\" height=\"16\" viewBox=\"0 0 12 16\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                            <path d=\"M0 0 L0 14 L4 10 L6.5 14.5 L8 13.5 L5.5 9 L10 9 Z\"\r\n                                fill={cursor.color || '#06b6d4'} stroke=\"white\" strokeWidth=\"1\" />\r\n                        </svg>\r\n                        <span className=\"wb-cursor-label\" style={{ backgroundColor: cursor.color || '#06b6d4' }}>\r\n                            {cursor.userName}\r\n                        </span>\r\n                    </div>\r\n                ))}\r\n\r\n                {/* Screen Share Preview */}\r\n                {screenStream && (\r\n                    <div className=\"wb-screen-preview\">\r\n                        <video\r\n                            ref={el => { if (el) el.srcObject = screenStream; }}\r\n                            autoPlay muted\r\n                            className=\"wb-screen-video\"\r\n                        />\r\n                    </div>\r\n                )}\r\n            </main>\r\n\r\n            {/* Right Sidebar (Chat) â€” slides in/out */}\r\n            <aside className={`wb-right-panel ${isSidebarOpen ? 'open' : ''}`}>\r\n                <div className=\"wb-sidebar-inner\">\r\n                    <div className=\"wb-sidebar-header\">\r\n                        <div className=\"wb-sidebar-tabs\">\r\n                            {['chat', 'files', 'users'].map((tab) => (\r\n                                <button\r\n                                    key={tab}\r\n                                    onClick={() => setActiveTab(tab)}\r\n                                    className={`wb-sidebar-tab ${activeTab === tab ? \"active\" : \"\"}`}\r\n                                >\r\n                                    {tab === 'chat' && <MessageCircle size={13} />}\r\n                                    {tab === 'users' && <Users size={13} />}\r\n                                    {tab}\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n                        <button className=\"wb-sidebar-close\" onClick={() => setIsSidebarOpen(false)}>\r\n                            <X size={16} />\r\n                        </button>\r\n                    </div>\r\n                    <div className=\"wb-sidebar-content\">\r\n                        {activeTab === \"chat\" ? (\r\n                            <Chat\r\n                                messages={messages}\r\n                                onSendMessage={(txt) => socket.emit(\"chat-message\", { roomId, message: txt, userId: user._id, userName: user.name })}\r\n                                currentUser={user}\r\n                                socket={socket}\r\n                                roomId={roomId}\r\n                                typingUsers={typingUsers}\r\n                                participants={participants}\r\n                            />\r\n                        ) : activeTab === \"files\" ? (\r\n                            <div className=\"wb-files-panel\">\r\n                                <label className={`wb-file-upload-btn ${loadingFileUpload ? 'disabled' : ''}`}>\r\n                                    <span>{loadingFileUpload ? 'Uploading...' : 'ðŸ“Ž Share Asset'}</span>\r\n                                    <input\r\n                                        type=\"file\" className=\"hidden\" disabled={loadingFileUpload}\r\n                                        onChange={async (e) => {\r\n                                            const file = e.target.files[0];\r\n                                            if (!file) return;\r\n                                            setLoadingFileUpload(true);\r\n                                            try {\r\n                                                const fd = new FormData();\r\n                                                fd.append('file', file);\r\n                                                const res = await roomService.uploadFile(roomId, fd);\r\n                                                setSharedFiles(prev => [...prev, res.data.file]);\r\n                                                socket.emit('file-shared', { roomId, file: res.data.file });\r\n                                                toast.success(`${file.name} shared!`);\r\n                                            } catch { toast.error('Upload failed'); }\r\n                                            finally { setLoadingFileUpload(false); e.target.value = ''; }\r\n                                        }}\r\n                                    />\r\n                                </label>\r\n                                <div className=\"wb-files-list\">\r\n                                    {sharedFiles.map((f, i) => (\r\n                                        <div key={i} className=\"wb-file-item\">\r\n                                            <span>{f.fileName}</span>\r\n                                            <span>â¬‡ï¸</span>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"wb-users-panel\">\r\n                                <div className=\"wb-users-count\">{participants.length} Online</div>\r\n                                {participants.map((p, i) => (\r\n                                    <div key={i} className=\"wb-user-item\">\r\n                                        <div className=\"wb-user-avatar\">{p.userName[0]}</div>\r\n                                        <span className=\"wb-user-name\">{p.userName}</span>\r\n                                        <div className=\"wb-user-status\"></div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </aside>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default WhiteboardRoom;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}