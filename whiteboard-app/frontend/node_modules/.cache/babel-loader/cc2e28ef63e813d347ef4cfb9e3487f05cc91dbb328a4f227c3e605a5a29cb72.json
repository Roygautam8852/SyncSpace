{"ast":null,"code":"var _jsxFileName = \"D:\\\\CapstoneProject\\\\whiteboard-app\\\\frontend\\\\src\\\\pages\\\\WhiteboardRoom.js\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useRef, useState } from \"react\";\nimport { useParams, useNavigate } from \"react-router-dom\";\nimport { useAuth } from \"../context/AuthContext\";\nimport { useSocket } from \"../context/SocketContext\";\nimport { roomService } from \"../services/api\";\nimport Toolbar from \"../components/Toolbar\";\nimport Chat from \"../components/Chat\";\nimport StylingPanel from \"../components/StylingPanel\";\nimport toast from \"react-hot-toast\";\nimport { Plus, Minus } from \"lucide-react\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst WhiteboardRoom = () => {\n  _s();\n  var _room$host, _room$host2;\n  const {\n    roomId\n  } = useParams();\n  const navigate = useNavigate();\n  const {\n    user\n  } = useAuth();\n  const {\n    socket\n  } = useSocket();\n  const canvasRef = useRef(null);\n  const viewportRef = useRef(null);\n  const contextRef = useRef(null);\n\n  // Tools & Styling\n  const [tool, setTool] = useState(\"pencil\");\n  const [showStyling, setShowStyling] = useState(true);\n  const [color, setColor] = useState(\"#000000\");\n  const [size, setSize] = useState(4);\n  const [opacity, setOpacity] = useState(1);\n  const [strokeStyle, setStrokeStyle] = useState('solid');\n  const [fill, setFill] = useState(false);\n\n  // Camera / Infinite Canvas States (Refs for performance, state for UI)\n  const [cameraScale, setCameraScale] = useState(1);\n  const [cameraOffset, setCameraOffset] = useState({\n    x: -4000 + window.innerWidth / 2,\n    y: -4000 + window.innerHeight / 2\n  });\n  const cameraScaleRef = useRef(1);\n  const cameraOffsetRef = useRef({\n    x: -4000 + window.innerWidth / 2,\n    y: -4000 + window.innerHeight / 2\n  });\n  const isPanningRef = useRef(false);\n  const panStartRef = useRef({\n    x: 0,\n    y: 0\n  });\n  const worldRef = useRef(null);\n\n  // Structured Data State\n  const [strokes, setStrokes] = useState([]); // Array of { type, points, color, size, opacity, ... }\n\n  // Performance Refs for Drawing\n  const isDrawingRef = useRef(false);\n  const currentPointsRef = useRef([]);\n  const startPosRef = useRef({\n    x: 0,\n    y: 0\n  });\n  const lastPosRef = useRef({\n    x: 0,\n    y: 0\n  });\n  const snapshotCanvasRef = useRef(null);\n  const backgroundRef = useRef(null);\n  const animationFrameRef = useRef(null);\n  const lastCursorEmitRef = useRef(0);\n  // Image upload to canvas\n  const imageFileRef = useRef(null);\n  const imagePlacePosRef = useRef({\n    x: 0,\n    y: 0\n  });\n  const imageCache = useRef(new Map());\n  const colors = [\"#000000\", \"#475569\", \"#dc2626\", \"#ea580c\", \"#d97706\", \"#65a30d\", \"#0891b2\", \"#2563eb\", \"#7c3aed\", \"#db2777\"];\n  const isDrawingTool = [\"pencil\", \"highlighter\", \"soft-brush\", \"marker\", \"smooth-pencil\", \"precision-eraser\", \"rect\", \"circle\", \"line\", \"arrow\", \"double-arrow\", \"rounded-rect\", \"ellipse\", \"triangle\", \"diamond\", \"sticky\", \"speech-bubble\", \"parallelogram\", \"cylinder\", \"document\", \"cloud\"].includes(tool);\n\n  // Dynamic canvas cursor based on active tool\n  const canvasCursor = {\n    select: 'default',\n    pan: 'grab',\n    eraser: 'cell',\n    'precision-eraser': 'cell',\n    text: 'text',\n    upload: 'copy'\n  }[tool] || 'crosshair';\n  const handleToolChange = newTool => {\n    if (tool === newTool) {\n      setShowStyling(!showStyling);\n    } else {\n      setTool(newTool);\n      setShowStyling(true);\n    }\n  };\n  const [room, setRoom] = useState(null);\n  const [participants, setParticipants] = useState([]);\n  const [messages, setMessages] = useState([]);\n  const [sharedFiles, setSharedFiles] = useState([]);\n  const [activeTab, setActiveTab] = useState(\"chat\");\n  const [loadingFileUpload, setLoadingFileUpload] = useState(false);\n  const [screenStream, setScreenStream] = useState(null);\n  const screenVideoRef = useRef(null);\n  const [isSidebarOpen, setIsSidebarOpen] = useState(true);\n  const [remoteCursors, setRemoteCursors] = useState({});\n\n  // History & Dragging\n  const [history, setHistory] = useState([]);\n  const [historyIndex, setHistoryIndex] = useState(-1);\n  useEffect(() => {\n    const fetchRoomDetails = async () => {\n      try {\n        const res = await roomService.getRoom(roomId);\n        setRoom(res.data.room);\n        setSharedFiles(res.data.room.sharedFiles || []);\n      } catch (err) {\n        toast.error(\"Failed to load workspace\");\n        navigate(\"/dashboard\");\n      }\n    };\n    fetchRoomDetails();\n    if (socket) {\n      socket.emit(\"join-room\", {\n        roomId,\n        userId: user._id,\n        userName: user.name\n      });\n      socket.on(\"user-joined\", data => toast.success(`${data.userName} joined`));\n      socket.on(\"online-users\", users => setParticipants(users));\n      socket.on(\"chat-message\", msg => setMessages(prev => [...prev, msg]));\n      socket.on(\"chat-history\", h => setMessages(h));\n      socket.on(\"drawing\", data => drawRemote(data));\n      socket.on(\"erase\", data => eraseRemote(data));\n      socket.on(\"board-cleared\", () => {\n        clearCanvasLocal();\n        setHistory([]);\n        setHistoryIndex(-1);\n      });\n      socket.on(\"canvas-state\", data => {\n        if (data) {\n          if (data.strokes && data.strokes.length > 0) {\n            setStrokes(data.strokes);\n            // If we have vector strokes, we don't load the pixel background \n            // to avoid \"ghosting\" effects where objects appear twice.\n            backgroundRef.current = null;\n            redrawCanvas();\n          } else if (data.image) {\n            applyCanvasState(data.image);\n          }\n          const stateToHistory = data.image || \"\";\n          setHistory([stateToHistory]);\n          setHistoryIndex(0);\n        }\n      });\n      socket.on(\"undo\", state => applyCanvasState(state));\n      socket.on(\"redo\", state => applyCanvasState(state));\n      socket.on(\"user-left\", data => toast(`ðŸ‘‹ ${data.userName} left`));\n      socket.on(\"new-stroke\", stroke => setStrokes(prev => [...prev, stroke]));\n      socket.on(\"board-state-updated\", updatedStrokes => setStrokes(updatedStrokes));\n      socket.on(\"new-file\", file => setSharedFiles(prev => [...prev, file]));\n      socket.on(\"cursor-move\", data => {\n        setRemoteCursors(prev => ({\n          ...prev,\n          [data.socketId]: data\n        }));\n        setTimeout(() => setRemoteCursors(prev => {\n          const n = {\n            ...prev\n          };\n          delete n[data.socketId];\n          return n;\n        }), 3000);\n      });\n    }\n    return () => {\n      if (socket) {\n        socket.emit(\"leave-room\", {\n          roomId,\n          userId: user._id,\n          userName: user.name\n        });\n        [\"user-joined\", \"online-users\", \"chat-message\", \"chat-history\", \"drawing\", \"erase\", \"board-cleared\", \"canvas-state\", \"undo\", \"redo\", \"user-left\", \"new-stroke\", \"board-state-updated\", \"new-file\", \"cursor-move\"].forEach(ev => socket.off(ev));\n      }\n    };\n  }, [roomId, socket, user, navigate]);\n  useEffect(() => {\n    const viewport = viewportRef.current;\n    const canvas = canvasRef.current;\n    if (!viewport || !canvas) return;\n    const updateCanvasSize = () => {\n      const dpr = window.devicePixelRatio || 1;\n      // Resize buffer to exactly match the displayed element size\n      canvas.width = viewport.clientWidth * dpr;\n      canvas.height = viewport.clientHeight * dpr;\n      const context = canvas.getContext(\"2d\", {\n        alpha: true\n      });\n      if (context) {\n        context.lineCap = \"round\";\n        context.lineJoin = \"round\";\n        contextRef.current = context;\n      }\n      if (!snapshotCanvasRef.current) {\n        snapshotCanvasRef.current = document.createElement('canvas');\n      }\n      snapshotCanvasRef.current.width = canvas.width;\n      snapshotCanvasRef.current.height = canvas.height;\n      redrawCanvas();\n    };\n    const ro = new ResizeObserver(() => {\n      updateCanvasSize();\n    });\n    ro.observe(viewport);\n    return () => ro.disconnect();\n  }, []);\n  useEffect(() => {\n    const handleZoomIn = () => updateZoom(1.1);\n    const handleZoomOut = () => updateZoom(1 / 1.1);\n    const handleResetZoom = () => {\n      const newScale = 1;\n      const newOffset = {\n        x: -8192 / 2 + window.innerWidth / 2,\n        y: -8192 / 2 + window.innerHeight / 2\n      };\n      cameraScaleRef.current = newScale;\n      cameraOffsetRef.current = newOffset;\n      setCameraScale(newScale);\n      setCameraOffset(newOffset);\n      syncViewDOM();\n    };\n    window.addEventListener('wb-zoom-in', handleZoomIn);\n    window.addEventListener('wb-zoom-out', handleZoomOut);\n    window.addEventListener('wb-reset-view', handleResetZoom);\n    return () => {\n      window.removeEventListener('wb-zoom-in', handleZoomIn);\n      window.removeEventListener('wb-zoom-out', handleZoomOut);\n      window.removeEventListener('wb-reset-view', handleResetZoom);\n    };\n  }, []);\n  useEffect(() => {\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n    const handleWheel = e => {\n      e.preventDefault();\n      if (e.ctrlKey) {\n        // Zoom centered on cursor\n        const zoomSpeed = 0.0012;\n        const delta = -e.deltaY * zoomSpeed * cameraScaleRef.current;\n        const newScale = Math.max(0.05, Math.min(10, cameraScaleRef.current + delta));\n        const rect = viewport.getBoundingClientRect();\n        const mouseX = e.clientX - rect.left;\n        const mouseY = e.clientY - rect.top;\n\n        // Relative point on the world map\n        const worldX = (mouseX - cameraOffsetRef.current.x) / cameraScaleRef.current;\n        const worldY = (mouseY - cameraOffsetRef.current.y) / cameraScaleRef.current;\n        cameraScaleRef.current = newScale;\n        cameraOffsetRef.current = {\n          x: mouseX - worldX * newScale,\n          y: mouseY - worldY * newScale\n        };\n        setCameraScale(newScale);\n        setCameraOffset(cameraOffsetRef.current);\n        syncViewDOM();\n      } else {\n        // Precise Panning\n        cameraOffsetRef.current = {\n          x: cameraOffsetRef.current.x - e.deltaX,\n          y: cameraOffsetRef.current.y - e.deltaY\n        };\n        syncViewDOM();\n        // Optionally throttle state update for UI\n        setCameraOffset(cameraOffsetRef.current);\n      }\n    };\n    viewport.addEventListener('wheel', handleWheel, {\n      passive: false\n    });\n    return () => viewport.removeEventListener('wheel', handleWheel);\n  }, []);\n  const updateZoom = factor => {\n    const newScale = Math.max(0.05, Math.min(10, cameraScaleRef.current * factor));\n    const centerX = window.innerWidth / 2;\n    const centerY = window.innerHeight / 2;\n    const worldX = (centerX - cameraOffsetRef.current.x) / cameraScaleRef.current;\n    const worldY = (centerY - cameraOffsetRef.current.y) / cameraScaleRef.current;\n    cameraScaleRef.current = newScale;\n    cameraOffsetRef.current = {\n      x: centerX - worldX * newScale,\n      y: centerY - worldY * newScale\n    };\n    setCameraScale(newScale);\n    setCameraOffset(cameraOffsetRef.current);\n    syncViewDOM();\n  };\n  const syncViewDOM = () => {\n    // We no longer scale the container. Panning/Zooming is handled via canvas transform.\n    // We still update the background grid for visual feedback.\n    if (viewportRef.current) {\n      const scale = cameraScaleRef.current;\n      const ox = cameraOffsetRef.current.x;\n      const oy = cameraOffsetRef.current.y;\n      viewportRef.current.style.backgroundSize = `${24 * scale}px ${24 * scale}px`;\n      viewportRef.current.style.backgroundPosition = `${ox}px ${oy}px`;\n    }\n    redrawCanvas();\n  };\n  const redrawCanvas = () => {\n    const canvas = canvasRef.current;\n    const ctx = contextRef.current;\n    if (!canvas || !ctx) return;\n    const dpr = window.devicePixelRatio || 1;\n\n    // 1. Clear the physical canvas\n    ctx.setTransform(1, 0, 0, 1, 0, 0);\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n    // Draw background image (applied canvas state) if available\n    if (backgroundRef.current) {\n      try {\n        ctx.drawImage(backgroundRef.current, 0, 0, canvas.width, canvas.height);\n      } catch (err) {\n        // ignore draw errors\n      }\n    }\n\n    // 2. Apply Camera Transform (DPR * Scale * Offset)\n    ctx.setTransform(cameraScaleRef.current * dpr, 0, 0, cameraScaleRef.current * dpr, cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr);\n\n    // 3. Render all strokes\n    strokes.forEach(stroke => {\n      renderStroke(ctx, stroke);\n    });\n  };\n  useEffect(() => {\n    redrawCanvas();\n  }, [strokes]);\n  const clearCanvasLocal = () => {\n    setStrokes([]);\n    redrawCanvas();\n  };\n  const renderStroke = (ctx, stroke) => {\n    const {\n      type,\n      points,\n      color,\n      size,\n      opacity,\n      strokeStyle,\n      fill\n    } = stroke;\n\n    // â”€â”€â”€ Text strokes â”€â”€â”€\n    if (type === 'text') {\n      ctx.save();\n      ctx.font = `bold ${size}px Inter, sans-serif`;\n      ctx.fillStyle = color;\n      ctx.globalAlpha = opacity;\n      ctx.globalCompositeOperation = \"source-over\";\n      ctx.shadowBlur = 0;\n      ctx.fillText(stroke.text || '', points[0].x, points[0].y);\n      ctx.restore();\n      return;\n    }\n\n    // â”€â”€â”€ Image strokes â”€â”€â”€\n    if (type === 'image') {\n      const cached = imageCache.current.get(stroke.src);\n      if (cached) {\n        ctx.save();\n        ctx.globalAlpha = stroke.opacity || 1;\n        ctx.drawImage(cached, points[0].x, points[0].y, stroke.imgW || 300, stroke.imgH || 200);\n        ctx.restore();\n      } else {\n        const img = new window.Image();\n        img.onload = () => {\n          imageCache.current.set(stroke.src, img);\n          redrawCanvas();\n        };\n        img.src = stroke.src;\n      }\n      return;\n    }\n    ctx.save();\n    if (type === 'eraser-precision' || type === 'mask') {\n      ctx.globalCompositeOperation = \"destination-out\";\n    } else {\n      ctx.globalCompositeOperation = \"source-over\";\n      ctx.globalAlpha = opacity;\n      ctx.strokeStyle = color;\n      ctx.fillStyle = color;\n      ctx.lineWidth = size;\n      ctx.setLineDash(strokeStyle === 'dashed' ? [10, 10] : []);\n      if (type === 'soft-brush') {\n        ctx.shadowBlur = size / 2;\n        ctx.shadowColor = color;\n      }\n      if (type === 'marker') {\n        ctx.globalAlpha = opacity * 0.6;\n      }\n    }\n    if (['pencil', 'highlighter', 'soft-brush', 'marker', 'smooth-pencil', 'eraser-precision'].includes(type)) {\n      if (points.length < 2) {\n        ctx.restore();\n        return;\n      }\n      ctx.beginPath();\n      ctx.moveTo(points[0].x, points[0].y);\n      for (let i = 1; i < points.length; i++) {\n        ctx.lineTo(points[i].x, points[i].y);\n      }\n      ctx.stroke();\n    } else {\n      drawShape(ctx, type, points, {\n        color,\n        size,\n        opacity,\n        strokeStyle,\n        fill\n      });\n    }\n    ctx.restore();\n  };\n  const drawShape = (ctx, type, points, style) => {\n    const start = points[0];\n    const end = points[points.length - 1];\n    const w = end.x - start.x;\n    const h = end.y - start.y;\n    if (type === 'rect') {\n      if (style.fill) ctx.fillRect(start.x, start.y, w, h);\n      ctx.strokeRect(start.x, start.y, w, h);\n    } else if (type === 'rounded-rect') {\n      ctx.beginPath();\n      ctx.roundRect(start.x, start.y, w, h, Math.min(Math.abs(w), Math.abs(h)) * 0.2);\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'circle' || type === 'ellipse') {\n      ctx.beginPath();\n      if (type === 'circle') {\n        const radius = Math.sqrt(w * w + h * h);\n        ctx.arc(start.x, start.y, radius, 0, 2 * Math.PI);\n      } else {\n        ctx.ellipse(start.x + w / 2, start.y + h / 2, Math.abs(w / 2), Math.abs(h / 2), 0, 0, 2 * Math.PI);\n      }\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'triangle') {\n      ctx.beginPath();\n      ctx.moveTo(start.x + w / 2, start.y);\n      ctx.lineTo(end.x, end.y);\n      ctx.lineTo(start.x, end.y);\n      ctx.closePath();\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'diamond') {\n      ctx.beginPath();\n      ctx.moveTo(start.x + w / 2, start.y);\n      ctx.lineTo(end.x, start.y + h / 2);\n      ctx.lineTo(start.x + w / 2, end.y);\n      ctx.lineTo(start.x, start.y + h / 2);\n      ctx.closePath();\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'line' || type === 'arrow' || type === 'double-arrow') {\n      ctx.beginPath();\n      ctx.moveTo(start.x, start.y);\n      ctx.lineTo(end.x, end.y);\n      ctx.stroke();\n      if (type === 'arrow' || type === 'double-arrow') {\n        drawArrowHead(ctx, start.x, start.y, end.x, end.y, style.size);\n      }\n      if (type === 'double-arrow') {\n        drawArrowHead(ctx, end.x, end.y, start.x, start.y, style.size);\n      }\n    } else if (type === 'sticky') {\n      ctx.save();\n      ctx.fillStyle = style.fill ? style.color : \"#fef08a\"; // Default yellow sticky\n      ctx.shadowBlur = 10;\n      ctx.shadowColor = \"rgba(0,0,0,0.1)\";\n      ctx.fillRect(start.x, start.y, w, h);\n      ctx.strokeStyle = \"rgba(0,0,0,0.05)\";\n      ctx.strokeRect(start.x, start.y, w, h);\n      ctx.restore();\n    } else if (type === 'speech-bubble') {\n      ctx.beginPath();\n      ctx.roundRect(start.x, start.y, w, h * 0.8, 10);\n      ctx.moveTo(start.x + w * 0.2, start.y + h * 0.8);\n      ctx.lineTo(start.x + w * 0.1, end.y);\n      ctx.lineTo(start.x + w * 0.4, start.y + h * 0.8);\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'parallelogram') {\n      const shift = w * 0.2;\n      ctx.beginPath();\n      ctx.moveTo(start.x + shift, start.y);\n      ctx.lineTo(end.x, start.y);\n      ctx.lineTo(end.x - shift, end.y);\n      ctx.lineTo(start.x, end.y);\n      ctx.closePath();\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'cylinder') {\n      const ry = Math.abs(h * 0.1);\n      // Bottom face\n      ctx.beginPath();\n      ctx.ellipse(start.x + w / 2, end.y - ry, Math.abs(w / 2), ry, 0, 0, Math.PI, false);\n      ctx.stroke();\n      // Side lines\n      ctx.beginPath();\n      ctx.moveTo(start.x, start.y + ry);\n      ctx.lineTo(start.x, end.y - ry);\n      ctx.moveTo(end.x, start.y + ry);\n      ctx.lineTo(end.x, end.y - ry);\n      ctx.stroke();\n      // Top face\n      ctx.beginPath();\n      ctx.ellipse(start.x + w / 2, start.y + ry, Math.abs(w / 2), ry, 0, 0, 2 * Math.PI);\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    } else if (type === 'document') {\n      const fold = Math.min(w, h) * 0.2;\n      ctx.beginPath();\n      ctx.moveTo(start.x, start.y);\n      ctx.lineTo(end.x - fold, start.y);\n      ctx.lineTo(end.x, start.y + fold);\n      ctx.lineTo(end.x, end.y);\n      ctx.lineTo(start.x, end.y);\n      ctx.closePath();\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n      // Fold line\n      ctx.beginPath();\n      ctx.moveTo(end.x - fold, start.y);\n      ctx.lineTo(end.x - fold, start.y + fold);\n      ctx.lineTo(end.x, start.y + fold);\n      ctx.stroke();\n    } else if (type === 'cloud') {\n      ctx.beginPath();\n      const mw = start.x + w / 2;\n      const mh = start.y + h / 2;\n      ctx.arc(mw - w * 0.2, mh, Math.abs(h * 0.3), 0, 2 * Math.PI);\n      ctx.arc(mw + w * 0.2, mh, Math.abs(h * 0.3), 0, 2 * Math.PI);\n      ctx.arc(mw, mh - h * 0.2, Math.abs(h * 0.3), 0, 2 * Math.PI);\n      ctx.arc(mw, mh + h * 0.2, Math.abs(h * 0.3), 0, 2 * Math.PI);\n      if (style.fill) ctx.fill();\n      ctx.stroke();\n    }\n  };\n  const drawArrowHead = (ctx, fromx, fromy, tox, toy, weight) => {\n    const headlen = weight * 4;\n    const angle = Math.atan2(toy - fromy, tox - fromx);\n    ctx.save();\n    ctx.translate(tox, toy);\n    ctx.rotate(angle);\n    ctx.beginPath();\n    ctx.moveTo(0, 0);\n    ctx.lineTo(-headlen, -headlen / 2);\n    ctx.lineTo(-headlen, headlen / 2);\n    ctx.closePath();\n    ctx.fill();\n    ctx.restore();\n  };\n  const getMousePos = e => {\n    const viewport = viewportRef.current;\n    if (!viewport) return {\n      x: 0,\n      y: 0\n    };\n    const rect = viewport.getBoundingClientRect();\n\n    // Convert screen coordinates to world coordinates\n    return {\n      x: (e.clientX - rect.left - cameraOffsetRef.current.x) / cameraScaleRef.current,\n      y: (e.clientY - rect.top - cameraOffsetRef.current.y) / cameraScaleRef.current\n    };\n  };\n  const startDrawing = e => {\n    // Handle Panning with Middle Mouse or Pan Tool\n    if (e.button === 1 || tool === 'pan') {\n      isPanningRef.current = true;\n      panStartRef.current = {\n        x: e.clientX - cameraOffsetRef.current.x,\n        y: e.clientY - cameraOffsetRef.current.y\n      };\n      return;\n    }\n    const canvas = canvasRef.current;\n    if (!canvas || !contextRef.current) return;\n    const pos = getMousePos(e);\n\n    // â”€â”€â”€ Select Tool â”€â”€â”€ (no drawing)\n    if (tool === 'select') return;\n\n    // â”€â”€â”€ Upload Image Tool â”€â”€â”€\n    if (tool === 'upload') {\n      var _imageFileRef$current;\n      imagePlacePosRef.current = pos;\n      (_imageFileRef$current = imageFileRef.current) === null || _imageFileRef$current === void 0 ? void 0 : _imageFileRef$current.click();\n      return;\n    }\n    if (tool === 'eraser') {\n      eraseObjectAt(pos);\n      return;\n    }\n\n    // â”€â”€â”€ Text Tool â”€â”€â”€\n    if (tool === 'text') {\n      const textInput = prompt('Enter text:');\n      if (!textInput) return;\n      const ctx = contextRef.current;\n      if (!ctx) return;\n      const dpr = window.devicePixelRatio || 1;\n      ctx.setTransform(cameraScaleRef.current * dpr, 0, 0, cameraScaleRef.current * dpr, cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr);\n      ctx.font = `bold ${size * 4}px Inter, sans-serif`;\n      ctx.fillStyle = color;\n      ctx.globalAlpha = opacity;\n      ctx.globalCompositeOperation = 'source-over';\n      ctx.shadowBlur = 0;\n      ctx.fillText(textInput, pos.x, pos.y);\n      const textStroke = {\n        id: Date.now() + Math.random(),\n        type: 'text',\n        text: textInput,\n        points: [pos],\n        color,\n        size: size * 4,\n        opacity,\n        strokeStyle,\n        fill\n      };\n      setStrokes(prev => [...prev, textStroke]);\n      socket.emit('new-stroke', {\n        roomId,\n        stroke: textStroke\n      });\n      const dataURL = canvasRef.current.toDataURL();\n      const nh = history.slice(0, historyIndex + 1);\n      nh.push(dataURL);\n      setHistory(nh);\n      setHistoryIndex(nh.length - 1);\n      socket.emit('save-canvas', {\n        roomId,\n        canvasData: dataURL\n      });\n      return;\n    }\n\n    // Initialize drawing refs\n    isDrawingRef.current = true;\n    currentPointsRef.current = [pos];\n    startPosRef.current = pos;\n    lastPosRef.current = pos;\n\n    // Efficient Snapshot of current viewport\n    const snapCtx = snapshotCanvasRef.current.getContext('2d');\n    snapCtx.setTransform(1, 0, 0, 1, 0, 0);\n    snapCtx.clearRect(0, 0, canvas.width, canvas.height);\n    snapCtx.drawImage(canvas, 0, 0);\n    if (isDrawingTool) {\n      const ctx = contextRef.current;\n      const dpr = window.devicePixelRatio || 1;\n\n      // Ensure context is transformed to world space for the live stroke\n      ctx.setTransform(cameraScaleRef.current * dpr, 0, 0, cameraScaleRef.current * dpr, cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr);\n      ctx.beginPath();\n      ctx.moveTo(pos.x, pos.y);\n\n      // Set styles\n      ctx.lineWidth = size;\n      ctx.strokeStyle = color;\n      ctx.globalAlpha = tool === \"highlighter\" ? opacity * 0.4 : tool === \"marker\" ? opacity * 0.6 : opacity;\n      ctx.setLineDash(strokeStyle === 'dashed' ? [10, 10] : []);\n      ctx.lineCap = \"round\";\n      ctx.lineJoin = \"round\";\n      ctx.globalCompositeOperation = tool === \"precision-eraser\" ? \"destination-out\" : \"source-over\";\n\n      // Disable heavy filters during live drawing for performance\n      ctx.shadowBlur = 0;\n    }\n  };\n  const handleMouseMove = e => {\n    // Throttled live cursor broadcast (â‰¤20 fps)\n    const now = Date.now();\n    if (socket && now - lastCursorEmitRef.current > 50) {\n      lastCursorEmitRef.current = now;\n      socket.emit('cursor-move', {\n        roomId,\n        cursorData: {\n          x: e.clientX,\n          y: e.clientY,\n          userName: user.name,\n          color\n        }\n      });\n    }\n    if (isPanningRef.current) {\n      cameraOffsetRef.current = {\n        x: e.clientX - panStartRef.current.x,\n        y: e.clientY - panStartRef.current.y\n      };\n      syncViewDOM();\n      return;\n    }\n    if (isDrawingRef.current) {\n      if (animationFrameRef.current) {\n        cancelAnimationFrame(animationFrameRef.current);\n      }\n      // Extract data from event because React event pooling may nullify 'e' inside rAF\n      const clientX = e.clientX;\n      const clientY = e.clientY;\n      const shiftKey = e.shiftKey;\n      animationFrameRef.current = requestAnimationFrame(() => draw({\n        clientX,\n        clientY,\n        shiftKey\n      }));\n    } else if (tool === 'eraser' && e.buttons === 1) {\n      eraseObjectAt(getMousePos(e));\n    }\n  };\n  const eraseObjectAt = pos => {\n    // Distance-based object erasing\n    const threshold = 15; // pixels\n    const updatedStrokes = strokes.filter(stroke => {\n      return !stroke.points.some(p => {\n        const dist = Math.sqrt(Math.pow(p.x - pos.x, 2) + Math.pow(p.y - pos.y, 2));\n        return dist < threshold;\n      });\n    });\n    if (updatedStrokes.length !== strokes.length) {\n      setStrokes(updatedStrokes);\n      socket.emit(\"update-board-state\", {\n        roomId,\n        strokes: updatedStrokes\n      });\n    }\n  };\n  const draw = e => {\n    if (!isDrawingRef.current || !contextRef.current) return;\n    const pos = getMousePos(e);\n    let currentPos = pos;\n\n    // Smooth Stroke Mode: Apply simple smoothing\n    if (tool === 'smooth-pencil' && currentPointsRef.current.length > 0) {\n      const lastPoint = currentPointsRef.current[currentPointsRef.current.length - 1];\n      currentPos = {\n        x: lastPoint.x * 0.8 + pos.x * 0.2,\n        // Linear interpolation for smoothing\n        y: lastPoint.y * 0.8 + pos.y * 0.2,\n        shiftKey: e.shiftKey\n      };\n    } else {\n      currentPos = {\n        ...pos,\n        shiftKey: e.shiftKey\n      };\n    }\n    currentPointsRef.current.push(currentPos);\n    const ctx = contextRef.current;\n    if ([\"pencil\", \"highlighter\", \"soft-brush\", \"marker\", \"smooth-pencil\", \"precision-eraser\"].includes(tool)) {\n      // Straight Line Mode (Shift Key)\n      if (e.shiftKey) {\n        redrawCanvas(); // Reset to static state\n        ctx.beginPath();\n        ctx.moveTo(startPosRef.current.x, startPosRef.current.y);\n        ctx.lineTo(currentPos.x, currentPos.y);\n        ctx.stroke();\n        return;\n      }\n      ctx.lineTo(currentPos.x, currentPos.y);\n      ctx.stroke();\n\n      // Emit drawing segment for real-time collab\n      socket.emit(\"drawing\", {\n        roomId,\n        drawingData: {\n          x: currentPos.x,\n          y: currentPos.y,\n          prevX: lastPosRef.current.x,\n          prevY: lastPosRef.current.y,\n          color,\n          size,\n          opacity: ctx.globalAlpha,\n          tool\n        }\n      });\n      lastPosRef.current = currentPos;\n    } else if ([\"rect\", \"circle\", \"line\", \"arrow\", \"double-arrow\", \"rounded-rect\", \"ellipse\", \"triangle\", \"diamond\", \"sticky\", \"speech-bubble\", \"parallelogram\", \"cylinder\", \"document\", \"cloud\"].includes(tool)) {\n      const dpr = window.devicePixelRatio || 1;\n      ctx.setTransform(1, 0, 0, 1, 0, 0);\n      ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);\n      ctx.drawImage(snapshotCanvasRef.current, 0, 0);\n\n      // Re-apply camera transform for shape drawing\n      ctx.setTransform(cameraScaleRef.current * dpr, 0, 0, cameraScaleRef.current * dpr, cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr);\n      drawShape(ctx, tool, [startPosRef.current, currentPos], {\n        color,\n        size,\n        opacity,\n        strokeStyle,\n        fill\n      });\n    }\n  };\n  const drawArrow = (ctx, fromx, fromy, tox, toy) => {\n    const headlen = size * 3;\n    const angle = Math.atan2(toy - fromy, tox - fromx);\n    ctx.moveTo(fromx, fromy);\n    ctx.lineTo(tox, toy);\n    ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));\n    ctx.moveTo(tox, toy);\n    ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));\n  };\n  const stopDrawing = () => {\n    if (isPanningRef.current) {\n      isPanningRef.current = false;\n      // Final sync to state for UI consistency\n      setCameraOffset(cameraOffsetRef.current);\n      return;\n    }\n    const canvas = canvasRef.current;\n    if (!isDrawingRef.current || !canvas) return;\n    if (animationFrameRef.current) {\n      cancelAnimationFrame(animationFrameRef.current);\n    }\n    isDrawingRef.current = false;\n\n    // Save current stroke to state\n    let points = [...currentPointsRef.current];\n\n    // Straight Line Mode: If shift was held, only keep start and end points\n    if ([\"pencil\", \"highlighter\", \"soft-brush\", \"marker\", \"smooth-pencil\"].includes(tool) && points.length > 1 && points[points.length - 1].shiftKey) {\n      points = [points[0], points[points.length - 1]];\n    }\n    const newStroke = {\n      id: Date.now() + Math.random(),\n      type: tool === 'precision-eraser' ? 'eraser-precision' : tool,\n      points: points,\n      color: color,\n      size: tool === 'precision-eraser' ? 10 : size,\n      opacity: tool === 'highlighter' ? 0.4 : tool === 'marker' ? 0.6 : opacity,\n      strokeStyle,\n      fill\n    };\n    if (tool !== 'eraser') {\n      // Only save non-eraser strokes to the strokes array\n      setStrokes(prev => [...prev, newStroke]);\n      socket.emit(\"new-stroke\", {\n        roomId,\n        stroke: newStroke\n      });\n    }\n    currentPointsRef.current = [];\n\n    // The following block is for canvas state history, which is now separate from strokes\n    const dataURL = canvas.toDataURL();\n    const newHistory = history.slice(0, historyIndex + 1);\n    newHistory.push(dataURL);\n    setHistory(newHistory);\n    setHistoryIndex(newHistory.length - 1);\n    socket.emit(\"save-canvas\", {\n      roomId,\n      canvasData: dataURL\n    });\n  };\n  const handleUndo = () => {\n    if (historyIndex > 0) {\n      const newIndex = historyIndex - 1;\n      const state = history[newIndex];\n      setHistoryIndex(newIndex);\n      applyCanvasState(state);\n      socket.emit(\"undo\", {\n        roomId,\n        canvasState: state\n      });\n      socket.emit(\"save-canvas\", {\n        roomId,\n        canvasData: state\n      });\n    }\n  };\n  const handleRedo = () => {\n    if (historyIndex < history.length - 1) {\n      const newIndex = historyIndex + 1;\n      const state = history[newIndex];\n      setHistoryIndex(newIndex);\n      applyCanvasState(state);\n      socket.emit(\"redo\", {\n        roomId,\n        canvasState: state\n      });\n      socket.emit(\"save-canvas\", {\n        roomId,\n        canvasData: state\n      });\n    }\n  };\n  const applyCanvasState = state => {\n    if (!state) return;\n    const canvas = canvasRef.current;\n    const ctx = contextRef.current;\n    if (!canvas || !ctx) return;\n    const img = new Image();\n    img.onload = () => {\n      // Store background as an offscreen canvas so redraws persist\n      try {\n        const off = document.createElement('canvas');\n        off.width = canvas.width;\n        off.height = canvas.height;\n        const offCtx = off.getContext('2d');\n        offCtx.setTransform(1, 0, 0, 1, 0, 0);\n        offCtx.clearRect(0, 0, off.width, off.height);\n        offCtx.drawImage(img, 0, 0, off.width, off.height);\n        backgroundRef.current = off;\n        // Draw immediately\n        redrawCanvas();\n      } catch (err) {\n        console.error('Failed to apply canvas state', err);\n      }\n    };\n    img.src = state;\n  };\n  const drawRemote = data => {\n    const {\n      x,\n      y,\n      prevX,\n      prevY,\n      color,\n      size,\n      opacity,\n      tool\n    } = data;\n    const ctx = contextRef.current;\n    if (!ctx) return;\n    const dpr = window.devicePixelRatio || 1;\n    ctx.save();\n\n    // Apply camera transform for remote drawings to match local board state\n    ctx.setTransform(cameraScaleRef.current * dpr, 0, 0, cameraScaleRef.current * dpr, cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr);\n    ctx.globalAlpha = opacity || 1;\n    ctx.strokeStyle = color;\n    ctx.lineWidth = size;\n    ctx.lineCap = \"round\";\n    ctx.lineJoin = \"round\";\n\n    // Handle Eraser mode for remotes\n    ctx.globalCompositeOperation = tool === \"precision-eraser\" ? \"destination-out\" : \"source-over\";\n    ctx.beginPath();\n    if (prevX && prevY) {\n      ctx.moveTo(prevX, prevY);\n    } else {\n      ctx.moveTo(x, y);\n    }\n    ctx.lineTo(x, y);\n    ctx.stroke();\n    ctx.restore();\n  };\n  const eraseRemote = data => {\n    const {\n      x,\n      y,\n      size\n    } = data;\n    const ctx = contextRef.current;\n    if (!ctx) return;\n    const dpr = window.devicePixelRatio || 1;\n    ctx.save();\n\n    // Apply camera transform for object-based erasures\n    ctx.setTransform(cameraScaleRef.current * dpr, 0, 0, cameraScaleRef.current * dpr, cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr);\n    ctx.globalCompositeOperation = \"destination-out\";\n    ctx.beginPath();\n    ctx.arc(x, y, size, 0, Math.PI * 2);\n    ctx.fill();\n    ctx.restore();\n  };\n  const handleClearBoard = () => {\n    if (window.confirm('Clear all drawings for everyone?')) socket.emit('clear-board', {\n      roomId,\n      userId: user._id\n    });\n  };\n\n  // â”€â”€â”€ Export canvas as PNG â”€â”€â”€\n  const downloadCanvas = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n    const link = document.createElement('a');\n    link.download = `${(room === null || room === void 0 ? void 0 : room.roomName) || 'whiteboard'}-${Date.now()}.png`;\n    link.href = canvas.toDataURL('image/png');\n    link.click();\n    toast.success('Board exported as PNG!');\n  };\n\n  // â”€â”€â”€ Handle Image Upload to Canvas â”€â”€â”€\n  const handleImageUpload = e => {\n    const file = e.target.files[0];\n    if (!file) return;\n    const reader = new FileReader();\n    reader.onload = ev => {\n      const src = ev.target.result;\n      const img = new window.Image();\n      img.onload = () => {\n        var _canvasRef$current;\n        const maxW = 400;\n        const scale = Math.min(1, maxW / img.width);\n        const imgW = Math.round(img.width * scale);\n        const imgH = Math.round(img.height * scale);\n        const pos = imagePlacePosRef.current;\n        // Cache & draw immediately\n        imageCache.current.set(src, img);\n        const ctx = contextRef.current;\n        if (ctx) {\n          const dpr = window.devicePixelRatio || 1;\n          ctx.save();\n          ctx.setTransform(cameraScaleRef.current * dpr, 0, 0, cameraScaleRef.current * dpr, cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr);\n          ctx.globalAlpha = opacity;\n          ctx.drawImage(img, pos.x, pos.y, imgW, imgH);\n          ctx.restore();\n        }\n        // Save to strokes\n        const imageStroke = {\n          id: Date.now() + Math.random(),\n          type: 'image',\n          src,\n          points: [pos],\n          imgW,\n          imgH,\n          color,\n          size,\n          opacity,\n          strokeStyle,\n          fill\n        };\n        setStrokes(prev => [...prev, imageStroke]);\n        if (socket) socket.emit('new-stroke', {\n          roomId,\n          stroke: imageStroke\n        });\n        // Save canvas history\n        const dataURL = (_canvasRef$current = canvasRef.current) === null || _canvasRef$current === void 0 ? void 0 : _canvasRef$current.toDataURL();\n        if (dataURL) {\n          setHistory(prev => {\n            const nh = [...prev.slice(0, historyIndex + 1), dataURL];\n            setHistoryIndex(nh.length - 1);\n            return nh;\n          });\n          if (socket) socket.emit('save-canvas', {\n            roomId,\n            canvasData: dataURL\n          });\n        }\n      };\n      img.src = src;\n    };\n    reader.readAsDataURL(file);\n    e.target.value = '';\n  };\n\n  // â”€â”€â”€ Keyboard Shortcuts (run-once on mount) â”€â”€â”€\n  React.useEffect(() => {\n    const onKey = e => {\n      if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;\n      if (e.ctrlKey || e.metaKey) {\n        if (e.key === 'z') {\n          e.preventDefault();\n          handleUndo();\n        }\n        if (e.key === 'y') {\n          e.preventDefault();\n          handleRedo();\n        }\n        return;\n      }\n      const map = {\n        v: 'select',\n        h: 'pan',\n        p: 'pencil',\n        e: 'eraser',\n        t: 'text'\n      };\n      if (map[e.key.toLowerCase()]) setTool(map[e.key.toLowerCase()]);\n    };\n    window.addEventListener('keydown', onKey);\n    return () => window.removeEventListener('keydown', onKey);\n  }, []);\n\n  // â”€â”€â”€ Screen Sharing â”€â”€â”€\n  const startScreenShare = async () => {\n    try {\n      if (screenStream) {\n        screenStream.getTracks().forEach(t => t.stop());\n        setScreenStream(null);\n        socket.emit('screen-share-stopped', {\n          roomId\n        });\n        toast('Screen sharing stopped');\n        return;\n      }\n      const stream = await navigator.mediaDevices.getDisplayMedia({\n        video: true,\n        audio: false\n      });\n      setScreenStream(stream);\n      socket.emit('screen-share-started', {\n        roomId,\n        userId: user._id,\n        userName: user.name\n      });\n      stream.getVideoTracks()[0].onended = () => {\n        setScreenStream(null);\n        socket.emit('screen-share-stopped', {\n          roomId\n        });\n        toast('Screen sharing stopped');\n      };\n      toast.success('Screen sharing started!');\n    } catch (err) {\n      if (err.name !== 'NotAllowedError') toast.error('Screen sharing failed');\n    }\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"wb-layout-container\",\n    children: [/*#__PURE__*/_jsxDEV(\"header\", {\n      className: \"wb-header-miro\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center gap-6\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"flex items-center gap-3\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"w-9 h-9 bg-violet-600 rounded-lg flex items-center justify-center cursor-pointer shadow-lg shadow-violet-200\",\n            onClick: () => navigate('/dashboard'),\n            children: /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"text-white font-black text-lg\",\n              children: \"S\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1072,\n              columnNumber: 29\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1071,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            children: [/*#__PURE__*/_jsxDEV(\"h1\", {\n              className: \"font-bold text-slate-800 leading-tight text-sm truncate max-w-[150px]\",\n              children: (room === null || room === void 0 ? void 0 : room.roomName) || 'Untitled Board'\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1075,\n              columnNumber: 29\n            }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"text-[10px] text-slate-400 font-bold uppercase tracking-widest\",\n              children: [participants.length, \" online\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1076,\n              columnNumber: 29\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1074,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1070,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"w-px h-8 bg-slate-100\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1080,\n          columnNumber: 21\n        }, this), isDrawingTool && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"flex items-center gap-6 animate-in fade-in slide-in-from-left-4 duration-300\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"flex items-center gap-2\",\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"grid grid-cols-5 gap-1 pt-0.5\",\n              children: colors.slice(0, 5).map(c => /*#__PURE__*/_jsxDEV(\"button\", {\n                onClick: () => setColor(c),\n                className: `w-4 h-4 rounded-full border border-slate-200 transition-all ${color === c ? 'ring-2 ring-violet-500 ring-offset-1 scale-110' : 'hover:scale-110'}`,\n                style: {\n                  backgroundColor: c\n                }\n              }, c, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1089,\n                columnNumber: 41\n              }, this))\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1087,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"grid grid-cols-5 gap-1 pt-0.5\",\n              children: colors.slice(5).map(c => /*#__PURE__*/_jsxDEV(\"button\", {\n                onClick: () => setColor(c),\n                className: `w-4 h-4 rounded-full border border-slate-200 transition-all ${color === c ? 'ring-2 ring-violet-500 ring-offset-1 scale-110' : 'hover:scale-110'}`,\n                style: {\n                  backgroundColor: c\n                }\n              }, c, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1099,\n                columnNumber: 41\n              }, this))\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1097,\n              columnNumber: 33\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1086,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"w-px h-6 bg-slate-100\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1109,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"flex items-center gap-3 w-32\",\n            children: [/*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"text-[9px] font-bold text-slate-400 uppercase tracking-widest\",\n              children: \"Size\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1113,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n              type: \"range\",\n              min: \"1\",\n              max: \"40\",\n              value: size,\n              onChange: e => setSize(parseInt(e.target.value)),\n              className: \"w-full accent-violet-600 h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1114,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"text-[10px] font-mono font-bold text-slate-600 min-w-[20px]\",\n              children: size\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1119,\n              columnNumber: 33\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1112,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"w-px h-6 bg-slate-100\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1122,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"flex items-center gap-3 w-32\",\n            children: [/*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"text-[9px] font-bold text-slate-400 uppercase tracking-widest\",\n              children: \"Opacity\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1126,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n              type: \"range\",\n              min: \"0.1\",\n              max: \"1\",\n              step: \"0.1\",\n              value: opacity,\n              onChange: e => setOpacity(parseFloat(e.target.value)),\n              className: \"w-full accent-violet-600 h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1127,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"text-[10px] font-mono font-bold text-slate-600 min-w-[25px]\",\n              children: [Math.round(opacity * 100), \"%\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1132,\n              columnNumber: 33\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1125,\n            columnNumber: 29\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1084,\n          columnNumber: 25\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1069,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center gap-3\",\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"btn-secondary-miro\",\n          onClick: downloadCanvas,\n          children: \"Export PNG\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1139,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"btn-secondary-miro\",\n          onClick: () => {\n            navigator.clipboard.writeText(window.location.href);\n            toast.success('Link copied!');\n          },\n          children: \"Invite\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1140,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: `btn-primary-miro ${screenStream ? '!bg-red-500 !shadow-red-200 hover:!bg-red-600' : ''}`,\n          onClick: startScreenShare,\n          children: screenStream ? 'Stop Sharing' : 'Share Screen'\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1144,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"w-px h-6 bg-slate-200 mx-1\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1150,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"tool-button\",\n          onClick: () => setIsSidebarOpen(!isSidebarOpen),\n          children: /*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"text-lg\",\n            children: \"\\uD83D\\uDCAC\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1152,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1151,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1138,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 1068,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"aside\", {\n      className: \"wb-left-panel\",\n      children: /*#__PURE__*/_jsxDEV(Toolbar, {\n        activeTool: tool,\n        setTool: handleToolChange,\n        isHost: (room === null || room === void 0 ? void 0 : (_room$host = room.host) === null || _room$host === void 0 ? void 0 : _room$host.toString()) === user._id || (room === null || room === void 0 ? void 0 : (_room$host2 = room.host) === null || _room$host2 === void 0 ? void 0 : _room$host2._id) === user._id,\n        onClear: handleClearBoard,\n        onUndo: handleUndo,\n        onRedo: handleRedo,\n        onDelete: () => {}\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1159,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1158,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"main\", {\n      ref: viewportRef,\n      className: \"wb-viewport relative overflow-hidden cursor-default bg-white\",\n      style: {\n        backgroundImage: 'radial-gradient(#cbd5e1 1px, transparent 1px)',\n        backgroundSize: `${24 * cameraScale}px ${24 * cameraScale}px`,\n        backgroundPosition: `${cameraOffset.x}px ${cameraOffset.y}px`\n      },\n      children: [/*#__PURE__*/_jsxDEV(\"canvas\", {\n        ref: canvasRef,\n        className: \"absolute inset-0 w-full h-full\",\n        style: {\n          cursor: canvasCursor\n        },\n        onMouseDown: startDrawing,\n        onMouseMove: handleMouseMove,\n        onMouseUp: stopDrawing,\n        onMouseOut: stopDrawing\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1182,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n        type: \"file\",\n        accept: \"image/*\",\n        className: \"hidden\",\n        ref: imageFileRef,\n        onChange: handleImageUpload\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1194,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(StylingPanel, {\n        tool: tool,\n        visible: showStyling,\n        strokeStyle: strokeStyle,\n        setStrokeStyle: setStrokeStyle,\n        fill: fill,\n        setFill: setFill\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1200,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"absolute bottom-6 right-6 flex items-center gap-2 bg-white p-1 rounded-xl shadow-lg border border-slate-200 z-50\",\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => {\n            cameraScaleRef.current = 1;\n            cameraOffsetRef.current = {\n              x: -4000 + window.innerWidth / 2,\n              y: -4000 + window.innerHeight / 2\n            };\n            setCameraScale(1);\n            setCameraOffset(cameraOffsetRef.current);\n            syncViewDOM();\n          },\n          className: \"w-12 h-8 hover:bg-slate-50 rounded-lg text-xs font-bold text-slate-600 transition-colors\",\n          children: [Math.round(cameraScale * 100), \"%\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1209,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"w-px h-4 bg-slate-100\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1219,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => updateZoom(1.1),\n          className: \"w-8 h-8 hover:bg-slate-50 rounded-lg flex items-center justify-center text-slate-600\",\n          children: /*#__PURE__*/_jsxDEV(Plus, {\n            size: 14\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1221,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1220,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => updateZoom(1 / 1.1),\n          className: \"w-8 h-8 hover:bg-slate-50 rounded-lg flex items-center justify-center text-slate-600\",\n          children: /*#__PURE__*/_jsxDEV(Minus, {\n            size: 14\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1224,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1223,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1208,\n        columnNumber: 17\n      }, this), Object.values(remoteCursors).map(cursor => /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"fixed pointer-events-none z-[9997] transition-[top,left] duration-75\",\n        style: {\n          left: cursor.x,\n          top: cursor.y\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"svg\", {\n          width: \"12\",\n          height: \"16\",\n          viewBox: \"0 0 12 16\",\n          xmlns: \"http://www.w3.org/2000/svg\",\n          children: /*#__PURE__*/_jsxDEV(\"path\", {\n            d: \"M0 0 L0 14 L4 10 L6.5 14.5 L8 13.5 L5.5 9 L10 9 Z\",\n            fill: cursor.color || '#7c3aed',\n            stroke: \"white\",\n            strokeWidth: \"1\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1236,\n            columnNumber: 29\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1235,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n          className: \"text-[9px] font-bold text-white px-1.5 py-0.5 rounded-full whitespace-nowrap block ml-2 -mt-0.5 shadow-md\",\n          style: {\n            backgroundColor: cursor.color || '#7c3aed'\n          },\n          children: cursor.userName\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1239,\n          columnNumber: 25\n        }, this)]\n      }, cursor.socketId, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1230,\n        columnNumber: 21\n      }, this))]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 1172,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"aside\", {\n      className: `wb-right-panel ${isSidebarOpen ? 'open' : ''}`,\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex flex-col h-full\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"flex p-2 bg-slate-50 border-b border-slate-200\",\n          children: ['chat', 'files', 'users'].map(tab => /*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: () => setActiveTab(tab),\n            className: `flex-1 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase tracking-widest\n                                          ${activeTab === tab ? \"bg-white text-violet-700 shadow-sm border border-slate-200\" : \"text-slate-500 hover:text-slate-700\"}`,\n            children: tab\n          }, tab, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1252,\n            columnNumber: 29\n          }, this))\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1250,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"flex-1 overflow-hidden\",\n          children: activeTab === \"chat\" ? /*#__PURE__*/_jsxDEV(Chat, {\n            messages: messages,\n            onSendMessage: txt => socket.emit(\"chat-message\", {\n              roomId,\n              message: txt,\n              userId: user._id,\n              userName: user.name\n            }),\n            currentUser: user\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1264,\n            columnNumber: 29\n          }, this) : activeTab === \"files\" ? /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"p-4\",\n            children: [/*#__PURE__*/_jsxDEV(\"label\", {\n              className: `btn-secondary-miro w-full flex justify-center cursor-pointer text-xs mb-4 ${loadingFileUpload ? 'opacity-50 cursor-not-allowed' : ''}`,\n              children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                children: loadingFileUpload ? 'Uploading...' : 'ðŸ“Ž Share Asset'\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1268,\n                columnNumber: 37\n              }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n                type: \"file\",\n                className: \"hidden\",\n                disabled: loadingFileUpload,\n                onChange: async e => {\n                  const file = e.target.files[0];\n                  if (!file) return;\n                  setLoadingFileUpload(true);\n                  try {\n                    const fd = new FormData();\n                    fd.append('file', file);\n                    const res = await roomService.uploadFile(roomId, fd);\n                    setSharedFiles(prev => [...prev, res.data.file]);\n                    socket.emit('file-shared', {\n                      roomId,\n                      file: res.data.file\n                    });\n                    toast.success(`${file.name} shared!`);\n                  } catch {\n                    toast.error('Upload failed');\n                  } finally {\n                    setLoadingFileUpload(false);\n                    e.target.value = '';\n                  }\n                }\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1269,\n                columnNumber: 37\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1267,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"space-y-2\",\n              children: sharedFiles.map((f, i) => /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"p-3 bg-slate-50 rounded-lg border border-slate-100 flex items-center justify-between\",\n                children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                  className: \"text-xs font-medium truncate max-w-[150px]\",\n                  children: f.fileName\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1292,\n                  columnNumber: 45\n                }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                  className: \"text-violet-600\",\n                  children: \"\\u2B07\\uFE0F\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1293,\n                  columnNumber: 45\n                }, this)]\n              }, i, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1291,\n                columnNumber: 41\n              }, this))\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1289,\n              columnNumber: 33\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1266,\n            columnNumber: 29\n          }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"p-4 space-y-2\",\n            children: participants.map((p, i) => /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"flex items-center gap-3 p-2 hover:bg-slate-50 rounded-lg\",\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"w-6 h-6 rounded-full bg-violet-100 flex items-center justify-center text-[10px] font-bold text-violet-700\",\n                children: p.userName[0]\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1302,\n                columnNumber: 41\n              }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                className: \"text-xs font-medium text-slate-700\",\n                children: p.userName\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1303,\n                columnNumber: 41\n              }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"w-1.5 h-1.5 rounded-full bg-green-500 ml-auto\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1304,\n                columnNumber: 41\n              }, this)]\n            }, i, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1301,\n              columnNumber: 37\n            }, this))\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1299,\n            columnNumber: 29\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1262,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1249,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1248,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 1066,\n    columnNumber: 9\n  }, this);\n};\n_s(WhiteboardRoom, \"c3/lcMEskjsZFBgSmkgdjsrMfvY=\", false, function () {\n  return [useParams, useNavigate, useAuth, useSocket];\n});\n_c = WhiteboardRoom;\nexport default WhiteboardRoom;\nvar _c;\n$RefreshReg$(_c, \"WhiteboardRoom\");","map":{"version":3,"names":["React","useEffect","useRef","useState","useParams","useNavigate","useAuth","useSocket","roomService","Toolbar","Chat","StylingPanel","toast","Plus","Minus","jsxDEV","_jsxDEV","WhiteboardRoom","_s","_room$host","_room$host2","roomId","navigate","user","socket","canvasRef","viewportRef","contextRef","tool","setTool","showStyling","setShowStyling","color","setColor","size","setSize","opacity","setOpacity","strokeStyle","setStrokeStyle","fill","setFill","cameraScale","setCameraScale","cameraOffset","setCameraOffset","x","window","innerWidth","y","innerHeight","cameraScaleRef","cameraOffsetRef","isPanningRef","panStartRef","worldRef","strokes","setStrokes","isDrawingRef","currentPointsRef","startPosRef","lastPosRef","snapshotCanvasRef","backgroundRef","animationFrameRef","lastCursorEmitRef","imageFileRef","imagePlacePosRef","imageCache","Map","colors","isDrawingTool","includes","canvasCursor","select","pan","eraser","text","upload","handleToolChange","newTool","room","setRoom","participants","setParticipants","messages","setMessages","sharedFiles","setSharedFiles","activeTab","setActiveTab","loadingFileUpload","setLoadingFileUpload","screenStream","setScreenStream","screenVideoRef","isSidebarOpen","setIsSidebarOpen","remoteCursors","setRemoteCursors","history","setHistory","historyIndex","setHistoryIndex","fetchRoomDetails","res","getRoom","data","err","error","emit","userId","_id","userName","name","on","success","users","msg","prev","h","drawRemote","eraseRemote","clearCanvasLocal","length","current","redrawCanvas","image","applyCanvasState","stateToHistory","state","stroke","updatedStrokes","file","socketId","setTimeout","n","forEach","ev","off","viewport","canvas","updateCanvasSize","dpr","devicePixelRatio","width","clientWidth","height","clientHeight","context","getContext","alpha","lineCap","lineJoin","document","createElement","ro","ResizeObserver","observe","disconnect","handleZoomIn","updateZoom","handleZoomOut","handleResetZoom","newScale","newOffset","syncViewDOM","addEventListener","removeEventListener","handleWheel","e","preventDefault","ctrlKey","zoomSpeed","delta","deltaY","Math","max","min","rect","getBoundingClientRect","mouseX","clientX","left","mouseY","clientY","top","worldX","worldY","deltaX","passive","factor","centerX","centerY","scale","ox","oy","style","backgroundSize","backgroundPosition","ctx","setTransform","clearRect","drawImage","renderStroke","type","points","save","font","fillStyle","globalAlpha","globalCompositeOperation","shadowBlur","fillText","restore","cached","get","src","imgW","imgH","img","Image","onload","set","lineWidth","setLineDash","shadowColor","beginPath","moveTo","i","lineTo","drawShape","start","end","w","fillRect","strokeRect","roundRect","abs","radius","sqrt","arc","PI","ellipse","closePath","drawArrowHead","shift","ry","fold","mw","mh","fromx","fromy","tox","toy","weight","headlen","angle","atan2","translate","rotate","getMousePos","startDrawing","button","pos","_imageFileRef$current","click","eraseObjectAt","textInput","prompt","textStroke","id","Date","now","random","dataURL","toDataURL","nh","slice","push","canvasData","snapCtx","handleMouseMove","cursorData","cancelAnimationFrame","shiftKey","requestAnimationFrame","draw","buttons","threshold","filter","some","p","dist","pow","currentPos","lastPoint","drawingData","prevX","prevY","drawArrow","cos","sin","stopDrawing","newStroke","newHistory","handleUndo","newIndex","canvasState","handleRedo","offCtx","console","handleClearBoard","confirm","downloadCanvas","link","download","roomName","href","handleImageUpload","target","files","reader","FileReader","result","_canvasRef$current","maxW","round","imageStroke","readAsDataURL","value","onKey","tagName","metaKey","key","map","v","t","toLowerCase","startScreenShare","getTracks","stop","stream","navigator","mediaDevices","getDisplayMedia","video","audio","getVideoTracks","onended","className","children","onClick","fileName","_jsxFileName","lineNumber","columnNumber","c","backgroundColor","onChange","parseInt","step","parseFloat","clipboard","writeText","location","activeTool","isHost","host","toString","onClear","onUndo","onRedo","onDelete","ref","backgroundImage","cursor","onMouseDown","onMouseMove","onMouseUp","onMouseOut","accept","visible","Object","values","viewBox","xmlns","d","strokeWidth","tab","onSendMessage","txt","message","currentUser","disabled","fd","FormData","append","uploadFile","f","_c","$RefreshReg$"],"sources":["D:/CapstoneProject/whiteboard-app/frontend/src/pages/WhiteboardRoom.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from \"react\";\r\nimport { useParams, useNavigate } from \"react-router-dom\";\r\nimport { useAuth } from \"../context/AuthContext\";\r\nimport { useSocket } from \"../context/SocketContext\";\r\nimport { roomService } from \"../services/api\";\r\nimport Toolbar from \"../components/Toolbar\";\r\nimport Chat from \"../components/Chat\";\r\nimport StylingPanel from \"../components/StylingPanel\";\r\nimport toast from \"react-hot-toast\";\r\nimport { Plus, Minus } from \"lucide-react\";\r\n\r\nconst WhiteboardRoom = () => {\r\n    const { roomId } = useParams();\r\n    const navigate = useNavigate();\r\n    const { user } = useAuth();\r\n    const { socket } = useSocket();\r\n\r\n    const canvasRef = useRef(null);\r\n    const viewportRef = useRef(null);\r\n    const contextRef = useRef(null);\r\n\r\n    // Tools & Styling\r\n    const [tool, setTool] = useState(\"pencil\");\r\n    const [showStyling, setShowStyling] = useState(true);\r\n    const [color, setColor] = useState(\"#000000\");\r\n    const [size, setSize] = useState(4);\r\n    const [opacity, setOpacity] = useState(1);\r\n    const [strokeStyle, setStrokeStyle] = useState('solid');\r\n    const [fill, setFill] = useState(false);\r\n\r\n    // Camera / Infinite Canvas States (Refs for performance, state for UI)\r\n    const [cameraScale, setCameraScale] = useState(1);\r\n    const [cameraOffset, setCameraOffset] = useState({ x: -4000 + window.innerWidth / 2, y: -4000 + window.innerHeight / 2 });\r\n\r\n    const cameraScaleRef = useRef(1);\r\n    const cameraOffsetRef = useRef({ x: -4000 + window.innerWidth / 2, y: -4000 + window.innerHeight / 2 });\r\n    const isPanningRef = useRef(false);\r\n    const panStartRef = useRef({ x: 0, y: 0 });\r\n    const worldRef = useRef(null);\r\n\r\n    // Structured Data State\r\n    const [strokes, setStrokes] = useState([]); // Array of { type, points, color, size, opacity, ... }\r\n\r\n    // Performance Refs for Drawing\r\n    const isDrawingRef = useRef(false);\r\n    const currentPointsRef = useRef([]);\r\n    const startPosRef = useRef({ x: 0, y: 0 });\r\n    const lastPosRef = useRef({ x: 0, y: 0 });\r\n    const snapshotCanvasRef = useRef(null);\r\n    const backgroundRef = useRef(null);\r\n    const animationFrameRef = useRef(null);\r\n    const lastCursorEmitRef = useRef(0);\r\n    // Image upload to canvas\r\n    const imageFileRef = useRef(null);\r\n    const imagePlacePosRef = useRef({ x: 0, y: 0 });\r\n    const imageCache = useRef(new Map());\r\n\r\n    const colors = [\r\n        \"#000000\", \"#475569\", \"#dc2626\", \"#ea580c\", \"#d97706\",\r\n        \"#65a30d\", \"#0891b2\", \"#2563eb\", \"#7c3aed\", \"#db2777\"\r\n    ];\r\n\r\n    const isDrawingTool = [\"pencil\", \"highlighter\", \"soft-brush\", \"marker\", \"smooth-pencil\", \"precision-eraser\",\r\n        \"rect\", \"circle\", \"line\", \"arrow\", \"double-arrow\", \"rounded-rect\", \"ellipse\",\r\n        \"triangle\", \"diamond\", \"sticky\", \"speech-bubble\", \"parallelogram\",\r\n        \"cylinder\", \"document\", \"cloud\"\r\n    ].includes(tool);\r\n\r\n    // Dynamic canvas cursor based on active tool\r\n    const canvasCursor = {\r\n        select: 'default',\r\n        pan: 'grab',\r\n        eraser: 'cell',\r\n        'precision-eraser': 'cell',\r\n        text: 'text',\r\n        upload: 'copy',\r\n    }[tool] || 'crosshair';\r\n\r\n    const handleToolChange = (newTool) => {\r\n        if (tool === newTool) {\r\n            setShowStyling(!showStyling);\r\n        } else {\r\n            setTool(newTool);\r\n            setShowStyling(true);\r\n        }\r\n    };\r\n\r\n    const [room, setRoom] = useState(null);\r\n    const [participants, setParticipants] = useState([]);\r\n    const [messages, setMessages] = useState([]);\r\n    const [sharedFiles, setSharedFiles] = useState([]);\r\n    const [activeTab, setActiveTab] = useState(\"chat\");\r\n    const [loadingFileUpload, setLoadingFileUpload] = useState(false);\r\n    const [screenStream, setScreenStream] = useState(null);\r\n    const screenVideoRef = useRef(null);\r\n    const [isSidebarOpen, setIsSidebarOpen] = useState(true);\r\n    const [remoteCursors, setRemoteCursors] = useState({});\r\n\r\n    // History & Dragging\r\n    const [history, setHistory] = useState([]);\r\n    const [historyIndex, setHistoryIndex] = useState(-1);\r\n\r\n    useEffect(() => {\r\n        const fetchRoomDetails = async () => {\r\n            try {\r\n                const res = await roomService.getRoom(roomId);\r\n                setRoom(res.data.room);\r\n                setSharedFiles(res.data.room.sharedFiles || []);\r\n            } catch (err) {\r\n                toast.error(\"Failed to load workspace\");\r\n                navigate(\"/dashboard\");\r\n            }\r\n        };\r\n\r\n        fetchRoomDetails();\r\n\r\n        if (socket) {\r\n            socket.emit(\"join-room\", { roomId, userId: user._id, userName: user.name });\r\n\r\n            socket.on(\"user-joined\", (data) => toast.success(`${data.userName} joined`));\r\n            socket.on(\"online-users\", (users) => setParticipants(users));\r\n            socket.on(\"chat-message\", (msg) => setMessages((prev) => [...prev, msg]));\r\n            socket.on(\"chat-history\", (h) => setMessages(h));\r\n            socket.on(\"drawing\", (data) => drawRemote(data));\r\n            socket.on(\"erase\", (data) => eraseRemote(data));\r\n            socket.on(\"board-cleared\", () => {\r\n                clearCanvasLocal();\r\n                setHistory([]);\r\n                setHistoryIndex(-1);\r\n            });\r\n            socket.on(\"canvas-state\", (data) => {\r\n                if (data) {\r\n                    if (data.strokes && data.strokes.length > 0) {\r\n                        setStrokes(data.strokes);\r\n                        // If we have vector strokes, we don't load the pixel background \r\n                        // to avoid \"ghosting\" effects where objects appear twice.\r\n                        backgroundRef.current = null;\r\n                        redrawCanvas();\r\n                    } else if (data.image) {\r\n                        applyCanvasState(data.image);\r\n                    }\r\n\r\n                    const stateToHistory = data.image || \"\";\r\n                    setHistory([stateToHistory]);\r\n                    setHistoryIndex(0);\r\n                }\r\n            });\r\n            socket.on(\"undo\", (state) => applyCanvasState(state));\r\n            socket.on(\"redo\", (state) => applyCanvasState(state));\r\n            socket.on(\"user-left\", (data) => toast(`ðŸ‘‹ ${data.userName} left`));\r\n            socket.on(\"new-stroke\", (stroke) => setStrokes(prev => [...prev, stroke]));\r\n            socket.on(\"board-state-updated\", (updatedStrokes) => setStrokes(updatedStrokes));\r\n            socket.on(\"new-file\", (file) => setSharedFiles(prev => [...prev, file]));\r\n            socket.on(\"cursor-move\", (data) => {\r\n                setRemoteCursors(prev => ({ ...prev, [data.socketId]: data }));\r\n                setTimeout(() => setRemoteCursors(prev => { const n = { ...prev }; delete n[data.socketId]; return n; }), 3000);\r\n            });\r\n        }\r\n\r\n        return () => {\r\n            if (socket) {\r\n                socket.emit(\"leave-room\", { roomId, userId: user._id, userName: user.name });\r\n                [\"user-joined\", \"online-users\", \"chat-message\", \"chat-history\", \"drawing\", \"erase\",\r\n                    \"board-cleared\", \"canvas-state\", \"undo\", \"redo\", \"user-left\", \"new-stroke\",\r\n                    \"board-state-updated\", \"new-file\", \"cursor-move\"].forEach(ev => socket.off(ev));\r\n            }\r\n        };\r\n    }, [roomId, socket, user, navigate]);\r\n\r\n    useEffect(() => {\r\n        const viewport = viewportRef.current;\r\n        const canvas = canvasRef.current;\r\n        if (!viewport || !canvas) return;\r\n\r\n        const updateCanvasSize = () => {\r\n            const dpr = window.devicePixelRatio || 1;\r\n            // Resize buffer to exactly match the displayed element size\r\n            canvas.width = viewport.clientWidth * dpr;\r\n            canvas.height = viewport.clientHeight * dpr;\r\n\r\n            const context = canvas.getContext(\"2d\", { alpha: true });\r\n            if (context) {\r\n                context.lineCap = \"round\";\r\n                context.lineJoin = \"round\";\r\n                contextRef.current = context;\r\n            }\r\n\r\n            if (!snapshotCanvasRef.current) {\r\n                snapshotCanvasRef.current = document.createElement('canvas');\r\n            }\r\n            snapshotCanvasRef.current.width = canvas.width;\r\n            snapshotCanvasRef.current.height = canvas.height;\r\n\r\n            redrawCanvas();\r\n        };\r\n\r\n        const ro = new ResizeObserver(() => {\r\n            updateCanvasSize();\r\n        });\r\n        ro.observe(viewport);\r\n\r\n        return () => ro.disconnect();\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        const handleZoomIn = () => updateZoom(1.1);\r\n        const handleZoomOut = () => updateZoom(1 / 1.1);\r\n        const handleResetZoom = () => {\r\n            const newScale = 1;\r\n            const newOffset = { x: -8192 / 2 + window.innerWidth / 2, y: -8192 / 2 + window.innerHeight / 2 };\r\n            cameraScaleRef.current = newScale;\r\n            cameraOffsetRef.current = newOffset;\r\n            setCameraScale(newScale);\r\n            setCameraOffset(newOffset);\r\n            syncViewDOM();\r\n        };\r\n\r\n        window.addEventListener('wb-zoom-in', handleZoomIn);\r\n        window.addEventListener('wb-zoom-out', handleZoomOut);\r\n        window.addEventListener('wb-reset-view', handleResetZoom);\r\n\r\n        return () => {\r\n            window.removeEventListener('wb-zoom-in', handleZoomIn);\r\n            window.removeEventListener('wb-zoom-out', handleZoomOut);\r\n            window.removeEventListener('wb-reset-view', handleResetZoom);\r\n        };\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        const viewport = viewportRef.current;\r\n        if (!viewport) return;\r\n\r\n        const handleWheel = (e) => {\r\n            e.preventDefault();\r\n\r\n            if (e.ctrlKey) {\r\n                // Zoom centered on cursor\r\n                const zoomSpeed = 0.0012;\r\n                const delta = -e.deltaY * zoomSpeed * cameraScaleRef.current;\r\n                const newScale = Math.max(0.05, Math.min(10, cameraScaleRef.current + delta));\r\n\r\n                const rect = viewport.getBoundingClientRect();\r\n                const mouseX = e.clientX - rect.left;\r\n                const mouseY = e.clientY - rect.top;\r\n\r\n                // Relative point on the world map\r\n                const worldX = (mouseX - cameraOffsetRef.current.x) / cameraScaleRef.current;\r\n                const worldY = (mouseY - cameraOffsetRef.current.y) / cameraScaleRef.current;\r\n\r\n                cameraScaleRef.current = newScale;\r\n                cameraOffsetRef.current = {\r\n                    x: mouseX - worldX * newScale,\r\n                    y: mouseY - worldY * newScale\r\n                };\r\n\r\n                setCameraScale(newScale);\r\n                setCameraOffset(cameraOffsetRef.current);\r\n                syncViewDOM();\r\n            } else {\r\n                // Precise Panning\r\n                cameraOffsetRef.current = {\r\n                    x: cameraOffsetRef.current.x - e.deltaX,\r\n                    y: cameraOffsetRef.current.y - e.deltaY\r\n                };\r\n                syncViewDOM();\r\n                // Optionally throttle state update for UI\r\n                setCameraOffset(cameraOffsetRef.current);\r\n            }\r\n        };\r\n\r\n        viewport.addEventListener('wheel', handleWheel, { passive: false });\r\n        return () => viewport.removeEventListener('wheel', handleWheel);\r\n    }, []);\r\n\r\n    const updateZoom = (factor) => {\r\n        const newScale = Math.max(0.05, Math.min(10, cameraScaleRef.current * factor));\r\n        const centerX = window.innerWidth / 2;\r\n        const centerY = window.innerHeight / 2;\r\n\r\n        const worldX = (centerX - cameraOffsetRef.current.x) / cameraScaleRef.current;\r\n        const worldY = (centerY - cameraOffsetRef.current.y) / cameraScaleRef.current;\r\n\r\n        cameraScaleRef.current = newScale;\r\n        cameraOffsetRef.current = {\r\n            x: centerX - worldX * newScale,\r\n            y: centerY - worldY * newScale\r\n        };\r\n\r\n        setCameraScale(newScale);\r\n        setCameraOffset(cameraOffsetRef.current);\r\n        syncViewDOM();\r\n    };\r\n\r\n    const syncViewDOM = () => {\r\n        // We no longer scale the container. Panning/Zooming is handled via canvas transform.\r\n        // We still update the background grid for visual feedback.\r\n        if (viewportRef.current) {\r\n            const scale = cameraScaleRef.current;\r\n            const ox = cameraOffsetRef.current.x;\r\n            const oy = cameraOffsetRef.current.y;\r\n            viewportRef.current.style.backgroundSize = `${24 * scale}px ${24 * scale}px`;\r\n            viewportRef.current.style.backgroundPosition = `${ox}px ${oy}px`;\r\n        }\r\n        redrawCanvas();\r\n    };\r\n\r\n    const redrawCanvas = () => {\r\n        const canvas = canvasRef.current;\r\n        const ctx = contextRef.current;\r\n        if (!canvas || !ctx) return;\r\n\r\n        const dpr = window.devicePixelRatio || 1;\r\n\r\n        // 1. Clear the physical canvas\r\n        ctx.setTransform(1, 0, 0, 1, 0, 0);\r\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n\r\n        // Draw background image (applied canvas state) if available\r\n        if (backgroundRef.current) {\r\n            try {\r\n                ctx.drawImage(backgroundRef.current, 0, 0, canvas.width, canvas.height);\r\n            } catch (err) {\r\n                // ignore draw errors\r\n            }\r\n        }\r\n\r\n        // 2. Apply Camera Transform (DPR * Scale * Offset)\r\n        ctx.setTransform(\r\n            cameraScaleRef.current * dpr, 0,\r\n            0, cameraScaleRef.current * dpr,\r\n            cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr\r\n        );\r\n\r\n        // 3. Render all strokes\r\n        strokes.forEach(stroke => {\r\n            renderStroke(ctx, stroke);\r\n        });\r\n    };\r\n\r\n    useEffect(() => {\r\n        redrawCanvas();\r\n    }, [strokes]);\r\n\r\n    const clearCanvasLocal = () => {\r\n        setStrokes([]);\r\n        redrawCanvas();\r\n    };\r\n\r\n    const renderStroke = (ctx, stroke) => {\r\n        const { type, points, color, size, opacity, strokeStyle, fill } = stroke;\r\n\r\n        // â”€â”€â”€ Text strokes â”€â”€â”€\r\n        if (type === 'text') {\r\n            ctx.save();\r\n            ctx.font = `bold ${size}px Inter, sans-serif`;\r\n            ctx.fillStyle = color;\r\n            ctx.globalAlpha = opacity;\r\n            ctx.globalCompositeOperation = \"source-over\";\r\n            ctx.shadowBlur = 0;\r\n            ctx.fillText(stroke.text || '', points[0].x, points[0].y);\r\n            ctx.restore();\r\n            return;\r\n        }\r\n\r\n        // â”€â”€â”€ Image strokes â”€â”€â”€\r\n        if (type === 'image') {\r\n            const cached = imageCache.current.get(stroke.src);\r\n            if (cached) {\r\n                ctx.save();\r\n                ctx.globalAlpha = stroke.opacity || 1;\r\n                ctx.drawImage(cached, points[0].x, points[0].y, stroke.imgW || 300, stroke.imgH || 200);\r\n                ctx.restore();\r\n            } else {\r\n                const img = new window.Image();\r\n                img.onload = () => { imageCache.current.set(stroke.src, img); redrawCanvas(); };\r\n                img.src = stroke.src;\r\n            }\r\n            return;\r\n        }\r\n\r\n        ctx.save();\r\n\r\n        if (type === 'eraser-precision' || type === 'mask') {\r\n            ctx.globalCompositeOperation = \"destination-out\";\r\n        } else {\r\n            ctx.globalCompositeOperation = \"source-over\";\r\n            ctx.globalAlpha = opacity;\r\n            ctx.strokeStyle = color;\r\n            ctx.fillStyle = color;\r\n            ctx.lineWidth = size;\r\n            ctx.setLineDash(strokeStyle === 'dashed' ? [10, 10] : []);\r\n\r\n            if (type === 'soft-brush') {\r\n                ctx.shadowBlur = size / 2;\r\n                ctx.shadowColor = color;\r\n            }\r\n            if (type === 'marker') {\r\n                ctx.globalAlpha = opacity * 0.6;\r\n            }\r\n        }\r\n\r\n        if (['pencil', 'highlighter', 'soft-brush', 'marker', 'smooth-pencil', 'eraser-precision'].includes(type)) {\r\n            if (points.length < 2) {\r\n                ctx.restore();\r\n                return;\r\n            }\r\n            ctx.beginPath();\r\n            ctx.moveTo(points[0].x, points[0].y);\r\n            for (let i = 1; i < points.length; i++) {\r\n                ctx.lineTo(points[i].x, points[i].y);\r\n            }\r\n            ctx.stroke();\r\n        } else {\r\n            drawShape(ctx, type, points, { color, size, opacity, strokeStyle, fill });\r\n        }\r\n        ctx.restore();\r\n    };\r\n\r\n    const drawShape = (ctx, type, points, style) => {\r\n        const start = points[0];\r\n        const end = points[points.length - 1];\r\n        const w = end.x - start.x;\r\n        const h = end.y - start.y;\r\n\r\n        if (type === 'rect') {\r\n            if (style.fill) ctx.fillRect(start.x, start.y, w, h);\r\n            ctx.strokeRect(start.x, start.y, w, h);\r\n        } else if (type === 'rounded-rect') {\r\n            ctx.beginPath();\r\n            ctx.roundRect(start.x, start.y, w, h, Math.min(Math.abs(w), Math.abs(h)) * 0.2);\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'circle' || type === 'ellipse') {\r\n            ctx.beginPath();\r\n            if (type === 'circle') {\r\n                const radius = Math.sqrt(w * w + h * h);\r\n                ctx.arc(start.x, start.y, radius, 0, 2 * Math.PI);\r\n            } else {\r\n                ctx.ellipse(start.x + w / 2, start.y + h / 2, Math.abs(w / 2), Math.abs(h / 2), 0, 0, 2 * Math.PI);\r\n            }\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'triangle') {\r\n            ctx.beginPath();\r\n            ctx.moveTo(start.x + w / 2, start.y);\r\n            ctx.lineTo(end.x, end.y);\r\n            ctx.lineTo(start.x, end.y);\r\n            ctx.closePath();\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'diamond') {\r\n            ctx.beginPath();\r\n            ctx.moveTo(start.x + w / 2, start.y);\r\n            ctx.lineTo(end.x, start.y + h / 2);\r\n            ctx.lineTo(start.x + w / 2, end.y);\r\n            ctx.lineTo(start.x, start.y + h / 2);\r\n            ctx.closePath();\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'line' || type === 'arrow' || type === 'double-arrow') {\r\n            ctx.beginPath();\r\n            ctx.moveTo(start.x, start.y);\r\n            ctx.lineTo(end.x, end.y);\r\n            ctx.stroke();\r\n            if (type === 'arrow' || type === 'double-arrow') {\r\n                drawArrowHead(ctx, start.x, start.y, end.x, end.y, style.size);\r\n            }\r\n            if (type === 'double-arrow') {\r\n                drawArrowHead(ctx, end.x, end.y, start.x, start.y, style.size);\r\n            }\r\n        } else if (type === 'sticky') {\r\n            ctx.save();\r\n            ctx.fillStyle = style.fill ? style.color : \"#fef08a\"; // Default yellow sticky\r\n            ctx.shadowBlur = 10;\r\n            ctx.shadowColor = \"rgba(0,0,0,0.1)\";\r\n            ctx.fillRect(start.x, start.y, w, h);\r\n            ctx.strokeStyle = \"rgba(0,0,0,0.05)\";\r\n            ctx.strokeRect(start.x, start.y, w, h);\r\n            ctx.restore();\r\n        } else if (type === 'speech-bubble') {\r\n            ctx.beginPath();\r\n            ctx.roundRect(start.x, start.y, w, h * 0.8, 10);\r\n            ctx.moveTo(start.x + w * 0.2, start.y + h * 0.8);\r\n            ctx.lineTo(start.x + w * 0.1, end.y);\r\n            ctx.lineTo(start.x + w * 0.4, start.y + h * 0.8);\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'parallelogram') {\r\n            const shift = w * 0.2;\r\n            ctx.beginPath();\r\n            ctx.moveTo(start.x + shift, start.y);\r\n            ctx.lineTo(end.x, start.y);\r\n            ctx.lineTo(end.x - shift, end.y);\r\n            ctx.lineTo(start.x, end.y);\r\n            ctx.closePath();\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'cylinder') {\r\n            const ry = Math.abs(h * 0.1);\r\n            // Bottom face\r\n            ctx.beginPath();\r\n            ctx.ellipse(start.x + w / 2, end.y - ry, Math.abs(w / 2), ry, 0, 0, Math.PI, false);\r\n            ctx.stroke();\r\n            // Side lines\r\n            ctx.beginPath();\r\n            ctx.moveTo(start.x, start.y + ry);\r\n            ctx.lineTo(start.x, end.y - ry);\r\n            ctx.moveTo(end.x, start.y + ry);\r\n            ctx.lineTo(end.x, end.y - ry);\r\n            ctx.stroke();\r\n            // Top face\r\n            ctx.beginPath();\r\n            ctx.ellipse(start.x + w / 2, start.y + ry, Math.abs(w / 2), ry, 0, 0, 2 * Math.PI);\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        } else if (type === 'document') {\r\n            const fold = Math.min(w, h) * 0.2;\r\n            ctx.beginPath();\r\n            ctx.moveTo(start.x, start.y);\r\n            ctx.lineTo(end.x - fold, start.y);\r\n            ctx.lineTo(end.x, start.y + fold);\r\n            ctx.lineTo(end.x, end.y);\r\n            ctx.lineTo(start.x, end.y);\r\n            ctx.closePath();\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n            // Fold line\r\n            ctx.beginPath();\r\n            ctx.moveTo(end.x - fold, start.y);\r\n            ctx.lineTo(end.x - fold, start.y + fold);\r\n            ctx.lineTo(end.x, start.y + fold);\r\n            ctx.stroke();\r\n        } else if (type === 'cloud') {\r\n            ctx.beginPath();\r\n            const mw = start.x + w / 2;\r\n            const mh = start.y + h / 2;\r\n            ctx.arc(mw - w * 0.2, mh, Math.abs(h * 0.3), 0, 2 * Math.PI);\r\n            ctx.arc(mw + w * 0.2, mh, Math.abs(h * 0.3), 0, 2 * Math.PI);\r\n            ctx.arc(mw, mh - h * 0.2, Math.abs(h * 0.3), 0, 2 * Math.PI);\r\n            ctx.arc(mw, mh + h * 0.2, Math.abs(h * 0.3), 0, 2 * Math.PI);\r\n            if (style.fill) ctx.fill();\r\n            ctx.stroke();\r\n        }\r\n    };\r\n\r\n    const drawArrowHead = (ctx, fromx, fromy, tox, toy, weight) => {\r\n        const headlen = weight * 4;\r\n        const angle = Math.atan2(toy - fromy, tox - fromx);\r\n        ctx.save();\r\n        ctx.translate(tox, toy);\r\n        ctx.rotate(angle);\r\n        ctx.beginPath();\r\n        ctx.moveTo(0, 0);\r\n        ctx.lineTo(-headlen, -headlen / 2);\r\n        ctx.lineTo(-headlen, headlen / 2);\r\n        ctx.closePath();\r\n        ctx.fill();\r\n        ctx.restore();\r\n    };\r\n\r\n\r\n    const getMousePos = (e) => {\r\n        const viewport = viewportRef.current;\r\n        if (!viewport) return { x: 0, y: 0 };\r\n        const rect = viewport.getBoundingClientRect();\r\n\r\n        // Convert screen coordinates to world coordinates\r\n        return {\r\n            x: (e.clientX - rect.left - cameraOffsetRef.current.x) / cameraScaleRef.current,\r\n            y: (e.clientY - rect.top - cameraOffsetRef.current.y) / cameraScaleRef.current\r\n        };\r\n    };\r\n\r\n    const startDrawing = (e) => {\r\n        // Handle Panning with Middle Mouse or Pan Tool\r\n        if (e.button === 1 || tool === 'pan') {\r\n            isPanningRef.current = true;\r\n            panStartRef.current = { x: e.clientX - cameraOffsetRef.current.x, y: e.clientY - cameraOffsetRef.current.y };\r\n            return;\r\n        }\r\n\r\n        const canvas = canvasRef.current;\r\n        if (!canvas || !contextRef.current) return;\r\n\r\n        const pos = getMousePos(e);\r\n\r\n        // â”€â”€â”€ Select Tool â”€â”€â”€ (no drawing)\r\n        if (tool === 'select') return;\r\n\r\n        // â”€â”€â”€ Upload Image Tool â”€â”€â”€\r\n        if (tool === 'upload') {\r\n            imagePlacePosRef.current = pos;\r\n            imageFileRef.current?.click();\r\n            return;\r\n        }\r\n\r\n        if (tool === 'eraser') {\r\n            eraseObjectAt(pos);\r\n            return;\r\n        }\r\n\r\n        // â”€â”€â”€ Text Tool â”€â”€â”€\r\n        if (tool === 'text') {\r\n            const textInput = prompt('Enter text:');\r\n            if (!textInput) return;\r\n            const ctx = contextRef.current;\r\n            if (!ctx) return;\r\n            const dpr = window.devicePixelRatio || 1;\r\n            ctx.setTransform(\r\n                cameraScaleRef.current * dpr, 0,\r\n                0, cameraScaleRef.current * dpr,\r\n                cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr\r\n            );\r\n            ctx.font = `bold ${size * 4}px Inter, sans-serif`;\r\n            ctx.fillStyle = color;\r\n            ctx.globalAlpha = opacity;\r\n            ctx.globalCompositeOperation = 'source-over';\r\n            ctx.shadowBlur = 0;\r\n            ctx.fillText(textInput, pos.x, pos.y);\r\n            const textStroke = {\r\n                id: Date.now() + Math.random(), type: 'text', text: textInput,\r\n                points: [pos], color, size: size * 4, opacity, strokeStyle, fill\r\n            };\r\n            setStrokes(prev => [...prev, textStroke]);\r\n            socket.emit('new-stroke', { roomId, stroke: textStroke });\r\n            const dataURL = canvasRef.current.toDataURL();\r\n            const nh = history.slice(0, historyIndex + 1); nh.push(dataURL);\r\n            setHistory(nh); setHistoryIndex(nh.length - 1);\r\n            socket.emit('save-canvas', { roomId, canvasData: dataURL });\r\n            return;\r\n        }\r\n\r\n        // Initialize drawing refs\r\n        isDrawingRef.current = true;\r\n        currentPointsRef.current = [pos];\r\n        startPosRef.current = pos;\r\n        lastPosRef.current = pos;\r\n\r\n        // Efficient Snapshot of current viewport\r\n        const snapCtx = snapshotCanvasRef.current.getContext('2d');\r\n        snapCtx.setTransform(1, 0, 0, 1, 0, 0);\r\n        snapCtx.clearRect(0, 0, canvas.width, canvas.height);\r\n        snapCtx.drawImage(canvas, 0, 0);\r\n\r\n        if (isDrawingTool) {\r\n            const ctx = contextRef.current;\r\n            const dpr = window.devicePixelRatio || 1;\r\n\r\n            // Ensure context is transformed to world space for the live stroke\r\n            ctx.setTransform(\r\n                cameraScaleRef.current * dpr, 0,\r\n                0, cameraScaleRef.current * dpr,\r\n                cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr\r\n            );\r\n\r\n            ctx.beginPath();\r\n            ctx.moveTo(pos.x, pos.y);\r\n\r\n            // Set styles\r\n            ctx.lineWidth = size;\r\n            ctx.strokeStyle = color;\r\n            ctx.globalAlpha = tool === \"highlighter\" ? (opacity * 0.4) :\r\n                tool === \"marker\" ? (opacity * 0.6) : opacity;\r\n            ctx.setLineDash(strokeStyle === 'dashed' ? [10, 10] : []);\r\n            ctx.lineCap = \"round\";\r\n            ctx.lineJoin = \"round\";\r\n            ctx.globalCompositeOperation = (tool === \"precision-eraser\") ? \"destination-out\" : \"source-over\";\r\n\r\n            // Disable heavy filters during live drawing for performance\r\n            ctx.shadowBlur = 0;\r\n        }\r\n    };\r\n\r\n    const handleMouseMove = (e) => {\r\n        // Throttled live cursor broadcast (â‰¤20 fps)\r\n        const now = Date.now();\r\n        if (socket && now - lastCursorEmitRef.current > 50) {\r\n            lastCursorEmitRef.current = now;\r\n            socket.emit('cursor-move', { roomId, cursorData: { x: e.clientX, y: e.clientY, userName: user.name, color } });\r\n        }\r\n\r\n        if (isPanningRef.current) {\r\n            cameraOffsetRef.current = {\r\n                x: e.clientX - panStartRef.current.x,\r\n                y: e.clientY - panStartRef.current.y\r\n            };\r\n            syncViewDOM();\r\n            return;\r\n        }\r\n\r\n        if (isDrawingRef.current) {\r\n            if (animationFrameRef.current) {\r\n                cancelAnimationFrame(animationFrameRef.current);\r\n            }\r\n            // Extract data from event because React event pooling may nullify 'e' inside rAF\r\n            const clientX = e.clientX;\r\n            const clientY = e.clientY;\r\n            const shiftKey = e.shiftKey;\r\n\r\n            animationFrameRef.current = requestAnimationFrame(() => draw({ clientX, clientY, shiftKey }));\r\n        } else if (tool === 'eraser' && e.buttons === 1) {\r\n            eraseObjectAt(getMousePos(e));\r\n        }\r\n    };\r\n\r\n    const eraseObjectAt = (pos) => {\r\n        // Distance-based object erasing\r\n        const threshold = 15; // pixels\r\n        const updatedStrokes = strokes.filter(stroke => {\r\n            return !stroke.points.some(p => {\r\n                const dist = Math.sqrt(Math.pow(p.x - pos.x, 2) + Math.pow(p.y - pos.y, 2));\r\n                return dist < threshold;\r\n            });\r\n        });\r\n\r\n        if (updatedStrokes.length !== strokes.length) {\r\n            setStrokes(updatedStrokes);\r\n            socket.emit(\"update-board-state\", { roomId, strokes: updatedStrokes });\r\n        }\r\n    };\r\n\r\n    const draw = (e) => {\r\n        if (!isDrawingRef.current || !contextRef.current) return;\r\n        const pos = getMousePos(e);\r\n        let currentPos = pos;\r\n\r\n        // Smooth Stroke Mode: Apply simple smoothing\r\n        if (tool === 'smooth-pencil' && currentPointsRef.current.length > 0) {\r\n            const lastPoint = currentPointsRef.current[currentPointsRef.current.length - 1];\r\n            currentPos = {\r\n                x: lastPoint.x * 0.8 + pos.x * 0.2, // Linear interpolation for smoothing\r\n                y: lastPoint.y * 0.8 + pos.y * 0.2,\r\n                shiftKey: e.shiftKey\r\n            };\r\n        } else {\r\n            currentPos = { ...pos, shiftKey: e.shiftKey };\r\n        }\r\n\r\n        currentPointsRef.current.push(currentPos);\r\n        const ctx = contextRef.current;\r\n\r\n        if ([\"pencil\", \"highlighter\", \"soft-brush\", \"marker\", \"smooth-pencil\", \"precision-eraser\"].includes(tool)) {\r\n            // Straight Line Mode (Shift Key)\r\n            if (e.shiftKey) {\r\n                redrawCanvas(); // Reset to static state\r\n                ctx.beginPath();\r\n                ctx.moveTo(startPosRef.current.x, startPosRef.current.y);\r\n                ctx.lineTo(currentPos.x, currentPos.y);\r\n                ctx.stroke();\r\n                return;\r\n            }\r\n\r\n            ctx.lineTo(currentPos.x, currentPos.y);\r\n            ctx.stroke();\r\n\r\n            // Emit drawing segment for real-time collab\r\n            socket.emit(\"drawing\", {\r\n                roomId,\r\n                drawingData: {\r\n                    x: currentPos.x,\r\n                    y: currentPos.y,\r\n                    prevX: lastPosRef.current.x,\r\n                    prevY: lastPosRef.current.y,\r\n                    color,\r\n                    size,\r\n                    opacity: ctx.globalAlpha,\r\n                    tool\r\n                }\r\n            });\r\n\r\n            lastPosRef.current = currentPos;\r\n        } else if ([\"rect\", \"circle\", \"line\", \"arrow\", \"double-arrow\", \"rounded-rect\", \"ellipse\", \"triangle\", \"diamond\", \"sticky\", \"speech-bubble\", \"parallelogram\", \"cylinder\", \"document\", \"cloud\"].includes(tool)) {\r\n            const dpr = window.devicePixelRatio || 1;\r\n            ctx.setTransform(1, 0, 0, 1, 0, 0);\r\n            ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);\r\n            ctx.drawImage(snapshotCanvasRef.current, 0, 0);\r\n\r\n            // Re-apply camera transform for shape drawing\r\n            ctx.setTransform(\r\n                cameraScaleRef.current * dpr, 0,\r\n                0, cameraScaleRef.current * dpr,\r\n                cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr\r\n            );\r\n\r\n            drawShape(ctx, tool, [startPosRef.current, currentPos], { color, size, opacity, strokeStyle, fill });\r\n        }\r\n    };\r\n\r\n    const drawArrow = (ctx, fromx, fromy, tox, toy) => {\r\n        const headlen = size * 3;\r\n        const angle = Math.atan2(toy - fromy, tox - fromx);\r\n        ctx.moveTo(fromx, fromy);\r\n        ctx.lineTo(tox, toy);\r\n        ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));\r\n        ctx.moveTo(tox, toy);\r\n        ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));\r\n    };\r\n\r\n    const stopDrawing = () => {\r\n        if (isPanningRef.current) {\r\n            isPanningRef.current = false;\r\n            // Final sync to state for UI consistency\r\n            setCameraOffset(cameraOffsetRef.current);\r\n            return;\r\n        }\r\n\r\n        const canvas = canvasRef.current;\r\n        if (!isDrawingRef.current || !canvas) return;\r\n\r\n        if (animationFrameRef.current) {\r\n            cancelAnimationFrame(animationFrameRef.current);\r\n        }\r\n\r\n        isDrawingRef.current = false;\r\n\r\n        // Save current stroke to state\r\n        let points = [...currentPointsRef.current];\r\n\r\n        // Straight Line Mode: If shift was held, only keep start and end points\r\n        if ([\"pencil\", \"highlighter\", \"soft-brush\", \"marker\", \"smooth-pencil\"].includes(tool) && points.length > 1 && points[points.length - 1].shiftKey) {\r\n            points = [points[0], points[points.length - 1]];\r\n        }\r\n\r\n        const newStroke = {\r\n            id: Date.now() + Math.random(),\r\n            type: tool === 'precision-eraser' ? 'eraser-precision' : tool,\r\n            points: points,\r\n            color: color,\r\n            size: tool === 'precision-eraser' ? 10 : size,\r\n            opacity: tool === 'highlighter' ? 0.4 :\r\n                tool === 'marker' ? 0.6 : opacity,\r\n            strokeStyle,\r\n            fill\r\n        };\r\n\r\n        if (tool !== 'eraser') { // Only save non-eraser strokes to the strokes array\r\n            setStrokes(prev => [...prev, newStroke]);\r\n            socket.emit(\"new-stroke\", { roomId, stroke: newStroke });\r\n        }\r\n\r\n        currentPointsRef.current = [];\r\n\r\n        // The following block is for canvas state history, which is now separate from strokes\r\n        const dataURL = canvas.toDataURL();\r\n        const newHistory = history.slice(0, historyIndex + 1);\r\n        newHistory.push(dataURL);\r\n        setHistory(newHistory);\r\n        setHistoryIndex(newHistory.length - 1);\r\n        socket.emit(\"save-canvas\", { roomId, canvasData: dataURL });\r\n    };\r\n\r\n    const handleUndo = () => {\r\n        if (historyIndex > 0) {\r\n            const newIndex = historyIndex - 1;\r\n            const state = history[newIndex];\r\n            setHistoryIndex(newIndex);\r\n            applyCanvasState(state);\r\n            socket.emit(\"undo\", { roomId, canvasState: state });\r\n            socket.emit(\"save-canvas\", { roomId, canvasData: state });\r\n        }\r\n    };\r\n\r\n    const handleRedo = () => {\r\n        if (historyIndex < history.length - 1) {\r\n            const newIndex = historyIndex + 1;\r\n            const state = history[newIndex];\r\n            setHistoryIndex(newIndex);\r\n            applyCanvasState(state);\r\n            socket.emit(\"redo\", { roomId, canvasState: state });\r\n            socket.emit(\"save-canvas\", { roomId, canvasData: state });\r\n        }\r\n    };\r\n\r\n    const applyCanvasState = (state) => {\r\n        if (!state) return;\r\n        const canvas = canvasRef.current;\r\n        const ctx = contextRef.current;\r\n        if (!canvas || !ctx) return;\r\n\r\n        const img = new Image();\r\n        img.onload = () => {\r\n            // Store background as an offscreen canvas so redraws persist\r\n            try {\r\n                const off = document.createElement('canvas');\r\n                off.width = canvas.width;\r\n                off.height = canvas.height;\r\n                const offCtx = off.getContext('2d');\r\n                offCtx.setTransform(1, 0, 0, 1, 0, 0);\r\n                offCtx.clearRect(0, 0, off.width, off.height);\r\n                offCtx.drawImage(img, 0, 0, off.width, off.height);\r\n                backgroundRef.current = off;\r\n                // Draw immediately\r\n                redrawCanvas();\r\n            } catch (err) {\r\n                console.error('Failed to apply canvas state', err);\r\n            }\r\n        };\r\n        img.src = state;\r\n    };\r\n\r\n    const drawRemote = (data) => {\r\n        const { x, y, prevX, prevY, color, size, opacity, tool } = data;\r\n        const ctx = contextRef.current;\r\n        if (!ctx) return;\r\n\r\n        const dpr = window.devicePixelRatio || 1;\r\n        ctx.save();\r\n\r\n        // Apply camera transform for remote drawings to match local board state\r\n        ctx.setTransform(\r\n            cameraScaleRef.current * dpr, 0,\r\n            0, cameraScaleRef.current * dpr,\r\n            cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr\r\n        );\r\n\r\n        ctx.globalAlpha = opacity || 1;\r\n        ctx.strokeStyle = color;\r\n        ctx.lineWidth = size;\r\n        ctx.lineCap = \"round\";\r\n        ctx.lineJoin = \"round\";\r\n\r\n        // Handle Eraser mode for remotes\r\n        ctx.globalCompositeOperation = (tool === \"precision-eraser\") ? \"destination-out\" : \"source-over\";\r\n\r\n        ctx.beginPath();\r\n        if (prevX && prevY) {\r\n            ctx.moveTo(prevX, prevY);\r\n        } else {\r\n            ctx.moveTo(x, y);\r\n        }\r\n        ctx.lineTo(x, y);\r\n        ctx.stroke();\r\n        ctx.restore();\r\n    };\r\n\r\n    const eraseRemote = (data) => {\r\n        const { x, y, size } = data;\r\n        const ctx = contextRef.current;\r\n        if (!ctx) return;\r\n\r\n        const dpr = window.devicePixelRatio || 1;\r\n        ctx.save();\r\n\r\n        // Apply camera transform for object-based erasures\r\n        ctx.setTransform(\r\n            cameraScaleRef.current * dpr, 0,\r\n            0, cameraScaleRef.current * dpr,\r\n            cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr\r\n        );\r\n\r\n        ctx.globalCompositeOperation = \"destination-out\";\r\n        ctx.beginPath();\r\n        ctx.arc(x, y, size, 0, Math.PI * 2);\r\n        ctx.fill();\r\n        ctx.restore();\r\n    };\r\n\r\n    const handleClearBoard = () => {\r\n        if (window.confirm('Clear all drawings for everyone?'))\r\n            socket.emit('clear-board', { roomId, userId: user._id });\r\n    };\r\n\r\n    // â”€â”€â”€ Export canvas as PNG â”€â”€â”€\r\n    const downloadCanvas = () => {\r\n        const canvas = canvasRef.current;\r\n        if (!canvas) return;\r\n        const link = document.createElement('a');\r\n        link.download = `${room?.roomName || 'whiteboard'}-${Date.now()}.png`;\r\n        link.href = canvas.toDataURL('image/png');\r\n        link.click();\r\n        toast.success('Board exported as PNG!');\r\n    };\r\n\r\n    // â”€â”€â”€ Handle Image Upload to Canvas â”€â”€â”€\r\n    const handleImageUpload = (e) => {\r\n        const file = e.target.files[0];\r\n        if (!file) return;\r\n        const reader = new FileReader();\r\n        reader.onload = (ev) => {\r\n            const src = ev.target.result;\r\n            const img = new window.Image();\r\n            img.onload = () => {\r\n                const maxW = 400;\r\n                const scale = Math.min(1, maxW / img.width);\r\n                const imgW = Math.round(img.width * scale);\r\n                const imgH = Math.round(img.height * scale);\r\n                const pos = imagePlacePosRef.current;\r\n                // Cache & draw immediately\r\n                imageCache.current.set(src, img);\r\n                const ctx = contextRef.current;\r\n                if (ctx) {\r\n                    const dpr = window.devicePixelRatio || 1;\r\n                    ctx.save();\r\n                    ctx.setTransform(\r\n                        cameraScaleRef.current * dpr, 0,\r\n                        0, cameraScaleRef.current * dpr,\r\n                        cameraOffsetRef.current.x * dpr, cameraOffsetRef.current.y * dpr\r\n                    );\r\n                    ctx.globalAlpha = opacity;\r\n                    ctx.drawImage(img, pos.x, pos.y, imgW, imgH);\r\n                    ctx.restore();\r\n                }\r\n                // Save to strokes\r\n                const imageStroke = {\r\n                    id: Date.now() + Math.random(),\r\n                    type: 'image', src,\r\n                    points: [pos], imgW, imgH,\r\n                    color, size, opacity, strokeStyle, fill\r\n                };\r\n                setStrokes(prev => [...prev, imageStroke]);\r\n                if (socket) socket.emit('new-stroke', { roomId, stroke: imageStroke });\r\n                // Save canvas history\r\n                const dataURL = canvasRef.current?.toDataURL();\r\n                if (dataURL) {\r\n                    setHistory(prev => { const nh = [...prev.slice(0, historyIndex + 1), dataURL]; setHistoryIndex(nh.length - 1); return nh; });\r\n                    if (socket) socket.emit('save-canvas', { roomId, canvasData: dataURL });\r\n                }\r\n            };\r\n            img.src = src;\r\n        };\r\n        reader.readAsDataURL(file);\r\n        e.target.value = '';\r\n    };\r\n\r\n    // â”€â”€â”€ Keyboard Shortcuts (run-once on mount) â”€â”€â”€\r\n    React.useEffect(() => {\r\n        const onKey = (e) => {\r\n            if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;\r\n            if (e.ctrlKey || e.metaKey) {\r\n                if (e.key === 'z') { e.preventDefault(); handleUndo(); }\r\n                if (e.key === 'y') { e.preventDefault(); handleRedo(); }\r\n                return;\r\n            }\r\n            const map = { v: 'select', h: 'pan', p: 'pencil', e: 'eraser', t: 'text' };\r\n            if (map[e.key.toLowerCase()]) setTool(map[e.key.toLowerCase()]);\r\n        };\r\n        window.addEventListener('keydown', onKey);\r\n        return () => window.removeEventListener('keydown', onKey);\r\n    }, []);\r\n\r\n    // â”€â”€â”€ Screen Sharing â”€â”€â”€\r\n    const startScreenShare = async () => {\r\n        try {\r\n            if (screenStream) {\r\n                screenStream.getTracks().forEach(t => t.stop());\r\n                setScreenStream(null);\r\n                socket.emit('screen-share-stopped', { roomId });\r\n                toast('Screen sharing stopped');\r\n                return;\r\n            }\r\n            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });\r\n            setScreenStream(stream);\r\n            socket.emit('screen-share-started', { roomId, userId: user._id, userName: user.name });\r\n            stream.getVideoTracks()[0].onended = () => {\r\n                setScreenStream(null);\r\n                socket.emit('screen-share-stopped', { roomId });\r\n                toast('Screen sharing stopped');\r\n            };\r\n            toast.success('Screen sharing started!');\r\n        } catch (err) {\r\n            if (err.name !== 'NotAllowedError') toast.error('Screen sharing failed');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"wb-layout-container\">\r\n            {/* Header */}\r\n            <header className=\"wb-header-miro\">\r\n                <div className=\"flex items-center gap-6\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"w-9 h-9 bg-violet-600 rounded-lg flex items-center justify-center cursor-pointer shadow-lg shadow-violet-200\" onClick={() => navigate('/dashboard')}>\r\n                            <span className=\"text-white font-black text-lg\">S</span>\r\n                        </div>\r\n                        <div>\r\n                            <h1 className=\"font-bold text-slate-800 leading-tight text-sm truncate max-w-[150px]\">{room?.roomName || 'Untitled Board'}</h1>\r\n                            <span className=\"text-[10px] text-slate-400 font-bold uppercase tracking-widest\">{participants.length} online</span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"w-px h-8 bg-slate-100\"></div>\r\n\r\n                    {/* Navbar Styling Controls */}\r\n                    {isDrawingTool && (\r\n                        <div className=\"flex items-center gap-6 animate-in fade-in slide-in-from-left-4 duration-300\">\r\n                            {/* Color Picker */}\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <div className=\"grid grid-cols-5 gap-1 pt-0.5\">\r\n                                    {colors.slice(0, 5).map(c => (\r\n                                        <button\r\n                                            key={c}\r\n                                            onClick={() => setColor(c)}\r\n                                            className={`w-4 h-4 rounded-full border border-slate-200 transition-all ${color === c ? 'ring-2 ring-violet-500 ring-offset-1 scale-110' : 'hover:scale-110'}`}\r\n                                            style={{ backgroundColor: c }}\r\n                                        />\r\n                                    ))}\r\n                                </div>\r\n                                <div className=\"grid grid-cols-5 gap-1 pt-0.5\">\r\n                                    {colors.slice(5).map(c => (\r\n                                        <button\r\n                                            key={c}\r\n                                            onClick={() => setColor(c)}\r\n                                            className={`w-4 h-4 rounded-full border border-slate-200 transition-all ${color === c ? 'ring-2 ring-violet-500 ring-offset-1 scale-110' : 'hover:scale-110'}`}\r\n                                            style={{ backgroundColor: c }}\r\n                                        />\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"w-px h-6 bg-slate-100\"></div>\r\n\r\n                            {/* Size Slider */}\r\n                            <div className=\"flex items-center gap-3 w-32\">\r\n                                <span className=\"text-[9px] font-bold text-slate-400 uppercase tracking-widest\">Size</span>\r\n                                <input\r\n                                    type=\"range\" min=\"1\" max=\"40\" value={size}\r\n                                    onChange={(e) => setSize(parseInt(e.target.value))}\r\n                                    className=\"w-full accent-violet-600 h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer\"\r\n                                />\r\n                                <span className=\"text-[10px] font-mono font-bold text-slate-600 min-w-[20px]\">{size}</span>\r\n                            </div>\r\n\r\n                            <div className=\"w-px h-6 bg-slate-100\"></div>\r\n\r\n                            {/* Opacity Control */}\r\n                            <div className=\"flex items-center gap-3 w-32\">\r\n                                <span className=\"text-[9px] font-bold text-slate-400 uppercase tracking-widest\">Opacity</span>\r\n                                <input\r\n                                    type=\"range\" min=\"0.1\" max=\"1\" step=\"0.1\" value={opacity}\r\n                                    onChange={(e) => setOpacity(parseFloat(e.target.value))}\r\n                                    className=\"w-full accent-violet-600 h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer\"\r\n                                />\r\n                                <span className=\"text-[10px] font-mono font-bold text-slate-600 min-w-[25px]\">{Math.round(opacity * 100)}%</span>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-3\">\r\n                    <button className=\"btn-secondary-miro\" onClick={downloadCanvas}>Export PNG</button>\r\n                    <button className=\"btn-secondary-miro\" onClick={() => {\r\n                        navigator.clipboard.writeText(window.location.href);\r\n                        toast.success('Link copied!');\r\n                    }}>Invite</button>\r\n                    <button\r\n                        className={`btn-primary-miro ${screenStream ? '!bg-red-500 !shadow-red-200 hover:!bg-red-600' : ''}`}\r\n                        onClick={startScreenShare}\r\n                    >\r\n                        {screenStream ? 'Stop Sharing' : 'Share Screen'}\r\n                    </button>\r\n                    <div className=\"w-px h-6 bg-slate-200 mx-1\"></div>\r\n                    <button className=\"tool-button\" onClick={() => setIsSidebarOpen(!isSidebarOpen)}>\r\n                        <span className=\"text-lg\">ðŸ’¬</span>\r\n                    </button>\r\n                </div>\r\n            </header>\r\n\r\n            {/* Left Sidebar */}\r\n            <aside className=\"wb-left-panel\">\r\n                <Toolbar\r\n                    activeTool={tool}\r\n                    setTool={handleToolChange}\r\n                    isHost={room?.host?.toString() === user._id || room?.host?._id === user._id}\r\n                    onClear={handleClearBoard}\r\n                    onUndo={handleUndo}\r\n                    onRedo={handleRedo}\r\n                    onDelete={() => { }}\r\n                />\r\n            </aside>\r\n\r\n            {/* Viewport & Canvas (Infinite Background) */}\r\n            {/* Viewport & Canvas (Full Page Surface) */}\r\n            <main\r\n                ref={viewportRef}\r\n                className=\"wb-viewport relative overflow-hidden cursor-default bg-white\"\r\n                style={{\r\n                    backgroundImage: 'radial-gradient(#cbd5e1 1px, transparent 1px)',\r\n                    backgroundSize: `${24 * cameraScale}px ${24 * cameraScale}px`,\r\n                    backgroundPosition: `${cameraOffset.x}px ${cameraOffset.y}px`\r\n                }}\r\n            >\r\n                {/* Main Viewport Canvas */}\r\n                <canvas\r\n                    ref={canvasRef}\r\n                    className=\"absolute inset-0 w-full h-full\"\r\n                    style={{ cursor: canvasCursor }}\r\n                    onMouseDown={startDrawing}\r\n                    onMouseMove={handleMouseMove}\r\n                    onMouseUp={stopDrawing}\r\n                    onMouseOut={stopDrawing}\r\n                />\r\n\r\n                {/* Floating Styling Panel (Secondary Controls: Stroke & Fill) */}\r\n                {/* Hidden file input for Upload Image tool */}\r\n                <input\r\n                    type=\"file\" accept=\"image/*\" className=\"hidden\"\r\n                    ref={imageFileRef}\r\n                    onChange={handleImageUpload}\r\n                />\r\n\r\n                <StylingPanel\r\n                    tool={tool}\r\n                    visible={showStyling}\r\n                    strokeStyle={strokeStyle} setStrokeStyle={setStrokeStyle}\r\n                    fill={fill} setFill={setFill}\r\n                />\r\n\r\n                {/* Zoom Controls Overlay */}\r\n                <div className=\"absolute bottom-6 right-6 flex items-center gap-2 bg-white p-1 rounded-xl shadow-lg border border-slate-200 z-50\">\r\n                    <button\r\n                        onClick={() => {\r\n                            cameraScaleRef.current = 1;\r\n                            cameraOffsetRef.current = { x: -4000 + window.innerWidth / 2, y: -4000 + window.innerHeight / 2 };\r\n                            setCameraScale(1); setCameraOffset(cameraOffsetRef.current); syncViewDOM();\r\n                        }}\r\n                        className=\"w-12 h-8 hover:bg-slate-50 rounded-lg text-xs font-bold text-slate-600 transition-colors\"\r\n                    >\r\n                        {Math.round(cameraScale * 100)}%\r\n                    </button>\r\n                    <div className=\"w-px h-4 bg-slate-100\"></div>\r\n                    <button onClick={() => updateZoom(1.1)} className=\"w-8 h-8 hover:bg-slate-50 rounded-lg flex items-center justify-center text-slate-600\">\r\n                        <Plus size={14} />\r\n                    </button>\r\n                    <button onClick={() => updateZoom(1 / 1.1)} className=\"w-8 h-8 hover:bg-slate-50 rounded-lg flex items-center justify-center text-slate-600\">\r\n                        <Minus size={14} />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* â”€â”€â”€ Remote Live Cursors â”€â”€â”€ */}\r\n                {Object.values(remoteCursors).map(cursor => (\r\n                    <div\r\n                        key={cursor.socketId}\r\n                        className=\"fixed pointer-events-none z-[9997] transition-[top,left] duration-75\"\r\n                        style={{ left: cursor.x, top: cursor.y }}\r\n                    >\r\n                        <svg width=\"12\" height=\"16\" viewBox=\"0 0 12 16\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                            <path d=\"M0 0 L0 14 L4 10 L6.5 14.5 L8 13.5 L5.5 9 L10 9 Z\"\r\n                                fill={cursor.color || '#7c3aed'} stroke=\"white\" strokeWidth=\"1\" />\r\n                        </svg>\r\n                        <span className=\"text-[9px] font-bold text-white px-1.5 py-0.5 rounded-full whitespace-nowrap block ml-2 -mt-0.5 shadow-md\"\r\n                            style={{ backgroundColor: cursor.color || '#7c3aed' }}>\r\n                            {cursor.userName}\r\n                        </span>\r\n                    </div>\r\n                ))}\r\n            </main>\r\n\r\n            {/* Right Sidebar */}\r\n            <aside className={`wb-right-panel ${isSidebarOpen ? 'open' : ''}`}>\r\n                <div className=\"flex flex-col h-full\">\r\n                    <div className=\"flex p-2 bg-slate-50 border-b border-slate-200\">\r\n                        {['chat', 'files', 'users'].map((tab) => (\r\n                            <button\r\n                                key={tab}\r\n                                onClick={() => setActiveTab(tab)}\r\n                                className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase tracking-widest\r\n                                          ${activeTab === tab ? \"bg-white text-violet-700 shadow-sm border border-slate-200\" : \"text-slate-500 hover:text-slate-700\"}`}\r\n                            >\r\n                                {tab}\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n                    <div className=\"flex-1 overflow-hidden\">\r\n                        {activeTab === \"chat\" ? (\r\n                            <Chat messages={messages} onSendMessage={(txt) => socket.emit(\"chat-message\", { roomId, message: txt, userId: user._id, userName: user.name })} currentUser={user} />\r\n                        ) : activeTab === \"files\" ? (\r\n                            <div className=\"p-4\">\r\n                                <label className={`btn-secondary-miro w-full flex justify-center cursor-pointer text-xs mb-4 ${loadingFileUpload ? 'opacity-50 cursor-not-allowed' : ''}`}>\r\n                                    <span>{loadingFileUpload ? 'Uploading...' : 'ðŸ“Ž Share Asset'}</span>\r\n                                    <input\r\n                                        type=\"file\"\r\n                                        className=\"hidden\"\r\n                                        disabled={loadingFileUpload}\r\n                                        onChange={async (e) => {\r\n                                            const file = e.target.files[0];\r\n                                            if (!file) return;\r\n                                            setLoadingFileUpload(true);\r\n                                            try {\r\n                                                const fd = new FormData();\r\n                                                fd.append('file', file);\r\n                                                const res = await roomService.uploadFile(roomId, fd);\r\n                                                setSharedFiles(prev => [...prev, res.data.file]);\r\n                                                socket.emit('file-shared', { roomId, file: res.data.file });\r\n                                                toast.success(`${file.name} shared!`);\r\n                                            } catch { toast.error('Upload failed'); }\r\n                                            finally { setLoadingFileUpload(false); e.target.value = ''; }\r\n                                        }}\r\n                                    />\r\n                                </label>\r\n                                <div className=\"space-y-2\">\r\n                                    {sharedFiles.map((f, i) => (\r\n                                        <div key={i} className=\"p-3 bg-slate-50 rounded-lg border border-slate-100 flex items-center justify-between\">\r\n                                            <span className=\"text-xs font-medium truncate max-w-[150px]\">{f.fileName}</span>\r\n                                            <span className=\"text-violet-600\">â¬‡ï¸</span>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"p-4 space-y-2\">\r\n                                {participants.map((p, i) => (\r\n                                    <div key={i} className=\"flex items-center gap-3 p-2 hover:bg-slate-50 rounded-lg\">\r\n                                        <div className=\"w-6 h-6 rounded-full bg-violet-100 flex items-center justify-center text-[10px] font-bold text-violet-700\">{p.userName[0]}</div>\r\n                                        <span className=\"text-xs font-medium text-slate-700\">{p.userName}</span>\r\n                                        <div className=\"w-1.5 h-1.5 rounded-full bg-green-500 ml-auto\"></div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </aside>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default WhiteboardRoom;\r\n"],"mappings":";;AAAA,OAAOA,KAAK,IAAIC,SAAS,EAAEC,MAAM,EAAEC,QAAQ,QAAQ,OAAO;AAC1D,SAASC,SAAS,EAAEC,WAAW,QAAQ,kBAAkB;AACzD,SAASC,OAAO,QAAQ,wBAAwB;AAChD,SAASC,SAAS,QAAQ,0BAA0B;AACpD,SAASC,WAAW,QAAQ,iBAAiB;AAC7C,OAAOC,OAAO,MAAM,uBAAuB;AAC3C,OAAOC,IAAI,MAAM,oBAAoB;AACrC,OAAOC,YAAY,MAAM,4BAA4B;AACrD,OAAOC,KAAK,MAAM,iBAAiB;AACnC,SAASC,IAAI,EAAEC,KAAK,QAAQ,cAAc;AAAC,SAAAC,MAAA,IAAAC,OAAA;AAE3C,MAAMC,cAAc,GAAGA,CAAA,KAAM;EAAAC,EAAA;EAAA,IAAAC,UAAA,EAAAC,WAAA;EACzB,MAAM;IAAEC;EAAO,CAAC,GAAGjB,SAAS,CAAC,CAAC;EAC9B,MAAMkB,QAAQ,GAAGjB,WAAW,CAAC,CAAC;EAC9B,MAAM;IAAEkB;EAAK,CAAC,GAAGjB,OAAO,CAAC,CAAC;EAC1B,MAAM;IAAEkB;EAAO,CAAC,GAAGjB,SAAS,CAAC,CAAC;EAE9B,MAAMkB,SAAS,GAAGvB,MAAM,CAAC,IAAI,CAAC;EAC9B,MAAMwB,WAAW,GAAGxB,MAAM,CAAC,IAAI,CAAC;EAChC,MAAMyB,UAAU,GAAGzB,MAAM,CAAC,IAAI,CAAC;;EAE/B;EACA,MAAM,CAAC0B,IAAI,EAAEC,OAAO,CAAC,GAAG1B,QAAQ,CAAC,QAAQ,CAAC;EAC1C,MAAM,CAAC2B,WAAW,EAAEC,cAAc,CAAC,GAAG5B,QAAQ,CAAC,IAAI,CAAC;EACpD,MAAM,CAAC6B,KAAK,EAAEC,QAAQ,CAAC,GAAG9B,QAAQ,CAAC,SAAS,CAAC;EAC7C,MAAM,CAAC+B,IAAI,EAAEC,OAAO,CAAC,GAAGhC,QAAQ,CAAC,CAAC,CAAC;EACnC,MAAM,CAACiC,OAAO,EAAEC,UAAU,CAAC,GAAGlC,QAAQ,CAAC,CAAC,CAAC;EACzC,MAAM,CAACmC,WAAW,EAAEC,cAAc,CAAC,GAAGpC,QAAQ,CAAC,OAAO,CAAC;EACvD,MAAM,CAACqC,IAAI,EAAEC,OAAO,CAAC,GAAGtC,QAAQ,CAAC,KAAK,CAAC;;EAEvC;EACA,MAAM,CAACuC,WAAW,EAAEC,cAAc,CAAC,GAAGxC,QAAQ,CAAC,CAAC,CAAC;EACjD,MAAM,CAACyC,YAAY,EAAEC,eAAe,CAAC,GAAG1C,QAAQ,CAAC;IAAE2C,CAAC,EAAE,CAAC,IAAI,GAAGC,MAAM,CAACC,UAAU,GAAG,CAAC;IAAEC,CAAC,EAAE,CAAC,IAAI,GAAGF,MAAM,CAACG,WAAW,GAAG;EAAE,CAAC,CAAC;EAEzH,MAAMC,cAAc,GAAGjD,MAAM,CAAC,CAAC,CAAC;EAChC,MAAMkD,eAAe,GAAGlD,MAAM,CAAC;IAAE4C,CAAC,EAAE,CAAC,IAAI,GAAGC,MAAM,CAACC,UAAU,GAAG,CAAC;IAAEC,CAAC,EAAE,CAAC,IAAI,GAAGF,MAAM,CAACG,WAAW,GAAG;EAAE,CAAC,CAAC;EACvG,MAAMG,YAAY,GAAGnD,MAAM,CAAC,KAAK,CAAC;EAClC,MAAMoD,WAAW,GAAGpD,MAAM,CAAC;IAAE4C,CAAC,EAAE,CAAC;IAAEG,CAAC,EAAE;EAAE,CAAC,CAAC;EAC1C,MAAMM,QAAQ,GAAGrD,MAAM,CAAC,IAAI,CAAC;;EAE7B;EACA,MAAM,CAACsD,OAAO,EAAEC,UAAU,CAAC,GAAGtD,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;;EAE5C;EACA,MAAMuD,YAAY,GAAGxD,MAAM,CAAC,KAAK,CAAC;EAClC,MAAMyD,gBAAgB,GAAGzD,MAAM,CAAC,EAAE,CAAC;EACnC,MAAM0D,WAAW,GAAG1D,MAAM,CAAC;IAAE4C,CAAC,EAAE,CAAC;IAAEG,CAAC,EAAE;EAAE,CAAC,CAAC;EAC1C,MAAMY,UAAU,GAAG3D,MAAM,CAAC;IAAE4C,CAAC,EAAE,CAAC;IAAEG,CAAC,EAAE;EAAE,CAAC,CAAC;EACzC,MAAMa,iBAAiB,GAAG5D,MAAM,CAAC,IAAI,CAAC;EACtC,MAAM6D,aAAa,GAAG7D,MAAM,CAAC,IAAI,CAAC;EAClC,MAAM8D,iBAAiB,GAAG9D,MAAM,CAAC,IAAI,CAAC;EACtC,MAAM+D,iBAAiB,GAAG/D,MAAM,CAAC,CAAC,CAAC;EACnC;EACA,MAAMgE,YAAY,GAAGhE,MAAM,CAAC,IAAI,CAAC;EACjC,MAAMiE,gBAAgB,GAAGjE,MAAM,CAAC;IAAE4C,CAAC,EAAE,CAAC;IAAEG,CAAC,EAAE;EAAE,CAAC,CAAC;EAC/C,MAAMmB,UAAU,GAAGlE,MAAM,CAAC,IAAImE,GAAG,CAAC,CAAC,CAAC;EAEpC,MAAMC,MAAM,GAAG,CACX,SAAS,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS,EACrD,SAAS,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS,CACxD;EAED,MAAMC,aAAa,GAAG,CAAC,QAAQ,EAAE,aAAa,EAAE,YAAY,EAAE,QAAQ,EAAE,eAAe,EAAE,kBAAkB,EACvG,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,OAAO,EAAE,cAAc,EAAE,cAAc,EAAE,SAAS,EAC5E,UAAU,EAAE,SAAS,EAAE,QAAQ,EAAE,eAAe,EAAE,eAAe,EACjE,UAAU,EAAE,UAAU,EAAE,OAAO,CAClC,CAACC,QAAQ,CAAC5C,IAAI,CAAC;;EAEhB;EACA,MAAM6C,YAAY,GAAG;IACjBC,MAAM,EAAE,SAAS;IACjBC,GAAG,EAAE,MAAM;IACXC,MAAM,EAAE,MAAM;IACd,kBAAkB,EAAE,MAAM;IAC1BC,IAAI,EAAE,MAAM;IACZC,MAAM,EAAE;EACZ,CAAC,CAAClD,IAAI,CAAC,IAAI,WAAW;EAEtB,MAAMmD,gBAAgB,GAAIC,OAAO,IAAK;IAClC,IAAIpD,IAAI,KAAKoD,OAAO,EAAE;MAClBjD,cAAc,CAAC,CAACD,WAAW,CAAC;IAChC,CAAC,MAAM;MACHD,OAAO,CAACmD,OAAO,CAAC;MAChBjD,cAAc,CAAC,IAAI,CAAC;IACxB;EACJ,CAAC;EAED,MAAM,CAACkD,IAAI,EAAEC,OAAO,CAAC,GAAG/E,QAAQ,CAAC,IAAI,CAAC;EACtC,MAAM,CAACgF,YAAY,EAAEC,eAAe,CAAC,GAAGjF,QAAQ,CAAC,EAAE,CAAC;EACpD,MAAM,CAACkF,QAAQ,EAAEC,WAAW,CAAC,GAAGnF,QAAQ,CAAC,EAAE,CAAC;EAC5C,MAAM,CAACoF,WAAW,EAAEC,cAAc,CAAC,GAAGrF,QAAQ,CAAC,EAAE,CAAC;EAClD,MAAM,CAACsF,SAAS,EAAEC,YAAY,CAAC,GAAGvF,QAAQ,CAAC,MAAM,CAAC;EAClD,MAAM,CAACwF,iBAAiB,EAAEC,oBAAoB,CAAC,GAAGzF,QAAQ,CAAC,KAAK,CAAC;EACjE,MAAM,CAAC0F,YAAY,EAAEC,eAAe,CAAC,GAAG3F,QAAQ,CAAC,IAAI,CAAC;EACtD,MAAM4F,cAAc,GAAG7F,MAAM,CAAC,IAAI,CAAC;EACnC,MAAM,CAAC8F,aAAa,EAAEC,gBAAgB,CAAC,GAAG9F,QAAQ,CAAC,IAAI,CAAC;EACxD,MAAM,CAAC+F,aAAa,EAAEC,gBAAgB,CAAC,GAAGhG,QAAQ,CAAC,CAAC,CAAC,CAAC;;EAEtD;EACA,MAAM,CAACiG,OAAO,EAAEC,UAAU,CAAC,GAAGlG,QAAQ,CAAC,EAAE,CAAC;EAC1C,MAAM,CAACmG,YAAY,EAAEC,eAAe,CAAC,GAAGpG,QAAQ,CAAC,CAAC,CAAC,CAAC;EAEpDF,SAAS,CAAC,MAAM;IACZ,MAAMuG,gBAAgB,GAAG,MAAAA,CAAA,KAAY;MACjC,IAAI;QACA,MAAMC,GAAG,GAAG,MAAMjG,WAAW,CAACkG,OAAO,CAACrF,MAAM,CAAC;QAC7C6D,OAAO,CAACuB,GAAG,CAACE,IAAI,CAAC1B,IAAI,CAAC;QACtBO,cAAc,CAACiB,GAAG,CAACE,IAAI,CAAC1B,IAAI,CAACM,WAAW,IAAI,EAAE,CAAC;MACnD,CAAC,CAAC,OAAOqB,GAAG,EAAE;QACVhG,KAAK,CAACiG,KAAK,CAAC,0BAA0B,CAAC;QACvCvF,QAAQ,CAAC,YAAY,CAAC;MAC1B;IACJ,CAAC;IAEDkF,gBAAgB,CAAC,CAAC;IAElB,IAAIhF,MAAM,EAAE;MACRA,MAAM,CAACsF,IAAI,CAAC,WAAW,EAAE;QAAEzF,MAAM;QAAE0F,MAAM,EAAExF,IAAI,CAACyF,GAAG;QAAEC,QAAQ,EAAE1F,IAAI,CAAC2F;MAAK,CAAC,CAAC;MAE3E1F,MAAM,CAAC2F,EAAE,CAAC,aAAa,EAAGR,IAAI,IAAK/F,KAAK,CAACwG,OAAO,CAAC,GAAGT,IAAI,CAACM,QAAQ,SAAS,CAAC,CAAC;MAC5EzF,MAAM,CAAC2F,EAAE,CAAC,cAAc,EAAGE,KAAK,IAAKjC,eAAe,CAACiC,KAAK,CAAC,CAAC;MAC5D7F,MAAM,CAAC2F,EAAE,CAAC,cAAc,EAAGG,GAAG,IAAKhC,WAAW,CAAEiC,IAAI,IAAK,CAAC,GAAGA,IAAI,EAAED,GAAG,CAAC,CAAC,CAAC;MACzE9F,MAAM,CAAC2F,EAAE,CAAC,cAAc,EAAGK,CAAC,IAAKlC,WAAW,CAACkC,CAAC,CAAC,CAAC;MAChDhG,MAAM,CAAC2F,EAAE,CAAC,SAAS,EAAGR,IAAI,IAAKc,UAAU,CAACd,IAAI,CAAC,CAAC;MAChDnF,MAAM,CAAC2F,EAAE,CAAC,OAAO,EAAGR,IAAI,IAAKe,WAAW,CAACf,IAAI,CAAC,CAAC;MAC/CnF,MAAM,CAAC2F,EAAE,CAAC,eAAe,EAAE,MAAM;QAC7BQ,gBAAgB,CAAC,CAAC;QAClBtB,UAAU,CAAC,EAAE,CAAC;QACdE,eAAe,CAAC,CAAC,CAAC,CAAC;MACvB,CAAC,CAAC;MACF/E,MAAM,CAAC2F,EAAE,CAAC,cAAc,EAAGR,IAAI,IAAK;QAChC,IAAIA,IAAI,EAAE;UACN,IAAIA,IAAI,CAACnD,OAAO,IAAImD,IAAI,CAACnD,OAAO,CAACoE,MAAM,GAAG,CAAC,EAAE;YACzCnE,UAAU,CAACkD,IAAI,CAACnD,OAAO,CAAC;YACxB;YACA;YACAO,aAAa,CAAC8D,OAAO,GAAG,IAAI;YAC5BC,YAAY,CAAC,CAAC;UAClB,CAAC,MAAM,IAAInB,IAAI,CAACoB,KAAK,EAAE;YACnBC,gBAAgB,CAACrB,IAAI,CAACoB,KAAK,CAAC;UAChC;UAEA,MAAME,cAAc,GAAGtB,IAAI,CAACoB,KAAK,IAAI,EAAE;UACvC1B,UAAU,CAAC,CAAC4B,cAAc,CAAC,CAAC;UAC5B1B,eAAe,CAAC,CAAC,CAAC;QACtB;MACJ,CAAC,CAAC;MACF/E,MAAM,CAAC2F,EAAE,CAAC,MAAM,EAAGe,KAAK,IAAKF,gBAAgB,CAACE,KAAK,CAAC,CAAC;MACrD1G,MAAM,CAAC2F,EAAE,CAAC,MAAM,EAAGe,KAAK,IAAKF,gBAAgB,CAACE,KAAK,CAAC,CAAC;MACrD1G,MAAM,CAAC2F,EAAE,CAAC,WAAW,EAAGR,IAAI,IAAK/F,KAAK,CAAC,MAAM+F,IAAI,CAACM,QAAQ,OAAO,CAAC,CAAC;MACnEzF,MAAM,CAAC2F,EAAE,CAAC,YAAY,EAAGgB,MAAM,IAAK1E,UAAU,CAAC8D,IAAI,IAAI,CAAC,GAAGA,IAAI,EAAEY,MAAM,CAAC,CAAC,CAAC;MAC1E3G,MAAM,CAAC2F,EAAE,CAAC,qBAAqB,EAAGiB,cAAc,IAAK3E,UAAU,CAAC2E,cAAc,CAAC,CAAC;MAChF5G,MAAM,CAAC2F,EAAE,CAAC,UAAU,EAAGkB,IAAI,IAAK7C,cAAc,CAAC+B,IAAI,IAAI,CAAC,GAAGA,IAAI,EAAEc,IAAI,CAAC,CAAC,CAAC;MACxE7G,MAAM,CAAC2F,EAAE,CAAC,aAAa,EAAGR,IAAI,IAAK;QAC/BR,gBAAgB,CAACoB,IAAI,KAAK;UAAE,GAAGA,IAAI;UAAE,CAACZ,IAAI,CAAC2B,QAAQ,GAAG3B;QAAK,CAAC,CAAC,CAAC;QAC9D4B,UAAU,CAAC,MAAMpC,gBAAgB,CAACoB,IAAI,IAAI;UAAE,MAAMiB,CAAC,GAAG;YAAE,GAAGjB;UAAK,CAAC;UAAE,OAAOiB,CAAC,CAAC7B,IAAI,CAAC2B,QAAQ,CAAC;UAAE,OAAOE,CAAC;QAAE,CAAC,CAAC,EAAE,IAAI,CAAC;MACnH,CAAC,CAAC;IACN;IAEA,OAAO,MAAM;MACT,IAAIhH,MAAM,EAAE;QACRA,MAAM,CAACsF,IAAI,CAAC,YAAY,EAAE;UAAEzF,MAAM;UAAE0F,MAAM,EAAExF,IAAI,CAACyF,GAAG;UAAEC,QAAQ,EAAE1F,IAAI,CAAC2F;QAAK,CAAC,CAAC;QAC5E,CAAC,aAAa,EAAE,cAAc,EAAE,cAAc,EAAE,cAAc,EAAE,SAAS,EAAE,OAAO,EAC9E,eAAe,EAAE,cAAc,EAAE,MAAM,EAAE,MAAM,EAAE,WAAW,EAAE,YAAY,EAC1E,qBAAqB,EAAE,UAAU,EAAE,aAAa,CAAC,CAACuB,OAAO,CAACC,EAAE,IAAIlH,MAAM,CAACmH,GAAG,CAACD,EAAE,CAAC,CAAC;MACvF;IACJ,CAAC;EACL,CAAC,EAAE,CAACrH,MAAM,EAAEG,MAAM,EAAED,IAAI,EAAED,QAAQ,CAAC,CAAC;EAEpCrB,SAAS,CAAC,MAAM;IACZ,MAAM2I,QAAQ,GAAGlH,WAAW,CAACmG,OAAO;IACpC,MAAMgB,MAAM,GAAGpH,SAAS,CAACoG,OAAO;IAChC,IAAI,CAACe,QAAQ,IAAI,CAACC,MAAM,EAAE;IAE1B,MAAMC,gBAAgB,GAAGA,CAAA,KAAM;MAC3B,MAAMC,GAAG,GAAGhG,MAAM,CAACiG,gBAAgB,IAAI,CAAC;MACxC;MACAH,MAAM,CAACI,KAAK,GAAGL,QAAQ,CAACM,WAAW,GAAGH,GAAG;MACzCF,MAAM,CAACM,MAAM,GAAGP,QAAQ,CAACQ,YAAY,GAAGL,GAAG;MAE3C,MAAMM,OAAO,GAAGR,MAAM,CAACS,UAAU,CAAC,IAAI,EAAE;QAAEC,KAAK,EAAE;MAAK,CAAC,CAAC;MACxD,IAAIF,OAAO,EAAE;QACTA,OAAO,CAACG,OAAO,GAAG,OAAO;QACzBH,OAAO,CAACI,QAAQ,GAAG,OAAO;QAC1B9H,UAAU,CAACkG,OAAO,GAAGwB,OAAO;MAChC;MAEA,IAAI,CAACvF,iBAAiB,CAAC+D,OAAO,EAAE;QAC5B/D,iBAAiB,CAAC+D,OAAO,GAAG6B,QAAQ,CAACC,aAAa,CAAC,QAAQ,CAAC;MAChE;MACA7F,iBAAiB,CAAC+D,OAAO,CAACoB,KAAK,GAAGJ,MAAM,CAACI,KAAK;MAC9CnF,iBAAiB,CAAC+D,OAAO,CAACsB,MAAM,GAAGN,MAAM,CAACM,MAAM;MAEhDrB,YAAY,CAAC,CAAC;IAClB,CAAC;IAED,MAAM8B,EAAE,GAAG,IAAIC,cAAc,CAAC,MAAM;MAChCf,gBAAgB,CAAC,CAAC;IACtB,CAAC,CAAC;IACFc,EAAE,CAACE,OAAO,CAAClB,QAAQ,CAAC;IAEpB,OAAO,MAAMgB,EAAE,CAACG,UAAU,CAAC,CAAC;EAChC,CAAC,EAAE,EAAE,CAAC;EAEN9J,SAAS,CAAC,MAAM;IACZ,MAAM+J,YAAY,GAAGA,CAAA,KAAMC,UAAU,CAAC,GAAG,CAAC;IAC1C,MAAMC,aAAa,GAAGA,CAAA,KAAMD,UAAU,CAAC,CAAC,GAAG,GAAG,CAAC;IAC/C,MAAME,eAAe,GAAGA,CAAA,KAAM;MAC1B,MAAMC,QAAQ,GAAG,CAAC;MAClB,MAAMC,SAAS,GAAG;QAAEvH,CAAC,EAAE,CAAC,IAAI,GAAG,CAAC,GAAGC,MAAM,CAACC,UAAU,GAAG,CAAC;QAAEC,CAAC,EAAE,CAAC,IAAI,GAAG,CAAC,GAAGF,MAAM,CAACG,WAAW,GAAG;MAAE,CAAC;MACjGC,cAAc,CAAC0E,OAAO,GAAGuC,QAAQ;MACjChH,eAAe,CAACyE,OAAO,GAAGwC,SAAS;MACnC1H,cAAc,CAACyH,QAAQ,CAAC;MACxBvH,eAAe,CAACwH,SAAS,CAAC;MAC1BC,WAAW,CAAC,CAAC;IACjB,CAAC;IAEDvH,MAAM,CAACwH,gBAAgB,CAAC,YAAY,EAAEP,YAAY,CAAC;IACnDjH,MAAM,CAACwH,gBAAgB,CAAC,aAAa,EAAEL,aAAa,CAAC;IACrDnH,MAAM,CAACwH,gBAAgB,CAAC,eAAe,EAAEJ,eAAe,CAAC;IAEzD,OAAO,MAAM;MACTpH,MAAM,CAACyH,mBAAmB,CAAC,YAAY,EAAER,YAAY,CAAC;MACtDjH,MAAM,CAACyH,mBAAmB,CAAC,aAAa,EAAEN,aAAa,CAAC;MACxDnH,MAAM,CAACyH,mBAAmB,CAAC,eAAe,EAAEL,eAAe,CAAC;IAChE,CAAC;EACL,CAAC,EAAE,EAAE,CAAC;EAENlK,SAAS,CAAC,MAAM;IACZ,MAAM2I,QAAQ,GAAGlH,WAAW,CAACmG,OAAO;IACpC,IAAI,CAACe,QAAQ,EAAE;IAEf,MAAM6B,WAAW,GAAIC,CAAC,IAAK;MACvBA,CAAC,CAACC,cAAc,CAAC,CAAC;MAElB,IAAID,CAAC,CAACE,OAAO,EAAE;QACX;QACA,MAAMC,SAAS,GAAG,MAAM;QACxB,MAAMC,KAAK,GAAG,CAACJ,CAAC,CAACK,MAAM,GAAGF,SAAS,GAAG1H,cAAc,CAAC0E,OAAO;QAC5D,MAAMuC,QAAQ,GAAGY,IAAI,CAACC,GAAG,CAAC,IAAI,EAAED,IAAI,CAACE,GAAG,CAAC,EAAE,EAAE/H,cAAc,CAAC0E,OAAO,GAAGiD,KAAK,CAAC,CAAC;QAE7E,MAAMK,IAAI,GAAGvC,QAAQ,CAACwC,qBAAqB,CAAC,CAAC;QAC7C,MAAMC,MAAM,GAAGX,CAAC,CAACY,OAAO,GAAGH,IAAI,CAACI,IAAI;QACpC,MAAMC,MAAM,GAAGd,CAAC,CAACe,OAAO,GAAGN,IAAI,CAACO,GAAG;;QAEnC;QACA,MAAMC,MAAM,GAAG,CAACN,MAAM,GAAGjI,eAAe,CAACyE,OAAO,CAAC/E,CAAC,IAAIK,cAAc,CAAC0E,OAAO;QAC5E,MAAM+D,MAAM,GAAG,CAACJ,MAAM,GAAGpI,eAAe,CAACyE,OAAO,CAAC5E,CAAC,IAAIE,cAAc,CAAC0E,OAAO;QAE5E1E,cAAc,CAAC0E,OAAO,GAAGuC,QAAQ;QACjChH,eAAe,CAACyE,OAAO,GAAG;UACtB/E,CAAC,EAAEuI,MAAM,GAAGM,MAAM,GAAGvB,QAAQ;UAC7BnH,CAAC,EAAEuI,MAAM,GAAGI,MAAM,GAAGxB;QACzB,CAAC;QAEDzH,cAAc,CAACyH,QAAQ,CAAC;QACxBvH,eAAe,CAACO,eAAe,CAACyE,OAAO,CAAC;QACxCyC,WAAW,CAAC,CAAC;MACjB,CAAC,MAAM;QACH;QACAlH,eAAe,CAACyE,OAAO,GAAG;UACtB/E,CAAC,EAAEM,eAAe,CAACyE,OAAO,CAAC/E,CAAC,GAAG4H,CAAC,CAACmB,MAAM;UACvC5I,CAAC,EAAEG,eAAe,CAACyE,OAAO,CAAC5E,CAAC,GAAGyH,CAAC,CAACK;QACrC,CAAC;QACDT,WAAW,CAAC,CAAC;QACb;QACAzH,eAAe,CAACO,eAAe,CAACyE,OAAO,CAAC;MAC5C;IACJ,CAAC;IAEDe,QAAQ,CAAC2B,gBAAgB,CAAC,OAAO,EAAEE,WAAW,EAAE;MAAEqB,OAAO,EAAE;IAAM,CAAC,CAAC;IACnE,OAAO,MAAMlD,QAAQ,CAAC4B,mBAAmB,CAAC,OAAO,EAAEC,WAAW,CAAC;EACnE,CAAC,EAAE,EAAE,CAAC;EAEN,MAAMR,UAAU,GAAI8B,MAAM,IAAK;IAC3B,MAAM3B,QAAQ,GAAGY,IAAI,CAACC,GAAG,CAAC,IAAI,EAAED,IAAI,CAACE,GAAG,CAAC,EAAE,EAAE/H,cAAc,CAAC0E,OAAO,GAAGkE,MAAM,CAAC,CAAC;IAC9E,MAAMC,OAAO,GAAGjJ,MAAM,CAACC,UAAU,GAAG,CAAC;IACrC,MAAMiJ,OAAO,GAAGlJ,MAAM,CAACG,WAAW,GAAG,CAAC;IAEtC,MAAMyI,MAAM,GAAG,CAACK,OAAO,GAAG5I,eAAe,CAACyE,OAAO,CAAC/E,CAAC,IAAIK,cAAc,CAAC0E,OAAO;IAC7E,MAAM+D,MAAM,GAAG,CAACK,OAAO,GAAG7I,eAAe,CAACyE,OAAO,CAAC5E,CAAC,IAAIE,cAAc,CAAC0E,OAAO;IAE7E1E,cAAc,CAAC0E,OAAO,GAAGuC,QAAQ;IACjChH,eAAe,CAACyE,OAAO,GAAG;MACtB/E,CAAC,EAAEkJ,OAAO,GAAGL,MAAM,GAAGvB,QAAQ;MAC9BnH,CAAC,EAAEgJ,OAAO,GAAGL,MAAM,GAAGxB;IAC1B,CAAC;IAEDzH,cAAc,CAACyH,QAAQ,CAAC;IACxBvH,eAAe,CAACO,eAAe,CAACyE,OAAO,CAAC;IACxCyC,WAAW,CAAC,CAAC;EACjB,CAAC;EAED,MAAMA,WAAW,GAAGA,CAAA,KAAM;IACtB;IACA;IACA,IAAI5I,WAAW,CAACmG,OAAO,EAAE;MACrB,MAAMqE,KAAK,GAAG/I,cAAc,CAAC0E,OAAO;MACpC,MAAMsE,EAAE,GAAG/I,eAAe,CAACyE,OAAO,CAAC/E,CAAC;MACpC,MAAMsJ,EAAE,GAAGhJ,eAAe,CAACyE,OAAO,CAAC5E,CAAC;MACpCvB,WAAW,CAACmG,OAAO,CAACwE,KAAK,CAACC,cAAc,GAAG,GAAG,EAAE,GAAGJ,KAAK,MAAM,EAAE,GAAGA,KAAK,IAAI;MAC5ExK,WAAW,CAACmG,OAAO,CAACwE,KAAK,CAACE,kBAAkB,GAAG,GAAGJ,EAAE,MAAMC,EAAE,IAAI;IACpE;IACAtE,YAAY,CAAC,CAAC;EAClB,CAAC;EAED,MAAMA,YAAY,GAAGA,CAAA,KAAM;IACvB,MAAMe,MAAM,GAAGpH,SAAS,CAACoG,OAAO;IAChC,MAAM2E,GAAG,GAAG7K,UAAU,CAACkG,OAAO;IAC9B,IAAI,CAACgB,MAAM,IAAI,CAAC2D,GAAG,EAAE;IAErB,MAAMzD,GAAG,GAAGhG,MAAM,CAACiG,gBAAgB,IAAI,CAAC;;IAExC;IACAwD,GAAG,CAACC,YAAY,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;IAClCD,GAAG,CAACE,SAAS,CAAC,CAAC,EAAE,CAAC,EAAE7D,MAAM,CAACI,KAAK,EAAEJ,MAAM,CAACM,MAAM,CAAC;;IAEhD;IACA,IAAIpF,aAAa,CAAC8D,OAAO,EAAE;MACvB,IAAI;QACA2E,GAAG,CAACG,SAAS,CAAC5I,aAAa,CAAC8D,OAAO,EAAE,CAAC,EAAE,CAAC,EAAEgB,MAAM,CAACI,KAAK,EAAEJ,MAAM,CAACM,MAAM,CAAC;MAC3E,CAAC,CAAC,OAAOvC,GAAG,EAAE;QACV;MAAA;IAER;;IAEA;IACA4F,GAAG,CAACC,YAAY,CACZtJ,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAAE,CAAC,EAC/B,CAAC,EAAE5F,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAC/B3F,eAAe,CAACyE,OAAO,CAAC/E,CAAC,GAAGiG,GAAG,EAAE3F,eAAe,CAACyE,OAAO,CAAC5E,CAAC,GAAG8F,GACjE,CAAC;;IAED;IACAvF,OAAO,CAACiF,OAAO,CAACN,MAAM,IAAI;MACtByE,YAAY,CAACJ,GAAG,EAAErE,MAAM,CAAC;IAC7B,CAAC,CAAC;EACN,CAAC;EAEDlI,SAAS,CAAC,MAAM;IACZ6H,YAAY,CAAC,CAAC;EAClB,CAAC,EAAE,CAACtE,OAAO,CAAC,CAAC;EAEb,MAAMmE,gBAAgB,GAAGA,CAAA,KAAM;IAC3BlE,UAAU,CAAC,EAAE,CAAC;IACdqE,YAAY,CAAC,CAAC;EAClB,CAAC;EAED,MAAM8E,YAAY,GAAGA,CAACJ,GAAG,EAAErE,MAAM,KAAK;IAClC,MAAM;MAAE0E,IAAI;MAAEC,MAAM;MAAE9K,KAAK;MAAEE,IAAI;MAAEE,OAAO;MAAEE,WAAW;MAAEE;IAAK,CAAC,GAAG2F,MAAM;;IAExE;IACA,IAAI0E,IAAI,KAAK,MAAM,EAAE;MACjBL,GAAG,CAACO,IAAI,CAAC,CAAC;MACVP,GAAG,CAACQ,IAAI,GAAG,QAAQ9K,IAAI,sBAAsB;MAC7CsK,GAAG,CAACS,SAAS,GAAGjL,KAAK;MACrBwK,GAAG,CAACU,WAAW,GAAG9K,OAAO;MACzBoK,GAAG,CAACW,wBAAwB,GAAG,aAAa;MAC5CX,GAAG,CAACY,UAAU,GAAG,CAAC;MAClBZ,GAAG,CAACa,QAAQ,CAAClF,MAAM,CAACtD,IAAI,IAAI,EAAE,EAAEiI,MAAM,CAAC,CAAC,CAAC,CAAChK,CAAC,EAAEgK,MAAM,CAAC,CAAC,CAAC,CAAC7J,CAAC,CAAC;MACzDuJ,GAAG,CAACc,OAAO,CAAC,CAAC;MACb;IACJ;;IAEA;IACA,IAAIT,IAAI,KAAK,OAAO,EAAE;MAClB,MAAMU,MAAM,GAAGnJ,UAAU,CAACyD,OAAO,CAAC2F,GAAG,CAACrF,MAAM,CAACsF,GAAG,CAAC;MACjD,IAAIF,MAAM,EAAE;QACRf,GAAG,CAACO,IAAI,CAAC,CAAC;QACVP,GAAG,CAACU,WAAW,GAAG/E,MAAM,CAAC/F,OAAO,IAAI,CAAC;QACrCoK,GAAG,CAACG,SAAS,CAACY,MAAM,EAAET,MAAM,CAAC,CAAC,CAAC,CAAChK,CAAC,EAAEgK,MAAM,CAAC,CAAC,CAAC,CAAC7J,CAAC,EAAEkF,MAAM,CAACuF,IAAI,IAAI,GAAG,EAAEvF,MAAM,CAACwF,IAAI,IAAI,GAAG,CAAC;QACvFnB,GAAG,CAACc,OAAO,CAAC,CAAC;MACjB,CAAC,MAAM;QACH,MAAMM,GAAG,GAAG,IAAI7K,MAAM,CAAC8K,KAAK,CAAC,CAAC;QAC9BD,GAAG,CAACE,MAAM,GAAG,MAAM;UAAE1J,UAAU,CAACyD,OAAO,CAACkG,GAAG,CAAC5F,MAAM,CAACsF,GAAG,EAAEG,GAAG,CAAC;UAAE9F,YAAY,CAAC,CAAC;QAAE,CAAC;QAC/E8F,GAAG,CAACH,GAAG,GAAGtF,MAAM,CAACsF,GAAG;MACxB;MACA;IACJ;IAEAjB,GAAG,CAACO,IAAI,CAAC,CAAC;IAEV,IAAIF,IAAI,KAAK,kBAAkB,IAAIA,IAAI,KAAK,MAAM,EAAE;MAChDL,GAAG,CAACW,wBAAwB,GAAG,iBAAiB;IACpD,CAAC,MAAM;MACHX,GAAG,CAACW,wBAAwB,GAAG,aAAa;MAC5CX,GAAG,CAACU,WAAW,GAAG9K,OAAO;MACzBoK,GAAG,CAAClK,WAAW,GAAGN,KAAK;MACvBwK,GAAG,CAACS,SAAS,GAAGjL,KAAK;MACrBwK,GAAG,CAACwB,SAAS,GAAG9L,IAAI;MACpBsK,GAAG,CAACyB,WAAW,CAAC3L,WAAW,KAAK,QAAQ,GAAG,CAAC,EAAE,EAAE,EAAE,CAAC,GAAG,EAAE,CAAC;MAEzD,IAAIuK,IAAI,KAAK,YAAY,EAAE;QACvBL,GAAG,CAACY,UAAU,GAAGlL,IAAI,GAAG,CAAC;QACzBsK,GAAG,CAAC0B,WAAW,GAAGlM,KAAK;MAC3B;MACA,IAAI6K,IAAI,KAAK,QAAQ,EAAE;QACnBL,GAAG,CAACU,WAAW,GAAG9K,OAAO,GAAG,GAAG;MACnC;IACJ;IAEA,IAAI,CAAC,QAAQ,EAAE,aAAa,EAAE,YAAY,EAAE,QAAQ,EAAE,eAAe,EAAE,kBAAkB,CAAC,CAACoC,QAAQ,CAACqI,IAAI,CAAC,EAAE;MACvG,IAAIC,MAAM,CAAClF,MAAM,GAAG,CAAC,EAAE;QACnB4E,GAAG,CAACc,OAAO,CAAC,CAAC;QACb;MACJ;MACAd,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAAC4B,MAAM,CAACtB,MAAM,CAAC,CAAC,CAAC,CAAChK,CAAC,EAAEgK,MAAM,CAAC,CAAC,CAAC,CAAC7J,CAAC,CAAC;MACpC,KAAK,IAAIoL,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGvB,MAAM,CAAClF,MAAM,EAAEyG,CAAC,EAAE,EAAE;QACpC7B,GAAG,CAAC8B,MAAM,CAACxB,MAAM,CAACuB,CAAC,CAAC,CAACvL,CAAC,EAAEgK,MAAM,CAACuB,CAAC,CAAC,CAACpL,CAAC,CAAC;MACxC;MACAuJ,GAAG,CAACrE,MAAM,CAAC,CAAC;IAChB,CAAC,MAAM;MACHoG,SAAS,CAAC/B,GAAG,EAAEK,IAAI,EAAEC,MAAM,EAAE;QAAE9K,KAAK;QAAEE,IAAI;QAAEE,OAAO;QAAEE,WAAW;QAAEE;MAAK,CAAC,CAAC;IAC7E;IACAgK,GAAG,CAACc,OAAO,CAAC,CAAC;EACjB,CAAC;EAED,MAAMiB,SAAS,GAAGA,CAAC/B,GAAG,EAAEK,IAAI,EAAEC,MAAM,EAAET,KAAK,KAAK;IAC5C,MAAMmC,KAAK,GAAG1B,MAAM,CAAC,CAAC,CAAC;IACvB,MAAM2B,GAAG,GAAG3B,MAAM,CAACA,MAAM,CAAClF,MAAM,GAAG,CAAC,CAAC;IACrC,MAAM8G,CAAC,GAAGD,GAAG,CAAC3L,CAAC,GAAG0L,KAAK,CAAC1L,CAAC;IACzB,MAAM0E,CAAC,GAAGiH,GAAG,CAACxL,CAAC,GAAGuL,KAAK,CAACvL,CAAC;IAEzB,IAAI4J,IAAI,KAAK,MAAM,EAAE;MACjB,IAAIR,KAAK,CAAC7J,IAAI,EAAEgK,GAAG,CAACmC,QAAQ,CAACH,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,EAAEyL,CAAC,EAAElH,CAAC,CAAC;MACpDgF,GAAG,CAACoC,UAAU,CAACJ,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,EAAEyL,CAAC,EAAElH,CAAC,CAAC;IAC1C,CAAC,MAAM,IAAIqF,IAAI,KAAK,cAAc,EAAE;MAChCL,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAACqC,SAAS,CAACL,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,EAAEyL,CAAC,EAAElH,CAAC,EAAEwD,IAAI,CAACE,GAAG,CAACF,IAAI,CAAC8D,GAAG,CAACJ,CAAC,CAAC,EAAE1D,IAAI,CAAC8D,GAAG,CAACtH,CAAC,CAAC,CAAC,GAAG,GAAG,CAAC;MAC/E,IAAI6E,KAAK,CAAC7J,IAAI,EAAEgK,GAAG,CAAChK,IAAI,CAAC,CAAC;MAC1BgK,GAAG,CAACrE,MAAM,CAAC,CAAC;IAChB,CAAC,MAAM,IAAI0E,IAAI,KAAK,QAAQ,IAAIA,IAAI,KAAK,SAAS,EAAE;MAChDL,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf,IAAItB,IAAI,KAAK,QAAQ,EAAE;QACnB,MAAMkC,MAAM,GAAG/D,IAAI,CAACgE,IAAI,CAACN,CAAC,GAAGA,CAAC,GAAGlH,CAAC,GAAGA,CAAC,CAAC;QACvCgF,GAAG,CAACyC,GAAG,CAACT,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,EAAE8L,MAAM,EAAE,CAAC,EAAE,CAAC,GAAG/D,IAAI,CAACkE,EAAE,CAAC;MACrD,CAAC,MAAM;QACH1C,GAAG,CAAC2C,OAAO,CAACX,KAAK,CAAC1L,CAAC,GAAG4L,CAAC,GAAG,CAAC,EAAEF,KAAK,CAACvL,CAAC,GAAGuE,CAAC,GAAG,CAAC,EAAEwD,IAAI,CAAC8D,GAAG,CAACJ,CAAC,GAAG,CAAC,CAAC,EAAE1D,IAAI,CAAC8D,GAAG,CAACtH,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGwD,IAAI,CAACkE,EAAE,CAAC;MACtG;MACA,IAAI7C,KAAK,CAAC7J,IAAI,EAAEgK,GAAG,CAAChK,IAAI,CAAC,CAAC;MAC1BgK,GAAG,CAACrE,MAAM,CAAC,CAAC;IAChB,CAAC,MAAM,IAAI0E,IAAI,KAAK,UAAU,EAAE;MAC5BL,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAAC4B,MAAM,CAACI,KAAK,CAAC1L,CAAC,GAAG4L,CAAC,GAAG,CAAC,EAAEF,KAAK,CAACvL,CAAC,CAAC;MACpCuJ,GAAG,CAAC8B,MAAM,CAACG,GAAG,CAAC3L,CAAC,EAAE2L,GAAG,CAACxL,CAAC,CAAC;MACxBuJ,GAAG,CAAC8B,MAAM,CAACE,KAAK,CAAC1L,CAAC,EAAE2L,GAAG,CAACxL,CAAC,CAAC;MAC1BuJ,GAAG,CAAC4C,SAAS,CAAC,CAAC;MACf,IAAI/C,KAAK,CAAC7J,IAAI,EAAEgK,GAAG,CAAChK,IAAI,CAAC,CAAC;MAC1BgK,GAAG,CAACrE,MAAM,CAAC,CAAC;IAChB,CAAC,MAAM,IAAI0E,IAAI,KAAK,SAAS,EAAE;MAC3BL,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAAC4B,MAAM,CAACI,KAAK,CAAC1L,CAAC,GAAG4L,CAAC,GAAG,CAAC,EAAEF,KAAK,CAACvL,CAAC,CAAC;MACpCuJ,GAAG,CAAC8B,MAAM,CAACG,GAAG,CAAC3L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,GAAGuE,CAAC,GAAG,CAAC,CAAC;MAClCgF,GAAG,CAAC8B,MAAM,CAACE,KAAK,CAAC1L,CAAC,GAAG4L,CAAC,GAAG,CAAC,EAAED,GAAG,CAACxL,CAAC,CAAC;MAClCuJ,GAAG,CAAC8B,MAAM,CAACE,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,GAAGuE,CAAC,GAAG,CAAC,CAAC;MACpCgF,GAAG,CAAC4C,SAAS,CAAC,CAAC;MACf,IAAI/C,KAAK,CAAC7J,IAAI,EAAEgK,GAAG,CAAChK,IAAI,CAAC,CAAC;MAC1BgK,GAAG,CAACrE,MAAM,CAAC,CAAC;IAChB,CAAC,MAAM,IAAI0E,IAAI,KAAK,MAAM,IAAIA,IAAI,KAAK,OAAO,IAAIA,IAAI,KAAK,cAAc,EAAE;MACvEL,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAAC4B,MAAM,CAACI,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,CAAC;MAC5BuJ,GAAG,CAAC8B,MAAM,CAACG,GAAG,CAAC3L,CAAC,EAAE2L,GAAG,CAACxL,CAAC,CAAC;MACxBuJ,GAAG,CAACrE,MAAM,CAAC,CAAC;MACZ,IAAI0E,IAAI,KAAK,OAAO,IAAIA,IAAI,KAAK,cAAc,EAAE;QAC7CwC,aAAa,CAAC7C,GAAG,EAAEgC,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,EAAEwL,GAAG,CAAC3L,CAAC,EAAE2L,GAAG,CAACxL,CAAC,EAAEoJ,KAAK,CAACnK,IAAI,CAAC;MAClE;MACA,IAAI2K,IAAI,KAAK,cAAc,EAAE;QACzBwC,aAAa,CAAC7C,GAAG,EAAEiC,GAAG,CAAC3L,CAAC,EAAE2L,GAAG,CAACxL,CAAC,EAAEuL,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,EAAEoJ,KAAK,CAACnK,IAAI,CAAC;MAClE;IACJ,CAAC,MAAM,IAAI2K,IAAI,KAAK,QAAQ,EAAE;MAC1BL,GAAG,CAACO,IAAI,CAAC,CAAC;MACVP,GAAG,CAACS,SAAS,GAAGZ,KAAK,CAAC7J,IAAI,GAAG6J,KAAK,CAACrK,KAAK,GAAG,SAAS,CAAC,CAAC;MACtDwK,GAAG,CAACY,UAAU,GAAG,EAAE;MACnBZ,GAAG,CAAC0B,WAAW,GAAG,iBAAiB;MACnC1B,GAAG,CAACmC,QAAQ,CAACH,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,EAAEyL,CAAC,EAAElH,CAAC,CAAC;MACpCgF,GAAG,CAAClK,WAAW,GAAG,kBAAkB;MACpCkK,GAAG,CAACoC,UAAU,CAACJ,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,EAAEyL,CAAC,EAAElH,CAAC,CAAC;MACtCgF,GAAG,CAACc,OAAO,CAAC,CAAC;IACjB,CAAC,MAAM,IAAIT,IAAI,KAAK,eAAe,EAAE;MACjCL,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAACqC,SAAS,CAACL,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,EAAEyL,CAAC,EAAElH,CAAC,GAAG,GAAG,EAAE,EAAE,CAAC;MAC/CgF,GAAG,CAAC4B,MAAM,CAACI,KAAK,CAAC1L,CAAC,GAAG4L,CAAC,GAAG,GAAG,EAAEF,KAAK,CAACvL,CAAC,GAAGuE,CAAC,GAAG,GAAG,CAAC;MAChDgF,GAAG,CAAC8B,MAAM,CAACE,KAAK,CAAC1L,CAAC,GAAG4L,CAAC,GAAG,GAAG,EAAED,GAAG,CAACxL,CAAC,CAAC;MACpCuJ,GAAG,CAAC8B,MAAM,CAACE,KAAK,CAAC1L,CAAC,GAAG4L,CAAC,GAAG,GAAG,EAAEF,KAAK,CAACvL,CAAC,GAAGuE,CAAC,GAAG,GAAG,CAAC;MAChD,IAAI6E,KAAK,CAAC7J,IAAI,EAAEgK,GAAG,CAAChK,IAAI,CAAC,CAAC;MAC1BgK,GAAG,CAACrE,MAAM,CAAC,CAAC;IAChB,CAAC,MAAM,IAAI0E,IAAI,KAAK,eAAe,EAAE;MACjC,MAAMyC,KAAK,GAAGZ,CAAC,GAAG,GAAG;MACrBlC,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAAC4B,MAAM,CAACI,KAAK,CAAC1L,CAAC,GAAGwM,KAAK,EAAEd,KAAK,CAACvL,CAAC,CAAC;MACpCuJ,GAAG,CAAC8B,MAAM,CAACG,GAAG,CAAC3L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,CAAC;MAC1BuJ,GAAG,CAAC8B,MAAM,CAACG,GAAG,CAAC3L,CAAC,GAAGwM,KAAK,EAAEb,GAAG,CAACxL,CAAC,CAAC;MAChCuJ,GAAG,CAAC8B,MAAM,CAACE,KAAK,CAAC1L,CAAC,EAAE2L,GAAG,CAACxL,CAAC,CAAC;MAC1BuJ,GAAG,CAAC4C,SAAS,CAAC,CAAC;MACf,IAAI/C,KAAK,CAAC7J,IAAI,EAAEgK,GAAG,CAAChK,IAAI,CAAC,CAAC;MAC1BgK,GAAG,CAACrE,MAAM,CAAC,CAAC;IAChB,CAAC,MAAM,IAAI0E,IAAI,KAAK,UAAU,EAAE;MAC5B,MAAM0C,EAAE,GAAGvE,IAAI,CAAC8D,GAAG,CAACtH,CAAC,GAAG,GAAG,CAAC;MAC5B;MACAgF,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAAC2C,OAAO,CAACX,KAAK,CAAC1L,CAAC,GAAG4L,CAAC,GAAG,CAAC,EAAED,GAAG,CAACxL,CAAC,GAAGsM,EAAE,EAAEvE,IAAI,CAAC8D,GAAG,CAACJ,CAAC,GAAG,CAAC,CAAC,EAAEa,EAAE,EAAE,CAAC,EAAE,CAAC,EAAEvE,IAAI,CAACkE,EAAE,EAAE,KAAK,CAAC;MACnF1C,GAAG,CAACrE,MAAM,CAAC,CAAC;MACZ;MACAqE,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAAC4B,MAAM,CAACI,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,GAAGsM,EAAE,CAAC;MACjC/C,GAAG,CAAC8B,MAAM,CAACE,KAAK,CAAC1L,CAAC,EAAE2L,GAAG,CAACxL,CAAC,GAAGsM,EAAE,CAAC;MAC/B/C,GAAG,CAAC4B,MAAM,CAACK,GAAG,CAAC3L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,GAAGsM,EAAE,CAAC;MAC/B/C,GAAG,CAAC8B,MAAM,CAACG,GAAG,CAAC3L,CAAC,EAAE2L,GAAG,CAACxL,CAAC,GAAGsM,EAAE,CAAC;MAC7B/C,GAAG,CAACrE,MAAM,CAAC,CAAC;MACZ;MACAqE,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAAC2C,OAAO,CAACX,KAAK,CAAC1L,CAAC,GAAG4L,CAAC,GAAG,CAAC,EAAEF,KAAK,CAACvL,CAAC,GAAGsM,EAAE,EAAEvE,IAAI,CAAC8D,GAAG,CAACJ,CAAC,GAAG,CAAC,CAAC,EAAEa,EAAE,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGvE,IAAI,CAACkE,EAAE,CAAC;MAClF,IAAI7C,KAAK,CAAC7J,IAAI,EAAEgK,GAAG,CAAChK,IAAI,CAAC,CAAC;MAC1BgK,GAAG,CAACrE,MAAM,CAAC,CAAC;IAChB,CAAC,MAAM,IAAI0E,IAAI,KAAK,UAAU,EAAE;MAC5B,MAAM2C,IAAI,GAAGxE,IAAI,CAACE,GAAG,CAACwD,CAAC,EAAElH,CAAC,CAAC,GAAG,GAAG;MACjCgF,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAAC4B,MAAM,CAACI,KAAK,CAAC1L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,CAAC;MAC5BuJ,GAAG,CAAC8B,MAAM,CAACG,GAAG,CAAC3L,CAAC,GAAG0M,IAAI,EAAEhB,KAAK,CAACvL,CAAC,CAAC;MACjCuJ,GAAG,CAAC8B,MAAM,CAACG,GAAG,CAAC3L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,GAAGuM,IAAI,CAAC;MACjChD,GAAG,CAAC8B,MAAM,CAACG,GAAG,CAAC3L,CAAC,EAAE2L,GAAG,CAACxL,CAAC,CAAC;MACxBuJ,GAAG,CAAC8B,MAAM,CAACE,KAAK,CAAC1L,CAAC,EAAE2L,GAAG,CAACxL,CAAC,CAAC;MAC1BuJ,GAAG,CAAC4C,SAAS,CAAC,CAAC;MACf,IAAI/C,KAAK,CAAC7J,IAAI,EAAEgK,GAAG,CAAChK,IAAI,CAAC,CAAC;MAC1BgK,GAAG,CAACrE,MAAM,CAAC,CAAC;MACZ;MACAqE,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAAC4B,MAAM,CAACK,GAAG,CAAC3L,CAAC,GAAG0M,IAAI,EAAEhB,KAAK,CAACvL,CAAC,CAAC;MACjCuJ,GAAG,CAAC8B,MAAM,CAACG,GAAG,CAAC3L,CAAC,GAAG0M,IAAI,EAAEhB,KAAK,CAACvL,CAAC,GAAGuM,IAAI,CAAC;MACxChD,GAAG,CAAC8B,MAAM,CAACG,GAAG,CAAC3L,CAAC,EAAE0L,KAAK,CAACvL,CAAC,GAAGuM,IAAI,CAAC;MACjChD,GAAG,CAACrE,MAAM,CAAC,CAAC;IAChB,CAAC,MAAM,IAAI0E,IAAI,KAAK,OAAO,EAAE;MACzBL,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf,MAAMsB,EAAE,GAAGjB,KAAK,CAAC1L,CAAC,GAAG4L,CAAC,GAAG,CAAC;MAC1B,MAAMgB,EAAE,GAAGlB,KAAK,CAACvL,CAAC,GAAGuE,CAAC,GAAG,CAAC;MAC1BgF,GAAG,CAACyC,GAAG,CAACQ,EAAE,GAAGf,CAAC,GAAG,GAAG,EAAEgB,EAAE,EAAE1E,IAAI,CAAC8D,GAAG,CAACtH,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGwD,IAAI,CAACkE,EAAE,CAAC;MAC5D1C,GAAG,CAACyC,GAAG,CAACQ,EAAE,GAAGf,CAAC,GAAG,GAAG,EAAEgB,EAAE,EAAE1E,IAAI,CAAC8D,GAAG,CAACtH,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGwD,IAAI,CAACkE,EAAE,CAAC;MAC5D1C,GAAG,CAACyC,GAAG,CAACQ,EAAE,EAAEC,EAAE,GAAGlI,CAAC,GAAG,GAAG,EAAEwD,IAAI,CAAC8D,GAAG,CAACtH,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGwD,IAAI,CAACkE,EAAE,CAAC;MAC5D1C,GAAG,CAACyC,GAAG,CAACQ,EAAE,EAAEC,EAAE,GAAGlI,CAAC,GAAG,GAAG,EAAEwD,IAAI,CAAC8D,GAAG,CAACtH,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGwD,IAAI,CAACkE,EAAE,CAAC;MAC5D,IAAI7C,KAAK,CAAC7J,IAAI,EAAEgK,GAAG,CAAChK,IAAI,CAAC,CAAC;MAC1BgK,GAAG,CAACrE,MAAM,CAAC,CAAC;IAChB;EACJ,CAAC;EAED,MAAMkH,aAAa,GAAGA,CAAC7C,GAAG,EAAEmD,KAAK,EAAEC,KAAK,EAAEC,GAAG,EAAEC,GAAG,EAAEC,MAAM,KAAK;IAC3D,MAAMC,OAAO,GAAGD,MAAM,GAAG,CAAC;IAC1B,MAAME,KAAK,GAAGjF,IAAI,CAACkF,KAAK,CAACJ,GAAG,GAAGF,KAAK,EAAEC,GAAG,GAAGF,KAAK,CAAC;IAClDnD,GAAG,CAACO,IAAI,CAAC,CAAC;IACVP,GAAG,CAAC2D,SAAS,CAACN,GAAG,EAAEC,GAAG,CAAC;IACvBtD,GAAG,CAAC4D,MAAM,CAACH,KAAK,CAAC;IACjBzD,GAAG,CAAC2B,SAAS,CAAC,CAAC;IACf3B,GAAG,CAAC4B,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC;IAChB5B,GAAG,CAAC8B,MAAM,CAAC,CAAC0B,OAAO,EAAE,CAACA,OAAO,GAAG,CAAC,CAAC;IAClCxD,GAAG,CAAC8B,MAAM,CAAC,CAAC0B,OAAO,EAAEA,OAAO,GAAG,CAAC,CAAC;IACjCxD,GAAG,CAAC4C,SAAS,CAAC,CAAC;IACf5C,GAAG,CAAChK,IAAI,CAAC,CAAC;IACVgK,GAAG,CAACc,OAAO,CAAC,CAAC;EACjB,CAAC;EAGD,MAAM+C,WAAW,GAAI3F,CAAC,IAAK;IACvB,MAAM9B,QAAQ,GAAGlH,WAAW,CAACmG,OAAO;IACpC,IAAI,CAACe,QAAQ,EAAE,OAAO;MAAE9F,CAAC,EAAE,CAAC;MAAEG,CAAC,EAAE;IAAE,CAAC;IACpC,MAAMkI,IAAI,GAAGvC,QAAQ,CAACwC,qBAAqB,CAAC,CAAC;;IAE7C;IACA,OAAO;MACHtI,CAAC,EAAE,CAAC4H,CAAC,CAACY,OAAO,GAAGH,IAAI,CAACI,IAAI,GAAGnI,eAAe,CAACyE,OAAO,CAAC/E,CAAC,IAAIK,cAAc,CAAC0E,OAAO;MAC/E5E,CAAC,EAAE,CAACyH,CAAC,CAACe,OAAO,GAAGN,IAAI,CAACO,GAAG,GAAGtI,eAAe,CAACyE,OAAO,CAAC5E,CAAC,IAAIE,cAAc,CAAC0E;IAC3E,CAAC;EACL,CAAC;EAED,MAAMyI,YAAY,GAAI5F,CAAC,IAAK;IACxB;IACA,IAAIA,CAAC,CAAC6F,MAAM,KAAK,CAAC,IAAI3O,IAAI,KAAK,KAAK,EAAE;MAClCyB,YAAY,CAACwE,OAAO,GAAG,IAAI;MAC3BvE,WAAW,CAACuE,OAAO,GAAG;QAAE/E,CAAC,EAAE4H,CAAC,CAACY,OAAO,GAAGlI,eAAe,CAACyE,OAAO,CAAC/E,CAAC;QAAEG,CAAC,EAAEyH,CAAC,CAACe,OAAO,GAAGrI,eAAe,CAACyE,OAAO,CAAC5E;MAAE,CAAC;MAC5G;IACJ;IAEA,MAAM4F,MAAM,GAAGpH,SAAS,CAACoG,OAAO;IAChC,IAAI,CAACgB,MAAM,IAAI,CAAClH,UAAU,CAACkG,OAAO,EAAE;IAEpC,MAAM2I,GAAG,GAAGH,WAAW,CAAC3F,CAAC,CAAC;;IAE1B;IACA,IAAI9I,IAAI,KAAK,QAAQ,EAAE;;IAEvB;IACA,IAAIA,IAAI,KAAK,QAAQ,EAAE;MAAA,IAAA6O,qBAAA;MACnBtM,gBAAgB,CAAC0D,OAAO,GAAG2I,GAAG;MAC9B,CAAAC,qBAAA,GAAAvM,YAAY,CAAC2D,OAAO,cAAA4I,qBAAA,uBAApBA,qBAAA,CAAsBC,KAAK,CAAC,CAAC;MAC7B;IACJ;IAEA,IAAI9O,IAAI,KAAK,QAAQ,EAAE;MACnB+O,aAAa,CAACH,GAAG,CAAC;MAClB;IACJ;;IAEA;IACA,IAAI5O,IAAI,KAAK,MAAM,EAAE;MACjB,MAAMgP,SAAS,GAAGC,MAAM,CAAC,aAAa,CAAC;MACvC,IAAI,CAACD,SAAS,EAAE;MAChB,MAAMpE,GAAG,GAAG7K,UAAU,CAACkG,OAAO;MAC9B,IAAI,CAAC2E,GAAG,EAAE;MACV,MAAMzD,GAAG,GAAGhG,MAAM,CAACiG,gBAAgB,IAAI,CAAC;MACxCwD,GAAG,CAACC,YAAY,CACZtJ,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAAE,CAAC,EAC/B,CAAC,EAAE5F,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAC/B3F,eAAe,CAACyE,OAAO,CAAC/E,CAAC,GAAGiG,GAAG,EAAE3F,eAAe,CAACyE,OAAO,CAAC5E,CAAC,GAAG8F,GACjE,CAAC;MACDyD,GAAG,CAACQ,IAAI,GAAG,QAAQ9K,IAAI,GAAG,CAAC,sBAAsB;MACjDsK,GAAG,CAACS,SAAS,GAAGjL,KAAK;MACrBwK,GAAG,CAACU,WAAW,GAAG9K,OAAO;MACzBoK,GAAG,CAACW,wBAAwB,GAAG,aAAa;MAC5CX,GAAG,CAACY,UAAU,GAAG,CAAC;MAClBZ,GAAG,CAACa,QAAQ,CAACuD,SAAS,EAAEJ,GAAG,CAAC1N,CAAC,EAAE0N,GAAG,CAACvN,CAAC,CAAC;MACrC,MAAM6N,UAAU,GAAG;QACfC,EAAE,EAAEC,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGjG,IAAI,CAACkG,MAAM,CAAC,CAAC;QAAErE,IAAI,EAAE,MAAM;QAAEhI,IAAI,EAAE+L,SAAS;QAC7D9D,MAAM,EAAE,CAAC0D,GAAG,CAAC;QAAExO,KAAK;QAAEE,IAAI,EAAEA,IAAI,GAAG,CAAC;QAAEE,OAAO;QAAEE,WAAW;QAAEE;MAChE,CAAC;MACDiB,UAAU,CAAC8D,IAAI,IAAI,CAAC,GAAGA,IAAI,EAAEuJ,UAAU,CAAC,CAAC;MACzCtP,MAAM,CAACsF,IAAI,CAAC,YAAY,EAAE;QAAEzF,MAAM;QAAE8G,MAAM,EAAE2I;MAAW,CAAC,CAAC;MACzD,MAAMK,OAAO,GAAG1P,SAAS,CAACoG,OAAO,CAACuJ,SAAS,CAAC,CAAC;MAC7C,MAAMC,EAAE,GAAGjL,OAAO,CAACkL,KAAK,CAAC,CAAC,EAAEhL,YAAY,GAAG,CAAC,CAAC;MAAE+K,EAAE,CAACE,IAAI,CAACJ,OAAO,CAAC;MAC/D9K,UAAU,CAACgL,EAAE,CAAC;MAAE9K,eAAe,CAAC8K,EAAE,CAACzJ,MAAM,GAAG,CAAC,CAAC;MAC9CpG,MAAM,CAACsF,IAAI,CAAC,aAAa,EAAE;QAAEzF,MAAM;QAAEmQ,UAAU,EAAEL;MAAQ,CAAC,CAAC;MAC3D;IACJ;;IAEA;IACAzN,YAAY,CAACmE,OAAO,GAAG,IAAI;IAC3BlE,gBAAgB,CAACkE,OAAO,GAAG,CAAC2I,GAAG,CAAC;IAChC5M,WAAW,CAACiE,OAAO,GAAG2I,GAAG;IACzB3M,UAAU,CAACgE,OAAO,GAAG2I,GAAG;;IAExB;IACA,MAAMiB,OAAO,GAAG3N,iBAAiB,CAAC+D,OAAO,CAACyB,UAAU,CAAC,IAAI,CAAC;IAC1DmI,OAAO,CAAChF,YAAY,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;IACtCgF,OAAO,CAAC/E,SAAS,CAAC,CAAC,EAAE,CAAC,EAAE7D,MAAM,CAACI,KAAK,EAAEJ,MAAM,CAACM,MAAM,CAAC;IACpDsI,OAAO,CAAC9E,SAAS,CAAC9D,MAAM,EAAE,CAAC,EAAE,CAAC,CAAC;IAE/B,IAAItE,aAAa,EAAE;MACf,MAAMiI,GAAG,GAAG7K,UAAU,CAACkG,OAAO;MAC9B,MAAMkB,GAAG,GAAGhG,MAAM,CAACiG,gBAAgB,IAAI,CAAC;;MAExC;MACAwD,GAAG,CAACC,YAAY,CACZtJ,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAAE,CAAC,EAC/B,CAAC,EAAE5F,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAC/B3F,eAAe,CAACyE,OAAO,CAAC/E,CAAC,GAAGiG,GAAG,EAAE3F,eAAe,CAACyE,OAAO,CAAC5E,CAAC,GAAG8F,GACjE,CAAC;MAEDyD,GAAG,CAAC2B,SAAS,CAAC,CAAC;MACf3B,GAAG,CAAC4B,MAAM,CAACoC,GAAG,CAAC1N,CAAC,EAAE0N,GAAG,CAACvN,CAAC,CAAC;;MAExB;MACAuJ,GAAG,CAACwB,SAAS,GAAG9L,IAAI;MACpBsK,GAAG,CAAClK,WAAW,GAAGN,KAAK;MACvBwK,GAAG,CAACU,WAAW,GAAGtL,IAAI,KAAK,aAAa,GAAIQ,OAAO,GAAG,GAAG,GACrDR,IAAI,KAAK,QAAQ,GAAIQ,OAAO,GAAG,GAAG,GAAIA,OAAO;MACjDoK,GAAG,CAACyB,WAAW,CAAC3L,WAAW,KAAK,QAAQ,GAAG,CAAC,EAAE,EAAE,EAAE,CAAC,GAAG,EAAE,CAAC;MACzDkK,GAAG,CAAChD,OAAO,GAAG,OAAO;MACrBgD,GAAG,CAAC/C,QAAQ,GAAG,OAAO;MACtB+C,GAAG,CAACW,wBAAwB,GAAIvL,IAAI,KAAK,kBAAkB,GAAI,iBAAiB,GAAG,aAAa;;MAEhG;MACA4K,GAAG,CAACY,UAAU,GAAG,CAAC;IACtB;EACJ,CAAC;EAED,MAAMsE,eAAe,GAAIhH,CAAC,IAAK;IAC3B;IACA,MAAMuG,GAAG,GAAGD,IAAI,CAACC,GAAG,CAAC,CAAC;IACtB,IAAIzP,MAAM,IAAIyP,GAAG,GAAGhN,iBAAiB,CAAC4D,OAAO,GAAG,EAAE,EAAE;MAChD5D,iBAAiB,CAAC4D,OAAO,GAAGoJ,GAAG;MAC/BzP,MAAM,CAACsF,IAAI,CAAC,aAAa,EAAE;QAAEzF,MAAM;QAAEsQ,UAAU,EAAE;UAAE7O,CAAC,EAAE4H,CAAC,CAACY,OAAO;UAAErI,CAAC,EAAEyH,CAAC,CAACe,OAAO;UAAExE,QAAQ,EAAE1F,IAAI,CAAC2F,IAAI;UAAElF;QAAM;MAAE,CAAC,CAAC;IAClH;IAEA,IAAIqB,YAAY,CAACwE,OAAO,EAAE;MACtBzE,eAAe,CAACyE,OAAO,GAAG;QACtB/E,CAAC,EAAE4H,CAAC,CAACY,OAAO,GAAGhI,WAAW,CAACuE,OAAO,CAAC/E,CAAC;QACpCG,CAAC,EAAEyH,CAAC,CAACe,OAAO,GAAGnI,WAAW,CAACuE,OAAO,CAAC5E;MACvC,CAAC;MACDqH,WAAW,CAAC,CAAC;MACb;IACJ;IAEA,IAAI5G,YAAY,CAACmE,OAAO,EAAE;MACtB,IAAI7D,iBAAiB,CAAC6D,OAAO,EAAE;QAC3B+J,oBAAoB,CAAC5N,iBAAiB,CAAC6D,OAAO,CAAC;MACnD;MACA;MACA,MAAMyD,OAAO,GAAGZ,CAAC,CAACY,OAAO;MACzB,MAAMG,OAAO,GAAGf,CAAC,CAACe,OAAO;MACzB,MAAMoG,QAAQ,GAAGnH,CAAC,CAACmH,QAAQ;MAE3B7N,iBAAiB,CAAC6D,OAAO,GAAGiK,qBAAqB,CAAC,MAAMC,IAAI,CAAC;QAAEzG,OAAO;QAAEG,OAAO;QAAEoG;MAAS,CAAC,CAAC,CAAC;IACjG,CAAC,MAAM,IAAIjQ,IAAI,KAAK,QAAQ,IAAI8I,CAAC,CAACsH,OAAO,KAAK,CAAC,EAAE;MAC7CrB,aAAa,CAACN,WAAW,CAAC3F,CAAC,CAAC,CAAC;IACjC;EACJ,CAAC;EAED,MAAMiG,aAAa,GAAIH,GAAG,IAAK;IAC3B;IACA,MAAMyB,SAAS,GAAG,EAAE,CAAC,CAAC;IACtB,MAAM7J,cAAc,GAAG5E,OAAO,CAAC0O,MAAM,CAAC/J,MAAM,IAAI;MAC5C,OAAO,CAACA,MAAM,CAAC2E,MAAM,CAACqF,IAAI,CAACC,CAAC,IAAI;QAC5B,MAAMC,IAAI,GAAGrH,IAAI,CAACgE,IAAI,CAAChE,IAAI,CAACsH,GAAG,CAACF,CAAC,CAACtP,CAAC,GAAG0N,GAAG,CAAC1N,CAAC,EAAE,CAAC,CAAC,GAAGkI,IAAI,CAACsH,GAAG,CAACF,CAAC,CAACnP,CAAC,GAAGuN,GAAG,CAACvN,CAAC,EAAE,CAAC,CAAC,CAAC;QAC3E,OAAOoP,IAAI,GAAGJ,SAAS;MAC3B,CAAC,CAAC;IACN,CAAC,CAAC;IAEF,IAAI7J,cAAc,CAACR,MAAM,KAAKpE,OAAO,CAACoE,MAAM,EAAE;MAC1CnE,UAAU,CAAC2E,cAAc,CAAC;MAC1B5G,MAAM,CAACsF,IAAI,CAAC,oBAAoB,EAAE;QAAEzF,MAAM;QAAEmC,OAAO,EAAE4E;MAAe,CAAC,CAAC;IAC1E;EACJ,CAAC;EAED,MAAM2J,IAAI,GAAIrH,CAAC,IAAK;IAChB,IAAI,CAAChH,YAAY,CAACmE,OAAO,IAAI,CAAClG,UAAU,CAACkG,OAAO,EAAE;IAClD,MAAM2I,GAAG,GAAGH,WAAW,CAAC3F,CAAC,CAAC;IAC1B,IAAI6H,UAAU,GAAG/B,GAAG;;IAEpB;IACA,IAAI5O,IAAI,KAAK,eAAe,IAAI+B,gBAAgB,CAACkE,OAAO,CAACD,MAAM,GAAG,CAAC,EAAE;MACjE,MAAM4K,SAAS,GAAG7O,gBAAgB,CAACkE,OAAO,CAAClE,gBAAgB,CAACkE,OAAO,CAACD,MAAM,GAAG,CAAC,CAAC;MAC/E2K,UAAU,GAAG;QACTzP,CAAC,EAAE0P,SAAS,CAAC1P,CAAC,GAAG,GAAG,GAAG0N,GAAG,CAAC1N,CAAC,GAAG,GAAG;QAAE;QACpCG,CAAC,EAAEuP,SAAS,CAACvP,CAAC,GAAG,GAAG,GAAGuN,GAAG,CAACvN,CAAC,GAAG,GAAG;QAClC4O,QAAQ,EAAEnH,CAAC,CAACmH;MAChB,CAAC;IACL,CAAC,MAAM;MACHU,UAAU,GAAG;QAAE,GAAG/B,GAAG;QAAEqB,QAAQ,EAAEnH,CAAC,CAACmH;MAAS,CAAC;IACjD;IAEAlO,gBAAgB,CAACkE,OAAO,CAAC0J,IAAI,CAACgB,UAAU,CAAC;IACzC,MAAM/F,GAAG,GAAG7K,UAAU,CAACkG,OAAO;IAE9B,IAAI,CAAC,QAAQ,EAAE,aAAa,EAAE,YAAY,EAAE,QAAQ,EAAE,eAAe,EAAE,kBAAkB,CAAC,CAACrD,QAAQ,CAAC5C,IAAI,CAAC,EAAE;MACvG;MACA,IAAI8I,CAAC,CAACmH,QAAQ,EAAE;QACZ/J,YAAY,CAAC,CAAC,CAAC,CAAC;QAChB0E,GAAG,CAAC2B,SAAS,CAAC,CAAC;QACf3B,GAAG,CAAC4B,MAAM,CAACxK,WAAW,CAACiE,OAAO,CAAC/E,CAAC,EAAEc,WAAW,CAACiE,OAAO,CAAC5E,CAAC,CAAC;QACxDuJ,GAAG,CAAC8B,MAAM,CAACiE,UAAU,CAACzP,CAAC,EAAEyP,UAAU,CAACtP,CAAC,CAAC;QACtCuJ,GAAG,CAACrE,MAAM,CAAC,CAAC;QACZ;MACJ;MAEAqE,GAAG,CAAC8B,MAAM,CAACiE,UAAU,CAACzP,CAAC,EAAEyP,UAAU,CAACtP,CAAC,CAAC;MACtCuJ,GAAG,CAACrE,MAAM,CAAC,CAAC;;MAEZ;MACA3G,MAAM,CAACsF,IAAI,CAAC,SAAS,EAAE;QACnBzF,MAAM;QACNoR,WAAW,EAAE;UACT3P,CAAC,EAAEyP,UAAU,CAACzP,CAAC;UACfG,CAAC,EAAEsP,UAAU,CAACtP,CAAC;UACfyP,KAAK,EAAE7O,UAAU,CAACgE,OAAO,CAAC/E,CAAC;UAC3B6P,KAAK,EAAE9O,UAAU,CAACgE,OAAO,CAAC5E,CAAC;UAC3BjB,KAAK;UACLE,IAAI;UACJE,OAAO,EAAEoK,GAAG,CAACU,WAAW;UACxBtL;QACJ;MACJ,CAAC,CAAC;MAEFiC,UAAU,CAACgE,OAAO,GAAG0K,UAAU;IACnC,CAAC,MAAM,IAAI,CAAC,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,OAAO,EAAE,cAAc,EAAE,cAAc,EAAE,SAAS,EAAE,UAAU,EAAE,SAAS,EAAE,QAAQ,EAAE,eAAe,EAAE,eAAe,EAAE,UAAU,EAAE,UAAU,EAAE,OAAO,CAAC,CAAC/N,QAAQ,CAAC5C,IAAI,CAAC,EAAE;MAC1M,MAAMmH,GAAG,GAAGhG,MAAM,CAACiG,gBAAgB,IAAI,CAAC;MACxCwD,GAAG,CAACC,YAAY,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;MAClCD,GAAG,CAACE,SAAS,CAAC,CAAC,EAAE,CAAC,EAAEjL,SAAS,CAACoG,OAAO,CAACoB,KAAK,EAAExH,SAAS,CAACoG,OAAO,CAACsB,MAAM,CAAC;MACtEqD,GAAG,CAACG,SAAS,CAAC7I,iBAAiB,CAAC+D,OAAO,EAAE,CAAC,EAAE,CAAC,CAAC;;MAE9C;MACA2E,GAAG,CAACC,YAAY,CACZtJ,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAAE,CAAC,EAC/B,CAAC,EAAE5F,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAC/B3F,eAAe,CAACyE,OAAO,CAAC/E,CAAC,GAAGiG,GAAG,EAAE3F,eAAe,CAACyE,OAAO,CAAC5E,CAAC,GAAG8F,GACjE,CAAC;MAEDwF,SAAS,CAAC/B,GAAG,EAAE5K,IAAI,EAAE,CAACgC,WAAW,CAACiE,OAAO,EAAE0K,UAAU,CAAC,EAAE;QAAEvQ,KAAK;QAAEE,IAAI;QAAEE,OAAO;QAAEE,WAAW;QAAEE;MAAK,CAAC,CAAC;IACxG;EACJ,CAAC;EAED,MAAMoQ,SAAS,GAAGA,CAACpG,GAAG,EAAEmD,KAAK,EAAEC,KAAK,EAAEC,GAAG,EAAEC,GAAG,KAAK;IAC/C,MAAME,OAAO,GAAG9N,IAAI,GAAG,CAAC;IACxB,MAAM+N,KAAK,GAAGjF,IAAI,CAACkF,KAAK,CAACJ,GAAG,GAAGF,KAAK,EAAEC,GAAG,GAAGF,KAAK,CAAC;IAClDnD,GAAG,CAAC4B,MAAM,CAACuB,KAAK,EAAEC,KAAK,CAAC;IACxBpD,GAAG,CAAC8B,MAAM,CAACuB,GAAG,EAAEC,GAAG,CAAC;IACpBtD,GAAG,CAAC8B,MAAM,CAACuB,GAAG,GAAGG,OAAO,GAAGhF,IAAI,CAAC6H,GAAG,CAAC5C,KAAK,GAAGjF,IAAI,CAACkE,EAAE,GAAG,CAAC,CAAC,EAAEY,GAAG,GAAGE,OAAO,GAAGhF,IAAI,CAAC8H,GAAG,CAAC7C,KAAK,GAAGjF,IAAI,CAACkE,EAAE,GAAG,CAAC,CAAC,CAAC;IACxG1C,GAAG,CAAC4B,MAAM,CAACyB,GAAG,EAAEC,GAAG,CAAC;IACpBtD,GAAG,CAAC8B,MAAM,CAACuB,GAAG,GAAGG,OAAO,GAAGhF,IAAI,CAAC6H,GAAG,CAAC5C,KAAK,GAAGjF,IAAI,CAACkE,EAAE,GAAG,CAAC,CAAC,EAAEY,GAAG,GAAGE,OAAO,GAAGhF,IAAI,CAAC8H,GAAG,CAAC7C,KAAK,GAAGjF,IAAI,CAACkE,EAAE,GAAG,CAAC,CAAC,CAAC;EAC5G,CAAC;EAED,MAAM6D,WAAW,GAAGA,CAAA,KAAM;IACtB,IAAI1P,YAAY,CAACwE,OAAO,EAAE;MACtBxE,YAAY,CAACwE,OAAO,GAAG,KAAK;MAC5B;MACAhF,eAAe,CAACO,eAAe,CAACyE,OAAO,CAAC;MACxC;IACJ;IAEA,MAAMgB,MAAM,GAAGpH,SAAS,CAACoG,OAAO;IAChC,IAAI,CAACnE,YAAY,CAACmE,OAAO,IAAI,CAACgB,MAAM,EAAE;IAEtC,IAAI7E,iBAAiB,CAAC6D,OAAO,EAAE;MAC3B+J,oBAAoB,CAAC5N,iBAAiB,CAAC6D,OAAO,CAAC;IACnD;IAEAnE,YAAY,CAACmE,OAAO,GAAG,KAAK;;IAE5B;IACA,IAAIiF,MAAM,GAAG,CAAC,GAAGnJ,gBAAgB,CAACkE,OAAO,CAAC;;IAE1C;IACA,IAAI,CAAC,QAAQ,EAAE,aAAa,EAAE,YAAY,EAAE,QAAQ,EAAE,eAAe,CAAC,CAACrD,QAAQ,CAAC5C,IAAI,CAAC,IAAIkL,MAAM,CAAClF,MAAM,GAAG,CAAC,IAAIkF,MAAM,CAACA,MAAM,CAAClF,MAAM,GAAG,CAAC,CAAC,CAACiK,QAAQ,EAAE;MAC9I/E,MAAM,GAAG,CAACA,MAAM,CAAC,CAAC,CAAC,EAAEA,MAAM,CAACA,MAAM,CAAClF,MAAM,GAAG,CAAC,CAAC,CAAC;IACnD;IAEA,MAAMoL,SAAS,GAAG;MACdjC,EAAE,EAAEC,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGjG,IAAI,CAACkG,MAAM,CAAC,CAAC;MAC9BrE,IAAI,EAAEjL,IAAI,KAAK,kBAAkB,GAAG,kBAAkB,GAAGA,IAAI;MAC7DkL,MAAM,EAAEA,MAAM;MACd9K,KAAK,EAAEA,KAAK;MACZE,IAAI,EAAEN,IAAI,KAAK,kBAAkB,GAAG,EAAE,GAAGM,IAAI;MAC7CE,OAAO,EAAER,IAAI,KAAK,aAAa,GAAG,GAAG,GACjCA,IAAI,KAAK,QAAQ,GAAG,GAAG,GAAGQ,OAAO;MACrCE,WAAW;MACXE;IACJ,CAAC;IAED,IAAIZ,IAAI,KAAK,QAAQ,EAAE;MAAE;MACrB6B,UAAU,CAAC8D,IAAI,IAAI,CAAC,GAAGA,IAAI,EAAEyL,SAAS,CAAC,CAAC;MACxCxR,MAAM,CAACsF,IAAI,CAAC,YAAY,EAAE;QAAEzF,MAAM;QAAE8G,MAAM,EAAE6K;MAAU,CAAC,CAAC;IAC5D;IAEArP,gBAAgB,CAACkE,OAAO,GAAG,EAAE;;IAE7B;IACA,MAAMsJ,OAAO,GAAGtI,MAAM,CAACuI,SAAS,CAAC,CAAC;IAClC,MAAM6B,UAAU,GAAG7M,OAAO,CAACkL,KAAK,CAAC,CAAC,EAAEhL,YAAY,GAAG,CAAC,CAAC;IACrD2M,UAAU,CAAC1B,IAAI,CAACJ,OAAO,CAAC;IACxB9K,UAAU,CAAC4M,UAAU,CAAC;IACtB1M,eAAe,CAAC0M,UAAU,CAACrL,MAAM,GAAG,CAAC,CAAC;IACtCpG,MAAM,CAACsF,IAAI,CAAC,aAAa,EAAE;MAAEzF,MAAM;MAAEmQ,UAAU,EAAEL;IAAQ,CAAC,CAAC;EAC/D,CAAC;EAED,MAAM+B,UAAU,GAAGA,CAAA,KAAM;IACrB,IAAI5M,YAAY,GAAG,CAAC,EAAE;MAClB,MAAM6M,QAAQ,GAAG7M,YAAY,GAAG,CAAC;MACjC,MAAM4B,KAAK,GAAG9B,OAAO,CAAC+M,QAAQ,CAAC;MAC/B5M,eAAe,CAAC4M,QAAQ,CAAC;MACzBnL,gBAAgB,CAACE,KAAK,CAAC;MACvB1G,MAAM,CAACsF,IAAI,CAAC,MAAM,EAAE;QAAEzF,MAAM;QAAE+R,WAAW,EAAElL;MAAM,CAAC,CAAC;MACnD1G,MAAM,CAACsF,IAAI,CAAC,aAAa,EAAE;QAAEzF,MAAM;QAAEmQ,UAAU,EAAEtJ;MAAM,CAAC,CAAC;IAC7D;EACJ,CAAC;EAED,MAAMmL,UAAU,GAAGA,CAAA,KAAM;IACrB,IAAI/M,YAAY,GAAGF,OAAO,CAACwB,MAAM,GAAG,CAAC,EAAE;MACnC,MAAMuL,QAAQ,GAAG7M,YAAY,GAAG,CAAC;MACjC,MAAM4B,KAAK,GAAG9B,OAAO,CAAC+M,QAAQ,CAAC;MAC/B5M,eAAe,CAAC4M,QAAQ,CAAC;MACzBnL,gBAAgB,CAACE,KAAK,CAAC;MACvB1G,MAAM,CAACsF,IAAI,CAAC,MAAM,EAAE;QAAEzF,MAAM;QAAE+R,WAAW,EAAElL;MAAM,CAAC,CAAC;MACnD1G,MAAM,CAACsF,IAAI,CAAC,aAAa,EAAE;QAAEzF,MAAM;QAAEmQ,UAAU,EAAEtJ;MAAM,CAAC,CAAC;IAC7D;EACJ,CAAC;EAED,MAAMF,gBAAgB,GAAIE,KAAK,IAAK;IAChC,IAAI,CAACA,KAAK,EAAE;IACZ,MAAMW,MAAM,GAAGpH,SAAS,CAACoG,OAAO;IAChC,MAAM2E,GAAG,GAAG7K,UAAU,CAACkG,OAAO;IAC9B,IAAI,CAACgB,MAAM,IAAI,CAAC2D,GAAG,EAAE;IAErB,MAAMoB,GAAG,GAAG,IAAIC,KAAK,CAAC,CAAC;IACvBD,GAAG,CAACE,MAAM,GAAG,MAAM;MACf;MACA,IAAI;QACA,MAAMnF,GAAG,GAAGe,QAAQ,CAACC,aAAa,CAAC,QAAQ,CAAC;QAC5ChB,GAAG,CAACM,KAAK,GAAGJ,MAAM,CAACI,KAAK;QACxBN,GAAG,CAACQ,MAAM,GAAGN,MAAM,CAACM,MAAM;QAC1B,MAAMmK,MAAM,GAAG3K,GAAG,CAACW,UAAU,CAAC,IAAI,CAAC;QACnCgK,MAAM,CAAC7G,YAAY,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;QACrC6G,MAAM,CAAC5G,SAAS,CAAC,CAAC,EAAE,CAAC,EAAE/D,GAAG,CAACM,KAAK,EAAEN,GAAG,CAACQ,MAAM,CAAC;QAC7CmK,MAAM,CAAC3G,SAAS,CAACiB,GAAG,EAAE,CAAC,EAAE,CAAC,EAAEjF,GAAG,CAACM,KAAK,EAAEN,GAAG,CAACQ,MAAM,CAAC;QAClDpF,aAAa,CAAC8D,OAAO,GAAGc,GAAG;QAC3B;QACAb,YAAY,CAAC,CAAC;MAClB,CAAC,CAAC,OAAOlB,GAAG,EAAE;QACV2M,OAAO,CAAC1M,KAAK,CAAC,8BAA8B,EAAED,GAAG,CAAC;MACtD;IACJ,CAAC;IACDgH,GAAG,CAACH,GAAG,GAAGvF,KAAK;EACnB,CAAC;EAED,MAAMT,UAAU,GAAId,IAAI,IAAK;IACzB,MAAM;MAAE7D,CAAC;MAAEG,CAAC;MAAEyP,KAAK;MAAEC,KAAK;MAAE3Q,KAAK;MAAEE,IAAI;MAAEE,OAAO;MAAER;IAAK,CAAC,GAAG+E,IAAI;IAC/D,MAAM6F,GAAG,GAAG7K,UAAU,CAACkG,OAAO;IAC9B,IAAI,CAAC2E,GAAG,EAAE;IAEV,MAAMzD,GAAG,GAAGhG,MAAM,CAACiG,gBAAgB,IAAI,CAAC;IACxCwD,GAAG,CAACO,IAAI,CAAC,CAAC;;IAEV;IACAP,GAAG,CAACC,YAAY,CACZtJ,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAAE,CAAC,EAC/B,CAAC,EAAE5F,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAC/B3F,eAAe,CAACyE,OAAO,CAAC/E,CAAC,GAAGiG,GAAG,EAAE3F,eAAe,CAACyE,OAAO,CAAC5E,CAAC,GAAG8F,GACjE,CAAC;IAEDyD,GAAG,CAACU,WAAW,GAAG9K,OAAO,IAAI,CAAC;IAC9BoK,GAAG,CAAClK,WAAW,GAAGN,KAAK;IACvBwK,GAAG,CAACwB,SAAS,GAAG9L,IAAI;IACpBsK,GAAG,CAAChD,OAAO,GAAG,OAAO;IACrBgD,GAAG,CAAC/C,QAAQ,GAAG,OAAO;;IAEtB;IACA+C,GAAG,CAACW,wBAAwB,GAAIvL,IAAI,KAAK,kBAAkB,GAAI,iBAAiB,GAAG,aAAa;IAEhG4K,GAAG,CAAC2B,SAAS,CAAC,CAAC;IACf,IAAIuE,KAAK,IAAIC,KAAK,EAAE;MAChBnG,GAAG,CAAC4B,MAAM,CAACsE,KAAK,EAAEC,KAAK,CAAC;IAC5B,CAAC,MAAM;MACHnG,GAAG,CAAC4B,MAAM,CAACtL,CAAC,EAAEG,CAAC,CAAC;IACpB;IACAuJ,GAAG,CAAC8B,MAAM,CAACxL,CAAC,EAAEG,CAAC,CAAC;IAChBuJ,GAAG,CAACrE,MAAM,CAAC,CAAC;IACZqE,GAAG,CAACc,OAAO,CAAC,CAAC;EACjB,CAAC;EAED,MAAM5F,WAAW,GAAIf,IAAI,IAAK;IAC1B,MAAM;MAAE7D,CAAC;MAAEG,CAAC;MAAEf;IAAK,CAAC,GAAGyE,IAAI;IAC3B,MAAM6F,GAAG,GAAG7K,UAAU,CAACkG,OAAO;IAC9B,IAAI,CAAC2E,GAAG,EAAE;IAEV,MAAMzD,GAAG,GAAGhG,MAAM,CAACiG,gBAAgB,IAAI,CAAC;IACxCwD,GAAG,CAACO,IAAI,CAAC,CAAC;;IAEV;IACAP,GAAG,CAACC,YAAY,CACZtJ,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAAE,CAAC,EAC/B,CAAC,EAAE5F,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAC/B3F,eAAe,CAACyE,OAAO,CAAC/E,CAAC,GAAGiG,GAAG,EAAE3F,eAAe,CAACyE,OAAO,CAAC5E,CAAC,GAAG8F,GACjE,CAAC;IAEDyD,GAAG,CAACW,wBAAwB,GAAG,iBAAiB;IAChDX,GAAG,CAAC2B,SAAS,CAAC,CAAC;IACf3B,GAAG,CAACyC,GAAG,CAACnM,CAAC,EAAEG,CAAC,EAAEf,IAAI,EAAE,CAAC,EAAE8I,IAAI,CAACkE,EAAE,GAAG,CAAC,CAAC;IACnC1C,GAAG,CAAChK,IAAI,CAAC,CAAC;IACVgK,GAAG,CAACc,OAAO,CAAC,CAAC;EACjB,CAAC;EAED,MAAMkG,gBAAgB,GAAGA,CAAA,KAAM;IAC3B,IAAIzQ,MAAM,CAAC0Q,OAAO,CAAC,kCAAkC,CAAC,EAClDjS,MAAM,CAACsF,IAAI,CAAC,aAAa,EAAE;MAAEzF,MAAM;MAAE0F,MAAM,EAAExF,IAAI,CAACyF;IAAI,CAAC,CAAC;EAChE,CAAC;;EAED;EACA,MAAM0M,cAAc,GAAGA,CAAA,KAAM;IACzB,MAAM7K,MAAM,GAAGpH,SAAS,CAACoG,OAAO;IAChC,IAAI,CAACgB,MAAM,EAAE;IACb,MAAM8K,IAAI,GAAGjK,QAAQ,CAACC,aAAa,CAAC,GAAG,CAAC;IACxCgK,IAAI,CAACC,QAAQ,GAAG,GAAG,CAAA3O,IAAI,aAAJA,IAAI,uBAAJA,IAAI,CAAE4O,QAAQ,KAAI,YAAY,IAAI7C,IAAI,CAACC,GAAG,CAAC,CAAC,MAAM;IACrE0C,IAAI,CAACG,IAAI,GAAGjL,MAAM,CAACuI,SAAS,CAAC,WAAW,CAAC;IACzCuC,IAAI,CAACjD,KAAK,CAAC,CAAC;IACZ9P,KAAK,CAACwG,OAAO,CAAC,wBAAwB,CAAC;EAC3C,CAAC;;EAED;EACA,MAAM2M,iBAAiB,GAAIrJ,CAAC,IAAK;IAC7B,MAAMrC,IAAI,GAAGqC,CAAC,CAACsJ,MAAM,CAACC,KAAK,CAAC,CAAC,CAAC;IAC9B,IAAI,CAAC5L,IAAI,EAAE;IACX,MAAM6L,MAAM,GAAG,IAAIC,UAAU,CAAC,CAAC;IAC/BD,MAAM,CAACpG,MAAM,GAAIpF,EAAE,IAAK;MACpB,MAAM+E,GAAG,GAAG/E,EAAE,CAACsL,MAAM,CAACI,MAAM;MAC5B,MAAMxG,GAAG,GAAG,IAAI7K,MAAM,CAAC8K,KAAK,CAAC,CAAC;MAC9BD,GAAG,CAACE,MAAM,GAAG,MAAM;QAAA,IAAAuG,kBAAA;QACf,MAAMC,IAAI,GAAG,GAAG;QAChB,MAAMpI,KAAK,GAAGlB,IAAI,CAACE,GAAG,CAAC,CAAC,EAAEoJ,IAAI,GAAG1G,GAAG,CAAC3E,KAAK,CAAC;QAC3C,MAAMyE,IAAI,GAAG1C,IAAI,CAACuJ,KAAK,CAAC3G,GAAG,CAAC3E,KAAK,GAAGiD,KAAK,CAAC;QAC1C,MAAMyB,IAAI,GAAG3C,IAAI,CAACuJ,KAAK,CAAC3G,GAAG,CAACzE,MAAM,GAAG+C,KAAK,CAAC;QAC3C,MAAMsE,GAAG,GAAGrM,gBAAgB,CAAC0D,OAAO;QACpC;QACAzD,UAAU,CAACyD,OAAO,CAACkG,GAAG,CAACN,GAAG,EAAEG,GAAG,CAAC;QAChC,MAAMpB,GAAG,GAAG7K,UAAU,CAACkG,OAAO;QAC9B,IAAI2E,GAAG,EAAE;UACL,MAAMzD,GAAG,GAAGhG,MAAM,CAACiG,gBAAgB,IAAI,CAAC;UACxCwD,GAAG,CAACO,IAAI,CAAC,CAAC;UACVP,GAAG,CAACC,YAAY,CACZtJ,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAAE,CAAC,EAC/B,CAAC,EAAE5F,cAAc,CAAC0E,OAAO,GAAGkB,GAAG,EAC/B3F,eAAe,CAACyE,OAAO,CAAC/E,CAAC,GAAGiG,GAAG,EAAE3F,eAAe,CAACyE,OAAO,CAAC5E,CAAC,GAAG8F,GACjE,CAAC;UACDyD,GAAG,CAACU,WAAW,GAAG9K,OAAO;UACzBoK,GAAG,CAACG,SAAS,CAACiB,GAAG,EAAE4C,GAAG,CAAC1N,CAAC,EAAE0N,GAAG,CAACvN,CAAC,EAAEyK,IAAI,EAAEC,IAAI,CAAC;UAC5CnB,GAAG,CAACc,OAAO,CAAC,CAAC;QACjB;QACA;QACA,MAAMkH,WAAW,GAAG;UAChBzD,EAAE,EAAEC,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGjG,IAAI,CAACkG,MAAM,CAAC,CAAC;UAC9BrE,IAAI,EAAE,OAAO;UAAEY,GAAG;UAClBX,MAAM,EAAE,CAAC0D,GAAG,CAAC;UAAE9C,IAAI;UAAEC,IAAI;UACzB3L,KAAK;UAAEE,IAAI;UAAEE,OAAO;UAAEE,WAAW;UAAEE;QACvC,CAAC;QACDiB,UAAU,CAAC8D,IAAI,IAAI,CAAC,GAAGA,IAAI,EAAEiN,WAAW,CAAC,CAAC;QAC1C,IAAIhT,MAAM,EAAEA,MAAM,CAACsF,IAAI,CAAC,YAAY,EAAE;UAAEzF,MAAM;UAAE8G,MAAM,EAAEqM;QAAY,CAAC,CAAC;QACtE;QACA,MAAMrD,OAAO,IAAAkD,kBAAA,GAAG5S,SAAS,CAACoG,OAAO,cAAAwM,kBAAA,uBAAjBA,kBAAA,CAAmBjD,SAAS,CAAC,CAAC;QAC9C,IAAID,OAAO,EAAE;UACT9K,UAAU,CAACkB,IAAI,IAAI;YAAE,MAAM8J,EAAE,GAAG,CAAC,GAAG9J,IAAI,CAAC+J,KAAK,CAAC,CAAC,EAAEhL,YAAY,GAAG,CAAC,CAAC,EAAE6K,OAAO,CAAC;YAAE5K,eAAe,CAAC8K,EAAE,CAACzJ,MAAM,GAAG,CAAC,CAAC;YAAE,OAAOyJ,EAAE;UAAE,CAAC,CAAC;UAC5H,IAAI7P,MAAM,EAAEA,MAAM,CAACsF,IAAI,CAAC,aAAa,EAAE;YAAEzF,MAAM;YAAEmQ,UAAU,EAAEL;UAAQ,CAAC,CAAC;QAC3E;MACJ,CAAC;MACDvD,GAAG,CAACH,GAAG,GAAGA,GAAG;IACjB,CAAC;IACDyG,MAAM,CAACO,aAAa,CAACpM,IAAI,CAAC;IAC1BqC,CAAC,CAACsJ,MAAM,CAACU,KAAK,GAAG,EAAE;EACvB,CAAC;;EAED;EACA1U,KAAK,CAACC,SAAS,CAAC,MAAM;IAClB,MAAM0U,KAAK,GAAIjK,CAAC,IAAK;MACjB,IAAI,CAAC,OAAO,EAAE,UAAU,CAAC,CAAClG,QAAQ,CAACkG,CAAC,CAACsJ,MAAM,CAACY,OAAO,CAAC,EAAE;MACtD,IAAIlK,CAAC,CAACE,OAAO,IAAIF,CAAC,CAACmK,OAAO,EAAE;QACxB,IAAInK,CAAC,CAACoK,GAAG,KAAK,GAAG,EAAE;UAAEpK,CAAC,CAACC,cAAc,CAAC,CAAC;UAAEuI,UAAU,CAAC,CAAC;QAAE;QACvD,IAAIxI,CAAC,CAACoK,GAAG,KAAK,GAAG,EAAE;UAAEpK,CAAC,CAACC,cAAc,CAAC,CAAC;UAAE0I,UAAU,CAAC,CAAC;QAAE;QACvD;MACJ;MACA,MAAM0B,GAAG,GAAG;QAAEC,CAAC,EAAE,QAAQ;QAAExN,CAAC,EAAE,KAAK;QAAE4K,CAAC,EAAE,QAAQ;QAAE1H,CAAC,EAAE,QAAQ;QAAEuK,CAAC,EAAE;MAAO,CAAC;MAC1E,IAAIF,GAAG,CAACrK,CAAC,CAACoK,GAAG,CAACI,WAAW,CAAC,CAAC,CAAC,EAAErT,OAAO,CAACkT,GAAG,CAACrK,CAAC,CAACoK,GAAG,CAACI,WAAW,CAAC,CAAC,CAAC,CAAC;IACnE,CAAC;IACDnS,MAAM,CAACwH,gBAAgB,CAAC,SAAS,EAAEoK,KAAK,CAAC;IACzC,OAAO,MAAM5R,MAAM,CAACyH,mBAAmB,CAAC,SAAS,EAAEmK,KAAK,CAAC;EAC7D,CAAC,EAAE,EAAE,CAAC;;EAEN;EACA,MAAMQ,gBAAgB,GAAG,MAAAA,CAAA,KAAY;IACjC,IAAI;MACA,IAAItP,YAAY,EAAE;QACdA,YAAY,CAACuP,SAAS,CAAC,CAAC,CAAC3M,OAAO,CAACwM,CAAC,IAAIA,CAAC,CAACI,IAAI,CAAC,CAAC,CAAC;QAC/CvP,eAAe,CAAC,IAAI,CAAC;QACrBtE,MAAM,CAACsF,IAAI,CAAC,sBAAsB,EAAE;UAAEzF;QAAO,CAAC,CAAC;QAC/CT,KAAK,CAAC,wBAAwB,CAAC;QAC/B;MACJ;MACA,MAAM0U,MAAM,GAAG,MAAMC,SAAS,CAACC,YAAY,CAACC,eAAe,CAAC;QAAEC,KAAK,EAAE,IAAI;QAAEC,KAAK,EAAE;MAAM,CAAC,CAAC;MAC1F7P,eAAe,CAACwP,MAAM,CAAC;MACvB9T,MAAM,CAACsF,IAAI,CAAC,sBAAsB,EAAE;QAAEzF,MAAM;QAAE0F,MAAM,EAAExF,IAAI,CAACyF,GAAG;QAAEC,QAAQ,EAAE1F,IAAI,CAAC2F;MAAK,CAAC,CAAC;MACtFoO,MAAM,CAACM,cAAc,CAAC,CAAC,CAAC,CAAC,CAAC,CAACC,OAAO,GAAG,MAAM;QACvC/P,eAAe,CAAC,IAAI,CAAC;QACrBtE,MAAM,CAACsF,IAAI,CAAC,sBAAsB,EAAE;UAAEzF;QAAO,CAAC,CAAC;QAC/CT,KAAK,CAAC,wBAAwB,CAAC;MACnC,CAAC;MACDA,KAAK,CAACwG,OAAO,CAAC,yBAAyB,CAAC;IAC5C,CAAC,CAAC,OAAOR,GAAG,EAAE;MACV,IAAIA,GAAG,CAACM,IAAI,KAAK,iBAAiB,EAAEtG,KAAK,CAACiG,KAAK,CAAC,uBAAuB,CAAC;IAC5E;EACJ,CAAC;EAED,oBACI7F,OAAA;IAAK8U,SAAS,EAAC,qBAAqB;IAAAC,QAAA,gBAEhC/U,OAAA;MAAQ8U,SAAS,EAAC,gBAAgB;MAAAC,QAAA,gBAC9B/U,OAAA;QAAK8U,SAAS,EAAC,yBAAyB;QAAAC,QAAA,gBACpC/U,OAAA;UAAK8U,SAAS,EAAC,yBAAyB;UAAAC,QAAA,gBACpC/U,OAAA;YAAK8U,SAAS,EAAC,8GAA8G;YAACE,OAAO,EAAEA,CAAA,KAAM1U,QAAQ,CAAC,YAAY,CAAE;YAAAyU,QAAA,eAChK/U,OAAA;cAAM8U,SAAS,EAAC,+BAA+B;cAAAC,QAAA,EAAC;YAAC;cAAAE,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAAM;UAAC;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OACvD,CAAC,eACNpV,OAAA;YAAA+U,QAAA,gBACI/U,OAAA;cAAI8U,SAAS,EAAC,uEAAuE;cAAAC,QAAA,EAAE,CAAA9Q,IAAI,aAAJA,IAAI,uBAAJA,IAAI,CAAE4O,QAAQ,KAAI;YAAgB;cAAAoC,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAAK,CAAC,eAC/HpV,OAAA;cAAM8U,SAAS,EAAC,gEAAgE;cAAAC,QAAA,GAAE5Q,YAAY,CAACyC,MAAM,EAAC,SAAO;YAAA;cAAAqO,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAAM,CAAC;UAAA;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OACnH,CAAC;QAAA;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OACL,CAAC,eAENpV,OAAA;UAAK8U,SAAS,EAAC;QAAuB;UAAAG,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAM,CAAC,EAG5C7R,aAAa,iBACVvD,OAAA;UAAK8U,SAAS,EAAC,8EAA8E;UAAAC,QAAA,gBAEzF/U,OAAA;YAAK8U,SAAS,EAAC,yBAAyB;YAAAC,QAAA,gBACpC/U,OAAA;cAAK8U,SAAS,EAAC,+BAA+B;cAAAC,QAAA,EACzCzR,MAAM,CAACgN,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAACyD,GAAG,CAACsB,CAAC,iBACrBrV,OAAA;gBAEIgV,OAAO,EAAEA,CAAA,KAAM/T,QAAQ,CAACoU,CAAC,CAAE;gBAC3BP,SAAS,EAAE,+DAA+D9T,KAAK,KAAKqU,CAAC,GAAG,gDAAgD,GAAG,iBAAiB,EAAG;gBAC/JhK,KAAK,EAAE;kBAAEiK,eAAe,EAAED;gBAAE;cAAE,GAHzBA,CAAC;gBAAAJ,QAAA,EAAAC,YAAA;gBAAAC,UAAA;gBAAAC,YAAA;cAAA,OAIT,CACJ;YAAC;cAAAH,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OACD,CAAC,eACNpV,OAAA;cAAK8U,SAAS,EAAC,+BAA+B;cAAAC,QAAA,EACzCzR,MAAM,CAACgN,KAAK,CAAC,CAAC,CAAC,CAACyD,GAAG,CAACsB,CAAC,iBAClBrV,OAAA;gBAEIgV,OAAO,EAAEA,CAAA,KAAM/T,QAAQ,CAACoU,CAAC,CAAE;gBAC3BP,SAAS,EAAE,+DAA+D9T,KAAK,KAAKqU,CAAC,GAAG,gDAAgD,GAAG,iBAAiB,EAAG;gBAC/JhK,KAAK,EAAE;kBAAEiK,eAAe,EAAED;gBAAE;cAAE,GAHzBA,CAAC;gBAAAJ,QAAA,EAAAC,YAAA;gBAAAC,UAAA;gBAAAC,YAAA;cAAA,OAIT,CACJ;YAAC;cAAAH,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OACD,CAAC;UAAA;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OACL,CAAC,eAENpV,OAAA;YAAK8U,SAAS,EAAC;UAAuB;YAAAG,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAM,CAAC,eAG7CpV,OAAA;YAAK8U,SAAS,EAAC,8BAA8B;YAAAC,QAAA,gBACzC/U,OAAA;cAAM8U,SAAS,EAAC,+DAA+D;cAAAC,QAAA,EAAC;YAAI;cAAAE,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAAM,CAAC,eAC3FpV,OAAA;cACI6L,IAAI,EAAC,OAAO;cAAC3B,GAAG,EAAC,GAAG;cAACD,GAAG,EAAC,IAAI;cAACyJ,KAAK,EAAExS,IAAK;cAC1CqU,QAAQ,EAAG7L,CAAC,IAAKvI,OAAO,CAACqU,QAAQ,CAAC9L,CAAC,CAACsJ,MAAM,CAACU,KAAK,CAAC,CAAE;cACnDoB,SAAS,EAAC;YAAqF;cAAAG,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAClG,CAAC,eACFpV,OAAA;cAAM8U,SAAS,EAAC,6DAA6D;cAAAC,QAAA,EAAE7T;YAAI;cAAA+T,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAAO,CAAC;UAAA;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAC1F,CAAC,eAENpV,OAAA;YAAK8U,SAAS,EAAC;UAAuB;YAAAG,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAM,CAAC,eAG7CpV,OAAA;YAAK8U,SAAS,EAAC,8BAA8B;YAAAC,QAAA,gBACzC/U,OAAA;cAAM8U,SAAS,EAAC,+DAA+D;cAAAC,QAAA,EAAC;YAAO;cAAAE,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAAM,CAAC,eAC9FpV,OAAA;cACI6L,IAAI,EAAC,OAAO;cAAC3B,GAAG,EAAC,KAAK;cAACD,GAAG,EAAC,GAAG;cAACwL,IAAI,EAAC,KAAK;cAAC/B,KAAK,EAAEtS,OAAQ;cACzDmU,QAAQ,EAAG7L,CAAC,IAAKrI,UAAU,CAACqU,UAAU,CAAChM,CAAC,CAACsJ,MAAM,CAACU,KAAK,CAAC,CAAE;cACxDoB,SAAS,EAAC;YAAqF;cAAAG,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAClG,CAAC,eACFpV,OAAA;cAAM8U,SAAS,EAAC,6DAA6D;cAAAC,QAAA,GAAE/K,IAAI,CAACuJ,KAAK,CAACnS,OAAO,GAAG,GAAG,CAAC,EAAC,GAAC;YAAA;cAAA6T,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAAM,CAAC;UAAA;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAChH,CAAC;QAAA;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OACL,CACR;MAAA;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OACA,CAAC,eAENpV,OAAA;QAAK8U,SAAS,EAAC,yBAAyB;QAAAC,QAAA,gBACpC/U,OAAA;UAAQ8U,SAAS,EAAC,oBAAoB;UAACE,OAAO,EAAEtC,cAAe;UAAAqC,QAAA,EAAC;QAAU;UAAAE,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAQ,CAAC,eACnFpV,OAAA;UAAQ8U,SAAS,EAAC,oBAAoB;UAACE,OAAO,EAAEA,CAAA,KAAM;YAClDT,SAAS,CAACoB,SAAS,CAACC,SAAS,CAAC7T,MAAM,CAAC8T,QAAQ,CAAC/C,IAAI,CAAC;YACnDlT,KAAK,CAACwG,OAAO,CAAC,cAAc,CAAC;UACjC,CAAE;UAAA2O,QAAA,EAAC;QAAM;UAAAE,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAQ,CAAC,eAClBpV,OAAA;UACI8U,SAAS,EAAE,oBAAoBjQ,YAAY,GAAG,+CAA+C,GAAG,EAAE,EAAG;UACrGmQ,OAAO,EAAEb,gBAAiB;UAAAY,QAAA,EAEzBlQ,YAAY,GAAG,cAAc,GAAG;QAAc;UAAAoQ,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAC3C,CAAC,eACTpV,OAAA;UAAK8U,SAAS,EAAC;QAA4B;UAAAG,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAM,CAAC,eAClDpV,OAAA;UAAQ8U,SAAS,EAAC,aAAa;UAACE,OAAO,EAAEA,CAAA,KAAM/P,gBAAgB,CAAC,CAACD,aAAa,CAAE;UAAA+P,QAAA,eAC5E/U,OAAA;YAAM8U,SAAS,EAAC,SAAS;YAAAC,QAAA,EAAC;UAAE;YAAAE,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAM;QAAC;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAC/B,CAAC;MAAA;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OACR,CAAC;IAAA;MAAAH,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OACF,CAAC,eAGTpV,OAAA;MAAO8U,SAAS,EAAC,eAAe;MAAAC,QAAA,eAC5B/U,OAAA,CAACP,OAAO;QACJqW,UAAU,EAAElV,IAAK;QACjBC,OAAO,EAAEkD,gBAAiB;QAC1BgS,MAAM,EAAE,CAAA9R,IAAI,aAAJA,IAAI,wBAAA9D,UAAA,GAAJ8D,IAAI,CAAE+R,IAAI,cAAA7V,UAAA,uBAAVA,UAAA,CAAY8V,QAAQ,CAAC,CAAC,MAAK1V,IAAI,CAACyF,GAAG,IAAI,CAAA/B,IAAI,aAAJA,IAAI,wBAAA7D,WAAA,GAAJ6D,IAAI,CAAE+R,IAAI,cAAA5V,WAAA,uBAAVA,WAAA,CAAY4F,GAAG,MAAKzF,IAAI,CAACyF,GAAI;QAC5EkQ,OAAO,EAAE1D,gBAAiB;QAC1B2D,MAAM,EAAEjE,UAAW;QACnBkE,MAAM,EAAE/D,UAAW;QACnBgE,QAAQ,EAAEA,CAAA,KAAM,CAAE;MAAE;QAAApB,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OACvB;IAAC;MAAAH,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OACC,CAAC,eAIRpV,OAAA;MACIsW,GAAG,EAAE5V,WAAY;MACjBoU,SAAS,EAAC,8DAA8D;MACxEzJ,KAAK,EAAE;QACHkL,eAAe,EAAE,+CAA+C;QAChEjL,cAAc,EAAE,GAAG,EAAE,GAAG5J,WAAW,MAAM,EAAE,GAAGA,WAAW,IAAI;QAC7D6J,kBAAkB,EAAE,GAAG3J,YAAY,CAACE,CAAC,MAAMF,YAAY,CAACK,CAAC;MAC7D,CAAE;MAAA8S,QAAA,gBAGF/U,OAAA;QACIsW,GAAG,EAAE7V,SAAU;QACfqU,SAAS,EAAC,gCAAgC;QAC1CzJ,KAAK,EAAE;UAAEmL,MAAM,EAAE/S;QAAa,CAAE;QAChCgT,WAAW,EAAEnH,YAAa;QAC1BoH,WAAW,EAAEhG,eAAgB;QAC7BiG,SAAS,EAAE5E,WAAY;QACvB6E,UAAU,EAAE7E;MAAY;QAAAkD,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAC3B,CAAC,eAIFpV,OAAA;QACI6L,IAAI,EAAC,MAAM;QAACgL,MAAM,EAAC,SAAS;QAAC/B,SAAS,EAAC,QAAQ;QAC/CwB,GAAG,EAAEpT,YAAa;QAClBqS,QAAQ,EAAExC;MAAkB;QAAAkC,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAC/B,CAAC,eAEFpV,OAAA,CAACL,YAAY;QACTiB,IAAI,EAAEA,IAAK;QACXkW,OAAO,EAAEhW,WAAY;QACrBQ,WAAW,EAAEA,WAAY;QAACC,cAAc,EAAEA,cAAe;QACzDC,IAAI,EAAEA,IAAK;QAACC,OAAO,EAAEA;MAAQ;QAAAwT,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAChC,CAAC,eAGFpV,OAAA;QAAK8U,SAAS,EAAC,kHAAkH;QAAAC,QAAA,gBAC7H/U,OAAA;UACIgV,OAAO,EAAEA,CAAA,KAAM;YACX7S,cAAc,CAAC0E,OAAO,GAAG,CAAC;YAC1BzE,eAAe,CAACyE,OAAO,GAAG;cAAE/E,CAAC,EAAE,CAAC,IAAI,GAAGC,MAAM,CAACC,UAAU,GAAG,CAAC;cAAEC,CAAC,EAAE,CAAC,IAAI,GAAGF,MAAM,CAACG,WAAW,GAAG;YAAE,CAAC;YACjGP,cAAc,CAAC,CAAC,CAAC;YAAEE,eAAe,CAACO,eAAe,CAACyE,OAAO,CAAC;YAAEyC,WAAW,CAAC,CAAC;UAC9E,CAAE;UACFwL,SAAS,EAAC,0FAA0F;UAAAC,QAAA,GAEnG/K,IAAI,CAACuJ,KAAK,CAAC7R,WAAW,GAAG,GAAG,CAAC,EAAC,GACnC;QAAA;UAAAuT,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAQ,CAAC,eACTpV,OAAA;UAAK8U,SAAS,EAAC;QAAuB;UAAAG,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAM,CAAC,eAC7CpV,OAAA;UAAQgV,OAAO,EAAEA,CAAA,KAAM/L,UAAU,CAAC,GAAG,CAAE;UAAC6L,SAAS,EAAC,sFAAsF;UAAAC,QAAA,eACpI/U,OAAA,CAACH,IAAI;YAACqB,IAAI,EAAE;UAAG;YAAA+T,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAE;QAAC;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OACd,CAAC,eACTpV,OAAA;UAAQgV,OAAO,EAAEA,CAAA,KAAM/L,UAAU,CAAC,CAAC,GAAG,GAAG,CAAE;UAAC6L,SAAS,EAAC,sFAAsF;UAAAC,QAAA,eACxI/U,OAAA,CAACF,KAAK;YAACoB,IAAI,EAAE;UAAG;YAAA+T,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAE;QAAC;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OACf,CAAC;MAAA;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OACR,CAAC,EAGL2B,MAAM,CAACC,MAAM,CAAC9R,aAAa,CAAC,CAAC6O,GAAG,CAACyC,MAAM,iBACpCxW,OAAA;QAEI8U,SAAS,EAAC,sEAAsE;QAChFzJ,KAAK,EAAE;UAAEd,IAAI,EAAEiM,MAAM,CAAC1U,CAAC;UAAE4I,GAAG,EAAE8L,MAAM,CAACvU;QAAE,CAAE;QAAA8S,QAAA,gBAEzC/U,OAAA;UAAKiI,KAAK,EAAC,IAAI;UAACE,MAAM,EAAC,IAAI;UAAC8O,OAAO,EAAC,WAAW;UAACC,KAAK,EAAC,4BAA4B;UAAAnC,QAAA,eAC9E/U,OAAA;YAAMmX,CAAC,EAAC,mDAAmD;YACvD3V,IAAI,EAAEgV,MAAM,CAACxV,KAAK,IAAI,SAAU;YAACmG,MAAM,EAAC,OAAO;YAACiQ,WAAW,EAAC;UAAG;YAAAnC,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAE;QAAC;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OACrE,CAAC,eACNpV,OAAA;UAAM8U,SAAS,EAAC,2GAA2G;UACvHzJ,KAAK,EAAE;YAAEiK,eAAe,EAAEkB,MAAM,CAACxV,KAAK,IAAI;UAAU,CAAE;UAAA+T,QAAA,EACrDyB,MAAM,CAACvQ;QAAQ;UAAAgP,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OACd,CAAC;MAAA,GAXFoB,MAAM,CAAClP,QAAQ;QAAA2N,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAYnB,CACR,CAAC;IAAA;MAAAH,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OACA,CAAC,eAGPpV,OAAA;MAAO8U,SAAS,EAAE,kBAAkB9P,aAAa,GAAG,MAAM,GAAG,EAAE,EAAG;MAAA+P,QAAA,eAC9D/U,OAAA;QAAK8U,SAAS,EAAC,sBAAsB;QAAAC,QAAA,gBACjC/U,OAAA;UAAK8U,SAAS,EAAC,gDAAgD;UAAAC,QAAA,EAC1D,CAAC,MAAM,EAAE,OAAO,EAAE,OAAO,CAAC,CAAChB,GAAG,CAAEsD,GAAG,iBAChCrX,OAAA;YAEIgV,OAAO,EAAEA,CAAA,KAAMtQ,YAAY,CAAC2S,GAAG,CAAE;YACjCvC,SAAS,EAAE;AAC3C,4CAA4CrQ,SAAS,KAAK4S,GAAG,GAAG,4DAA4D,GAAG,qCAAqC,EAAG;YAAAtC,QAAA,EAEtIsC;UAAG,GALCA,GAAG;YAAApC,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAMJ,CACX;QAAC;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OACD,CAAC,eACNpV,OAAA;UAAK8U,SAAS,EAAC,wBAAwB;UAAAC,QAAA,EAClCtQ,SAAS,KAAK,MAAM,gBACjBzE,OAAA,CAACN,IAAI;YAAC2E,QAAQ,EAAEA,QAAS;YAACiT,aAAa,EAAGC,GAAG,IAAK/W,MAAM,CAACsF,IAAI,CAAC,cAAc,EAAE;cAAEzF,MAAM;cAAEmX,OAAO,EAAED,GAAG;cAAExR,MAAM,EAAExF,IAAI,CAACyF,GAAG;cAAEC,QAAQ,EAAE1F,IAAI,CAAC2F;YAAK,CAAC,CAAE;YAACuR,WAAW,EAAElX;UAAK;YAAA0U,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAE,CAAC,GACrK3Q,SAAS,KAAK,OAAO,gBACrBzE,OAAA;YAAK8U,SAAS,EAAC,KAAK;YAAAC,QAAA,gBAChB/U,OAAA;cAAO8U,SAAS,EAAE,6EAA6EnQ,iBAAiB,GAAG,+BAA+B,GAAG,EAAE,EAAG;cAAAoQ,QAAA,gBACtJ/U,OAAA;gBAAA+U,QAAA,EAAOpQ,iBAAiB,GAAG,cAAc,GAAG;cAAgB;gBAAAsQ,QAAA,EAAAC,YAAA;gBAAAC,UAAA;gBAAAC,YAAA;cAAA,OAAO,CAAC,eACpEpV,OAAA;gBACI6L,IAAI,EAAC,MAAM;gBACXiJ,SAAS,EAAC,QAAQ;gBAClB4C,QAAQ,EAAE/S,iBAAkB;gBAC5B4Q,QAAQ,EAAE,MAAO7L,CAAC,IAAK;kBACnB,MAAMrC,IAAI,GAAGqC,CAAC,CAACsJ,MAAM,CAACC,KAAK,CAAC,CAAC,CAAC;kBAC9B,IAAI,CAAC5L,IAAI,EAAE;kBACXzC,oBAAoB,CAAC,IAAI,CAAC;kBAC1B,IAAI;oBACA,MAAM+S,EAAE,GAAG,IAAIC,QAAQ,CAAC,CAAC;oBACzBD,EAAE,CAACE,MAAM,CAAC,MAAM,EAAExQ,IAAI,CAAC;oBACvB,MAAM5B,GAAG,GAAG,MAAMjG,WAAW,CAACsY,UAAU,CAACzX,MAAM,EAAEsX,EAAE,CAAC;oBACpDnT,cAAc,CAAC+B,IAAI,IAAI,CAAC,GAAGA,IAAI,EAAEd,GAAG,CAACE,IAAI,CAAC0B,IAAI,CAAC,CAAC;oBAChD7G,MAAM,CAACsF,IAAI,CAAC,aAAa,EAAE;sBAAEzF,MAAM;sBAAEgH,IAAI,EAAE5B,GAAG,CAACE,IAAI,CAAC0B;oBAAK,CAAC,CAAC;oBAC3DzH,KAAK,CAACwG,OAAO,CAAC,GAAGiB,IAAI,CAACnB,IAAI,UAAU,CAAC;kBACzC,CAAC,CAAC,MAAM;oBAAEtG,KAAK,CAACiG,KAAK,CAAC,eAAe,CAAC;kBAAE,CAAC,SACjC;oBAAEjB,oBAAoB,CAAC,KAAK,CAAC;oBAAE8E,CAAC,CAACsJ,MAAM,CAACU,KAAK,GAAG,EAAE;kBAAE;gBAChE;cAAE;gBAAAuB,QAAA,EAAAC,YAAA;gBAAAC,UAAA;gBAAAC,YAAA;cAAA,OACL,CAAC;YAAA;cAAAH,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OACC,CAAC,eACRpV,OAAA;cAAK8U,SAAS,EAAC,WAAW;cAAAC,QAAA,EACrBxQ,WAAW,CAACwP,GAAG,CAAC,CAACgE,CAAC,EAAE1K,CAAC,kBAClBrN,OAAA;gBAAa8U,SAAS,EAAC,sFAAsF;gBAAAC,QAAA,gBACzG/U,OAAA;kBAAM8U,SAAS,EAAC,4CAA4C;kBAAAC,QAAA,EAAEgD,CAAC,CAAC9C;gBAAQ;kBAAAA,QAAA,EAAAC,YAAA;kBAAAC,UAAA;kBAAAC,YAAA;gBAAA,OAAO,CAAC,eAChFpV,OAAA;kBAAM8U,SAAS,EAAC,iBAAiB;kBAAAC,QAAA,EAAC;gBAAE;kBAAAE,QAAA,EAAAC,YAAA;kBAAAC,UAAA;kBAAAC,YAAA;gBAAA,OAAM,CAAC;cAAA,GAFrC/H,CAAC;gBAAA4H,QAAA,EAAAC,YAAA;gBAAAC,UAAA;gBAAAC,YAAA;cAAA,OAGN,CACR;YAAC;cAAAH,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OACD,CAAC;UAAA;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OACL,CAAC,gBAENpV,OAAA;YAAK8U,SAAS,EAAC,eAAe;YAAAC,QAAA,EACzB5Q,YAAY,CAAC4P,GAAG,CAAC,CAAC3C,CAAC,EAAE/D,CAAC,kBACnBrN,OAAA;cAAa8U,SAAS,EAAC,0DAA0D;cAAAC,QAAA,gBAC7E/U,OAAA;gBAAK8U,SAAS,EAAC,2GAA2G;gBAAAC,QAAA,EAAE3D,CAAC,CAACnL,QAAQ,CAAC,CAAC;cAAC;gBAAAgP,QAAA,EAAAC,YAAA;gBAAAC,UAAA;gBAAAC,YAAA;cAAA,OAAM,CAAC,eAChJpV,OAAA;gBAAM8U,SAAS,EAAC,oCAAoC;gBAAAC,QAAA,EAAE3D,CAAC,CAACnL;cAAQ;gBAAAgP,QAAA,EAAAC,YAAA;gBAAAC,UAAA;gBAAAC,YAAA;cAAA,OAAO,CAAC,eACxEpV,OAAA;gBAAK8U,SAAS,EAAC;cAA+C;gBAAAG,QAAA,EAAAC,YAAA;gBAAAC,UAAA;gBAAAC,YAAA;cAAA,OAAM,CAAC;YAAA,GAH/D/H,CAAC;cAAA4H,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAIN,CACR;UAAC;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OACD;QACR;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OACA,CAAC;MAAA;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OACL;IAAC;MAAAH,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OACH,CAAC;EAAA;IAAAH,QAAA,EAAAC,YAAA;IAAAC,UAAA;IAAAC,YAAA;EAAA,OACP,CAAC;AAEd,CAAC;AAAClV,EAAA,CAtxCID,cAAc;EAAA,QACGb,SAAS,EACXC,WAAW,EACXC,OAAO,EACLC,SAAS;AAAA;AAAAyY,EAAA,GAJ1B/X,cAAc;AAwxCpB,eAAeA,cAAc;AAAC,IAAA+X,EAAA;AAAAC,YAAA,CAAAD,EAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}