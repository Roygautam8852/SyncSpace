{"ast":null,"code":"var _jsxFileName = \"D:\\\\CapstoneProject\\\\whiteboard-app\\\\frontend\\\\src\\\\components\\\\video\\\\WebRTCMeeting.js\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useRef, useState, useCallback } from 'react';\nimport { Mic, MicOff, Video, VideoOff, PhoneOff, Monitor, MonitorOff, RefreshCcw } from 'lucide-react';\nimport toast from 'react-hot-toast';\n\n/**\r\n * WebRTCMeeting — Rebuilt with a robust 3-stage state machine.\r\n * - isCaller / signalingId are stored in refs to avoid stale-closure bugs.\r\n * - Signal listeners are registered BEFORE offer is sent (race-condition fix).\r\n * - handleLeave correctly calls fullDestruction + onLeave.\r\n */\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst WebRTCMeeting = ({\n  socket,\n  roomId,\n  signalingId,\n  isCaller,\n  username,\n  onLeave\n}) => {\n  _s();\n  // ── UI State ──────────────────────────────────────────────────────────────\n  const [localStream, setLocalStream] = useState(null);\n  const [remoteStream, setRemoteStream] = useState(null);\n  const [isMicEnabled, setIsMicEnabled] = useState(true);\n  const [isCamEnabled, setIsCamEnabled] = useState(true);\n  const [isScreenSharing, setIsScreenSharing] = useState(false);\n  const [status, setStatus] = useState('Initializing Media...');\n\n  // ── Management Refs (Persistent across renders) ───────────────────────────\n  const pcRef = useRef(null);\n  const localVideoRef = useRef(null);\n  const remoteVideoRef = useRef(null);\n  const streamRef = useRef(null);\n  const screenRef = useRef(null);\n  const candidateQueue = useRef([]);\n  const makingOffer = useRef(false);\n  const componentMounted = useRef(true);\n\n  // ── Stable refs for props (avoids stale-closure problems) ─────────────────\n  const signalingIdRef = useRef(signalingId);\n  const isCallerRef = useRef(isCaller);\n  const onLeaveRef = useRef(onLeave);\n  useEffect(() => {\n    signalingIdRef.current = signalingId;\n  }, [signalingId]);\n  useEffect(() => {\n    isCallerRef.current = isCaller;\n  }, [isCaller]);\n  useEffect(() => {\n    onLeaveRef.current = onLeave;\n  }, [onLeave]);\n\n  // ── signalReady: true once signal listeners are attached ──────────────────\n  const signalReadyRef = useRef(false);\n  const rtcConfig = {\n    iceServers: [{\n      urls: 'stun:stun.l.google.com:19302'\n    }, {\n      urls: 'stun:stun1.l.google.com:19302'\n    }]\n  };\n\n  // ── Lifecycle Helpers (defined first so they're available everywhere) ─────\n  const fullDestruction = useCallback(() => {\n    if (pcRef.current) {\n      pcRef.current.close();\n      pcRef.current = null;\n    }\n    if (streamRef.current) {\n      streamRef.current.getTracks().forEach(t => t.stop());\n      streamRef.current = null;\n    }\n    if (screenRef.current) {\n      screenRef.current.getTracks().forEach(t => t.stop());\n      screenRef.current = null;\n    }\n    setLocalStream(null);\n    setRemoteStream(null);\n    setStatus('Call Ended');\n  }, []);\n\n  // ── 2. Negotiation Logic ──────────────────────────────────────────────────\n  const handleNegotiation = useCallback(async () => {\n    if (!pcRef.current || makingOffer.current) return;\n    try {\n      makingOffer.current = true;\n      setStatus('Negotiating...');\n      const offer = await pcRef.current.createOffer();\n      await pcRef.current.setLocalDescription(offer);\n      socket.emit('call:offer', {\n        roomId,\n        to: signalingIdRef.current,\n        offer\n      });\n    } catch (err) {\n      console.error('[WebRTC] Negotiation Failed:', err);\n    } finally {\n      makingOffer.current = false;\n    }\n  }, [socket, roomId]);\n\n  // ── 3. Signaling Handlers (Bound to socket events) ───────────────────────\n  // Registered BEFORE we send the offer, so the callee never misses it.\n  useEffect(() => {\n    if (!socket) return;\n    const processQueue = async () => {\n      while (candidateQueue.current.length > 0 && (_pcRef$current = pcRef.current) !== null && _pcRef$current !== void 0 && _pcRef$current.remoteDescription) {\n        var _pcRef$current;\n        const cand = candidateQueue.current.shift();\n        try {\n          await pcRef.current.addIceCandidate(new RTCIceCandidate(cand));\n        } catch (e) {}\n      }\n    };\n    const onOffer = async ({\n      from,\n      offer\n    }) => {\n      const pc = pcRef.current;\n      if (!pc || pc.signalingState !== 'stable') return;\n      try {\n        await pc.setRemoteDescription(new RTCSessionDescription(offer));\n        const answer = await pc.createAnswer();\n        await pc.setLocalDescription(answer);\n        socket.emit('call:answer', {\n          roomId,\n          to: from,\n          answer\n        });\n        await processQueue();\n      } catch (e) {\n        console.error('[WebRTC] Offer process failed:', e);\n      }\n    };\n    const onAnswer = async ({\n      from,\n      answer\n    }) => {\n      const pc = pcRef.current;\n      if (!pc || pc.signalingState !== 'have-local-offer') return;\n      try {\n        await pc.setRemoteDescription(new RTCSessionDescription(answer));\n        await processQueue();\n        setStatus('Connecting...');\n      } catch (e) {\n        console.error('[WebRTC] Answer process failed:', e);\n      }\n    };\n    const onCandidate = async ({\n      from,\n      candidate\n    }) => {\n      var _pc$remoteDescription;\n      const pc = pcRef.current;\n      if (!pc) return;\n      if ((_pc$remoteDescription = pc.remoteDescription) !== null && _pc$remoteDescription !== void 0 && _pc$remoteDescription.type) {\n        try {\n          await pc.addIceCandidate(new RTCIceCandidate(candidate));\n        } catch (e) {}\n      } else {\n        candidateQueue.current.push(candidate);\n      }\n    };\n    const onEnd = () => {\n      fullDestruction();\n      onLeaveRef.current();\n    };\n    socket.on('call:offer', onOffer);\n    socket.on('call:answer', onAnswer);\n    socket.on('call:candidate', onCandidate);\n    socket.on('call:ended', onEnd);\n\n    // Mark signal listeners as ready — now it's safe for caller to send offer\n    signalReadyRef.current = true;\n    return () => {\n      socket.off('call:offer', onOffer);\n      socket.off('call:answer', onAnswer);\n      socket.off('call:candidate', onCandidate);\n      socket.off('call:ended', onEnd);\n      signalReadyRef.current = false;\n    };\n  }, [socket, roomId, fullDestruction]);\n\n  // ── 1. Media Initialization ───────────────────────────────────────────────\n  // RUN AFTER signal listeners are registered (deps includes socket so it runs\n  // after the signaling effect above).\n  useEffect(() => {\n    componentMounted.current = true;\n    const startHardware = async () => {\n      try {\n        setStatus('Accessing Camera/Mic...');\n        const stream = await navigator.mediaDevices.getUserMedia({\n          video: true,\n          audio: true\n        });\n        if (!componentMounted.current) {\n          stream.getTracks().forEach(t => t.stop());\n          return;\n        }\n        streamRef.current = stream;\n        setLocalStream(stream);\n        if (localVideoRef.current) localVideoRef.current.srcObject = stream;\n        initConnection(stream);\n      } catch (err) {\n        console.error('[WebRTC] Media Fail:', err);\n        setStatus('Media Permission Denied');\n        toast.error('Could not access camera/mic. Please check permissions.');\n      }\n    };\n    const initConnection = stream => {\n      const pc = new RTCPeerConnection(rtcConfig);\n      pcRef.current = pc;\n\n      // Add local tracks\n      stream.getTracks().forEach(track => pc.addTrack(track, stream));\n\n      // Remote stream handler\n      pc.ontrack = event => {\n        console.log('[WebRTC] Received Remote Track:', event.track.kind);\n        const rStream = event.streams[0];\n        setRemoteStream(rStream);\n        if (remoteVideoRef.current) {\n          remoteVideoRef.current.srcObject = rStream;\n          remoteVideoRef.current.play().catch(e => console.warn('Autoplay blocked:', e));\n        }\n      };\n\n      // Network health handler\n      pc.oniceconnectionstatechange = () => {\n        if (!componentMounted.current) return;\n        console.log('[WebRTC] Connection State:', pc.iceConnectionState);\n        const s = pc.iceConnectionState;\n        if (s === 'connected' || s === 'completed') setStatus('Connected');else if (s === 'checking') setStatus('Connecting...');else if (s === 'disconnected' || s === 'failed') setStatus('Connection Lost');else if (s === 'closed') setStatus('Ended');\n      };\n\n      // ICE Candidate signaling — uses ref so always has latest signalingId\n      pc.onicecandidate = event => {\n        if (event.candidate && signalingIdRef.current) {\n          socket.emit('call:candidate', {\n            roomId,\n            to: signalingIdRef.current,\n            candidate: event.candidate\n          });\n        }\n      };\n\n      // Start negotiation if we are the caller.\n      // Wait a tick to ensure signaling listeners from the other effect are registered.\n      if (isCallerRef.current) {\n        // Small delay so the React render cycle completes and signal listeners are live\n        setTimeout(() => {\n          if (componentMounted.current) handleNegotiation();\n        }, 300);\n      } else {\n        setStatus('Waiting for peer...');\n      }\n    };\n    startHardware();\n    return () => {\n      componentMounted.current = false;\n      fullDestruction();\n    };\n  }, [socket]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  // ── 4. Control Helpers ────────────────────────────────────────────────────\n  const toggleMic = () => {\n    var _streamRef$current;\n    const track = (_streamRef$current = streamRef.current) === null || _streamRef$current === void 0 ? void 0 : _streamRef$current.getAudioTracks()[0];\n    if (track) {\n      track.enabled = !track.enabled;\n      setIsMicEnabled(track.enabled);\n    }\n  };\n  const toggleCam = () => {\n    var _streamRef$current2;\n    const track = (_streamRef$current2 = streamRef.current) === null || _streamRef$current2 === void 0 ? void 0 : _streamRef$current2.getVideoTracks()[0];\n    if (track) {\n      track.enabled = !track.enabled;\n      setIsCamEnabled(track.enabled);\n    }\n  };\n\n  // Fix: was calling onEnd() which is scoped inside the signal useEffect — now correctly calls fullDestruction + onLeave\n  const handleLeave = () => {\n    socket.emit('call:end', {\n      roomId,\n      to: signalingIdRef.current\n    });\n    fullDestruction();\n    onLeaveRef.current();\n  };\n  const handleReconnect = () => {\n    if (isCallerRef.current) handleNegotiation();else setStatus('Waiting for host to reconnect...');\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"wb-meeting-container bg-slate-950 flex flex-col h-full w-full relative overflow-hidden font-sans\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"flex-1 grid grid-rows-2 md:grid-rows-1 md:grid-cols-2 gap-4 p-4 lg:p-6 overflow-hidden\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"relative group bg-slate-900 rounded-3xl overflow-hidden shadow-2xl transition-all duration-500 border border-slate-800\",\n        children: [/*#__PURE__*/_jsxDEV(\"video\", {\n          ref: localVideoRef,\n          autoPlay: true,\n          muted: true,\n          playsInline: true,\n          className: \"w-full h-full object-cover\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 260,\n          columnNumber: 21\n        }, this), !isCamEnabled && !isScreenSharing && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"absolute inset-0 flex items-center justify-center bg-slate-900 backdrop-blur-sm\",\n          children: /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"w-24 h-24 bg-indigo-600 rounded-full flex items-center justify-center text-4xl font-bold text-white shadow-lg ring-4 ring-indigo-500/20\",\n            children: username[0].toUpperCase()\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 263,\n            columnNumber: 29\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 262,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"absolute bottom-4 left-4 flex items-center gap-2 px-3 py-1.5 bg-slate-900/60 backdrop-blur-md rounded-full border border-white/10\",\n          children: [/*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"text-white font-semibold text-sm tracking-wide\",\n            children: [username, \" (You)\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 269,\n            columnNumber: 25\n          }, this), !isMicEnabled && /*#__PURE__*/_jsxDEV(MicOff, {\n            size: 14,\n            className: \"text-red-400\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 270,\n            columnNumber: 43\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 268,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 259,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"relative group bg-slate-900 rounded-3xl overflow-hidden shadow-2xl transition-all duration-500 border border-slate-800\",\n        children: [/*#__PURE__*/_jsxDEV(\"video\", {\n          ref: remoteVideoRef,\n          autoPlay: true,\n          playsInline: true,\n          className: \"w-full h-full object-cover\",\n          style: {\n            opacity: remoteStream ? 1 : 0\n          }\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 276,\n          columnNumber: 21\n        }, this), !remoteStream && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"absolute inset-0 flex flex-col items-center justify-center bg-slate-900 shadow-inner\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"relative\",\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"absolute inset-0 bg-indigo-500 blur-2xl opacity-20 animate-pulse\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 281,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent shadow-xl relative\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 282,\n              columnNumber: 33\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 280,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n            className: \"text-slate-400 mt-6 font-medium tracking-widest text-xs uppercase animate-pulse\",\n            children: \"Waiting for peer...\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 284,\n            columnNumber: 29\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 279,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"absolute bottom-4 left-4 flex items-center gap-2 px-3 py-1.5 bg-slate-900/60 backdrop-blur-md rounded-full border border-white/10\",\n          children: /*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"text-white font-semibold text-sm tracking-wide\",\n            children: \"Remote Participant\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 288,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 287,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 275,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 257,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"h-24 flex items-center justify-center px-8 bg-gradient-to-t from-slate-950 via-slate-950/90 to-transparent\",\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center gap-4 bg-slate-900/80 backdrop-blur-2xl px-6 py-4 rounded-3xl border border-white/5 shadow-2xl\",\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: toggleMic,\n          className: `p-4 rounded-2xl transition-all duration-300 ${isMicEnabled ? 'bg-slate-800 hover:bg-slate-700 text-white' : 'bg-red-500 text-white ring-4 ring-red-500/20 active:scale-90 hover:bg-red-600'}`,\n          children: isMicEnabled ? /*#__PURE__*/_jsxDEV(Mic, {\n            size: 22\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 297,\n            columnNumber: 41\n          }, this) : /*#__PURE__*/_jsxDEV(MicOff, {\n            size: 22\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 297,\n            columnNumber: 61\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 296,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: toggleCam,\n          className: `p-4 rounded-2xl transition-all duration-300 ${isCamEnabled ? 'bg-slate-800 hover:bg-slate-700 text-white' : 'bg-red-500 text-white ring-4 ring-red-500/20 active:scale-90 hover:bg-red-600'}`,\n          children: isCamEnabled ? /*#__PURE__*/_jsxDEV(Video, {\n            size: 22\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 301,\n            columnNumber: 41\n          }, this) : /*#__PURE__*/_jsxDEV(VideoOff, {\n            size: 22\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 301,\n            columnNumber: 63\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 300,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: handleReconnect,\n          className: \"p-4 bg-slate-800 hover:bg-slate-700 rounded-2xl text-white transition-all active:scale-90 group\",\n          title: \"Reconnect\",\n          children: /*#__PURE__*/_jsxDEV(RefreshCcw, {\n            size: 22,\n            className: \"group-active:rotate-180 transition-transform\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 305,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 304,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"w-px h-10 bg-white/10 mx-2\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 308,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: handleLeave,\n          className: \"p-4 bg-rose-600 hover:bg-rose-700 rounded-2xl text-white shadow-xl shadow-rose-900/20 transition-all hover:-translate-y-1 active:scale-90\",\n          children: /*#__PURE__*/_jsxDEV(PhoneOff, {\n            size: 22\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 311,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 310,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 295,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 294,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"absolute top-6 left-1/2 -translate-x-1/2 bg-slate-900/80 backdrop-blur-xl border border-white/5 px-5 py-2 rounded-full shadow-2xl flex items-center gap-3\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: `w-2 h-2 rounded-full animate-pulse shadow-[0_0_10px_rgba(255,255,255,0.5)] ${status === 'Connected' ? 'bg-emerald-400' : 'bg-amber-400'}`\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 318,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n        className: \"text-white text-[11px] font-bold uppercase tracking-widest leading-none\",\n        children: status\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 319,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 317,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 255,\n    columnNumber: 9\n  }, this);\n};\n_s(WebRTCMeeting, \"0HwC3YHDU8CUjP0EmRq8w0+rlIc=\");\n_c = WebRTCMeeting;\nexport default WebRTCMeeting;\nvar _c;\n$RefreshReg$(_c, \"WebRTCMeeting\");","map":{"version":3,"names":["React","useEffect","useRef","useState","useCallback","Mic","MicOff","Video","VideoOff","PhoneOff","Monitor","MonitorOff","RefreshCcw","toast","jsxDEV","_jsxDEV","WebRTCMeeting","socket","roomId","signalingId","isCaller","username","onLeave","_s","localStream","setLocalStream","remoteStream","setRemoteStream","isMicEnabled","setIsMicEnabled","isCamEnabled","setIsCamEnabled","isScreenSharing","setIsScreenSharing","status","setStatus","pcRef","localVideoRef","remoteVideoRef","streamRef","screenRef","candidateQueue","makingOffer","componentMounted","signalingIdRef","isCallerRef","onLeaveRef","current","signalReadyRef","rtcConfig","iceServers","urls","fullDestruction","close","getTracks","forEach","t","stop","handleNegotiation","offer","createOffer","setLocalDescription","emit","to","err","console","error","processQueue","length","_pcRef$current","remoteDescription","cand","shift","addIceCandidate","RTCIceCandidate","e","onOffer","from","pc","signalingState","setRemoteDescription","RTCSessionDescription","answer","createAnswer","onAnswer","onCandidate","candidate","_pc$remoteDescription","type","push","onEnd","on","off","startHardware","stream","navigator","mediaDevices","getUserMedia","video","audio","srcObject","initConnection","RTCPeerConnection","track","addTrack","ontrack","event","log","kind","rStream","streams","play","catch","warn","oniceconnectionstatechange","iceConnectionState","s","onicecandidate","setTimeout","toggleMic","_streamRef$current","getAudioTracks","enabled","toggleCam","_streamRef$current2","getVideoTracks","handleLeave","handleReconnect","className","children","ref","autoPlay","muted","playsInline","fileName","_jsxFileName","lineNumber","columnNumber","toUpperCase","size","style","opacity","onClick","title","_c","$RefreshReg$"],"sources":["D:/CapstoneProject/whiteboard-app/frontend/src/components/video/WebRTCMeeting.js"],"sourcesContent":["import React, { useEffect, useRef, useState, useCallback } from 'react';\r\nimport { Mic, MicOff, Video, VideoOff, PhoneOff, Monitor, MonitorOff, RefreshCcw } from 'lucide-react';\r\nimport toast from 'react-hot-toast';\r\n\r\n/**\r\n * WebRTCMeeting — Rebuilt with a robust 3-stage state machine.\r\n * - isCaller / signalingId are stored in refs to avoid stale-closure bugs.\r\n * - Signal listeners are registered BEFORE offer is sent (race-condition fix).\r\n * - handleLeave correctly calls fullDestruction + onLeave.\r\n */\r\nconst WebRTCMeeting = ({ socket, roomId, signalingId, isCaller, username, onLeave }) => {\r\n    // ── UI State ──────────────────────────────────────────────────────────────\r\n    const [localStream, setLocalStream] = useState(null);\r\n    const [remoteStream, setRemoteStream] = useState(null);\r\n    const [isMicEnabled, setIsMicEnabled] = useState(true);\r\n    const [isCamEnabled, setIsCamEnabled] = useState(true);\r\n    const [isScreenSharing, setIsScreenSharing] = useState(false);\r\n    const [status, setStatus] = useState('Initializing Media...');\r\n\r\n    // ── Management Refs (Persistent across renders) ───────────────────────────\r\n    const pcRef = useRef(null);\r\n    const localVideoRef = useRef(null);\r\n    const remoteVideoRef = useRef(null);\r\n    const streamRef = useRef(null);\r\n    const screenRef = useRef(null);\r\n    const candidateQueue = useRef([]);\r\n    const makingOffer = useRef(false);\r\n    const componentMounted = useRef(true);\r\n\r\n    // ── Stable refs for props (avoids stale-closure problems) ─────────────────\r\n    const signalingIdRef = useRef(signalingId);\r\n    const isCallerRef = useRef(isCaller);\r\n    const onLeaveRef = useRef(onLeave);\r\n    useEffect(() => { signalingIdRef.current = signalingId; }, [signalingId]);\r\n    useEffect(() => { isCallerRef.current = isCaller; }, [isCaller]);\r\n    useEffect(() => { onLeaveRef.current = onLeave; }, [onLeave]);\r\n\r\n    // ── signalReady: true once signal listeners are attached ──────────────────\r\n    const signalReadyRef = useRef(false);\r\n\r\n    const rtcConfig = {\r\n        iceServers: [\r\n            { urls: 'stun:stun.l.google.com:19302' },\r\n            { urls: 'stun:stun1.l.google.com:19302' },\r\n        ],\r\n    };\r\n\r\n    // ── Lifecycle Helpers (defined first so they're available everywhere) ─────\r\n    const fullDestruction = useCallback(() => {\r\n        if (pcRef.current) { pcRef.current.close(); pcRef.current = null; }\r\n        if (streamRef.current) {\r\n            streamRef.current.getTracks().forEach(t => t.stop());\r\n            streamRef.current = null;\r\n        }\r\n        if (screenRef.current) {\r\n            screenRef.current.getTracks().forEach(t => t.stop());\r\n            screenRef.current = null;\r\n        }\r\n        setLocalStream(null);\r\n        setRemoteStream(null);\r\n        setStatus('Call Ended');\r\n    }, []);\r\n\r\n    // ── 2. Negotiation Logic ──────────────────────────────────────────────────\r\n    const handleNegotiation = useCallback(async () => {\r\n        if (!pcRef.current || makingOffer.current) return;\r\n        try {\r\n            makingOffer.current = true;\r\n            setStatus('Negotiating...');\r\n            const offer = await pcRef.current.createOffer();\r\n            await pcRef.current.setLocalDescription(offer);\r\n            socket.emit('call:offer', { roomId, to: signalingIdRef.current, offer });\r\n        } catch (err) {\r\n            console.error('[WebRTC] Negotiation Failed:', err);\r\n        } finally {\r\n            makingOffer.current = false;\r\n        }\r\n    }, [socket, roomId]);\r\n\r\n    // ── 3. Signaling Handlers (Bound to socket events) ───────────────────────\r\n    // Registered BEFORE we send the offer, so the callee never misses it.\r\n    useEffect(() => {\r\n        if (!socket) return;\r\n\r\n        const processQueue = async () => {\r\n            while (candidateQueue.current.length > 0 && pcRef.current?.remoteDescription) {\r\n                const cand = candidateQueue.current.shift();\r\n                try { await pcRef.current.addIceCandidate(new RTCIceCandidate(cand)); } catch (e) { }\r\n            }\r\n        };\r\n\r\n        const onOffer = async ({ from, offer }) => {\r\n            const pc = pcRef.current;\r\n            if (!pc || pc.signalingState !== 'stable') return;\r\n            try {\r\n                await pc.setRemoteDescription(new RTCSessionDescription(offer));\r\n                const answer = await pc.createAnswer();\r\n                await pc.setLocalDescription(answer);\r\n                socket.emit('call:answer', { roomId, to: from, answer });\r\n                await processQueue();\r\n            } catch (e) { console.error('[WebRTC] Offer process failed:', e); }\r\n        };\r\n\r\n        const onAnswer = async ({ from, answer }) => {\r\n            const pc = pcRef.current;\r\n            if (!pc || pc.signalingState !== 'have-local-offer') return;\r\n            try {\r\n                await pc.setRemoteDescription(new RTCSessionDescription(answer));\r\n                await processQueue();\r\n                setStatus('Connecting...');\r\n            } catch (e) { console.error('[WebRTC] Answer process failed:', e); }\r\n        };\r\n\r\n        const onCandidate = async ({ from, candidate }) => {\r\n            const pc = pcRef.current;\r\n            if (!pc) return;\r\n            if (pc.remoteDescription?.type) {\r\n                try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); } catch (e) { }\r\n            } else {\r\n                candidateQueue.current.push(candidate);\r\n            }\r\n        };\r\n\r\n        const onEnd = () => {\r\n            fullDestruction();\r\n            onLeaveRef.current();\r\n        };\r\n\r\n        socket.on('call:offer', onOffer);\r\n        socket.on('call:answer', onAnswer);\r\n        socket.on('call:candidate', onCandidate);\r\n        socket.on('call:ended', onEnd);\r\n\r\n        // Mark signal listeners as ready — now it's safe for caller to send offer\r\n        signalReadyRef.current = true;\r\n\r\n        return () => {\r\n            socket.off('call:offer', onOffer);\r\n            socket.off('call:answer', onAnswer);\r\n            socket.off('call:candidate', onCandidate);\r\n            socket.off('call:ended', onEnd);\r\n            signalReadyRef.current = false;\r\n        };\r\n    }, [socket, roomId, fullDestruction]);\r\n\r\n    // ── 1. Media Initialization ───────────────────────────────────────────────\r\n    // RUN AFTER signal listeners are registered (deps includes socket so it runs\r\n    // after the signaling effect above).\r\n    useEffect(() => {\r\n        componentMounted.current = true;\r\n\r\n        const startHardware = async () => {\r\n            try {\r\n                setStatus('Accessing Camera/Mic...');\r\n                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });\r\n\r\n                if (!componentMounted.current) {\r\n                    stream.getTracks().forEach(t => t.stop());\r\n                    return;\r\n                }\r\n\r\n                streamRef.current = stream;\r\n                setLocalStream(stream);\r\n                if (localVideoRef.current) localVideoRef.current.srcObject = stream;\r\n\r\n                initConnection(stream);\r\n            } catch (err) {\r\n                console.error('[WebRTC] Media Fail:', err);\r\n                setStatus('Media Permission Denied');\r\n                toast.error('Could not access camera/mic. Please check permissions.');\r\n            }\r\n        };\r\n\r\n        const initConnection = (stream) => {\r\n            const pc = new RTCPeerConnection(rtcConfig);\r\n            pcRef.current = pc;\r\n\r\n            // Add local tracks\r\n            stream.getTracks().forEach(track => pc.addTrack(track, stream));\r\n\r\n            // Remote stream handler\r\n            pc.ontrack = (event) => {\r\n                console.log('[WebRTC] Received Remote Track:', event.track.kind);\r\n                const rStream = event.streams[0];\r\n                setRemoteStream(rStream);\r\n                if (remoteVideoRef.current) {\r\n                    remoteVideoRef.current.srcObject = rStream;\r\n                    remoteVideoRef.current.play().catch(e => console.warn('Autoplay blocked:', e));\r\n                }\r\n            };\r\n\r\n            // Network health handler\r\n            pc.oniceconnectionstatechange = () => {\r\n                if (!componentMounted.current) return;\r\n                console.log('[WebRTC] Connection State:', pc.iceConnectionState);\r\n\r\n                const s = pc.iceConnectionState;\r\n                if (s === 'connected' || s === 'completed') setStatus('Connected');\r\n                else if (s === 'checking') setStatus('Connecting...');\r\n                else if (s === 'disconnected' || s === 'failed') setStatus('Connection Lost');\r\n                else if (s === 'closed') setStatus('Ended');\r\n            };\r\n\r\n            // ICE Candidate signaling — uses ref so always has latest signalingId\r\n            pc.onicecandidate = (event) => {\r\n                if (event.candidate && signalingIdRef.current) {\r\n                    socket.emit('call:candidate', { roomId, to: signalingIdRef.current, candidate: event.candidate });\r\n                }\r\n            };\r\n\r\n            // Start negotiation if we are the caller.\r\n            // Wait a tick to ensure signaling listeners from the other effect are registered.\r\n            if (isCallerRef.current) {\r\n                // Small delay so the React render cycle completes and signal listeners are live\r\n                setTimeout(() => {\r\n                    if (componentMounted.current) handleNegotiation();\r\n                }, 300);\r\n            } else {\r\n                setStatus('Waiting for peer...');\r\n            }\r\n        };\r\n\r\n        startHardware();\r\n\r\n        return () => {\r\n            componentMounted.current = false;\r\n            fullDestruction();\r\n        };\r\n    }, [socket]); // eslint-disable-line react-hooks/exhaustive-deps\r\n\r\n    // ── 4. Control Helpers ────────────────────────────────────────────────────\r\n    const toggleMic = () => {\r\n        const track = streamRef.current?.getAudioTracks()[0];\r\n        if (track) { track.enabled = !track.enabled; setIsMicEnabled(track.enabled); }\r\n    };\r\n\r\n    const toggleCam = () => {\r\n        const track = streamRef.current?.getVideoTracks()[0];\r\n        if (track) { track.enabled = !track.enabled; setIsCamEnabled(track.enabled); }\r\n    };\r\n\r\n    // Fix: was calling onEnd() which is scoped inside the signal useEffect — now correctly calls fullDestruction + onLeave\r\n    const handleLeave = () => {\r\n        socket.emit('call:end', { roomId, to: signalingIdRef.current });\r\n        fullDestruction();\r\n        onLeaveRef.current();\r\n    };\r\n\r\n    const handleReconnect = () => {\r\n        if (isCallerRef.current) handleNegotiation();\r\n        else setStatus('Waiting for host to reconnect...');\r\n    };\r\n\r\n    return (\r\n        <div className=\"wb-meeting-container bg-slate-950 flex flex-col h-full w-full relative overflow-hidden font-sans\">\r\n            {/* Main Video Stage */}\r\n            <div className=\"flex-1 grid grid-rows-2 md:grid-rows-1 md:grid-cols-2 gap-4 p-4 lg:p-6 overflow-hidden\">\r\n                {/* Local User */}\r\n                <div className=\"relative group bg-slate-900 rounded-3xl overflow-hidden shadow-2xl transition-all duration-500 border border-slate-800\">\r\n                    <video ref={localVideoRef} autoPlay muted playsInline className=\"w-full h-full object-cover\" />\r\n                    {!isCamEnabled && !isScreenSharing && (\r\n                        <div className=\"absolute inset-0 flex items-center justify-center bg-slate-900 backdrop-blur-sm\">\r\n                            <div className=\"w-24 h-24 bg-indigo-600 rounded-full flex items-center justify-center text-4xl font-bold text-white shadow-lg ring-4 ring-indigo-500/20\">\r\n                                {username[0].toUpperCase()}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                    <div className=\"absolute bottom-4 left-4 flex items-center gap-2 px-3 py-1.5 bg-slate-900/60 backdrop-blur-md rounded-full border border-white/10\">\r\n                        <span className=\"text-white font-semibold text-sm tracking-wide\">{username} (You)</span>\r\n                        {!isMicEnabled && <MicOff size={14} className=\"text-red-400\" />}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Remote User */}\r\n                <div className=\"relative group bg-slate-900 rounded-3xl overflow-hidden shadow-2xl transition-all duration-500 border border-slate-800\">\r\n                    <video ref={remoteVideoRef} autoPlay playsInline className=\"w-full h-full object-cover\"\r\n                        style={{ opacity: remoteStream ? 1 : 0 }} />\r\n                    {!remoteStream && (\r\n                        <div className=\"absolute inset-0 flex flex-col items-center justify-center bg-slate-900 shadow-inner\">\r\n                            <div className=\"relative\">\r\n                                <div className=\"absolute inset-0 bg-indigo-500 blur-2xl opacity-20 animate-pulse\"></div>\r\n                                <div className=\"animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent shadow-xl relative\"></div>\r\n                            </div>\r\n                            <p className=\"text-slate-400 mt-6 font-medium tracking-widest text-xs uppercase animate-pulse\">Waiting for peer...</p>\r\n                        </div>\r\n                    )}\r\n                    <div className=\"absolute bottom-4 left-4 flex items-center gap-2 px-3 py-1.5 bg-slate-900/60 backdrop-blur-md rounded-full border border-white/10\">\r\n                        <span className=\"text-white font-semibold text-sm tracking-wide\">Remote Participant</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Premium Control Bar */}\r\n            <div className=\"h-24 flex items-center justify-center px-8 bg-gradient-to-t from-slate-950 via-slate-950/90 to-transparent\">\r\n                <div className=\"flex items-center gap-4 bg-slate-900/80 backdrop-blur-2xl px-6 py-4 rounded-3xl border border-white/5 shadow-2xl\">\r\n                    <button onClick={toggleMic} className={`p-4 rounded-2xl transition-all duration-300 ${isMicEnabled ? 'bg-slate-800 hover:bg-slate-700 text-white' : 'bg-red-500 text-white ring-4 ring-red-500/20 active:scale-90 hover:bg-red-600'}`}>\r\n                        {isMicEnabled ? <Mic size={22} /> : <MicOff size={22} />}\r\n                    </button>\r\n\r\n                    <button onClick={toggleCam} className={`p-4 rounded-2xl transition-all duration-300 ${isCamEnabled ? 'bg-slate-800 hover:bg-slate-700 text-white' : 'bg-red-500 text-white ring-4 ring-red-500/20 active:scale-90 hover:bg-red-600'}`}>\r\n                        {isCamEnabled ? <Video size={22} /> : <VideoOff size={22} />}\r\n                    </button>\r\n\r\n                    <button onClick={handleReconnect} className=\"p-4 bg-slate-800 hover:bg-slate-700 rounded-2xl text-white transition-all active:scale-90 group\" title=\"Reconnect\">\r\n                        <RefreshCcw size={22} className=\"group-active:rotate-180 transition-transform\" />\r\n                    </button>\r\n\r\n                    <div className=\"w-px h-10 bg-white/10 mx-2\"></div>\r\n\r\n                    <button onClick={handleLeave} className=\"p-4 bg-rose-600 hover:bg-rose-700 rounded-2xl text-white shadow-xl shadow-rose-900/20 transition-all hover:-translate-y-1 active:scale-90\">\r\n                        <PhoneOff size={22} />\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Dynamic Status Indicator */}\r\n            <div className=\"absolute top-6 left-1/2 -translate-x-1/2 bg-slate-900/80 backdrop-blur-xl border border-white/5 px-5 py-2 rounded-full shadow-2xl flex items-center gap-3\">\r\n                <div className={`w-2 h-2 rounded-full animate-pulse shadow-[0_0_10px_rgba(255,255,255,0.5)] ${status === 'Connected' ? 'bg-emerald-400' : 'bg-amber-400'}`}></div>\r\n                <span className=\"text-white text-[11px] font-bold uppercase tracking-widest leading-none\">{status}</span>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default WebRTCMeeting;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}