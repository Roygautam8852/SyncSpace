{"ast":null,"code":"var _jsxFileName = \"D:\\\\CapstoneProject\\\\whiteboard-app\\\\frontend\\\\src\\\\components\\\\video\\\\WebRTCMeeting.js\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\nimport React, { useEffect, useRef, useState, useCallback } from 'react';\nimport { Mic, MicOff, Video, VideoOff, PhoneOff, Monitor, MonitorOff, Minimize2, Maximize2, GripHorizontal } from 'lucide-react';\nimport toast from 'react-hot-toast';\n\n/**\r\n * WebRTCMeeting — Zoom-like group call via P2P mesh.\r\n *\r\n * Key guarantees:\r\n * - NEVER creates a peer connection to self (filters own socketId)\r\n * - Only one mesh:join emission per mount (joinedRef guard)\r\n * - ICE candidates are queued until remoteDescription is set\r\n * - Local <video> always has `muted` to prevent echo\r\n * - Mute uses track.enabled (not track.stop) so unmute works\r\n * - Only one RTCPeerConnection per remote socketId\r\n */\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst WebRTCMeeting = ({\n  socket,\n  roomId,\n  username,\n  onLeave\n}) => {\n  _s();\n  var _username$;\n  const [localStream, setLocalStream] = useState(null);\n  const [peers, setPeers] = useState({});\n  const [isMicEnabled, setIsMicEnabled] = useState(true);\n  const [isCamEnabled, setIsCamEnabled] = useState(true);\n  const [isScreenSharing, setIsScreenSharing] = useState(false);\n  const [isMinimized, setIsMinimized] = useState(false);\n  const localVideoRef = useRef(null);\n  const streamRef = useRef(null);\n  const screenRef = useRef(null);\n  const peersRef = useRef({});\n  const componentMounted = useRef(true);\n  const joinedRef = useRef(false); // Prevent duplicate mesh:join\n  const onLeaveRef = useRef(onLeave);\n  useEffect(() => {\n    onLeaveRef.current = onLeave;\n  }, [onLeave]);\n\n  // Drag\n  const containerRef = useRef(null);\n  const isDragging = useRef(false);\n  const dragOffset = useRef({\n    x: 0,\n    y: 0\n  });\n  const [position, setPosition] = useState({\n    x: 16,\n    y: 70\n  });\n  const rtcConfig = useRef({\n    iceServers: [{\n      urls: 'stun:stun.l.google.com:19302'\n    }, {\n      urls: 'stun:stun1.l.google.com:19302'\n    }]\n  }).current;\n\n  // ── Flush queued ICE candidates ───────────────────────────────────────────\n  const flushCandidates = useCallback(async socketId => {\n    var _peer$pc$remoteDescri;\n    const peer = peersRef.current[socketId];\n    if (!(peer !== null && peer !== void 0 && peer.pc) || !((_peer$pc$remoteDescri = peer.pc.remoteDescription) !== null && _peer$pc$remoteDescri !== void 0 && _peer$pc$remoteDescri.type)) return;\n    while (((_peer$candidateQueue = peer.candidateQueue) === null || _peer$candidateQueue === void 0 ? void 0 : _peer$candidateQueue.length) > 0) {\n      var _peer$candidateQueue;\n      const c = peer.candidateQueue.shift();\n      try {\n        await peer.pc.addIceCandidate(new RTCIceCandidate(c));\n      } catch (_) {}\n    }\n  }, []);\n\n  // ── Push ref state → React state ──────────────────────────────────────────\n  const syncPeersState = useCallback(() => {\n    const snap = {};\n    Object.entries(peersRef.current).forEach(([id, p]) => {\n      snap[id] = {\n        stream: p.stream,\n        username: p.username\n      };\n    });\n    setPeers(snap);\n  }, []);\n\n  // ── Remove a peer cleanly ─────────────────────────────────────────────────\n  const removePeer = useCallback(socketId => {\n    const peer = peersRef.current[socketId];\n    if (peer) {\n      try {\n        var _peer$pc;\n        (_peer$pc = peer.pc) === null || _peer$pc === void 0 ? void 0 : _peer$pc.close();\n      } catch (_) {}\n      delete peersRef.current[socketId];\n      syncPeersState();\n    }\n  }, [syncPeersState]);\n\n  // ── Create ONE PeerConnection per remote socketId ─────────────────────────\n  const createPeer = useCallback((targetSocketId, targetUsername, stream, isInitiator) => {\n    // NEVER connect to self\n    if (targetSocketId === (socket === null || socket === void 0 ? void 0 : socket.id)) return null;\n\n    // If we already have a live PC for this peer, return it\n    const existing = peersRef.current[targetSocketId];\n    if (existing !== null && existing !== void 0 && existing.pc) {\n      const state = existing.pc.connectionState || existing.pc.iceConnectionState;\n      if (state !== 'closed' && state !== 'failed') {\n        return existing.pc;\n      }\n      // Dead connection — clean up\n      try {\n        existing.pc.close();\n      } catch (_) {}\n    }\n    const pc = new RTCPeerConnection(rtcConfig);\n\n    // Add every local track\n    stream.getTracks().forEach(track => pc.addTrack(track, stream));\n\n    // Store immediately with candidate queue\n    peersRef.current[targetSocketId] = {\n      pc,\n      stream: null,\n      username: targetUsername,\n      candidateQueue: []\n    };\n\n    // ── Remote tracks ──\n    pc.ontrack = event => {\n      var _event$streams;\n      const rStream = (_event$streams = event.streams) === null || _event$streams === void 0 ? void 0 : _event$streams[0];\n      if (!rStream) return;\n      const entry = peersRef.current[targetSocketId];\n      if (entry) entry.stream = rStream;\n      syncPeersState();\n    };\n\n    // ── ICE candidates → remote ──\n    pc.onicecandidate = event => {\n      if (event.candidate) {\n        socket.emit('mesh:candidate', {\n          roomId,\n          to: targetSocketId,\n          candidate: event.candidate\n        });\n      }\n    };\n\n    // ── Connection state changes ──\n    pc.oniceconnectionstatechange = () => {\n      const s = pc.iceConnectionState;\n      if (s === 'connected' || s === 'completed') syncPeersState();\n      if (s === 'failed') removePeer(targetSocketId);\n    };\n    syncPeersState();\n\n    // Initiator sends offer\n    if (isInitiator) {\n      (async () => {\n        try {\n          const offer = await pc.createOffer();\n          await pc.setLocalDescription(offer);\n          socket.emit('mesh:offer', {\n            roomId,\n            to: targetSocketId,\n            offer: pc.localDescription\n          });\n        } catch (err) {\n          console.error('[Mesh] Offer error:', err);\n        }\n      })();\n    }\n    return pc;\n  }, [socket, roomId, rtcConfig, removePeer, syncPeersState]);\n\n  // ══════════════════════════════════════════════════════════════════════════\n  //  1. Get media → join call (runs ONCE per mount)\n  // ══════════════════════════════════════════════════════════════════════════\n  useEffect(() => {\n    componentMounted.current = true;\n    joinedRef.current = false;\n    const start = async () => {\n      try {\n        const stream = await navigator.mediaDevices.getUserMedia({\n          video: true,\n          audio: {\n            echoCancellation: true,\n            noiseSuppression: true\n          }\n        });\n        if (!componentMounted.current) {\n          stream.getTracks().forEach(t => t.stop());\n          return;\n        }\n        streamRef.current = stream;\n        setLocalStream(stream);\n\n        // Attach to <video> — always muted to prevent echo\n        if (localVideoRef.current) {\n          localVideoRef.current.srcObject = stream;\n          localVideoRef.current.muted = true;\n        }\n\n        // Emit mesh:join exactly once\n        if (!joinedRef.current) {\n          joinedRef.current = true;\n          socket.emit('mesh:join', {\n            roomId,\n            username\n          });\n        }\n      } catch (err) {\n        console.error('[WebRTC] Media error:', err);\n        toast.error('Could not access camera or microphone.');\n      }\n    };\n    start();\n    return () => {\n      componentMounted.current = false;\n      joinedRef.current = false;\n\n      // Close every peer connection\n      Object.keys(peersRef.current).forEach(id => {\n        try {\n          var _peersRef$current$id, _peersRef$current$id$;\n          (_peersRef$current$id = peersRef.current[id]) === null || _peersRef$current$id === void 0 ? void 0 : (_peersRef$current$id$ = _peersRef$current$id.pc) === null || _peersRef$current$id$ === void 0 ? void 0 : _peersRef$current$id$.close();\n        } catch (_) {}\n      });\n      peersRef.current = {};\n\n      // Stop local tracks\n      if (streamRef.current) {\n        streamRef.current.getTracks().forEach(t => t.stop());\n        streamRef.current = null;\n      }\n      if (screenRef.current) {\n        screenRef.current.getTracks().forEach(t => t.stop());\n        screenRef.current = null;\n      }\n    };\n    // eslint-disable-next-line\n  }, []); // Empty deps — run once on mount, clean up on unmount\n\n  // ══════════════════════════════════════════════════════════════════════════\n  //  2. Socket signaling (mesh topology)\n  // ══════════════════════════════════════════════════════════════════════════\n  useEffect(() => {\n    if (!socket) return;\n    const myId = socket.id;\n\n    // Server sends existing call participants\n    const onExistingPeers = ({\n      peers: existingPeers\n    }) => {\n      if (!streamRef.current) return;\n      existingPeers.forEach(p => {\n        // Never connect to self\n        if (p.socketId === myId) return;\n        createPeer(p.socketId, p.username, streamRef.current, true);\n      });\n    };\n\n    // A new peer joined — pre-create PC (they will send us an offer)\n    const onNewPeer = ({\n      socketId,\n      username: peerName\n    }) => {\n      if (!streamRef.current || socketId === myId) return;\n      createPeer(socketId, peerName, streamRef.current, false);\n    };\n\n    // Receive offer\n    const onOffer = async ({\n      from,\n      offer,\n      username: peerName\n    }) => {\n      if (!streamRef.current || from === myId) return;\n      let peer = peersRef.current[from];\n      let pc;\n      if (!(peer !== null && peer !== void 0 && peer.pc) || peer.pc.signalingState === 'closed') {\n        pc = createPeer(from, peerName, streamRef.current, false);\n      } else {\n        pc = peer.pc;\n        if (peerName) peersRef.current[from].username = peerName;\n      }\n      if (!pc) return;\n      try {\n        // Glare: both sides sent offers — higher ID yields\n        if (pc.signalingState === 'have-local-offer') {\n          if (myId > from) {\n            await pc.setLocalDescription({\n              type: 'rollback'\n            });\n          } else {\n            return;\n          }\n        }\n        await pc.setRemoteDescription(new RTCSessionDescription(offer));\n        await flushCandidates(from);\n        const answer = await pc.createAnswer();\n        await pc.setLocalDescription(answer);\n        socket.emit('mesh:answer', {\n          roomId,\n          to: from,\n          answer: pc.localDescription\n        });\n      } catch (e) {\n        console.error('[Mesh] Offer handling error:', e);\n      }\n    };\n\n    // Receive answer\n    const onAnswer = async ({\n      from,\n      answer\n    }) => {\n      const peer = peersRef.current[from];\n      if (!(peer !== null && peer !== void 0 && peer.pc) || peer.pc.signalingState !== 'have-local-offer') return;\n      try {\n        await peer.pc.setRemoteDescription(new RTCSessionDescription(answer));\n        await flushCandidates(from);\n      } catch (e) {\n        console.error('[Mesh] Answer error:', e);\n      }\n    };\n\n    // Receive ICE candidate — queue if remote description not ready\n    const onCandidate = async ({\n      from,\n      candidate\n    }) => {\n      var _peer$pc$remoteDescri2;\n      const peer = peersRef.current[from];\n      if (!(peer !== null && peer !== void 0 && peer.pc)) return;\n      if ((_peer$pc$remoteDescri2 = peer.pc.remoteDescription) !== null && _peer$pc$remoteDescri2 !== void 0 && _peer$pc$remoteDescri2.type) {\n        try {\n          await peer.pc.addIceCandidate(new RTCIceCandidate(candidate));\n        } catch (_) {}\n      } else {\n        peer.candidateQueue = peer.candidateQueue || [];\n        peer.candidateQueue.push(candidate);\n      }\n    };\n\n    // A peer left\n    const onPeerLeft = ({\n      socketId\n    }) => removePeer(socketId);\n    socket.on('mesh:existing-peers', onExistingPeers);\n    socket.on('mesh:new-peer', onNewPeer);\n    socket.on('mesh:offer', onOffer);\n    socket.on('mesh:answer', onAnswer);\n    socket.on('mesh:candidate', onCandidate);\n    socket.on('mesh:peer-left', onPeerLeft);\n    return () => {\n      socket.off('mesh:existing-peers', onExistingPeers);\n      socket.off('mesh:new-peer', onNewPeer);\n      socket.off('mesh:offer', onOffer);\n      socket.off('mesh:answer', onAnswer);\n      socket.off('mesh:candidate', onCandidate);\n      socket.off('mesh:peer-left', onPeerLeft);\n    };\n  }, [socket, roomId, createPeer, removePeer, flushCandidates]);\n\n  // ══════════════════════════════════════════════════════════════════════════\n  //  Controls\n  // ══════════════════════════════════════════════════════════════════════════\n  const toggleMic = () => {\n    var _streamRef$current;\n    const audioTrack = (_streamRef$current = streamRef.current) === null || _streamRef$current === void 0 ? void 0 : _streamRef$current.getAudioTracks()[0];\n    if (!audioTrack) return;\n    audioTrack.enabled = !audioTrack.enabled; // enabled, NOT stop()\n    setIsMicEnabled(audioTrack.enabled);\n  };\n  const toggleCam = () => {\n    var _streamRef$current2;\n    const videoTrack = (_streamRef$current2 = streamRef.current) === null || _streamRef$current2 === void 0 ? void 0 : _streamRef$current2.getVideoTracks()[0];\n    if (!videoTrack) return;\n    videoTrack.enabled = !videoTrack.enabled;\n    setIsCamEnabled(videoTrack.enabled);\n  };\n  const toggleScreenShare = async () => {\n    if (isScreenSharing) {\n      var _streamRef$current3;\n      if (screenRef.current) {\n        screenRef.current.getTracks().forEach(t => t.stop());\n        screenRef.current = null;\n      }\n      const camTrack = (_streamRef$current3 = streamRef.current) === null || _streamRef$current3 === void 0 ? void 0 : _streamRef$current3.getVideoTracks()[0];\n      Object.values(peersRef.current).forEach(({\n        pc\n      }) => {\n        var _pc$getSenders, _pc$getSenders$call;\n        const sender = pc === null || pc === void 0 ? void 0 : (_pc$getSenders = pc.getSenders) === null || _pc$getSenders === void 0 ? void 0 : (_pc$getSenders$call = _pc$getSenders.call(pc)) === null || _pc$getSenders$call === void 0 ? void 0 : _pc$getSenders$call.find(s => {\n          var _s$track;\n          return ((_s$track = s.track) === null || _s$track === void 0 ? void 0 : _s$track.kind) === 'video';\n        });\n        if (sender && camTrack) sender.replaceTrack(camTrack);\n      });\n      if (localVideoRef.current && streamRef.current) localVideoRef.current.srcObject = streamRef.current;\n      setIsScreenSharing(false);\n    } else {\n      try {\n        const screenStream = await navigator.mediaDevices.getDisplayMedia({\n          video: true\n        });\n        screenRef.current = screenStream;\n        const screenTrack = screenStream.getVideoTracks()[0];\n        Object.values(peersRef.current).forEach(({\n          pc\n        }) => {\n          var _pc$getSenders2, _pc$getSenders2$call;\n          const sender = pc === null || pc === void 0 ? void 0 : (_pc$getSenders2 = pc.getSenders) === null || _pc$getSenders2 === void 0 ? void 0 : (_pc$getSenders2$call = _pc$getSenders2.call(pc)) === null || _pc$getSenders2$call === void 0 ? void 0 : _pc$getSenders2$call.find(s => {\n            var _s$track2;\n            return ((_s$track2 = s.track) === null || _s$track2 === void 0 ? void 0 : _s$track2.kind) === 'video';\n          });\n          if (sender) sender.replaceTrack(screenTrack);\n        });\n        if (localVideoRef.current) localVideoRef.current.srcObject = screenStream;\n        screenTrack.onended = () => toggleScreenShare();\n        setIsScreenSharing(true);\n      } catch (_) {}\n    }\n  };\n  const handleLeave = () => {\n    socket.emit('mesh:leave', {\n      roomId\n    });\n    Object.keys(peersRef.current).forEach(id => {\n      try {\n        var _peersRef$current$id2, _peersRef$current$id3;\n        (_peersRef$current$id2 = peersRef.current[id]) === null || _peersRef$current$id2 === void 0 ? void 0 : (_peersRef$current$id3 = _peersRef$current$id2.pc) === null || _peersRef$current$id3 === void 0 ? void 0 : _peersRef$current$id3.close();\n      } catch (_) {}\n    });\n    peersRef.current = {};\n    if (streamRef.current) {\n      streamRef.current.getTracks().forEach(t => t.stop());\n      streamRef.current = null;\n    }\n    if (screenRef.current) {\n      screenRef.current.getTracks().forEach(t => t.stop());\n      screenRef.current = null;\n    }\n    onLeaveRef.current();\n  };\n\n  // ── Drag ──────────────────────────────────────────────────────────────────\n  const onDragStart = e => {\n    isDragging.current = true;\n    const rect = containerRef.current.getBoundingClientRect();\n    dragOffset.current = {\n      x: e.clientX - rect.left,\n      y: e.clientY - rect.top\n    };\n    const move = ev => {\n      if (!isDragging.current) return;\n      setPosition({\n        x: Math.max(0, Math.min(window.innerWidth - 120, ev.clientX - dragOffset.current.x)),\n        y: Math.max(0, Math.min(window.innerHeight - 80, ev.clientY - dragOffset.current.y))\n      });\n    };\n    const up = () => {\n      isDragging.current = false;\n      document.removeEventListener('mousemove', move);\n      document.removeEventListener('mouseup', up);\n    };\n    document.addEventListener('mousemove', move);\n    document.addEventListener('mouseup', up);\n  };\n\n  // ── Only render remote peers that are alive ───────────────────────────────\n  const peerEntries = Object.entries(peers).filter(([id]) => id !== (socket === null || socket === void 0 ? void 0 : socket.id) // Extra safety: never render self as remote\n  );\n  const participantCount = 1 + peerEntries.length;\n\n  // ── Minimized ─────────────────────────────────────────────────────────────\n  if (isMinimized) {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      ref: containerRef,\n      className: \"wbrtc-floating wbrtc-minimized\",\n      style: {\n        left: position.x,\n        top: position.y\n      },\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"wbrtc-mini-bar\",\n        onMouseDown: onDragStart,\n        children: [/*#__PURE__*/_jsxDEV(GripHorizontal, {\n          size: 14,\n          className: \"wbrtc-grip\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 406,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wbrtc-mini-info\",\n          children: [/*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"wbrtc-mini-dot\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 408,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n            children: [participantCount, \" in call\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 409,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 407,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"wbrtc-mini-btn\",\n          onClick: () => setIsMinimized(false),\n          title: \"Expand\",\n          children: /*#__PURE__*/_jsxDEV(Maximize2, {\n            size: 13\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 411,\n            columnNumber: 109\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 411,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"wbrtc-mini-btn wbrtc-mini-leave\",\n          onClick: handleLeave,\n          title: \"Leave\",\n          children: /*#__PURE__*/_jsxDEV(PhoneOff, {\n            size: 13\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 412,\n            columnNumber: 109\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 412,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 405,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 404,\n      columnNumber: 13\n    }, this);\n  }\n\n  // ── Full floating window ──────────────────────────────────────────────────\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    ref: containerRef,\n    className: \"wbrtc-floating\",\n    style: {\n      left: position.x,\n      top: position.y\n    },\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"wbrtc-drag-bar\",\n      onMouseDown: onDragStart,\n      children: [/*#__PURE__*/_jsxDEV(GripHorizontal, {\n        size: 14,\n        className: \"wbrtc-grip\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 423,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n        className: \"wbrtc-drag-title\",\n        children: [participantCount, \" in call\"]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 424,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"wbrtc-drag-actions\",\n        children: /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"wbrtc-mini-btn\",\n          onClick: () => setIsMinimized(true),\n          title: \"Minimize\",\n          children: /*#__PURE__*/_jsxDEV(Minimize2, {\n            size: 13\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 426,\n            columnNumber: 110\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 426,\n          columnNumber: 21\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 425,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 422,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"wbrtc-grid\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"wbrtc-tile\",\n        children: [/*#__PURE__*/_jsxDEV(\"video\", {\n          ref: localVideoRef,\n          autoPlay: true,\n          muted: true /* ← ALWAYS muted to prevent echo */,\n          playsInline: true,\n          className: \"wbrtc-tile-video wbrtc-tile-mirror\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 434,\n          columnNumber: 21\n        }, this), !isCamEnabled && !isScreenSharing && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wbrtc-tile-avatar\",\n          children: username === null || username === void 0 ? void 0 : (_username$ = username[0]) === null || _username$ === void 0 ? void 0 : _username$.toUpperCase()\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 442,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wbrtc-tile-name\",\n          children: [username, \" (You)\", !isMicEnabled && /*#__PURE__*/_jsxDEV(MicOff, {\n            size: 10,\n            className: \"wbrtc-tile-muted\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 446,\n            columnNumber: 43\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 444,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 433,\n        columnNumber: 17\n      }, this), peerEntries.map(([socketId, peer]) => {\n        var _2;\n        return /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"wbrtc-tile\",\n          children: [peer.stream ? /*#__PURE__*/_jsxDEV(RemoteVideo, {\n            stream: peer.stream\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 454,\n            columnNumber: 29\n          }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"wbrtc-tile-avatar\",\n            children: (_2 = (peer.username || '?')[0]) === null || _2 === void 0 ? void 0 : _2.toUpperCase()\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 456,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"wbrtc-tile-name\",\n            children: peer.username || 'Participant'\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 458,\n            columnNumber: 25\n          }, this)]\n        }, socketId, true, {\n          fileName: _jsxFileName,\n          lineNumber: 452,\n          columnNumber: 21\n        }, this);\n      })]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 431,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"wbrtc-controls\",\n      children: [/*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: toggleMic,\n        className: `wbrtc-btn ${!isMicEnabled ? 'wbrtc-btn--danger' : ''}`,\n        title: isMicEnabled ? 'Mute' : 'Unmute',\n        children: isMicEnabled ? /*#__PURE__*/_jsxDEV(Mic, {\n          size: 15\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 466,\n          columnNumber: 37\n        }, this) : /*#__PURE__*/_jsxDEV(MicOff, {\n          size: 15\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 466,\n          columnNumber: 57\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 465,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: toggleCam,\n        className: `wbrtc-btn ${!isCamEnabled ? 'wbrtc-btn--danger' : ''}`,\n        title: isCamEnabled ? 'Stop Video' : 'Start Video',\n        children: isCamEnabled ? /*#__PURE__*/_jsxDEV(Video, {\n          size: 15\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 469,\n          columnNumber: 37\n        }, this) : /*#__PURE__*/_jsxDEV(VideoOff, {\n          size: 15\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 469,\n          columnNumber: 59\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 468,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: toggleScreenShare,\n        className: `wbrtc-btn ${isScreenSharing ? 'wbrtc-btn--active' : ''}`,\n        title: isScreenSharing ? 'Stop Sharing' : 'Share Screen',\n        children: isScreenSharing ? /*#__PURE__*/_jsxDEV(MonitorOff, {\n          size: 15\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 472,\n          columnNumber: 40\n        }, this) : /*#__PURE__*/_jsxDEV(Monitor, {\n          size: 15\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 472,\n          columnNumber: 67\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 471,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"wbrtc-divider\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 474,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: handleLeave,\n        className: \"wbrtc-btn wbrtc-btn--leave\",\n        title: \"Leave call\",\n        children: /*#__PURE__*/_jsxDEV(PhoneOff, {\n          size: 15\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 476,\n          columnNumber: 21\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 475,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 464,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 420,\n    columnNumber: 9\n  }, this);\n};\n\n// ── Remote video renderer (memoized, never muted) ─────────────────────────────\n_s(WebRTCMeeting, \"rl1Mn4l9c89FBng/28dWlwMbvdE=\");\n_c = WebRTCMeeting;\nconst RemoteVideo = /*#__PURE__*/_s2(/*#__PURE__*/React.memo(_c2 = _s2(({\n  stream\n}) => {\n  _s2();\n  const ref = useRef(null);\n  useEffect(() => {\n    const vid = ref.current;\n    if (!vid || !stream) return;\n    vid.srcObject = stream;\n    vid.muted = false; // Remote audio MUST be audible\n\n    const tryPlay = () => vid.play().catch(() => {});\n    if (stream.active) tryPlay();\n    stream.addEventListener('addtrack', tryPlay);\n    return () => stream.removeEventListener('addtrack', tryPlay);\n  }, [stream]);\n  return /*#__PURE__*/_jsxDEV(\"video\", {\n    ref: ref,\n    autoPlay: true,\n    playsInline: true,\n    className: \"wbrtc-tile-video\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 501,\n    columnNumber: 12\n  }, this);\n}, \"8uVE59eA/r6b92xF80p7sH8rXLk=\")), \"8uVE59eA/r6b92xF80p7sH8rXLk=\");\n_c3 = RemoteVideo;\nexport default WebRTCMeeting;\nvar _c, _c2, _c3;\n$RefreshReg$(_c, \"WebRTCMeeting\");\n$RefreshReg$(_c2, \"RemoteVideo$React.memo\");\n$RefreshReg$(_c3, \"RemoteVideo\");","map":{"version":3,"names":["React","useEffect","useRef","useState","useCallback","Mic","MicOff","Video","VideoOff","PhoneOff","Monitor","MonitorOff","Minimize2","Maximize2","GripHorizontal","toast","jsxDEV","_jsxDEV","WebRTCMeeting","socket","roomId","username","onLeave","_s","_username$","localStream","setLocalStream","peers","setPeers","isMicEnabled","setIsMicEnabled","isCamEnabled","setIsCamEnabled","isScreenSharing","setIsScreenSharing","isMinimized","setIsMinimized","localVideoRef","streamRef","screenRef","peersRef","componentMounted","joinedRef","onLeaveRef","current","containerRef","isDragging","dragOffset","x","y","position","setPosition","rtcConfig","iceServers","urls","flushCandidates","socketId","_peer$pc$remoteDescri","peer","pc","remoteDescription","type","_peer$candidateQueue","candidateQueue","length","c","shift","addIceCandidate","RTCIceCandidate","_","syncPeersState","snap","Object","entries","forEach","id","p","stream","removePeer","_peer$pc","close","createPeer","targetSocketId","targetUsername","isInitiator","existing","state","connectionState","iceConnectionState","RTCPeerConnection","getTracks","track","addTrack","ontrack","event","_event$streams","rStream","streams","entry","onicecandidate","candidate","emit","to","oniceconnectionstatechange","s","offer","createOffer","setLocalDescription","localDescription","err","console","error","start","navigator","mediaDevices","getUserMedia","video","audio","echoCancellation","noiseSuppression","t","stop","srcObject","muted","keys","_peersRef$current$id","_peersRef$current$id$","myId","onExistingPeers","existingPeers","onNewPeer","peerName","onOffer","from","signalingState","setRemoteDescription","RTCSessionDescription","answer","createAnswer","e","onAnswer","onCandidate","_peer$pc$remoteDescri2","push","onPeerLeft","on","off","toggleMic","_streamRef$current","audioTrack","getAudioTracks","enabled","toggleCam","_streamRef$current2","videoTrack","getVideoTracks","toggleScreenShare","_streamRef$current3","camTrack","values","_pc$getSenders","_pc$getSenders$call","sender","getSenders","call","find","_s$track","kind","replaceTrack","screenStream","getDisplayMedia","screenTrack","_pc$getSenders2","_pc$getSenders2$call","_s$track2","onended","handleLeave","_peersRef$current$id2","_peersRef$current$id3","onDragStart","rect","getBoundingClientRect","clientX","left","clientY","top","move","ev","Math","max","min","window","innerWidth","innerHeight","up","document","removeEventListener","addEventListener","peerEntries","filter","participantCount","ref","className","style","children","onMouseDown","size","fileName","_jsxFileName","lineNumber","columnNumber","onClick","title","autoPlay","playsInline","toUpperCase","map","_2","RemoteVideo","_c","_s2","memo","_c2","vid","tryPlay","play","catch","active","_c3","$RefreshReg$"],"sources":["D:/CapstoneProject/whiteboard-app/frontend/src/components/video/WebRTCMeeting.js"],"sourcesContent":["import React, { useEffect, useRef, useState, useCallback } from 'react';\r\nimport { Mic, MicOff, Video, VideoOff, PhoneOff, Monitor, MonitorOff, Minimize2, Maximize2, GripHorizontal } from 'lucide-react';\r\nimport toast from 'react-hot-toast';\r\n\r\n/**\r\n * WebRTCMeeting — Zoom-like group call via P2P mesh.\r\n *\r\n * Key guarantees:\r\n * - NEVER creates a peer connection to self (filters own socketId)\r\n * - Only one mesh:join emission per mount (joinedRef guard)\r\n * - ICE candidates are queued until remoteDescription is set\r\n * - Local <video> always has `muted` to prevent echo\r\n * - Mute uses track.enabled (not track.stop) so unmute works\r\n * - Only one RTCPeerConnection per remote socketId\r\n */\r\nconst WebRTCMeeting = ({ socket, roomId, username, onLeave }) => {\r\n    const [localStream, setLocalStream] = useState(null);\r\n    const [peers, setPeers] = useState({});\r\n    const [isMicEnabled, setIsMicEnabled] = useState(true);\r\n    const [isCamEnabled, setIsCamEnabled] = useState(true);\r\n    const [isScreenSharing, setIsScreenSharing] = useState(false);\r\n    const [isMinimized, setIsMinimized] = useState(false);\r\n\r\n    const localVideoRef = useRef(null);\r\n    const streamRef = useRef(null);\r\n    const screenRef = useRef(null);\r\n    const peersRef = useRef({});\r\n    const componentMounted = useRef(true);\r\n    const joinedRef = useRef(false);  // Prevent duplicate mesh:join\r\n    const onLeaveRef = useRef(onLeave);\r\n    useEffect(() => { onLeaveRef.current = onLeave; }, [onLeave]);\r\n\r\n    // Drag\r\n    const containerRef = useRef(null);\r\n    const isDragging = useRef(false);\r\n    const dragOffset = useRef({ x: 0, y: 0 });\r\n    const [position, setPosition] = useState({ x: 16, y: 70 });\r\n\r\n    const rtcConfig = useRef({\r\n        iceServers: [\r\n            { urls: 'stun:stun.l.google.com:19302' },\r\n            { urls: 'stun:stun1.l.google.com:19302' },\r\n        ],\r\n    }).current;\r\n\r\n    // ── Flush queued ICE candidates ───────────────────────────────────────────\r\n    const flushCandidates = useCallback(async (socketId) => {\r\n        const peer = peersRef.current[socketId];\r\n        if (!peer?.pc || !peer.pc.remoteDescription?.type) return;\r\n        while (peer.candidateQueue?.length > 0) {\r\n            const c = peer.candidateQueue.shift();\r\n            try { await peer.pc.addIceCandidate(new RTCIceCandidate(c)); } catch (_) { }\r\n        }\r\n    }, []);\r\n\r\n    // ── Push ref state → React state ──────────────────────────────────────────\r\n    const syncPeersState = useCallback(() => {\r\n        const snap = {};\r\n        Object.entries(peersRef.current).forEach(([id, p]) => {\r\n            snap[id] = { stream: p.stream, username: p.username };\r\n        });\r\n        setPeers(snap);\r\n    }, []);\r\n\r\n    // ── Remove a peer cleanly ─────────────────────────────────────────────────\r\n    const removePeer = useCallback((socketId) => {\r\n        const peer = peersRef.current[socketId];\r\n        if (peer) {\r\n            try { peer.pc?.close(); } catch (_) { }\r\n            delete peersRef.current[socketId];\r\n            syncPeersState();\r\n        }\r\n    }, [syncPeersState]);\r\n\r\n    // ── Create ONE PeerConnection per remote socketId ─────────────────────────\r\n    const createPeer = useCallback((targetSocketId, targetUsername, stream, isInitiator) => {\r\n        // NEVER connect to self\r\n        if (targetSocketId === socket?.id) return null;\r\n\r\n        // If we already have a live PC for this peer, return it\r\n        const existing = peersRef.current[targetSocketId];\r\n        if (existing?.pc) {\r\n            const state = existing.pc.connectionState || existing.pc.iceConnectionState;\r\n            if (state !== 'closed' && state !== 'failed') {\r\n                return existing.pc;\r\n            }\r\n            // Dead connection — clean up\r\n            try { existing.pc.close(); } catch (_) { }\r\n        }\r\n\r\n        const pc = new RTCPeerConnection(rtcConfig);\r\n\r\n        // Add every local track\r\n        stream.getTracks().forEach(track => pc.addTrack(track, stream));\r\n\r\n        // Store immediately with candidate queue\r\n        peersRef.current[targetSocketId] = {\r\n            pc,\r\n            stream: null,\r\n            username: targetUsername,\r\n            candidateQueue: [],\r\n        };\r\n\r\n        // ── Remote tracks ──\r\n        pc.ontrack = (event) => {\r\n            const rStream = event.streams?.[0];\r\n            if (!rStream) return;\r\n            const entry = peersRef.current[targetSocketId];\r\n            if (entry) entry.stream = rStream;\r\n            syncPeersState();\r\n        };\r\n\r\n        // ── ICE candidates → remote ──\r\n        pc.onicecandidate = (event) => {\r\n            if (event.candidate) {\r\n                socket.emit('mesh:candidate', {\r\n                    roomId,\r\n                    to: targetSocketId,\r\n                    candidate: event.candidate,\r\n                });\r\n            }\r\n        };\r\n\r\n        // ── Connection state changes ──\r\n        pc.oniceconnectionstatechange = () => {\r\n            const s = pc.iceConnectionState;\r\n            if (s === 'connected' || s === 'completed') syncPeersState();\r\n            if (s === 'failed') removePeer(targetSocketId);\r\n        };\r\n\r\n        syncPeersState();\r\n\r\n        // Initiator sends offer\r\n        if (isInitiator) {\r\n            (async () => {\r\n                try {\r\n                    const offer = await pc.createOffer();\r\n                    await pc.setLocalDescription(offer);\r\n                    socket.emit('mesh:offer', {\r\n                        roomId,\r\n                        to: targetSocketId,\r\n                        offer: pc.localDescription,\r\n                    });\r\n                } catch (err) {\r\n                    console.error('[Mesh] Offer error:', err);\r\n                }\r\n            })();\r\n        }\r\n\r\n        return pc;\r\n    }, [socket, roomId, rtcConfig, removePeer, syncPeersState]);\r\n\r\n    // ══════════════════════════════════════════════════════════════════════════\r\n    //  1. Get media → join call (runs ONCE per mount)\r\n    // ══════════════════════════════════════════════════════════════════════════\r\n    useEffect(() => {\r\n        componentMounted.current = true;\r\n        joinedRef.current = false;\r\n\r\n        const start = async () => {\r\n            try {\r\n                const stream = await navigator.mediaDevices.getUserMedia({\r\n                    video: true,\r\n                    audio: { echoCancellation: true, noiseSuppression: true },\r\n                });\r\n                if (!componentMounted.current) {\r\n                    stream.getTracks().forEach(t => t.stop());\r\n                    return;\r\n                }\r\n\r\n                streamRef.current = stream;\r\n                setLocalStream(stream);\r\n\r\n                // Attach to <video> — always muted to prevent echo\r\n                if (localVideoRef.current) {\r\n                    localVideoRef.current.srcObject = stream;\r\n                    localVideoRef.current.muted = true;\r\n                }\r\n\r\n                // Emit mesh:join exactly once\r\n                if (!joinedRef.current) {\r\n                    joinedRef.current = true;\r\n                    socket.emit('mesh:join', { roomId, username });\r\n                }\r\n            } catch (err) {\r\n                console.error('[WebRTC] Media error:', err);\r\n                toast.error('Could not access camera or microphone.');\r\n            }\r\n        };\r\n\r\n        start();\r\n\r\n        return () => {\r\n            componentMounted.current = false;\r\n            joinedRef.current = false;\r\n\r\n            // Close every peer connection\r\n            Object.keys(peersRef.current).forEach(id => {\r\n                try { peersRef.current[id]?.pc?.close(); } catch (_) { }\r\n            });\r\n            peersRef.current = {};\r\n\r\n            // Stop local tracks\r\n            if (streamRef.current) {\r\n                streamRef.current.getTracks().forEach(t => t.stop());\r\n                streamRef.current = null;\r\n            }\r\n            if (screenRef.current) {\r\n                screenRef.current.getTracks().forEach(t => t.stop());\r\n                screenRef.current = null;\r\n            }\r\n        };\r\n        // eslint-disable-next-line\r\n    }, []);  // Empty deps — run once on mount, clean up on unmount\r\n\r\n    // ══════════════════════════════════════════════════════════════════════════\r\n    //  2. Socket signaling (mesh topology)\r\n    // ══════════════════════════════════════════════════════════════════════════\r\n    useEffect(() => {\r\n        if (!socket) return;\r\n        const myId = socket.id;\r\n\r\n        // Server sends existing call participants\r\n        const onExistingPeers = ({ peers: existingPeers }) => {\r\n            if (!streamRef.current) return;\r\n            existingPeers.forEach(p => {\r\n                // Never connect to self\r\n                if (p.socketId === myId) return;\r\n                createPeer(p.socketId, p.username, streamRef.current, true);\r\n            });\r\n        };\r\n\r\n        // A new peer joined — pre-create PC (they will send us an offer)\r\n        const onNewPeer = ({ socketId, username: peerName }) => {\r\n            if (!streamRef.current || socketId === myId) return;\r\n            createPeer(socketId, peerName, streamRef.current, false);\r\n        };\r\n\r\n        // Receive offer\r\n        const onOffer = async ({ from, offer, username: peerName }) => {\r\n            if (!streamRef.current || from === myId) return;\r\n\r\n            let peer = peersRef.current[from];\r\n            let pc;\r\n\r\n            if (!peer?.pc || peer.pc.signalingState === 'closed') {\r\n                pc = createPeer(from, peerName, streamRef.current, false);\r\n            } else {\r\n                pc = peer.pc;\r\n                if (peerName) peersRef.current[from].username = peerName;\r\n            }\r\n            if (!pc) return;\r\n\r\n            try {\r\n                // Glare: both sides sent offers — higher ID yields\r\n                if (pc.signalingState === 'have-local-offer') {\r\n                    if (myId > from) {\r\n                        await pc.setLocalDescription({ type: 'rollback' });\r\n                    } else {\r\n                        return;\r\n                    }\r\n                }\r\n\r\n                await pc.setRemoteDescription(new RTCSessionDescription(offer));\r\n                await flushCandidates(from);\r\n\r\n                const answer = await pc.createAnswer();\r\n                await pc.setLocalDescription(answer);\r\n                socket.emit('mesh:answer', { roomId, to: from, answer: pc.localDescription });\r\n            } catch (e) {\r\n                console.error('[Mesh] Offer handling error:', e);\r\n            }\r\n        };\r\n\r\n        // Receive answer\r\n        const onAnswer = async ({ from, answer }) => {\r\n            const peer = peersRef.current[from];\r\n            if (!peer?.pc || peer.pc.signalingState !== 'have-local-offer') return;\r\n            try {\r\n                await peer.pc.setRemoteDescription(new RTCSessionDescription(answer));\r\n                await flushCandidates(from);\r\n            } catch (e) {\r\n                console.error('[Mesh] Answer error:', e);\r\n            }\r\n        };\r\n\r\n        // Receive ICE candidate — queue if remote description not ready\r\n        const onCandidate = async ({ from, candidate }) => {\r\n            const peer = peersRef.current[from];\r\n            if (!peer?.pc) return;\r\n\r\n            if (peer.pc.remoteDescription?.type) {\r\n                try { await peer.pc.addIceCandidate(new RTCIceCandidate(candidate)); } catch (_) { }\r\n            } else {\r\n                peer.candidateQueue = peer.candidateQueue || [];\r\n                peer.candidateQueue.push(candidate);\r\n            }\r\n        };\r\n\r\n        // A peer left\r\n        const onPeerLeft = ({ socketId }) => removePeer(socketId);\r\n\r\n        socket.on('mesh:existing-peers', onExistingPeers);\r\n        socket.on('mesh:new-peer', onNewPeer);\r\n        socket.on('mesh:offer', onOffer);\r\n        socket.on('mesh:answer', onAnswer);\r\n        socket.on('mesh:candidate', onCandidate);\r\n        socket.on('mesh:peer-left', onPeerLeft);\r\n\r\n        return () => {\r\n            socket.off('mesh:existing-peers', onExistingPeers);\r\n            socket.off('mesh:new-peer', onNewPeer);\r\n            socket.off('mesh:offer', onOffer);\r\n            socket.off('mesh:answer', onAnswer);\r\n            socket.off('mesh:candidate', onCandidate);\r\n            socket.off('mesh:peer-left', onPeerLeft);\r\n        };\r\n    }, [socket, roomId, createPeer, removePeer, flushCandidates]);\r\n\r\n    // ══════════════════════════════════════════════════════════════════════════\r\n    //  Controls\r\n    // ══════════════════════════════════════════════════════════════════════════\r\n    const toggleMic = () => {\r\n        const audioTrack = streamRef.current?.getAudioTracks()[0];\r\n        if (!audioTrack) return;\r\n        audioTrack.enabled = !audioTrack.enabled;   // enabled, NOT stop()\r\n        setIsMicEnabled(audioTrack.enabled);\r\n    };\r\n\r\n    const toggleCam = () => {\r\n        const videoTrack = streamRef.current?.getVideoTracks()[0];\r\n        if (!videoTrack) return;\r\n        videoTrack.enabled = !videoTrack.enabled;\r\n        setIsCamEnabled(videoTrack.enabled);\r\n    };\r\n\r\n    const toggleScreenShare = async () => {\r\n        if (isScreenSharing) {\r\n            if (screenRef.current) { screenRef.current.getTracks().forEach(t => t.stop()); screenRef.current = null; }\r\n            const camTrack = streamRef.current?.getVideoTracks()[0];\r\n            Object.values(peersRef.current).forEach(({ pc }) => {\r\n                const sender = pc?.getSenders?.()?.find(s => s.track?.kind === 'video');\r\n                if (sender && camTrack) sender.replaceTrack(camTrack);\r\n            });\r\n            if (localVideoRef.current && streamRef.current) localVideoRef.current.srcObject = streamRef.current;\r\n            setIsScreenSharing(false);\r\n        } else {\r\n            try {\r\n                const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });\r\n                screenRef.current = screenStream;\r\n                const screenTrack = screenStream.getVideoTracks()[0];\r\n                Object.values(peersRef.current).forEach(({ pc }) => {\r\n                    const sender = pc?.getSenders?.()?.find(s => s.track?.kind === 'video');\r\n                    if (sender) sender.replaceTrack(screenTrack);\r\n                });\r\n                if (localVideoRef.current) localVideoRef.current.srcObject = screenStream;\r\n                screenTrack.onended = () => toggleScreenShare();\r\n                setIsScreenSharing(true);\r\n            } catch (_) { }\r\n        }\r\n    };\r\n\r\n    const handleLeave = () => {\r\n        socket.emit('mesh:leave', { roomId });\r\n        Object.keys(peersRef.current).forEach(id => {\r\n            try { peersRef.current[id]?.pc?.close(); } catch (_) { }\r\n        });\r\n        peersRef.current = {};\r\n        if (streamRef.current) { streamRef.current.getTracks().forEach(t => t.stop()); streamRef.current = null; }\r\n        if (screenRef.current) { screenRef.current.getTracks().forEach(t => t.stop()); screenRef.current = null; }\r\n        onLeaveRef.current();\r\n    };\r\n\r\n    // ── Drag ──────────────────────────────────────────────────────────────────\r\n    const onDragStart = (e) => {\r\n        isDragging.current = true;\r\n        const rect = containerRef.current.getBoundingClientRect();\r\n        dragOffset.current = { x: e.clientX - rect.left, y: e.clientY - rect.top };\r\n        const move = (ev) => {\r\n            if (!isDragging.current) return;\r\n            setPosition({\r\n                x: Math.max(0, Math.min(window.innerWidth - 120, ev.clientX - dragOffset.current.x)),\r\n                y: Math.max(0, Math.min(window.innerHeight - 80, ev.clientY - dragOffset.current.y)),\r\n            });\r\n        };\r\n        const up = () => {\r\n            isDragging.current = false;\r\n            document.removeEventListener('mousemove', move);\r\n            document.removeEventListener('mouseup', up);\r\n        };\r\n        document.addEventListener('mousemove', move);\r\n        document.addEventListener('mouseup', up);\r\n    };\r\n\r\n    // ── Only render remote peers that are alive ───────────────────────────────\r\n    const peerEntries = Object.entries(peers).filter(\r\n        ([id]) => id !== socket?.id  // Extra safety: never render self as remote\r\n    );\r\n    const participantCount = 1 + peerEntries.length;\r\n\r\n    // ── Minimized ─────────────────────────────────────────────────────────────\r\n    if (isMinimized) {\r\n        return (\r\n            <div ref={containerRef} className=\"wbrtc-floating wbrtc-minimized\" style={{ left: position.x, top: position.y }}>\r\n                <div className=\"wbrtc-mini-bar\" onMouseDown={onDragStart}>\r\n                    <GripHorizontal size={14} className=\"wbrtc-grip\" />\r\n                    <div className=\"wbrtc-mini-info\">\r\n                        <span className=\"wbrtc-mini-dot\" />\r\n                        <span>{participantCount} in call</span>\r\n                    </div>\r\n                    <button className=\"wbrtc-mini-btn\" onClick={() => setIsMinimized(false)} title=\"Expand\"><Maximize2 size={13} /></button>\r\n                    <button className=\"wbrtc-mini-btn wbrtc-mini-leave\" onClick={handleLeave} title=\"Leave\"><PhoneOff size={13} /></button>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // ── Full floating window ──────────────────────────────────────────────────\r\n    return (\r\n        <div ref={containerRef} className=\"wbrtc-floating\" style={{ left: position.x, top: position.y }}>\r\n            {/* Drag handle */}\r\n            <div className=\"wbrtc-drag-bar\" onMouseDown={onDragStart}>\r\n                <GripHorizontal size={14} className=\"wbrtc-grip\" />\r\n                <span className=\"wbrtc-drag-title\">{participantCount} in call</span>\r\n                <div className=\"wbrtc-drag-actions\">\r\n                    <button className=\"wbrtc-mini-btn\" onClick={() => setIsMinimized(true)} title=\"Minimize\"><Minimize2 size={13} /></button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Video grid */}\r\n            <div className=\"wbrtc-grid\">\r\n                {/* ── LOCAL tile (always first, always muted) ── */}\r\n                <div className=\"wbrtc-tile\">\r\n                    <video\r\n                        ref={localVideoRef}\r\n                        autoPlay\r\n                        muted          /* ← ALWAYS muted to prevent echo */\r\n                        playsInline\r\n                        className=\"wbrtc-tile-video wbrtc-tile-mirror\"\r\n                    />\r\n                    {!isCamEnabled && !isScreenSharing && (\r\n                        <div className=\"wbrtc-tile-avatar\">{username?.[0]?.toUpperCase()}</div>\r\n                    )}\r\n                    <div className=\"wbrtc-tile-name\">\r\n                        {username} (You)\r\n                        {!isMicEnabled && <MicOff size={10} className=\"wbrtc-tile-muted\" />}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* ── REMOTE tiles (one per unique socketId, self excluded) ── */}\r\n                {peerEntries.map(([socketId, peer]) => (\r\n                    <div className=\"wbrtc-tile\" key={socketId}>\r\n                        {peer.stream ? (\r\n                            <RemoteVideo stream={peer.stream} />\r\n                        ) : (\r\n                            <div className=\"wbrtc-tile-avatar\">{(peer.username || '?')[0]?.toUpperCase()}</div>\r\n                        )}\r\n                        <div className=\"wbrtc-tile-name\">{peer.username || 'Participant'}</div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n\r\n            {/* Controls */}\r\n            <div className=\"wbrtc-controls\">\r\n                <button onClick={toggleMic} className={`wbrtc-btn ${!isMicEnabled ? 'wbrtc-btn--danger' : ''}`} title={isMicEnabled ? 'Mute' : 'Unmute'}>\r\n                    {isMicEnabled ? <Mic size={15} /> : <MicOff size={15} />}\r\n                </button>\r\n                <button onClick={toggleCam} className={`wbrtc-btn ${!isCamEnabled ? 'wbrtc-btn--danger' : ''}`} title={isCamEnabled ? 'Stop Video' : 'Start Video'}>\r\n                    {isCamEnabled ? <Video size={15} /> : <VideoOff size={15} />}\r\n                </button>\r\n                <button onClick={toggleScreenShare} className={`wbrtc-btn ${isScreenSharing ? 'wbrtc-btn--active' : ''}`} title={isScreenSharing ? 'Stop Sharing' : 'Share Screen'}>\r\n                    {isScreenSharing ? <MonitorOff size={15} /> : <Monitor size={15} />}\r\n                </button>\r\n                <div className=\"wbrtc-divider\" />\r\n                <button onClick={handleLeave} className=\"wbrtc-btn wbrtc-btn--leave\" title=\"Leave call\">\r\n                    <PhoneOff size={15} />\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ── Remote video renderer (memoized, never muted) ─────────────────────────────\r\nconst RemoteVideo = React.memo(({ stream }) => {\r\n    const ref = useRef(null);\r\n\r\n    useEffect(() => {\r\n        const vid = ref.current;\r\n        if (!vid || !stream) return;\r\n\r\n        vid.srcObject = stream;\r\n        vid.muted = false;  // Remote audio MUST be audible\r\n\r\n        const tryPlay = () => vid.play().catch(() => { });\r\n\r\n        if (stream.active) tryPlay();\r\n        stream.addEventListener('addtrack', tryPlay);\r\n        return () => stream.removeEventListener('addtrack', tryPlay);\r\n    }, [stream]);\r\n\r\n    return <video ref={ref} autoPlay playsInline className=\"wbrtc-tile-video\" />;\r\n});\r\n\r\nexport default WebRTCMeeting;\r\n"],"mappings":";;;AAAA,OAAOA,KAAK,IAAIC,SAAS,EAAEC,MAAM,EAAEC,QAAQ,EAAEC,WAAW,QAAQ,OAAO;AACvE,SAASC,GAAG,EAAEC,MAAM,EAAEC,KAAK,EAAEC,QAAQ,EAAEC,QAAQ,EAAEC,OAAO,EAAEC,UAAU,EAAEC,SAAS,EAAEC,SAAS,EAAEC,cAAc,QAAQ,cAAc;AAChI,OAAOC,KAAK,MAAM,iBAAiB;;AAEnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAVA,SAAAC,MAAA,IAAAC,OAAA;AAWA,MAAMC,aAAa,GAAGA,CAAC;EAAEC,MAAM;EAAEC,MAAM;EAAEC,QAAQ;EAAEC;AAAQ,CAAC,KAAK;EAAAC,EAAA;EAAA,IAAAC,UAAA;EAC7D,MAAM,CAACC,WAAW,EAAEC,cAAc,CAAC,GAAGvB,QAAQ,CAAC,IAAI,CAAC;EACpD,MAAM,CAACwB,KAAK,EAAEC,QAAQ,CAAC,GAAGzB,QAAQ,CAAC,CAAC,CAAC,CAAC;EACtC,MAAM,CAAC0B,YAAY,EAAEC,eAAe,CAAC,GAAG3B,QAAQ,CAAC,IAAI,CAAC;EACtD,MAAM,CAAC4B,YAAY,EAAEC,eAAe,CAAC,GAAG7B,QAAQ,CAAC,IAAI,CAAC;EACtD,MAAM,CAAC8B,eAAe,EAAEC,kBAAkB,CAAC,GAAG/B,QAAQ,CAAC,KAAK,CAAC;EAC7D,MAAM,CAACgC,WAAW,EAAEC,cAAc,CAAC,GAAGjC,QAAQ,CAAC,KAAK,CAAC;EAErD,MAAMkC,aAAa,GAAGnC,MAAM,CAAC,IAAI,CAAC;EAClC,MAAMoC,SAAS,GAAGpC,MAAM,CAAC,IAAI,CAAC;EAC9B,MAAMqC,SAAS,GAAGrC,MAAM,CAAC,IAAI,CAAC;EAC9B,MAAMsC,QAAQ,GAAGtC,MAAM,CAAC,CAAC,CAAC,CAAC;EAC3B,MAAMuC,gBAAgB,GAAGvC,MAAM,CAAC,IAAI,CAAC;EACrC,MAAMwC,SAAS,GAAGxC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAE;EAClC,MAAMyC,UAAU,GAAGzC,MAAM,CAACoB,OAAO,CAAC;EAClCrB,SAAS,CAAC,MAAM;IAAE0C,UAAU,CAACC,OAAO,GAAGtB,OAAO;EAAE,CAAC,EAAE,CAACA,OAAO,CAAC,CAAC;;EAE7D;EACA,MAAMuB,YAAY,GAAG3C,MAAM,CAAC,IAAI,CAAC;EACjC,MAAM4C,UAAU,GAAG5C,MAAM,CAAC,KAAK,CAAC;EAChC,MAAM6C,UAAU,GAAG7C,MAAM,CAAC;IAAE8C,CAAC,EAAE,CAAC;IAAEC,CAAC,EAAE;EAAE,CAAC,CAAC;EACzC,MAAM,CAACC,QAAQ,EAAEC,WAAW,CAAC,GAAGhD,QAAQ,CAAC;IAAE6C,CAAC,EAAE,EAAE;IAAEC,CAAC,EAAE;EAAG,CAAC,CAAC;EAE1D,MAAMG,SAAS,GAAGlD,MAAM,CAAC;IACrBmD,UAAU,EAAE,CACR;MAAEC,IAAI,EAAE;IAA+B,CAAC,EACxC;MAAEA,IAAI,EAAE;IAAgC,CAAC;EAEjD,CAAC,CAAC,CAACV,OAAO;;EAEV;EACA,MAAMW,eAAe,GAAGnD,WAAW,CAAC,MAAOoD,QAAQ,IAAK;IAAA,IAAAC,qBAAA;IACpD,MAAMC,IAAI,GAAGlB,QAAQ,CAACI,OAAO,CAACY,QAAQ,CAAC;IACvC,IAAI,EAACE,IAAI,aAAJA,IAAI,eAAJA,IAAI,CAAEC,EAAE,KAAI,GAAAF,qBAAA,GAACC,IAAI,CAACC,EAAE,CAACC,iBAAiB,cAAAH,qBAAA,eAAzBA,qBAAA,CAA2BI,IAAI,GAAE;IACnD,OAAO,EAAAC,oBAAA,GAAAJ,IAAI,CAACK,cAAc,cAAAD,oBAAA,uBAAnBA,oBAAA,CAAqBE,MAAM,IAAG,CAAC,EAAE;MAAA,IAAAF,oBAAA;MACpC,MAAMG,CAAC,GAAGP,IAAI,CAACK,cAAc,CAACG,KAAK,CAAC,CAAC;MACrC,IAAI;QAAE,MAAMR,IAAI,CAACC,EAAE,CAACQ,eAAe,CAAC,IAAIC,eAAe,CAACH,CAAC,CAAC,CAAC;MAAE,CAAC,CAAC,OAAOI,CAAC,EAAE,CAAE;IAC/E;EACJ,CAAC,EAAE,EAAE,CAAC;;EAEN;EACA,MAAMC,cAAc,GAAGlE,WAAW,CAAC,MAAM;IACrC,MAAMmE,IAAI,GAAG,CAAC,CAAC;IACfC,MAAM,CAACC,OAAO,CAACjC,QAAQ,CAACI,OAAO,CAAC,CAAC8B,OAAO,CAAC,CAAC,CAACC,EAAE,EAAEC,CAAC,CAAC,KAAK;MAClDL,IAAI,CAACI,EAAE,CAAC,GAAG;QAAEE,MAAM,EAAED,CAAC,CAACC,MAAM;QAAExD,QAAQ,EAAEuD,CAAC,CAACvD;MAAS,CAAC;IACzD,CAAC,CAAC;IACFO,QAAQ,CAAC2C,IAAI,CAAC;EAClB,CAAC,EAAE,EAAE,CAAC;;EAEN;EACA,MAAMO,UAAU,GAAG1E,WAAW,CAAEoD,QAAQ,IAAK;IACzC,MAAME,IAAI,GAAGlB,QAAQ,CAACI,OAAO,CAACY,QAAQ,CAAC;IACvC,IAAIE,IAAI,EAAE;MACN,IAAI;QAAA,IAAAqB,QAAA;QAAE,CAAAA,QAAA,GAAArB,IAAI,CAACC,EAAE,cAAAoB,QAAA,uBAAPA,QAAA,CAASC,KAAK,CAAC,CAAC;MAAE,CAAC,CAAC,OAAOX,CAAC,EAAE,CAAE;MACtC,OAAO7B,QAAQ,CAACI,OAAO,CAACY,QAAQ,CAAC;MACjCc,cAAc,CAAC,CAAC;IACpB;EACJ,CAAC,EAAE,CAACA,cAAc,CAAC,CAAC;;EAEpB;EACA,MAAMW,UAAU,GAAG7E,WAAW,CAAC,CAAC8E,cAAc,EAAEC,cAAc,EAAEN,MAAM,EAAEO,WAAW,KAAK;IACpF;IACA,IAAIF,cAAc,MAAK/D,MAAM,aAANA,MAAM,uBAANA,MAAM,CAAEwD,EAAE,GAAE,OAAO,IAAI;;IAE9C;IACA,MAAMU,QAAQ,GAAG7C,QAAQ,CAACI,OAAO,CAACsC,cAAc,CAAC;IACjD,IAAIG,QAAQ,aAARA,QAAQ,eAARA,QAAQ,CAAE1B,EAAE,EAAE;MACd,MAAM2B,KAAK,GAAGD,QAAQ,CAAC1B,EAAE,CAAC4B,eAAe,IAAIF,QAAQ,CAAC1B,EAAE,CAAC6B,kBAAkB;MAC3E,IAAIF,KAAK,KAAK,QAAQ,IAAIA,KAAK,KAAK,QAAQ,EAAE;QAC1C,OAAOD,QAAQ,CAAC1B,EAAE;MACtB;MACA;MACA,IAAI;QAAE0B,QAAQ,CAAC1B,EAAE,CAACqB,KAAK,CAAC,CAAC;MAAE,CAAC,CAAC,OAAOX,CAAC,EAAE,CAAE;IAC7C;IAEA,MAAMV,EAAE,GAAG,IAAI8B,iBAAiB,CAACrC,SAAS,CAAC;;IAE3C;IACAyB,MAAM,CAACa,SAAS,CAAC,CAAC,CAAChB,OAAO,CAACiB,KAAK,IAAIhC,EAAE,CAACiC,QAAQ,CAACD,KAAK,EAAEd,MAAM,CAAC,CAAC;;IAE/D;IACArC,QAAQ,CAACI,OAAO,CAACsC,cAAc,CAAC,GAAG;MAC/BvB,EAAE;MACFkB,MAAM,EAAE,IAAI;MACZxD,QAAQ,EAAE8D,cAAc;MACxBpB,cAAc,EAAE;IACpB,CAAC;;IAED;IACAJ,EAAE,CAACkC,OAAO,GAAIC,KAAK,IAAK;MAAA,IAAAC,cAAA;MACpB,MAAMC,OAAO,IAAAD,cAAA,GAAGD,KAAK,CAACG,OAAO,cAAAF,cAAA,uBAAbA,cAAA,CAAgB,CAAC,CAAC;MAClC,IAAI,CAACC,OAAO,EAAE;MACd,MAAME,KAAK,GAAG1D,QAAQ,CAACI,OAAO,CAACsC,cAAc,CAAC;MAC9C,IAAIgB,KAAK,EAAEA,KAAK,CAACrB,MAAM,GAAGmB,OAAO;MACjC1B,cAAc,CAAC,CAAC;IACpB,CAAC;;IAED;IACAX,EAAE,CAACwC,cAAc,GAAIL,KAAK,IAAK;MAC3B,IAAIA,KAAK,CAACM,SAAS,EAAE;QACjBjF,MAAM,CAACkF,IAAI,CAAC,gBAAgB,EAAE;UAC1BjF,MAAM;UACNkF,EAAE,EAAEpB,cAAc;UAClBkB,SAAS,EAAEN,KAAK,CAACM;QACrB,CAAC,CAAC;MACN;IACJ,CAAC;;IAED;IACAzC,EAAE,CAAC4C,0BAA0B,GAAG,MAAM;MAClC,MAAMC,CAAC,GAAG7C,EAAE,CAAC6B,kBAAkB;MAC/B,IAAIgB,CAAC,KAAK,WAAW,IAAIA,CAAC,KAAK,WAAW,EAAElC,cAAc,CAAC,CAAC;MAC5D,IAAIkC,CAAC,KAAK,QAAQ,EAAE1B,UAAU,CAACI,cAAc,CAAC;IAClD,CAAC;IAEDZ,cAAc,CAAC,CAAC;;IAEhB;IACA,IAAIc,WAAW,EAAE;MACb,CAAC,YAAY;QACT,IAAI;UACA,MAAMqB,KAAK,GAAG,MAAM9C,EAAE,CAAC+C,WAAW,CAAC,CAAC;UACpC,MAAM/C,EAAE,CAACgD,mBAAmB,CAACF,KAAK,CAAC;UACnCtF,MAAM,CAACkF,IAAI,CAAC,YAAY,EAAE;YACtBjF,MAAM;YACNkF,EAAE,EAAEpB,cAAc;YAClBuB,KAAK,EAAE9C,EAAE,CAACiD;UACd,CAAC,CAAC;QACN,CAAC,CAAC,OAAOC,GAAG,EAAE;UACVC,OAAO,CAACC,KAAK,CAAC,qBAAqB,EAAEF,GAAG,CAAC;QAC7C;MACJ,CAAC,EAAE,CAAC;IACR;IAEA,OAAOlD,EAAE;EACb,CAAC,EAAE,CAACxC,MAAM,EAAEC,MAAM,EAAEgC,SAAS,EAAE0B,UAAU,EAAER,cAAc,CAAC,CAAC;;EAE3D;EACA;EACA;EACArE,SAAS,CAAC,MAAM;IACZwC,gBAAgB,CAACG,OAAO,GAAG,IAAI;IAC/BF,SAAS,CAACE,OAAO,GAAG,KAAK;IAEzB,MAAMoE,KAAK,GAAG,MAAAA,CAAA,KAAY;MACtB,IAAI;QACA,MAAMnC,MAAM,GAAG,MAAMoC,SAAS,CAACC,YAAY,CAACC,YAAY,CAAC;UACrDC,KAAK,EAAE,IAAI;UACXC,KAAK,EAAE;YAAEC,gBAAgB,EAAE,IAAI;YAAEC,gBAAgB,EAAE;UAAK;QAC5D,CAAC,CAAC;QACF,IAAI,CAAC9E,gBAAgB,CAACG,OAAO,EAAE;UAC3BiC,MAAM,CAACa,SAAS,CAAC,CAAC,CAAChB,OAAO,CAAC8C,CAAC,IAAIA,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC;UACzC;QACJ;QAEAnF,SAAS,CAACM,OAAO,GAAGiC,MAAM;QAC1BnD,cAAc,CAACmD,MAAM,CAAC;;QAEtB;QACA,IAAIxC,aAAa,CAACO,OAAO,EAAE;UACvBP,aAAa,CAACO,OAAO,CAAC8E,SAAS,GAAG7C,MAAM;UACxCxC,aAAa,CAACO,OAAO,CAAC+E,KAAK,GAAG,IAAI;QACtC;;QAEA;QACA,IAAI,CAACjF,SAAS,CAACE,OAAO,EAAE;UACpBF,SAAS,CAACE,OAAO,GAAG,IAAI;UACxBzB,MAAM,CAACkF,IAAI,CAAC,WAAW,EAAE;YAAEjF,MAAM;YAAEC;UAAS,CAAC,CAAC;QAClD;MACJ,CAAC,CAAC,OAAOwF,GAAG,EAAE;QACVC,OAAO,CAACC,KAAK,CAAC,uBAAuB,EAAEF,GAAG,CAAC;QAC3C9F,KAAK,CAACgG,KAAK,CAAC,wCAAwC,CAAC;MACzD;IACJ,CAAC;IAEDC,KAAK,CAAC,CAAC;IAEP,OAAO,MAAM;MACTvE,gBAAgB,CAACG,OAAO,GAAG,KAAK;MAChCF,SAAS,CAACE,OAAO,GAAG,KAAK;;MAEzB;MACA4B,MAAM,CAACoD,IAAI,CAACpF,QAAQ,CAACI,OAAO,CAAC,CAAC8B,OAAO,CAACC,EAAE,IAAI;QACxC,IAAI;UAAA,IAAAkD,oBAAA,EAAAC,qBAAA;UAAE,CAAAD,oBAAA,GAAArF,QAAQ,CAACI,OAAO,CAAC+B,EAAE,CAAC,cAAAkD,oBAAA,wBAAAC,qBAAA,GAApBD,oBAAA,CAAsBlE,EAAE,cAAAmE,qBAAA,uBAAxBA,qBAAA,CAA0B9C,KAAK,CAAC,CAAC;QAAE,CAAC,CAAC,OAAOX,CAAC,EAAE,CAAE;MAC3D,CAAC,CAAC;MACF7B,QAAQ,CAACI,OAAO,GAAG,CAAC,CAAC;;MAErB;MACA,IAAIN,SAAS,CAACM,OAAO,EAAE;QACnBN,SAAS,CAACM,OAAO,CAAC8C,SAAS,CAAC,CAAC,CAAChB,OAAO,CAAC8C,CAAC,IAAIA,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC;QACpDnF,SAAS,CAACM,OAAO,GAAG,IAAI;MAC5B;MACA,IAAIL,SAAS,CAACK,OAAO,EAAE;QACnBL,SAAS,CAACK,OAAO,CAAC8C,SAAS,CAAC,CAAC,CAAChB,OAAO,CAAC8C,CAAC,IAAIA,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC;QACpDlF,SAAS,CAACK,OAAO,GAAG,IAAI;MAC5B;IACJ,CAAC;IACD;EACJ,CAAC,EAAE,EAAE,CAAC,CAAC,CAAE;;EAET;EACA;EACA;EACA3C,SAAS,CAAC,MAAM;IACZ,IAAI,CAACkB,MAAM,EAAE;IACb,MAAM4G,IAAI,GAAG5G,MAAM,CAACwD,EAAE;;IAEtB;IACA,MAAMqD,eAAe,GAAGA,CAAC;MAAErG,KAAK,EAAEsG;IAAc,CAAC,KAAK;MAClD,IAAI,CAAC3F,SAAS,CAACM,OAAO,EAAE;MACxBqF,aAAa,CAACvD,OAAO,CAACE,CAAC,IAAI;QACvB;QACA,IAAIA,CAAC,CAACpB,QAAQ,KAAKuE,IAAI,EAAE;QACzB9C,UAAU,CAACL,CAAC,CAACpB,QAAQ,EAAEoB,CAAC,CAACvD,QAAQ,EAAEiB,SAAS,CAACM,OAAO,EAAE,IAAI,CAAC;MAC/D,CAAC,CAAC;IACN,CAAC;;IAED;IACA,MAAMsF,SAAS,GAAGA,CAAC;MAAE1E,QAAQ;MAAEnC,QAAQ,EAAE8G;IAAS,CAAC,KAAK;MACpD,IAAI,CAAC7F,SAAS,CAACM,OAAO,IAAIY,QAAQ,KAAKuE,IAAI,EAAE;MAC7C9C,UAAU,CAACzB,QAAQ,EAAE2E,QAAQ,EAAE7F,SAAS,CAACM,OAAO,EAAE,KAAK,CAAC;IAC5D,CAAC;;IAED;IACA,MAAMwF,OAAO,GAAG,MAAAA,CAAO;MAAEC,IAAI;MAAE5B,KAAK;MAAEpF,QAAQ,EAAE8G;IAAS,CAAC,KAAK;MAC3D,IAAI,CAAC7F,SAAS,CAACM,OAAO,IAAIyF,IAAI,KAAKN,IAAI,EAAE;MAEzC,IAAIrE,IAAI,GAAGlB,QAAQ,CAACI,OAAO,CAACyF,IAAI,CAAC;MACjC,IAAI1E,EAAE;MAEN,IAAI,EAACD,IAAI,aAAJA,IAAI,eAAJA,IAAI,CAAEC,EAAE,KAAID,IAAI,CAACC,EAAE,CAAC2E,cAAc,KAAK,QAAQ,EAAE;QAClD3E,EAAE,GAAGsB,UAAU,CAACoD,IAAI,EAAEF,QAAQ,EAAE7F,SAAS,CAACM,OAAO,EAAE,KAAK,CAAC;MAC7D,CAAC,MAAM;QACHe,EAAE,GAAGD,IAAI,CAACC,EAAE;QACZ,IAAIwE,QAAQ,EAAE3F,QAAQ,CAACI,OAAO,CAACyF,IAAI,CAAC,CAAChH,QAAQ,GAAG8G,QAAQ;MAC5D;MACA,IAAI,CAACxE,EAAE,EAAE;MAET,IAAI;QACA;QACA,IAAIA,EAAE,CAAC2E,cAAc,KAAK,kBAAkB,EAAE;UAC1C,IAAIP,IAAI,GAAGM,IAAI,EAAE;YACb,MAAM1E,EAAE,CAACgD,mBAAmB,CAAC;cAAE9C,IAAI,EAAE;YAAW,CAAC,CAAC;UACtD,CAAC,MAAM;YACH;UACJ;QACJ;QAEA,MAAMF,EAAE,CAAC4E,oBAAoB,CAAC,IAAIC,qBAAqB,CAAC/B,KAAK,CAAC,CAAC;QAC/D,MAAMlD,eAAe,CAAC8E,IAAI,CAAC;QAE3B,MAAMI,MAAM,GAAG,MAAM9E,EAAE,CAAC+E,YAAY,CAAC,CAAC;QACtC,MAAM/E,EAAE,CAACgD,mBAAmB,CAAC8B,MAAM,CAAC;QACpCtH,MAAM,CAACkF,IAAI,CAAC,aAAa,EAAE;UAAEjF,MAAM;UAAEkF,EAAE,EAAE+B,IAAI;UAAEI,MAAM,EAAE9E,EAAE,CAACiD;QAAiB,CAAC,CAAC;MACjF,CAAC,CAAC,OAAO+B,CAAC,EAAE;QACR7B,OAAO,CAACC,KAAK,CAAC,8BAA8B,EAAE4B,CAAC,CAAC;MACpD;IACJ,CAAC;;IAED;IACA,MAAMC,QAAQ,GAAG,MAAAA,CAAO;MAAEP,IAAI;MAAEI;IAAO,CAAC,KAAK;MACzC,MAAM/E,IAAI,GAAGlB,QAAQ,CAACI,OAAO,CAACyF,IAAI,CAAC;MACnC,IAAI,EAAC3E,IAAI,aAAJA,IAAI,eAAJA,IAAI,CAAEC,EAAE,KAAID,IAAI,CAACC,EAAE,CAAC2E,cAAc,KAAK,kBAAkB,EAAE;MAChE,IAAI;QACA,MAAM5E,IAAI,CAACC,EAAE,CAAC4E,oBAAoB,CAAC,IAAIC,qBAAqB,CAACC,MAAM,CAAC,CAAC;QACrE,MAAMlF,eAAe,CAAC8E,IAAI,CAAC;MAC/B,CAAC,CAAC,OAAOM,CAAC,EAAE;QACR7B,OAAO,CAACC,KAAK,CAAC,sBAAsB,EAAE4B,CAAC,CAAC;MAC5C;IACJ,CAAC;;IAED;IACA,MAAME,WAAW,GAAG,MAAAA,CAAO;MAAER,IAAI;MAAEjC;IAAU,CAAC,KAAK;MAAA,IAAA0C,sBAAA;MAC/C,MAAMpF,IAAI,GAAGlB,QAAQ,CAACI,OAAO,CAACyF,IAAI,CAAC;MACnC,IAAI,EAAC3E,IAAI,aAAJA,IAAI,eAAJA,IAAI,CAAEC,EAAE,GAAE;MAEf,KAAAmF,sBAAA,GAAIpF,IAAI,CAACC,EAAE,CAACC,iBAAiB,cAAAkF,sBAAA,eAAzBA,sBAAA,CAA2BjF,IAAI,EAAE;QACjC,IAAI;UAAE,MAAMH,IAAI,CAACC,EAAE,CAACQ,eAAe,CAAC,IAAIC,eAAe,CAACgC,SAAS,CAAC,CAAC;QAAE,CAAC,CAAC,OAAO/B,CAAC,EAAE,CAAE;MACvF,CAAC,MAAM;QACHX,IAAI,CAACK,cAAc,GAAGL,IAAI,CAACK,cAAc,IAAI,EAAE;QAC/CL,IAAI,CAACK,cAAc,CAACgF,IAAI,CAAC3C,SAAS,CAAC;MACvC;IACJ,CAAC;;IAED;IACA,MAAM4C,UAAU,GAAGA,CAAC;MAAExF;IAAS,CAAC,KAAKsB,UAAU,CAACtB,QAAQ,CAAC;IAEzDrC,MAAM,CAAC8H,EAAE,CAAC,qBAAqB,EAAEjB,eAAe,CAAC;IACjD7G,MAAM,CAAC8H,EAAE,CAAC,eAAe,EAAEf,SAAS,CAAC;IACrC/G,MAAM,CAAC8H,EAAE,CAAC,YAAY,EAAEb,OAAO,CAAC;IAChCjH,MAAM,CAAC8H,EAAE,CAAC,aAAa,EAAEL,QAAQ,CAAC;IAClCzH,MAAM,CAAC8H,EAAE,CAAC,gBAAgB,EAAEJ,WAAW,CAAC;IACxC1H,MAAM,CAAC8H,EAAE,CAAC,gBAAgB,EAAED,UAAU,CAAC;IAEvC,OAAO,MAAM;MACT7H,MAAM,CAAC+H,GAAG,CAAC,qBAAqB,EAAElB,eAAe,CAAC;MAClD7G,MAAM,CAAC+H,GAAG,CAAC,eAAe,EAAEhB,SAAS,CAAC;MACtC/G,MAAM,CAAC+H,GAAG,CAAC,YAAY,EAAEd,OAAO,CAAC;MACjCjH,MAAM,CAAC+H,GAAG,CAAC,aAAa,EAAEN,QAAQ,CAAC;MACnCzH,MAAM,CAAC+H,GAAG,CAAC,gBAAgB,EAAEL,WAAW,CAAC;MACzC1H,MAAM,CAAC+H,GAAG,CAAC,gBAAgB,EAAEF,UAAU,CAAC;IAC5C,CAAC;EACL,CAAC,EAAE,CAAC7H,MAAM,EAAEC,MAAM,EAAE6D,UAAU,EAAEH,UAAU,EAAEvB,eAAe,CAAC,CAAC;;EAE7D;EACA;EACA;EACA,MAAM4F,SAAS,GAAGA,CAAA,KAAM;IAAA,IAAAC,kBAAA;IACpB,MAAMC,UAAU,IAAAD,kBAAA,GAAG9G,SAAS,CAACM,OAAO,cAAAwG,kBAAA,uBAAjBA,kBAAA,CAAmBE,cAAc,CAAC,CAAC,CAAC,CAAC,CAAC;IACzD,IAAI,CAACD,UAAU,EAAE;IACjBA,UAAU,CAACE,OAAO,GAAG,CAACF,UAAU,CAACE,OAAO,CAAC,CAAG;IAC5CzH,eAAe,CAACuH,UAAU,CAACE,OAAO,CAAC;EACvC,CAAC;EAED,MAAMC,SAAS,GAAGA,CAAA,KAAM;IAAA,IAAAC,mBAAA;IACpB,MAAMC,UAAU,IAAAD,mBAAA,GAAGnH,SAAS,CAACM,OAAO,cAAA6G,mBAAA,uBAAjBA,mBAAA,CAAmBE,cAAc,CAAC,CAAC,CAAC,CAAC,CAAC;IACzD,IAAI,CAACD,UAAU,EAAE;IACjBA,UAAU,CAACH,OAAO,GAAG,CAACG,UAAU,CAACH,OAAO;IACxCvH,eAAe,CAAC0H,UAAU,CAACH,OAAO,CAAC;EACvC,CAAC;EAED,MAAMK,iBAAiB,GAAG,MAAAA,CAAA,KAAY;IAClC,IAAI3H,eAAe,EAAE;MAAA,IAAA4H,mBAAA;MACjB,IAAItH,SAAS,CAACK,OAAO,EAAE;QAAEL,SAAS,CAACK,OAAO,CAAC8C,SAAS,CAAC,CAAC,CAAChB,OAAO,CAAC8C,CAAC,IAAIA,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC;QAAElF,SAAS,CAACK,OAAO,GAAG,IAAI;MAAE;MACzG,MAAMkH,QAAQ,IAAAD,mBAAA,GAAGvH,SAAS,CAACM,OAAO,cAAAiH,mBAAA,uBAAjBA,mBAAA,CAAmBF,cAAc,CAAC,CAAC,CAAC,CAAC,CAAC;MACvDnF,MAAM,CAACuF,MAAM,CAACvH,QAAQ,CAACI,OAAO,CAAC,CAAC8B,OAAO,CAAC,CAAC;QAAEf;MAAG,CAAC,KAAK;QAAA,IAAAqG,cAAA,EAAAC,mBAAA;QAChD,MAAMC,MAAM,GAAGvG,EAAE,aAAFA,EAAE,wBAAAqG,cAAA,GAAFrG,EAAE,CAAEwG,UAAU,cAAAH,cAAA,wBAAAC,mBAAA,GAAdD,cAAA,CAAAI,IAAA,CAAAzG,EAAiB,CAAC,cAAAsG,mBAAA,uBAAlBA,mBAAA,CAAoBI,IAAI,CAAC7D,CAAC;UAAA,IAAA8D,QAAA;UAAA,OAAI,EAAAA,QAAA,GAAA9D,CAAC,CAACb,KAAK,cAAA2E,QAAA,uBAAPA,QAAA,CAASC,IAAI,MAAK,OAAO;QAAA,EAAC;QACvE,IAAIL,MAAM,IAAIJ,QAAQ,EAAEI,MAAM,CAACM,YAAY,CAACV,QAAQ,CAAC;MACzD,CAAC,CAAC;MACF,IAAIzH,aAAa,CAACO,OAAO,IAAIN,SAAS,CAACM,OAAO,EAAEP,aAAa,CAACO,OAAO,CAAC8E,SAAS,GAAGpF,SAAS,CAACM,OAAO;MACnGV,kBAAkB,CAAC,KAAK,CAAC;IAC7B,CAAC,MAAM;MACH,IAAI;QACA,MAAMuI,YAAY,GAAG,MAAMxD,SAAS,CAACC,YAAY,CAACwD,eAAe,CAAC;UAAEtD,KAAK,EAAE;QAAK,CAAC,CAAC;QAClF7E,SAAS,CAACK,OAAO,GAAG6H,YAAY;QAChC,MAAME,WAAW,GAAGF,YAAY,CAACd,cAAc,CAAC,CAAC,CAAC,CAAC,CAAC;QACpDnF,MAAM,CAACuF,MAAM,CAACvH,QAAQ,CAACI,OAAO,CAAC,CAAC8B,OAAO,CAAC,CAAC;UAAEf;QAAG,CAAC,KAAK;UAAA,IAAAiH,eAAA,EAAAC,oBAAA;UAChD,MAAMX,MAAM,GAAGvG,EAAE,aAAFA,EAAE,wBAAAiH,eAAA,GAAFjH,EAAE,CAAEwG,UAAU,cAAAS,eAAA,wBAAAC,oBAAA,GAAdD,eAAA,CAAAR,IAAA,CAAAzG,EAAiB,CAAC,cAAAkH,oBAAA,uBAAlBA,oBAAA,CAAoBR,IAAI,CAAC7D,CAAC;YAAA,IAAAsE,SAAA;YAAA,OAAI,EAAAA,SAAA,GAAAtE,CAAC,CAACb,KAAK,cAAAmF,SAAA,uBAAPA,SAAA,CAASP,IAAI,MAAK,OAAO;UAAA,EAAC;UACvE,IAAIL,MAAM,EAAEA,MAAM,CAACM,YAAY,CAACG,WAAW,CAAC;QAChD,CAAC,CAAC;QACF,IAAItI,aAAa,CAACO,OAAO,EAAEP,aAAa,CAACO,OAAO,CAAC8E,SAAS,GAAG+C,YAAY;QACzEE,WAAW,CAACI,OAAO,GAAG,MAAMnB,iBAAiB,CAAC,CAAC;QAC/C1H,kBAAkB,CAAC,IAAI,CAAC;MAC5B,CAAC,CAAC,OAAOmC,CAAC,EAAE,CAAE;IAClB;EACJ,CAAC;EAED,MAAM2G,WAAW,GAAGA,CAAA,KAAM;IACtB7J,MAAM,CAACkF,IAAI,CAAC,YAAY,EAAE;MAAEjF;IAAO,CAAC,CAAC;IACrCoD,MAAM,CAACoD,IAAI,CAACpF,QAAQ,CAACI,OAAO,CAAC,CAAC8B,OAAO,CAACC,EAAE,IAAI;MACxC,IAAI;QAAA,IAAAsG,qBAAA,EAAAC,qBAAA;QAAE,CAAAD,qBAAA,GAAAzI,QAAQ,CAACI,OAAO,CAAC+B,EAAE,CAAC,cAAAsG,qBAAA,wBAAAC,qBAAA,GAApBD,qBAAA,CAAsBtH,EAAE,cAAAuH,qBAAA,uBAAxBA,qBAAA,CAA0BlG,KAAK,CAAC,CAAC;MAAE,CAAC,CAAC,OAAOX,CAAC,EAAE,CAAE;IAC3D,CAAC,CAAC;IACF7B,QAAQ,CAACI,OAAO,GAAG,CAAC,CAAC;IACrB,IAAIN,SAAS,CAACM,OAAO,EAAE;MAAEN,SAAS,CAACM,OAAO,CAAC8C,SAAS,CAAC,CAAC,CAAChB,OAAO,CAAC8C,CAAC,IAAIA,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC;MAAEnF,SAAS,CAACM,OAAO,GAAG,IAAI;IAAE;IACzG,IAAIL,SAAS,CAACK,OAAO,EAAE;MAAEL,SAAS,CAACK,OAAO,CAAC8C,SAAS,CAAC,CAAC,CAAChB,OAAO,CAAC8C,CAAC,IAAIA,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC;MAAElF,SAAS,CAACK,OAAO,GAAG,IAAI;IAAE;IACzGD,UAAU,CAACC,OAAO,CAAC,CAAC;EACxB,CAAC;;EAED;EACA,MAAMuI,WAAW,GAAIxC,CAAC,IAAK;IACvB7F,UAAU,CAACF,OAAO,GAAG,IAAI;IACzB,MAAMwI,IAAI,GAAGvI,YAAY,CAACD,OAAO,CAACyI,qBAAqB,CAAC,CAAC;IACzDtI,UAAU,CAACH,OAAO,GAAG;MAAEI,CAAC,EAAE2F,CAAC,CAAC2C,OAAO,GAAGF,IAAI,CAACG,IAAI;MAAEtI,CAAC,EAAE0F,CAAC,CAAC6C,OAAO,GAAGJ,IAAI,CAACK;IAAI,CAAC;IAC1E,MAAMC,IAAI,GAAIC,EAAE,IAAK;MACjB,IAAI,CAAC7I,UAAU,CAACF,OAAO,EAAE;MACzBO,WAAW,CAAC;QACRH,CAAC,EAAE4I,IAAI,CAACC,GAAG,CAAC,CAAC,EAAED,IAAI,CAACE,GAAG,CAACC,MAAM,CAACC,UAAU,GAAG,GAAG,EAAEL,EAAE,CAACL,OAAO,GAAGvI,UAAU,CAACH,OAAO,CAACI,CAAC,CAAC,CAAC;QACpFC,CAAC,EAAE2I,IAAI,CAACC,GAAG,CAAC,CAAC,EAAED,IAAI,CAACE,GAAG,CAACC,MAAM,CAACE,WAAW,GAAG,EAAE,EAAEN,EAAE,CAACH,OAAO,GAAGzI,UAAU,CAACH,OAAO,CAACK,CAAC,CAAC;MACvF,CAAC,CAAC;IACN,CAAC;IACD,MAAMiJ,EAAE,GAAGA,CAAA,KAAM;MACbpJ,UAAU,CAACF,OAAO,GAAG,KAAK;MAC1BuJ,QAAQ,CAACC,mBAAmB,CAAC,WAAW,EAAEV,IAAI,CAAC;MAC/CS,QAAQ,CAACC,mBAAmB,CAAC,SAAS,EAAEF,EAAE,CAAC;IAC/C,CAAC;IACDC,QAAQ,CAACE,gBAAgB,CAAC,WAAW,EAAEX,IAAI,CAAC;IAC5CS,QAAQ,CAACE,gBAAgB,CAAC,SAAS,EAAEH,EAAE,CAAC;EAC5C,CAAC;;EAED;EACA,MAAMI,WAAW,GAAG9H,MAAM,CAACC,OAAO,CAAC9C,KAAK,CAAC,CAAC4K,MAAM,CAC5C,CAAC,CAAC5H,EAAE,CAAC,KAAKA,EAAE,MAAKxD,MAAM,aAANA,MAAM,uBAANA,MAAM,CAAEwD,EAAE,EAAE;EACjC,CAAC;EACD,MAAM6H,gBAAgB,GAAG,CAAC,GAAGF,WAAW,CAACtI,MAAM;;EAE/C;EACA,IAAI7B,WAAW,EAAE;IACb,oBACIlB,OAAA;MAAKwL,GAAG,EAAE5J,YAAa;MAAC6J,SAAS,EAAC,gCAAgC;MAACC,KAAK,EAAE;QAAEpB,IAAI,EAAErI,QAAQ,CAACF,CAAC;QAAEyI,GAAG,EAAEvI,QAAQ,CAACD;MAAE,CAAE;MAAA2J,QAAA,eAC5G3L,OAAA;QAAKyL,SAAS,EAAC,gBAAgB;QAACG,WAAW,EAAE1B,WAAY;QAAAyB,QAAA,gBACrD3L,OAAA,CAACH,cAAc;UAACgM,IAAI,EAAE,EAAG;UAACJ,SAAS,EAAC;QAAY;UAAAK,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAE,CAAC,eACnDjM,OAAA;UAAKyL,SAAS,EAAC,iBAAiB;UAAAE,QAAA,gBAC5B3L,OAAA;YAAMyL,SAAS,EAAC;UAAgB;YAAAK,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAE,CAAC,eACnCjM,OAAA;YAAA2L,QAAA,GAAOJ,gBAAgB,EAAC,UAAQ;UAAA;YAAAO,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAM,CAAC;QAAA;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OACtC,CAAC,eACNjM,OAAA;UAAQyL,SAAS,EAAC,gBAAgB;UAACS,OAAO,EAAEA,CAAA,KAAM/K,cAAc,CAAC,KAAK,CAAE;UAACgL,KAAK,EAAC,QAAQ;UAAAR,QAAA,eAAC3L,OAAA,CAACJ,SAAS;YAACiM,IAAI,EAAE;UAAG;YAAAC,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAE;QAAC;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAQ,CAAC,eACxHjM,OAAA;UAAQyL,SAAS,EAAC,iCAAiC;UAACS,OAAO,EAAEnC,WAAY;UAACoC,KAAK,EAAC,OAAO;UAAAR,QAAA,eAAC3L,OAAA,CAACR,QAAQ;YAACqM,IAAI,EAAE;UAAG;YAAAC,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAE;QAAC;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAQ,CAAC;MAAA;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OACtH;IAAC;MAAAH,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OACL,CAAC;EAEd;;EAEA;EACA,oBACIjM,OAAA;IAAKwL,GAAG,EAAE5J,YAAa;IAAC6J,SAAS,EAAC,gBAAgB;IAACC,KAAK,EAAE;MAAEpB,IAAI,EAAErI,QAAQ,CAACF,CAAC;MAAEyI,GAAG,EAAEvI,QAAQ,CAACD;IAAE,CAAE;IAAA2J,QAAA,gBAE5F3L,OAAA;MAAKyL,SAAS,EAAC,gBAAgB;MAACG,WAAW,EAAE1B,WAAY;MAAAyB,QAAA,gBACrD3L,OAAA,CAACH,cAAc;QAACgM,IAAI,EAAE,EAAG;QAACJ,SAAS,EAAC;MAAY;QAAAK,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAAE,CAAC,eACnDjM,OAAA;QAAMyL,SAAS,EAAC,kBAAkB;QAAAE,QAAA,GAAEJ,gBAAgB,EAAC,UAAQ;MAAA;QAAAO,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAAM,CAAC,eACpEjM,OAAA;QAAKyL,SAAS,EAAC,oBAAoB;QAAAE,QAAA,eAC/B3L,OAAA;UAAQyL,SAAS,EAAC,gBAAgB;UAACS,OAAO,EAAEA,CAAA,KAAM/K,cAAc,CAAC,IAAI,CAAE;UAACgL,KAAK,EAAC,UAAU;UAAAR,QAAA,eAAC3L,OAAA,CAACL,SAAS;YAACkM,IAAI,EAAE;UAAG;YAAAC,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAE;QAAC;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAQ;MAAC;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OACxH,CAAC;IAAA;MAAAH,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OACL,CAAC,eAGNjM,OAAA;MAAKyL,SAAS,EAAC,YAAY;MAAAE,QAAA,gBAEvB3L,OAAA;QAAKyL,SAAS,EAAC,YAAY;QAAAE,QAAA,gBACvB3L,OAAA;UACIwL,GAAG,EAAEpK,aAAc;UACnBgL,QAAQ;UACR1F,KAAK,OAAU;UACf2F,WAAW;UACXZ,SAAS,EAAC;QAAoC;UAAAK,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OACjD,CAAC,EACD,CAACnL,YAAY,IAAI,CAACE,eAAe,iBAC9BhB,OAAA;UAAKyL,SAAS,EAAC,mBAAmB;UAAAE,QAAA,EAAEvL,QAAQ,aAARA,QAAQ,wBAAAG,UAAA,GAARH,QAAQ,CAAG,CAAC,CAAC,cAAAG,UAAA,uBAAbA,UAAA,CAAe+L,WAAW,CAAC;QAAC;UAAAR,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAM,CACzE,eACDjM,OAAA;UAAKyL,SAAS,EAAC,iBAAiB;UAAAE,QAAA,GAC3BvL,QAAQ,EAAC,QACV,EAAC,CAACQ,YAAY,iBAAIZ,OAAA,CAACX,MAAM;YAACwM,IAAI,EAAE,EAAG;YAACJ,SAAS,EAAC;UAAkB;YAAAK,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAE,CAAC;QAAA;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAClE,CAAC;MAAA;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OACL,CAAC,EAGLZ,WAAW,CAACkB,GAAG,CAAC,CAAC,CAAChK,QAAQ,EAAEE,IAAI,CAAC;QAAA,IAAA+J,EAAA;QAAA,oBAC9BxM,OAAA;UAAKyL,SAAS,EAAC,YAAY;UAAAE,QAAA,GACtBlJ,IAAI,CAACmB,MAAM,gBACR5D,OAAA,CAACyM,WAAW;YAAC7I,MAAM,EAAEnB,IAAI,CAACmB;UAAO;YAAAkI,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAE,CAAC,gBAEpCjM,OAAA;YAAKyL,SAAS,EAAC,mBAAmB;YAAAE,QAAA,GAAAa,EAAA,GAAE,CAAC/J,IAAI,CAACrC,QAAQ,IAAI,GAAG,EAAE,CAAC,CAAC,cAAAoM,EAAA,uBAAzBA,EAAA,CAA2BF,WAAW,CAAC;UAAC;YAAAR,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAM,CACrF,eACDjM,OAAA;YAAKyL,SAAS,EAAC,iBAAiB;YAAAE,QAAA,EAAElJ,IAAI,CAACrC,QAAQ,IAAI;UAAa;YAAA0L,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAM,CAAC;QAAA,GAN1C1J,QAAQ;UAAAuJ,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAOpC,CAAC;MAAA,CACT,CAAC;IAAA;MAAAH,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OACD,CAAC,eAGNjM,OAAA;MAAKyL,SAAS,EAAC,gBAAgB;MAAAE,QAAA,gBAC3B3L,OAAA;QAAQkM,OAAO,EAAEhE,SAAU;QAACuD,SAAS,EAAE,aAAa,CAAC7K,YAAY,GAAG,mBAAmB,GAAG,EAAE,EAAG;QAACuL,KAAK,EAAEvL,YAAY,GAAG,MAAM,GAAG,QAAS;QAAA+K,QAAA,EACnI/K,YAAY,gBAAGZ,OAAA,CAACZ,GAAG;UAACyM,IAAI,EAAE;QAAG;UAAAC,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAE,CAAC,gBAAGjM,OAAA,CAACX,MAAM;UAACwM,IAAI,EAAE;QAAG;UAAAC,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAE;MAAC;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OACpD,CAAC,eACTjM,OAAA;QAAQkM,OAAO,EAAE3D,SAAU;QAACkD,SAAS,EAAE,aAAa,CAAC3K,YAAY,GAAG,mBAAmB,GAAG,EAAE,EAAG;QAACqL,KAAK,EAAErL,YAAY,GAAG,YAAY,GAAG,aAAc;QAAA6K,QAAA,EAC9I7K,YAAY,gBAAGd,OAAA,CAACV,KAAK;UAACuM,IAAI,EAAE;QAAG;UAAAC,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAE,CAAC,gBAAGjM,OAAA,CAACT,QAAQ;UAACsM,IAAI,EAAE;QAAG;UAAAC,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAE;MAAC;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OACxD,CAAC,eACTjM,OAAA;QAAQkM,OAAO,EAAEvD,iBAAkB;QAAC8C,SAAS,EAAE,aAAazK,eAAe,GAAG,mBAAmB,GAAG,EAAE,EAAG;QAACmL,KAAK,EAAEnL,eAAe,GAAG,cAAc,GAAG,cAAe;QAAA2K,QAAA,EAC9J3K,eAAe,gBAAGhB,OAAA,CAACN,UAAU;UAACmM,IAAI,EAAE;QAAG;UAAAC,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAE,CAAC,gBAAGjM,OAAA,CAACP,OAAO;UAACoM,IAAI,EAAE;QAAG;UAAAC,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAE;MAAC;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAC/D,CAAC,eACTjM,OAAA;QAAKyL,SAAS,EAAC;MAAe;QAAAK,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAAE,CAAC,eACjCjM,OAAA;QAAQkM,OAAO,EAAEnC,WAAY;QAAC0B,SAAS,EAAC,4BAA4B;QAACU,KAAK,EAAC,YAAY;QAAAR,QAAA,eACnF3L,OAAA,CAACR,QAAQ;UAACqM,IAAI,EAAE;QAAG;UAAAC,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAAE;MAAC;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAClB,CAAC;IAAA;MAAAH,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OACR,CAAC;EAAA;IAAAH,QAAA,EAAAC,YAAA;IAAAC,UAAA;IAAAC,YAAA;EAAA,OACL,CAAC;AAEd,CAAC;;AAED;AAAA3L,EAAA,CAndML,aAAa;AAAAyM,EAAA,GAAbzM,aAAa;AAodnB,MAAMwM,WAAW,gBAAAE,GAAA,cAAG5N,KAAK,CAAC6N,IAAI,CAAAC,GAAA,GAAAF,GAAA,CAAC,CAAC;EAAE/I;AAAO,CAAC,KAAK;EAAA+I,GAAA;EAC3C,MAAMnB,GAAG,GAAGvM,MAAM,CAAC,IAAI,CAAC;EAExBD,SAAS,CAAC,MAAM;IACZ,MAAM8N,GAAG,GAAGtB,GAAG,CAAC7J,OAAO;IACvB,IAAI,CAACmL,GAAG,IAAI,CAAClJ,MAAM,EAAE;IAErBkJ,GAAG,CAACrG,SAAS,GAAG7C,MAAM;IACtBkJ,GAAG,CAACpG,KAAK,GAAG,KAAK,CAAC,CAAE;;IAEpB,MAAMqG,OAAO,GAAGA,CAAA,KAAMD,GAAG,CAACE,IAAI,CAAC,CAAC,CAACC,KAAK,CAAC,MAAM,CAAE,CAAC,CAAC;IAEjD,IAAIrJ,MAAM,CAACsJ,MAAM,EAAEH,OAAO,CAAC,CAAC;IAC5BnJ,MAAM,CAACwH,gBAAgB,CAAC,UAAU,EAAE2B,OAAO,CAAC;IAC5C,OAAO,MAAMnJ,MAAM,CAACuH,mBAAmB,CAAC,UAAU,EAAE4B,OAAO,CAAC;EAChE,CAAC,EAAE,CAACnJ,MAAM,CAAC,CAAC;EAEZ,oBAAO5D,OAAA;IAAOwL,GAAG,EAAEA,GAAI;IAACY,QAAQ;IAACC,WAAW;IAACZ,SAAS,EAAC;EAAkB;IAAAK,QAAA,EAAAC,YAAA;IAAAC,UAAA;IAAAC,YAAA;EAAA,OAAE,CAAC;AAChF,CAAC,kCAAC;AAACkB,GAAA,GAlBGV,WAAW;AAoBjB,eAAexM,aAAa;AAAC,IAAAyM,EAAA,EAAAG,GAAA,EAAAM,GAAA;AAAAC,YAAA,CAAAV,EAAA;AAAAU,YAAA,CAAAP,GAAA;AAAAO,YAAA,CAAAD,GAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}